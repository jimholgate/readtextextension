<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="TTS_Utilities" script:language="StarBasic">Rem *  *  *  *  * BASIC *  *  *  *  *
&apos;&apos;
&apos;&apos; # TTS_Utilities
&apos;&apos; 
&apos;&apos; These functions handle events, create combo box listings, read and write
&apos;&apos; strings to files, get selected text, clean up strings, etc. There are
&apos;&apos; some strings that may need to be modified over time, including URLs and
&apos;&apos; command lines for programs that get revised or don’t work anymore.
&apos;&apos; 
&apos;&apos; In this program, external scripts do the work. The script language is
&apos;&apos; different for each major platform. In Apple MacOS, the language is
&apos;&apos; osascript, also known as Apple Script. Linux and other Unix-like
&apos;&apos; platforms use python scripts. Windows uses vbs. Read the script and
&apos;&apos; command line for your platform by clicking the **About…** button from
&apos;&apos; the main dialogue window.
&apos;&apos; 
&apos;&apos; The abilities of Read Text vary by platform and installed software. for
&apos;&apos; example, in Windows, installing iTunes allows you to save files in the
&apos;&apos; .m4a format for portable players. In Linux, `avconv` or `ffmpeg` allow
&apos;&apos; you to save sounds in various audio formats according to the packages
&apos;&apos; installed on your computer. if you install a new program, then the Read
&apos;&apos; Text dialogue updates to reflect the new capabilities of your computer.
&apos;&apos; 
&apos;&apos; Specific information for your platform is included in the program
&apos;&apos; listing shown when you view the **About** dialogue.
&apos;&apos; 
&apos;&apos; ## System Clipboard.
&apos;&apos; 
&apos;&apos; In some circumstances, the extension might use the system clipboard to
&apos;&apos; retrieve text. (*Tools - Addons - Read clipboard*) If your computer uses
&apos;&apos; an accessibility tool that also uses the clipboard to retrieve text,
&apos;&apos; check whether the extension interferes with your software or hardware
&apos;&apos; before using the extension to read the clipboard.
&apos;&apos; 
&apos;&apos; ## Windows dialogue
&apos;&apos; 
&apos;&apos; **Read text** reads text aloud, saves audio files and can use resources
&apos;&apos; from the web based on the selected text.
&apos;&apos; 
&apos;&apos; -   Select text.
&apos;&apos; -   Click the *Read selection* button.
&apos;&apos; -   To read aloud, accept the default in the dialogue, or choose another
&apos;&apos;     action from the menus.
&apos;&apos; 
&apos;&apos; ### Saving files
&apos;&apos; 
&apos;&apos; Windows lets you save sound files in an uncompressed`.wav` format. To
&apos;&apos; save space, convert `.wav` files to small `.m4a` or `mp3` files that you
&apos;&apos; can share on most mobile phones, music players and tablets.
&apos;&apos; 
&apos;&apos; ### Language support
&apos;&apos; 
&apos;&apos; This script uses the Windows speech application programming interface
&apos;&apos; (`SAPI`). Depending on the version and locale of Windows, voices in
&apos;&apos; different languages may be available.
&apos;&apos; 
&apos;&apos; ### Examples:
&apos;&apos; 
&apos;&apos; External program:
&apos;&apos; 
&apos;&apos;     C:\Windows\SysWOW64\wscript.exe
&apos;&apos; 
&apos;&apos; Command line options (default):
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; or (save as a .wav file in the home directory):
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /soundfile:&quot;(HOME)(NOW).wav&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; or (use a named voice)
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /voice:&quot;Microsoft Hortense Desktop - French&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; or (read a little slower)
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /rate:-3 &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; or (change voice by language)
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /language:&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; **Note**: Selecting this option doesn’t work with the SAPI speech
&apos;&apos; synthesizer if you haven’t installed a voice in the language.
&apos;&apos; 
&apos;&apos; ## Optional formats
&apos;&apos; 
&apos;&apos; ### VLC
&apos;&apos; 
&apos;&apos; [VLC](https://videolan.org/vlc) is a free cross platform audio player.
&apos;&apos; The full desktop version can save audio files in many different formats.
&apos;&apos; This extension does not add additional metadata when you use VLC.
&apos;&apos; 
&apos;&apos; ### Flac
&apos;&apos; 
&apos;&apos; Makes free lossless audio codec (FLAC) files.
&apos;&apos; 
&apos;&apos; -   Install `flac.exe` in `C:\opt\`
&apos;&apos; 
&apos;&apos; -   [flac encoder](https://xiph.org/flac/links.html#software)
&apos;&apos; 
&apos;&apos; -   [Players and plugins](https://xiph.org/flac/)
&apos;&apos; 
&apos;&apos;     “(TTS_WSCRIPT_VBS)” /use-optional-app:“True”
&apos;&apos;     /soundfile:“(HOME)en(NOW).flac” “(TMP)”
&apos;&apos; 
&apos;&apos; ### iTunes
&apos;&apos; 
&apos;&apos; **iTunes** is a visual music manager from Apple available at no cost.
&apos;&apos; 
&apos;&apos; Use [iTunes](https://www.apple.com/itunes/) to convert sound files with
&apos;&apos; metadata and album cover art. The first time you use it, iTunes takes a
&apos;&apos; few moments to start. iTunes creates the audio file in it’s own
&apos;&apos; directory and signals you with a sound. Read Text Extension puts a copy
&apos;&apos; in a sound directory in your home directory.
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /language:&quot;en-US&quot; /soundfile:&quot;(HOME)en\(NOW).aif&quot; &quot;(TMP)&quot;
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /language:&quot;en-US&quot; /soundfile:&quot;(HOME)en\(NOW).m4a&quot; &quot;(TMP)&quot;
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /language:&quot;en-US&quot; /soundfile:&quot;(HOME)en\(NOW).mp3&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; ### Lame
&apos;&apos; 
&apos;&apos; Lame is a free command line file converter.
&apos;&apos; 
&apos;&apos; Play mp3 compatible encoded sound files with most music players Use
&apos;&apos; `lame.exe` to make an mp3 compatible file.
&apos;&apos; 
&apos;&apos; -   Install `lame.exe` in `C:\opt\`
&apos;&apos; 
&apos;&apos; -   [Lame encoder](http://www.rarewares.org/mp3-lame-bundle.php)
&apos;&apos; 
&apos;&apos;     “(TTS_WSCRIPT_VBS)” /use-optional-app:“True”
&apos;&apos;     /soundfile:“(HOME)en(NOW).mp3” “(TMP)”
&apos;&apos; 
&apos;&apos; ### FFmpeg
&apos;&apos; 
&apos;&apos; [ffmpeg](https://www.ffmpeg.org) is a free visual music and video
&apos;&apos; converter.
&apos;&apos; 
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /use-optional-app:&quot;True&quot; /soundfile:&quot;(HOME)en\(NOW).mp3&quot; &quot;(TMP)&quot;
&apos;&apos;     &quot;(TTS_WSCRIPT_VBS)&quot; /use-optional-app:&quot;True&quot; /soundfile:&quot;(HOME)en\(NOW).ogg&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; ### Ogg
&apos;&apos; 
&apos;&apos; Play ogg encoded sound files with firefox, chrome or chromium. Use
&apos;&apos; `oggenc.exe` or `oggenc2.exe` to make an ogg file
&apos;&apos; 
&apos;&apos; -   The ogg converter program must be installed in `C:\opt\`.
&apos;&apos; 
&apos;&apos; -   [oggenc2 encoder](http://www.rarewares.org/ogg-oggenc.php)
&apos;&apos; 
&apos;&apos; -   [Players and plugins](https://xiph.org/vorbis/)
&apos;&apos; 
&apos;&apos;     “(TTS_WSCRIPT_VBS)” /use-optional-app:“True”
&apos;&apos;     /soundfile:“(HOME)en(NOW).ogg” “(TMP)”
&apos;&apos; 
&apos;&apos; ## Apple MacOS
&apos;&apos; 
&apos;&apos; **Read Text** reads text aloud, saves audio or video files from text,
&apos;&apos; and can use resources from the web based on the selected text.
&apos;&apos; 
&apos;&apos; -   Select text.
&apos;&apos; -   Click the *Read selection…* button.
&apos;&apos; -   To read aloud, accept the default in the dialogue, or choose another
&apos;&apos;     action from the menus.
&apos;&apos; 
&apos;&apos; Read Aloud
&apos;&apos; 
&apos;&apos;     &quot;(SAY_APPLESCRIPT)&quot;
&apos;&apos; 
&apos;&apos; ### Python option
&apos;&apos; 
&apos;&apos; Recent releases of the MacOS operating system use python 3. With
&apos;&apos; python3, you can use python instead of Apple Script.
&apos;&apos; 
&apos;&apos; Python’s added options include the ability to use various local
&apos;&apos; `python-pip3` libraries like `qrcode` and speech servers available on a
&apos;&apos; local http server or an online resource.
&apos;&apos; 
&apos;&apos; Read with a female voice
&apos;&apos; 
&apos;&apos;     &quot;(SPD_READ_TEXT_PY)&quot; --language &quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot; --voice &quot;FEMALE1&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; #### QR Code
&apos;&apos; 
&apos;&apos; `pip3 install Pillow qrcode`
&apos;&apos; 
&apos;&apos;     &quot;(CREATE_QR_LABEL_PY)&quot; --size 12 --output &quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).png&quot; &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; #### Network speech synthesis
&apos;&apos; 
&apos;&apos; `pip3 install gTTS`
&apos;&apos; 
&apos;&apos;     &quot;(NETWORK_READ_TEXT_PY)&quot; --language (SELECTION_LANGUAGE_CODE) &quot;(TMP)&quot;
&apos;&apos; 
&apos;&apos; &lt;span id=&quot;ch014.xhtml&quot;&gt;&lt;/span&gt;
&apos;&apos; 
&apos;&apos; ## Linux
&apos;&apos; 
&apos;&apos; ### Festival
&apos;&apos; 
&apos;&apos; Reads a text file using festival.
&apos;&apos; 
&apos;&apos; The festival engine is a software speech synthesizer.
&apos;&apos; 
&apos;&apos; Install festival using a package manager to install a festivox or
&apos;&apos; festival voice. The package manager should automatically select the
&apos;&apos; festival package and the required support files.
&apos;&apos; 
&apos;&apos; Festival scripts allow you to change the speed, the pitch and the voice.
&apos;&apos; You can add music or sound effects to the output.
&apos;&apos; 
&apos;&apos; ### Python
&apos;&apos; 
&apos;&apos; [Python](https://python.org) is an interpreted, interactive,
&apos;&apos; object-oriented programming language.
&apos;&apos; 
&apos;&apos; Read Text uses python to access operating system commands in Linux.
&apos;&apos; 
&apos;&apos; External program:
&apos;&apos; 
&apos;&apos;     /usr/bin/python3
&apos;&apos; 
&apos;&apos; #### Command line options:
&apos;&apos; 
&apos;&apos; The command line options vary depending on the resources available on
&apos;&apos; your computer. Both [avconv](https://libav.org/avconv.html) and
&apos;&apos; [ffmpeg](https://ffmpeg.org) are capable of adding a poster image to an
&apos;&apos; mp3 file as well as normal metadata.
&apos;&apos; 
&apos;&apos; #### Larynx
&apos;&apos; 
&apos;&apos; If you have downloaded a container version of LibreOffice from a
&apos;&apos; `flatpak` or `snap` repository, you can use `larynx-server` to read text
&apos;&apos; aloud with high quality voices. The `larynx-server` works like the
&apos;&apos; `cups` print server. When the server is running you can access a
&apos;&apos; `localhost` speech tool at &lt;http://0.0.0.0:5002&gt;. The read text
&apos;&apos; extension uses the larynx python application program interface to read
&apos;&apos; text aloud.
&apos;&apos; 
&apos;&apos; ##### Fedora, Red Hat, CentOS…
&apos;&apos; 
&apos;&apos;     sudo dnf install docker
&apos;&apos; 
&apos;&apos; ##### Debian, Ubuntu, Mint…
&apos;&apos; 
&apos;&apos;     apt-get install docker
&apos;&apos; 
&apos;&apos; ##### All
&apos;&apos; 
&apos;&apos;     docker run \
&apos;&apos;         -it \
&apos;&apos;         -p 5002:5002 \
&apos;&apos;         -e &quot;HOME=${HOME}&quot; \
&apos;&apos;         -v &quot;$HOME:${HOME}&quot; \
&apos;&apos;         -v /usr/share/ca-certificates:/usr/share/ca-certificates \
&apos;&apos;         -v /etc/ssl/certs:/etc/ssl/certs \
&apos;&apos;         -w &quot;${PWD}&quot; \
&apos;&apos;         --user &quot;$(id -u):$(id -g)&quot; \
&apos;&apos;         rhasspy/larynx
&apos;&apos; 
&apos;&apos; You can find out more about Larynx at the `rhsspy larynx` website.
&apos;&apos; 
&apos;&apos; &lt;https://github.com/rhasspy/larynx&gt;
&apos;&apos; 
&apos;&apos; #### More
&apos;&apos; 
&apos;&apos; See the manual page for *python* for more detailed information about
&apos;&apos; python. Click the *About…* button in the extension dialogue for
&apos;&apos; information about specific options available to you.
&apos;&apos; 
&apos;&apos; ## Cross Platform information
&apos;&apos; 
&apos;&apos; ### Reset Speech
&apos;&apos; 
&apos;&apos; if you are having problems with speech it is easy to reset the extension
&apos;&apos; to the default settings. Simply type some random characters into the
&apos;&apos; *External program* box in the main dialogue. The extension shows an
&apos;&apos; error message and deletes the settings files that the extension creates.
&apos;&apos; When you click the *Read Selection* button, the settings are rebuilt
&apos;&apos; from scratch.
&apos;&apos; 
&apos;&apos; ### Reading files
&apos;&apos; 
&apos;&apos; All extensions run in the **trusted** zone on your computer. This means
&apos;&apos; that this extension, like all extensions, can read files on your
&apos;&apos; computer without notifying you. Make sure that extensions you use come
&apos;&apos; from a trusted source.
&apos;&apos; 
&apos;&apos; ### Temporary Files
&apos;&apos; 
&apos;&apos; This extension uses temporary files for two purposes:
&apos;&apos; 
&apos;&apos; -   Communicate with an external script or program.
&apos;&apos; -   Remember your preferences.
&apos;&apos; 
&apos;&apos; The location of temporary and settings files are determined by your
&apos;&apos; operating system. Depending on the security set up of your computer,
&apos;&apos; other users or programs might be able to read the contents of the
&apos;&apos; settings or temporary files. if you are concerned about privacy, launch
&apos;&apos; this add-on again with no text selected to replace the temporary file
&apos;&apos; that contains the text you want to remain confidential. The path and
&apos;&apos; name of the temporary file is shown in the Command and Script areas of
&apos;&apos; the *About…* dialogue.
&apos;&apos; 
&apos;&apos; ### Customizing speech
&apos;&apos; 
&apos;&apos; Speech can be modified by command line arguments, platform settings and
&apos;&apos; codes embedded into the speech text string.
&apos;&apos; 
&apos;&apos; When creating spoken records of written documents, pauses are important.
&apos;&apos; Text is more understandable and less fatiguing to listen to when it is
&apos;&apos; punctuated by pauses between paragraphs or ideas.
&apos;&apos; 
&apos;&apos; Modern speech synthesizers take care of most of the pauses required due
&apos;&apos; to punctuation and line breaks, but under some circumstances, an author
&apos;&apos; of a speech document may need to add a break manually.
&apos;&apos; 
&apos;&apos; ### Windows
&apos;&apos; 
&apos;&apos; All currently supported versions of Windows can use [W3 Synchronized
&apos;&apos; Multimedia Integration Language](https://www.w3.org/TR/SMIL3/). **SMIL**
&apos;&apos; markup enables responsive speech as well as incorporating specific
&apos;&apos; languages, pitch, volume, speed and pauses.
&apos;&apos; 
&apos;&apos; ### Linux
&apos;&apos; 
&apos;&apos; Linux support for SMIL varies by speech synthesizer. In some speech
&apos;&apos; synthesizers, it is disabled by default, but can be enabled using a
&apos;&apos; command line switch.
&apos;&apos; 
&apos;&apos; ### MacOS
&apos;&apos; 
&apos;&apos; MacOS uses a [custom
&apos;&apos; markup](https://developer.apple.com/library/mac/documentation/UserExperience/Conceptual/SpeechSynthesisProgrammingGuide/Introduction/Introduction.html)
&apos;&apos; for speech synthesis instead of SMIL. The markup can incorporate changes
&apos;&apos; in pitch, speed and volume, but does not specify language. for US
&apos;&apos; English users, the markup includes a context driven means of specifying
&apos;&apos; a particular way to pronounce a word in an ambiguous context.
&apos;&apos; 
&apos;&apos; MacOS computers require a short gap at the end of short synthesized
&apos;&apos; speech utterances when recording sound to a file.
&apos;&apos; 
&apos;&apos; Very short words cause an osascript error when adding metadata via
&apos;&apos; iTunes on MacOS. As well, single words in synthesized speech are easier
&apos;&apos; to understand if we add about half a second of silence to the end of
&apos;&apos; each utterance, especially if gapless playback is enabled.
&apos;&apos; 
&apos;&apos; The [inline
&apos;&apos; code](https://developer.apple.com/library/mac/documentation/UserExperience/Conceptual/SpeechSynthesisProgrammingGuide/FineTuning/FineTuning.html#//apple_ref/doc/uid/TP40004365-CH5-SW10)
&apos;&apos; `[[slnc 400]]` causes the speech synthesizer to include 400 milliseconds
&apos;&apos; of silence.
&apos;&apos; 
&apos;&apos; ### Media Directories
&apos;&apos; 
&apos;&apos; Read Text Extension can create media files for playback on portable
&apos;&apos; devices or for embedding into other content you create.
&apos;&apos; 
&apos;&apos; -   if you are using iTunes, the iTunes program creates a media file in
&apos;&apos;     the iTunes music directory. The extension makes a copy in your home
&apos;&apos;     directory in a folder named with the iso code of your language -
&apos;&apos;     *en* for English, *de* for German, *es* for Spanish etc.
&apos;&apos; -   if you are using a command-line program to convert your media files,
&apos;&apos;     then the media file is saved to home directory in a folder named
&apos;&apos;     with the iso code of your language.
&apos;&apos; 
&apos;&apos; ### Custom Directories
&apos;&apos; 
&apos;&apos; if you don’t like the defaults, set the name of the directory yourself.
&apos;&apos; The extension will attempt to create the directory if it is a valid
&apos;&apos; path.
&apos;&apos; 
&apos;&apos; ### Tokens
&apos;&apos; 
&apos;&apos; The extension replaces strings in the main dialogue with path names or
&apos;&apos; command arguments at run time. You can preview the actual command line
&apos;&apos; using the *About…* dialogue.
&apos;&apos; 
&apos;&apos; for more information about tokens, look in the office help for *Read
&apos;&apos; Text Extension - Setting Up Read Text Extension - Command and Script
&apos;&apos; Tokens*.
&apos;&apos; 
&apos;&apos; ## Language and Region
&apos;&apos; 
&apos;&apos; The extension can determine the language of the selected text and pass
&apos;&apos; the value to a speech synthesizer. The languages on your computer vary
&apos;&apos; depending on the platform, release version and locale of the operating
&apos;&apos; system as well as software you might have installed.
&apos;&apos; 
&apos;&apos; Most computers include at least a simple English voice. if you are not
&apos;&apos; certain whether speech is installed, try a using a simple English voice
&apos;&apos; with plain ASCII text.
&apos;&apos; 
&apos;&apos; ### Complex languages
&apos;&apos; 
&apos;&apos; Complex languages need special handling because their Unicode strings
&apos;&apos; use directional markers.
&apos;&apos; 
&apos;&apos; Gurmukhi script is used for Punjabi. Devanagari script is for Hindi and
&apos;&apos; other Indic languages. Other complex languages include Dogri, Bodo,
&apos;&apos; Maithili, Khmer, Thaana, Dhiveh, Urdu, Farsi, Arabic, Kashmiri, Kurdish,
&apos;&apos; Hebrew, Bengali, Gurjarti, Oriya, Tamil, Telugu, Kannada, Malayalam,
&apos;&apos; Burmese (Myanmar), Thai, Lao, Tibetan, Dzongkha, Ethiopic, Ethiopic
&apos;&apos; Supplement, Limbu, and Ethopic Extended. Some languages use either
&apos;&apos; western or complex letters depending on region and media.
&apos;&apos; 
&apos;&apos; ### Asian languages
&apos;&apos; 
&apos;&apos; Asian languages may include a large porportion of ideagrams, or
&apos;&apos; non-phonetic letters. The direction of Asian text is top to bottom or
&apos;&apos; left to right. Korean Hangul traditionally incorporated Chinese-like
&apos;&apos; characters, but contemporary script is primarily phonetic. Japanese
&apos;&apos; includes Chinese-like characters as well as different phonetic letter
&apos;&apos; sets for some Japanese and imported words.
&apos;&apos; 
&apos;&apos; ## Reference
&apos;&apos; 
&apos;&apos; ### MsgSpeak (Basic command)
&apos;&apos; 
&apos;&apos; if you want to get your hands dirty with a little Basic programming, you
&apos;&apos; can use the `msgspeak` command in your own slide shows or programs to
&apos;&apos; synthesize speech.
&apos;&apos; 
&apos;&apos; The command reads the string using the language and region of the the
&apos;&apos; current document using the current settings of extension. if the
&apos;&apos; extension is set up to go to a web page or save a file, that is what it
&apos;&apos; will do when you activate the command.
&apos;&apos; 
&apos;&apos; This example shows how to use the command in your own script:
&apos;&apos; 
&apos;&apos;     sub OnClickMySlide1Image1()
&apos;&apos;         &apos; Read text aloud.
&apos;&apos;         dim oSvc
&apos;&apos;         dim sURL
&apos;&apos;         dim sArg
&apos;&apos; 
&apos;&apos;         sArg = &quot;Hello world!&quot;
&apos;&apos;         sURL = &quot;https://sites.google.com/site/readtextextension/&quot;
&apos;&apos;         On Error Goto OnClickMySlide1Image1Err
&apos;&apos;         msgSpeak(sArg)
&apos;&apos;         exit sub
&apos;&apos;         OnClickMySlide1Image1Err:
&apos;&apos;         if msgbox(&quot;The button couldn&apos;t find a &quot;&quot;text to speech&quot;&quot; add-on.&quot; &amp; _
&apos;&apos;                 chr(10) &amp; _
&apos;&apos;                 sArg &amp; _
&apos;&apos;                 chr(10) &amp; _
&apos;&apos;                 &quot;Get on-line help?&quot;, _
&apos;&apos;                 4, _
&apos;&apos;                 &quot;Read Text&quot;) &lt;&gt; 7 then
&apos;&apos;             oSvc = createUnoService(&quot;com.sun.star.system.SystemShellExecute&quot;)
&apos;&apos;             oSvc.execute(sURL,&quot;&quot;,0)
&apos;&apos;         end if
&apos;&apos;     end sub
&apos;&apos; 
&apos;&apos; ### Help in LibreOffice
&apos;&apos; 
&apos;&apos; LibreOffice does not show an extension’s help documents if the
&apos;&apos; application’s help documents are not installed. In this case, we show
&apos;&apos; web based extension help in a browser window
&apos;&apos; 
&apos;&apos; ### Time formats
&apos;&apos; 
&apos;&apos; Speech synthesizers may be able to convert strings written in a standard
&apos;&apos; machine language style to normal speech. if you are not sure how to
&apos;&apos; communicate a time and date to someone who does not speak your language,
&apos;&apos; a standard time format is useful.
&apos;&apos; 
&apos;&apos; -   The Internet Engineering Task force [RFC
&apos;&apos;     3339](https://www.ietf.org/rfc/rfc3339.txt).
&apos;&apos; -   Unix `man date`
&apos;&apos; 
&apos;&apos; Unix commands to generate formatted time strings
&apos;&apos; 
&apos;&apos;     date +%F-T%X%:z &gt; &quot;$HOME/date.txt&quot;
&apos;&apos;     date -u +%F-T%X-00:00 &gt; &quot;$HOME/date.txt&quot;
&apos;&apos; 
&apos;&apos; &lt;span id=&quot;ch018.xhtml&quot;&gt;&lt;/span&gt;
&apos;&apos; 
&apos;&apos; ## iTunes for Windows
&apos;&apos; 
&apos;&apos; People with Apple branded devices or subscribers to Apple services can
&apos;&apos; use iTunes for Windows to access streaming media and to manage their
&apos;&apos; devices.
&apos;&apos; 
&apos;&apos; A Windows computer can use iTunes to convert text to speech audio files
&apos;&apos; in WAV format to MP3 or M4A audio files for mobile devices.
&apos;&apos; 
&apos;&apos; ### More information
&apos;&apos; 
&apos;&apos; -   [Windows 7](https://www.apple.com/itunes/download/win64)
&apos;&apos; -   Windows 8, 10 and 11 [Microsoft  
&apos;&apos;     store](https://www.microsoft.com/en-us/p/itunes/9pb2mz1zmb1s?activetab=pivot:overviewtab)
&apos;&apos;     (recommended)
&apos;&apos; 
&apos;&apos; ### Graphic sizes
&apos;&apos; 
&apos;&apos; Impress presentation software can convert slide images to **.jpeg** or
&apos;&apos; **.png** files. it’s an easy way to add titles to a photo or to prepare
&apos;&apos; a picture with a specific size for publication on a blog or news site.
&apos;&apos; 
&apos;&apos; When you publish a graphic, it looks best and renders fastest if you set
&apos;&apos; it to the exact size needed. Cameras usually use resolution settings
&apos;&apos; that are much larger than needed for viewing on a screen. The large size
&apos;&apos; is required because images are often cropped or straightened. On low
&apos;&apos; cost portable devices, these large images may take a long time to render
&apos;&apos; or may be distorted.
&apos;&apos; 
&apos;&apos; The [Participatory Culture
&apos;&apos; Foundation](https://web.archive.org/web/20160526113720/http://develop.participatoryculture.org/index.php/ConversionMatrix)
&apos;&apos; published a matrix that shows standard screen resolutions as well as
&apos;&apos; resolutions for many portable devices. Here are several popular formats:
&apos;&apos; 
&apos;&apos; -   **1200x800** A classic 35 mm camera format that looks good on a HDMI
&apos;&apos;     screen or a full screen MacBook
&apos;&apos; -   **640x480** VGA projector or NTSC broadcast 4:3
&apos;&apos; -   **720x576** PAL broadcast
&apos;&apos; -   **1366x768** Windows laptop 16:9
&apos;&apos; -   **1280x800** Apple MacBook
&apos;&apos; -   **1440x900** Apple MacBook Air
&apos;&apos; -   **1920x1080** 1080p High Def TV 16:9
&apos;&apos; 
&apos;&apos; Some media players will distort album cover art if it is not square.
&apos;&apos; 
&apos;&apos; -   **600x600** Small square format for audio players
&apos;&apos; 
&apos;&apos; ### FFmpeg
&apos;&apos; 
&apos;&apos; [FFmpeg](https://www.ffmpeg.org) is a general purpose command line
&apos;&apos; video, graphic and sound converter for Linux, MacOS, UNIX and Windows.
&apos;&apos; Read Text can use it to convert speech recordings to different formats.
&apos;&apos; 
&apos;&apos; [AVconv](https://libav.org/avconv.html) is a *fork* of FFmpeg, and
&apos;&apos; shares many of the same commands and capabilities. On [Ubuntu
&apos;&apos; Linux](https://ubuntu.com), the `avconv` project is included in the
&apos;&apos; repository instead of `ffmpeg`. Read text can use either.
&apos;&apos; 
&apos;&apos;     sudo apt-get install avconv
&apos;&apos; 
&apos;&apos;     &apos; or return `` if the application isn&apos;t in the path.
&apos;&apos; 
&apos;&apos; ### Stopping Speech
&apos;&apos; 
&apos;&apos; To stop speech, click the Read selection button while the voice is
&apos;&apos; speaking.
&apos;&apos; 
&apos;&apos; ### Windows
&apos;&apos; 
&apos;&apos; Stopping the speech is handled in the external script.
&apos;&apos; 
&apos;&apos; ### MacOS
&apos;&apos; 
&apos;&apos; Stopping the speech is handled in the `resetSpeechDispatcher` procedure
&apos;&apos; in the TTS Utilities module of the extension.
&apos;&apos; 
&apos;&apos; ### Linux
&apos;&apos; 
&apos;&apos; Stopping the speech is handled in the `resetSpeechDispatcher` procedure
&apos;&apos; in the TTS Utilities module of the extension.
&apos;&apos; 
&apos;&apos; **Speech Dispatcher** is an optional speech manager for Linux. It isn’t
&apos;&apos; needed for read text extension.
&apos;&apos; 
&apos;&apos; You can manually edit the speech-dispatcher settings files to use
&apos;&apos; specific speech engines for different languages. for example, you could
&apos;&apos; set up English and Spanish to use pico and Catalan to use festival. if
&apos;&apos; the speech dispatcher voice becomes distorted or stops working, you can
&apos;&apos; try resetting it using `killall speech-dispatcher`, or by logging out
&apos;&apos; and logging in again. Specific voice settings are in the extension’s
&apos;&apos; main menu dialogue.
&apos;&apos; 
&apos;&apos; [Speech-dispatcher
&apos;&apos; help](https://www.unix.com/man-page/all/1/speech-dispatcher/)
&apos;&apos; 
&apos;&apos; To install speech-dispatcher, use:
&apos;&apos; 
&apos;&apos;     sudo apt-get install speech-dispatcher
&apos;&apos; 
&apos;&apos; ## Your personal information
&apos;&apos; 
&apos;&apos; Extensions run in the **trusted zone**. All extensions have access to
&apos;&apos; the information that you entered into *Tools - Options - User Data*.
&apos;&apos; Read Text extension uses your first and last name to provide *artist*
&apos;&apos; information to sound or video files that you create only if the original
&apos;&apos; author of a document is ambiguous or missing.
&apos;&apos; 
&apos;&apos; ### Where is your personal information stored?
&apos;&apos; 
&apos;&apos; Apache OpenOffice and LibreOffice store the personal information in a
&apos;&apos; registry file, coded in xml format in a UTF-8 text document. You can
&apos;&apos; review the data in the file,
&apos;&apos; `&lt;&lt;OOo-Profile/3/user/registry/data&gt;&gt; /org/openoffice/UserProfile.xcu`.
&apos;&apos; The information is located in the XML-node labelled *Data*. Find out
&apos;&apos; more at the [Apache OpenOffice
&apos;&apos; forum](http://forum.openoffice.org/en/forum/viewtopic.php?f=20&amp;t=14750).
&apos;&apos; 
&apos;&apos; Depending on your office application and version, you may be able to
&apos;&apos; uncheck a box labelled *Use data for document properties* in the *User
&apos;&apos; Data* dialogue.
&apos;&apos; 
&apos;&apos; ## Making release notes
&apos;&apos; 
&apos;&apos; Each xba script includes up-to-date notes as **markdown** text. To
&apos;&apos; create an *About* document in Linux or MacOS, use the terminal command
&apos;&apos; shown in the input box shown when you run the `fsReleasenotesCMD`
&apos;&apos; procedure.
&apos;&apos; 
&apos;&apos; You can use [Python Markdown](https://pypi.python.org/pypi/Markdown) or
&apos;&apos; [Dingus](https://daringfireball.net/projects/markdown/dingus), an
&apos;&apos; on-line markdown converter, to convert the help file to html. You can
&apos;&apos; use [calibre-ebook](https://calibre-ebook.com/) to convert markdown text
&apos;&apos; to many other formats.
&apos;&apos; 
&apos;&apos; ### About Markdown
&apos;&apos; 
&apos;&apos; [Markdown](https://daringfireball.net/projects/markdown/) is a simple
&apos;&apos; way to format text for blogs, email, news, education and technical
&apos;&apos; support documentation.
&apos;&apos; 
&apos;&apos; There are forks and extensions of the original release. To provide
&apos;&apos; compatibility across platforms, use plain and simple markdown that is
&apos;&apos; compatible with python-markdown.
&apos;&apos; 
&apos;&apos; [Python-markdown](https://pypi.python.org/pypi/Markdown) comes with
&apos;&apos; [calibre-ebook](https://calibre-ebook.com/) or is available on Debian
&apos;&apos; and Ubuntu Linux with:
&apos;&apos; 
&apos;&apos;     sudo apt-get install python-markdown
&apos;&apos; 
&apos;&apos; ### Copyright And License
&apos;&apos; 
&apos;&apos; \(c\) 2008-2023 James Holgate Vancouver, CANADA (readtextextension (a)
&apos;&apos; outlook.com)
&apos;&apos; 
&apos;&apos; THIS IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY IT UNDER
&apos;&apos; THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY THE FREE
&apos;&apos; SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR (AT YOUR
&apos;&apos; OPTION) ANY LATER VERSION. THIS SCRIPT IS DISTRIBUTED IN THE HOPE THAT
&apos;&apos; IT WILL BE USEFUL, BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED
&apos;&apos; WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. SEE THE
&apos;&apos; GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
&apos;&apos; 
&apos;&apos; YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE ALONG
&apos;&apos; WITH THIS SOFTWARE; if not, WRITE TO THE FREE SOFTWARE FOUNDATION,INC.,
&apos;&apos; 59 TEMPLE PLACE,SUITE 330,BOSTON,MA 02111-1307 USA
&apos;&apos;
Option Explicit

Type KeyValueType
	&apos; key value pairs as strings
	key As String
	value As String
End Type


Function isSnap() As Boolean
	isSnap = Instr(Environ(&quot;PATH&quot;), &quot;/snap/&quot;) = 1
End Function


Function isFlatPak() As Boolean
	isFlatPak = instr(Environ(&quot;PATH&quot;), &quot;/app/bin:/usr/bin&quot;) = 1
End Function


Function fbLocalHostOk(ByVal _url As String, ByVal _key As String) As Boolean
	&apos; Check if a web api resource that returns text is available.
	&apos; Note: fsGetWebService could freeze if you &quot;Pause&quot; a docker
	&apos; image instead of &quot;Stopping&quot; it becaue it will wait for a reply
	&apos; from the local server.
	fbLocalHostOk = False
	On Error Goto fbLocalHostOkErr
	Dim test_str$ : test_str = &quot;&quot;
	Dim alt_key$ : alt_key = _key
	If Len(_url) = 0 Then
		&apos; rhasspy/larynx speech server
		_url = &quot;http://0.0.0.0:5002/api/voices&quot;
	End If
	test_str = fsGetWebService(_url)
	If Len(_key) = 0 Then
		_key = Lcase(fsSelectionLanguageAndRegion(True))
		test_str = Lcase(test_str)
		If Len(_key) = 0 Then
			Exit Function
		End If
		alt_key = fsReplaceText(_key, &quot;-&quot;, &quot;_&quot;)
	End If
	Select Case Len(test_str)
		Case 0
		fbLocalHostOk = False
		Case Else
		If Instr(test_str, _key) = 0 And _
		Instr(test_str, alt_key) = 0 Then
			&apos; 404, timeout or unexpected contents
			fbLocalHostOk = False
		Else
			fbLocalHostOk = True
		End If
	End Select
	Exit Function
	fbLocalHostOkErr:
	fbLocalHostOk = False
End Function


Function fbRemoveFile(FilePath as String) As Boolean
	&apos; Kill a file if it exists. Return `True` if file does not exist on exit.
	Dim oUcb as Object
	oUcb = createUnoService(&quot;com.sun.star.ucb.SimpleFileAccess&quot;)
	If oUcb.Exists(FilePath) Then
		oUcb.Kill(FilePath)
	End If
	fbRemoveFile = Not oUcb.Exists(FilePath)
End Function


Sub OK_MouseUp( _
	Event As Object)
	&apos; This sub uses the current dialog settings without dismissing
	&apos; the dialog if you right click the OK button.
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.RIGHT Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		&quot;&quot;)
	ElseIf Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;CommandButton1&quot;).model.Label)
	End If
End Sub


Sub Cancel_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;CommandButton2&quot;).model.Label)
	End If
End Sub


Sub Reset_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;CommandButton4&quot;).model.Label)
	ElseIf Event.Buttons And com.sun.star.awt.MouseButton.Left Then
		resetSpeech()
		
	End If
End Sub


Sub About_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;CommandButton3&quot;).model.Label)
	Else
		aboutReadTextDialog()
	End If
End Sub


Sub UseFestival_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;FrameControl1&quot;).model.Label &amp; _
		&quot;,&quot; &amp; _
		f_dlgSpeechSetup.GetControl(&quot;OptionButton1&quot;).model.Label)
	End If
End Sub


Sub Label1_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;Label1&quot;).model.Label)
	End If
End Sub


Sub Label2_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;Label2&quot;).model.Label)
	End If
End Sub


Sub UseExternal_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;FrameControl1&quot;).model.Label &amp; _
		&quot;,&quot; &amp; _
		f_dlgSpeechSetup.GetControl(&quot;OptionButton2&quot;).model.Label)
	End If
End Sub


Sub UseWeb_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;FrameControl1&quot;).model.Label &amp; _
		&quot;,&quot; &amp; _
		f_dlgSpeechSetup.GetControl(&quot;OptionButton3&quot;).model.Label)
	End If
End Sub


Sub UseAlwaysShow_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons And com.sun.star.awt.MouseButton.MIDDLE Then
		ttsActuate(fvCurrentDialogConfig(), _
		msgs(), _
		errorCode, _
		f_dlgSpeechSetup.GetControl(&quot;FrameControl2&quot;).model.Label &amp; _
		&quot;,&quot; &amp; _
		f_dlgSpeechSetup.GetControl(&quot;CheckBox1&quot;).model.Label)
	End If
End Sub


Sub AboutButton_MouseUp( _
	Event As Object)
	Dim msgs() As Variant
	Dim errorCode As Integer
	
	If Event.Buttons Then
		If FileExists(fsMyTempLock(&quot;lock&quot;)) Then
			resetSpeechDispatcher(True)
		Else
			ttsActuate(fvCurrentDialogConfig(),msgs(),errorCode,fsAbout())
		End If
	End If
End Sub


Function fsHttpHelpUrl() As String
	fsHttpHelpUrl = fsLookUpTerm2( &quot;s_http-help-url&quot;, fsDisplayLanguage())
End Function


Sub webHelpButton() As String
	&apos; Dialog3 Button on LibreOffice cannot call webHelp directly because of input
	&apos; parameter
	webHelp(fsHttpHelpUrl())
End Sub


Function fbIsLibreOffice() As Boolean
	&apos; &quot;OpenOffice&quot; returns `False`, but &quot;LibreOfficeDev&quot; returns `True`. 
	fbIsLibreOffice = Instr(fsGetSetting(&quot;ooname&quot;), &quot;LibreOffice&quot;) = 1
End Function


Function fbInPaths(ByVal _app As String) As Boolean
	Dim Paths As String
	Dim Div As String
	Dim Os_Div As String
	Dim PathList As Variant
	Dim x As Integer
	fbInPaths = False
	On Local Error GoTo fbInPathsErr
	Paths = fsReplaceText(Environ(&quot;PATH&quot;), &quot;PATH=&quot;, &quot;&quot;)
	If Instr(Paths, &quot;:&quot;) &lt;&gt; 0 Then
		Div = &quot;:&quot;
		Os_Div = &quot;/&quot;
	Else
		Div = &quot;;&quot;
		Os_Div = &quot;\&quot;
	End If
	PathList = Split(Paths, Div)
	For x = Lbound(PathList) To Ubound(PathList)
		If FileExists(PathList(x) &amp; Os_Div &amp; _app) Then
			fbInPaths = True
			Exit For
		End If
	Next
	Exit Function
	fbInPathsErr:
	fbInPaths = False
End Function


Sub webHelp(ByVal sURL)
	Dim oSvc
	On Error Goto webHelpErr
	If Len(sURL) &gt; 12 Then
		oSvc = createUnoService(&quot;com.sun.star.system.SystemShellExecute&quot;)
		Select Case fsGetOS()
			Case &quot;MacOS&quot;
			oSvc.execute(converttourl(sURL), &quot;&quot; ,0)
			Case Else
			oSvc.execute(sURL, &quot;&quot; ,0)
		End Select
	End If
	Exit Sub
	webHelpErr:
	
	MsgBox &quot;error in TTSUtilities: webHelp&quot;
End Sub


Function fbUsingTouchScreen() As Boolean
&apos; System Clipboard.
	Dim sFile As String
	Dim iSmart As Integer
	Dim config
	Dim errorCode
	
	On Error Goto fbUsingTouchScreenErr
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	If FileExists(sFile)Then
		tts_config_parseFile(sFile,config(),errorCode)
		iSmart = config(fiSmartSelectCheckBox())
	Else
		iSmart = 0
	End If
	If iSmart = 0 Then
		fbUsingTouchScreen = False
	Else
		fbUsingTouchScreen = True
	End If
	Exit Function
	fbUsingTouchScreenErr:
	
	fbUsingTouchScreen = False
End Function


Function fbUsingPosixTalkProgram(ByVal s1) As Boolean
	fbUsingPosixTalkProgram = False
	Dim i#
	i = 0
	Dim a1
	a1 = Array( _
	&quot;espeak&quot;, _
	&quot;espeak-ng&quot;, _
	&quot;festival&quot;, _
	&quot;padsp&quot;, _
	&quot;say&quot;, _
	&quot;speak-ng&quot;, _
	&quot;aplay&quot;)
	If s1 = &quot;&quot; Then
		s1 = fsProgramCommand()
	End If
	If s1 = &quot;&quot; Then Exit Function
	For i = LBound(a1) To UBound(a1)
		If Right(s1, Len(a1(i))) = a1(i) Then
			fbUsingPosixTalkProgram = True
			Exit For
		End If
	Next
End Function


Function fsProgramCommand() As String

	Dim sFile As String
	Dim sSmart As String
	Dim config
	Dim errorCode
	Dim msgs
	
	On Error Goto fsProgramCommandErr
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	&apos;Load default settings, so any settings undefined by settings file are not empty
	config() = fvTts_config_createDefaultConfig(msgs(), errorCode)
	&apos;Load the settings you used last time
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	If FileExists(sFile) Then
		tts_config_parseFile(sFile, config(), errorCode)
	Else
		&apos; The &quot;About&quot; dialog needs this file to show current information
		tts_config_writeFile(config(), sfile)
	End If
	
	sSmart = config(fiExternalProgramPath())
	
	If Not(sSmart = &quot;&quot;) And FileExists(sSmart) Then
		fsProgramCommand = sSmart
	Else
		fsProgramCommand = &quot;&quot;
	End If
	Exit Function
	fsProgramCommandErr:
	
	fsProgramCommand = &quot;&quot;
End Function


Function fiReportMetaData( _
	ByVal bVerify As Boolean) As Integer
	&apos; bVerify - if bVerify is False, the function always 
	&apos; returns 6 (&quot;Yes&quot;) but if bVerify is true, then the
	&apos; function  returns 6 if you click &quot;Yes&quot;, 7 if you
	&apos; click &quot;No&quot;, and 2 if you click Cancel
	&apos;
	Dim iYes As Integer
	iYes = 6
	Dim iNo As Integer
	iNo = 7
	Dim iCancel As Integer
	iCancel = 2
	Dim iYesNoCancel As Integer
	iYesNoCancel = 3
	Dim sA As String
	sA = &quot;&quot;
	Dim CR As String
	CR = Chr(10)
	Dim n As Integer
	n = iYes
	
	On Error Goto fiReportMetaDataErr
	
	CR = Chr(10)
	sA = Join(Array(fsLookUpTerm(&quot;s_album&quot;), &quot; : &quot;&quot;&quot;, fsThisDocTitle(), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_artist&quot;), &quot; : &quot;&quot;&quot;, fsThisDocAuthor(), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_genre&quot;), &quot; : &quot;&quot;&quot;, fsThisDocGenre(), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_title&quot;), &quot; : &quot;&quot;&quot;, fsThisSoundTitle(), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_track&quot;), &quot; : &quot;&quot;&quot;, fiMyCurrentAudioTrack(False), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_year&quot;), &quot; : &quot;&quot;&quot;, Year(Now), &quot;&quot;&quot;&quot;, CR, _
	fsLookUpTerm(&quot;s_imagedefault&quot;), &quot; : &quot;, Trim(ConvertFromUrl(fsPosterImg())), CR), _
	&quot;&quot;)
	If bVerify Then
		n = MsgBox(sA, _
		iYesNoCancel, _
		fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
		&quot; - &quot; &amp; _
		fsLookUpTerm(&quot;s_speech-properties&quot;) &amp; _
		&quot; - &quot; &amp; _
		fsLookUpTerm(&quot;s_ok&quot;) &amp; _
		&quot; ? &quot;)
	End If
	fiReportMetaData = n
	Exit Function
	fiReportMetaDataErr:
	
	&apos; MetaData has a problem, so return &quot;No&quot;.
	fiReportMetaData = iNo
End Function


Function fiReportOnlineRequest() As Integer
	&apos; The function returns 6 if you click &quot;Yes&quot;, 7 if you
	&apos; click &quot;No&quot;, and 2 if you click Cancel
	&apos;
	Dim iYes As Integer
	Dim iNo As Integer
	Dim iCancel As Integer
	Dim iYesNo As Integer
	Dim iYesNoCancel As Integer
	Dim sA As String
	Dim CR As String
	Dim n As Integer
	
	On Error Goto fiReportOnlineRequestErr
	iYes = 6
	iNo = 7
	iCancel = 2
	iYesNo = 1
	iYesNoCancel = 3
	n = iYes
	CR = Chr(10)
	sA = &quot;&quot; &amp; _
	fsLookUpTerm(&quot;s_use-a-web-application&quot;) &amp; _
	&quot; - &quot; &amp; _
	fsLookUpTerm(&quot;s_ok&quot;) &amp; _
	&quot; ? &quot;
	fiReportOnlineRequest = MsgBox(sA, _
	iYesNoCancel, _
	fsLookUpTerm(&quot;s_read-text&quot;))
	Exit Function
	fiReportOnlineRequestErr:
	fiReportOnlineRequest = iNo
End Function


Function fbHelpIsInstalled() As Boolean
	Dim sA As String
	
	sA = fsPathSettings(&quot;Help&quot;) &amp; &quot;/&quot;
	If FileExists(sA &amp; fsGetLanguage()) Then
		fbHelpIsInstalled = True
	ElseIf FileExists(sA &amp; &quot;en&quot;) Then
		fbHelpIsInstalled = True
	ElseIf FileExists(sA &amp; &quot;fr&quot;) Then
		fbHelpIsInstalled = True
	ElseIf FileExists(sA &amp; &quot;de&quot;) Then
		fbHelpIsInstalled = True
	Else
		fbHelpIsInstalled = False
	End If
End Function


Function soundsDirectory() As String
	&apos;This function returns the application sound gallery location
	Dim strA As String
	Dim intA As Integer
	
	strA = fsPathSettings(&quot;Gallery&quot;)
	intA = InStr(strA,&quot;;&quot;)
	If intA &lt;&gt; 0 Then
		strA = Left(strA,intA - 1)
		&apos; We do not want the semi-colon or the string that follows it
	End If
	soundsDirectory = ConvertFromUrl(strA &amp; &quot;/sounds/&quot;)
End Function


Function fbEnhancedRTVersion() As Boolean
	&apos; A variant of the Read Text Extension enables smart text
	&apos; and includes a help file for Tools - Add-ons - Impress-view.
	fbEnhancedRTVersion = FileExists(fsMyURL() &amp; _
	&quot;/help/en/&quot; &amp; _
	fsAppSignature() &amp; _
	&quot;/impress_view.xhp&quot;)
End Function


Function fsGetTextSelection( _
	bHideMDCode As Boolean, _
	bgoRight As Boolean) As String
	&apos; Check whether extension should use fsGetSmartTextSelection or
	&apos; fsGetOnlySelectedText.  The fsGetSmartTextSelection tries more
	&apos; strategies to determine the selected text and can automatically
	&apos; update the position of the text cursor to the next paragraph as
	&apos; it reads.  In Impress, it will read the note or the text of the 
	&apos; screen if no text is selected.
	&apos;
	If fbUsingTouchScreen() Or _
		ThisComponent.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		fsGetTextSelection = fsGetSmartTextSelection(bHideMDCode, bgoRight)
	Else
		fsGetTextSelection = fsGetOnlySelectedText()
	End If
End Function


Function fsGetOnlySelectedText() As String
	Dim oDoc   As Object
	Dim oSelection As Object
	Dim sSelectedText As String
	Dim n As Integer
	On Error Goto fsGetOnlySelectedTextErr
	oDoc = thisComponent
	If oDoc.SupportsService(&quot;com.sun.star.sheet.SpreadsheetDocument&quot;) Then
		sSelectedText = fsRetrieveCalcActiveCellText()
	ElseIf oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		sSelectedText = fsDrawText()
	ElseIf oDoc.supportsService(&quot;com.sun.star.drawing.DrawingDocument&quot;) Then
		sSelectedText = fsDrawText()
	ElseIf oDoc.supportsService(&quot;com.sun.star.text.TextDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.text.WebDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.text.globalDocument&quot;) Then
		oSelection = oDoc.getCurrentSelection()
		sSelectedText = &quot;&quot;
		If oSelection.supportsService(&quot;com.sun.star.text.TextRanges&quot;) Then
			For n = 0 To (oSelection.getCount() - 1)
				sSelectedText = sSelectedText &amp; _
				&quot; &quot; &amp; _
				oSelection.getByIndex(n).getString()
			Next
		Else
			sSelectedText = oSelection.getByIndex(0).getString()
		End If
		If sSelectedText = &quot; &quot; Then
			sSelectedText = fsgetCursorWord(True)
		End If
	Else &apos;unsupported document format
		sSelectedText = &quot;&quot;
	End If
	fsGetOnlySelectedText = Trim(sSelectedText)
	Exit Function
	fsGetOnlySelectedTextErr:
	
	fsGetOnlySelectedText = &quot;&quot;
End Function


Function fsGetSmartTextSelection( _
	ByVal bHideMDCode As Boolean, _
	ByVal bgoRight As Boolean) As String
	&apos; for audio presentations we lightly clean [Markdown][1] code.
	&apos; (Imagine a computer voice saying &quot;equals&quot; 79 times in a row.)
	&apos; for visual presentation, we can show it.
	&apos; [1]: https://daringfireball.net/projects/markdown/
	Dim oDoc As Object
	Dim oSelection As Object
	Dim sSelectedText As String
	Dim n As Integer
	
	On Error Goto fsGetSmartTextSelectionErr
	
	oDoc = thisComponent
	If oDoc.SupportsService(&quot;com.sun.star.sheet.SpreadsheetDocument&quot;) Then
		sSelectedText = fsRetrieveCalcActiveCellText()
	ElseIf oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.drawing.DrawingDocument&quot;) Then
		sSelectedText = fsDrawText()
		If sSelectedText = &quot;&quot; Then
			&apos; if no text is selected, read the text of the note
			&apos; This is to allow you to provide text for pictures
			&apos; and graphs that don&apos;t translate directly into audio.
			sSelectedText = fsGetSlidenote(bHideMDCode)
			If sSelectedText = &quot;&quot; Then
				&apos; Read the text of the slide
				sSelectedText = fsSlidePlainText()
			End If
		End If
	ElseIf oDoc.supportsService(&quot;com.sun.star.text.TextDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.text.WebDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.text.globalDocument&quot;) Then
		oSelection = oDoc.getCurrentSelection()
		sSelectedText = &quot;&quot;
		If oSelection.supportsService(&quot;com.sun.star.text.TextRanges&quot;) Then
			fsGetSelectionAndCopy()
			For n = 0 To (oSelection.getCount() - 1)
				sSelectedText = sSelectedText &amp; &quot; &quot; &amp; oSelection.getByIndex(n).getString()
			Next
		Else
			sSelectedText = fsGetSelectionAndCopy()
		End If
		If sSelectedText = &quot; &quot; Then
			If bgoRight Then
				sSelectedText = fsGetTextSelectiontoend(True)
				fbGoRight
			End If
		End If
	Else &apos; unsupported document format
		sSelectedText = &quot;&quot;
	End If
	
	If fbCreatingMediaFile(&quot;.aif,.aiff,.ogg,.m4a,.mp3&quot;) Then
		&apos; Gapless music players make sentences run into each other.
		&apos; Insert a brief pause at the end of the recording.
		sSelectedText = Trim(sSelectedText)
	End If
	fsGetSmartTextSelection = sSelectedText
	Exit Function
	fsGetSmartTextSelectionErr:
	
	fsGetSmartTextSelection = &quot;&quot;
End Function


Function fsgetTextSelectiontoend( _
	bAsPara As Boolean) As String
	Dim sA As String
	Dim sB As String
	
	On Error Resume Next
	
	If bAsPara Then
		sA = fsSupertrim(fsgetCursorWord(False), &quot;&quot;)
		fbSelecttoendofParagraph()
		SetWorkingCountryLanguage()
		sB = fsGetSelectionAndCopy()
		If Len(sA) = 0 Then
			fbGoLeft()
		End If
	Else
		fbSelecttoendofDoc()
		sB = fsGetSelectionAndCopy()
	End If
	fsgetTextSelectiontoend = sB
	
	Exit Function
	fsgetTextSelectiontoendErr
	
	fsgetTextSelectiontoend = &quot;&quot;
End Function


Function fsgetCursorWord( _
	bSelectWord As Boolean) As String
	&apos; function to get a word under the current cursor position.
	&apos; Adapted from code contributed On 2009-04-25  by JohnV To 
	&apos; http://www.oooforum.org/
	Dim oDoc
	Dim oTC
	Dim oTCtring
	Dim oVC
	oDoc = ThisComponent
	oVC = oDoc.getCurrentController.getViewCursor
	oTC = oDoc.getText.createTextCursorByRange(oVC,False)
	oTC.gotoendOfWord(False)
	oTC.gotoStartOfWord(True)
	fsgetCursorWord = oTC.String
	If bSelectWord Then
		selectAWord()
	End If
End Function


Function fsGetSelectionAndCopy() As String
	&apos;We copy to the clipboard, then return the clipboard contents as text. 
	&apos;The clipboard contents can be used for external tools for the disabled that use
	&apos;the clipboard. Examples include Braille pads or pictographic symbol displays.
	Dim document   As object
	Dim dispatcher As object
	
	document = ThisComponent.CurrentController.Frame
	dispatcher = createUnoService(&quot;com.sun.star.frame.DispatchHelper&quot;)
	dispatcher.executeDispatch(document, &quot;.uno:Copy&quot;, &quot;&quot;, 0, Array())
	fsGetSelectionAndCopy = fsGetClipBoard(False)
End Function


Function fbGoRight() As Boolean
	fbGoRight = fbGoToMark(&quot;right&quot;)
End Function


Function gotoend() As Boolean
	gotoend = fbGoToMark(&quot;end&quot;)
End Function


Function fbGoLeft() As Boolean
	fbGoLeft = fbGoToMark(&quot;left&quot;)
End Function


Function fbSelecttoendofParagraph() As Boolean
	fbSelecttoendofParagraph = fbGoToMark(&quot;paragraphselect&quot;)
End Function


Function fbSelecttoendofDoc() As Boolean
	fbSelecttoendofDoc = fbGoToMark(&quot;endselect&quot;)
End Function


Function fbGoToMark(MarkType) As Boolean
	Dim document   As object
	Dim dispatcher As object
	Dim args1(1) As New com.sun.star.beans.PropertyValue
	
	On Error Goto fbGoToMarkErr
	document = ThisComponent.CurrentController.Frame
	dispatcher = createUnoService(&quot;com.sun.star.frame.DispatchHelper&quot;)
	args1(0).Name = &quot;Count&quot;
	args1(0).Value = 1
	args1(1).Name = &quot;Select&quot;
	args1(1).Value = &quot;False&quot;
	Select Case LCase(MarkType)
		Case &quot;left&quot;
		dispatcher.executeDispatch(document, &quot;.uno:GoLeft&quot;, &quot;&quot;, 0, args1())
		Case &quot;right&quot;
		dispatcher.executeDispatch(document, &quot;.uno:GoRight&quot;, &quot;&quot;, 0, args1())
		Case &quot;paragraphselect&quot;
		dispatcher.executeDispatch(document, &quot;.uno:endOfParaSel&quot;, &quot;&quot;, 0, Array())
		Case &quot;endselect&quot;
		dispatcher.executeDispatch(document, &quot;.uno:GoToPrevWord&quot;, &quot;&quot;, 0, Array())
		dispatcher.executeDispatch(document, &quot;.uno:endOfDocumentSel&quot;, &quot;&quot;, 0, Array())
		Case Else  &apos; &quot;end&quot;
		dispatcher.executeDispatch(document, &quot;.uno:GoToendOfDoc&quot;, &quot;&quot;, 0, Array())
	End Select
	fbGoToMark = True
	Exit Function
	fbGoToMarkErr:
	
	fbGoToMark = False
End Function


Function fbClipBoardAvailable() As Boolean
	&apos; if program has crashed or is a version known to 
	&apos; crash when reading the clipboard, provide
	&apos; an alternative to reading the clipboard directly.
	On Error Goto fbClipBoardAvailableErr
	fbClipBoardAvailable = fbOfficeSupports(_
	&quot;com.sun.star.datatransfer.clipboard.SystemClipboard&quot;)
	If FileExists(fsFullPathOf(&quot;ReadClipBoard.lock&quot;)) Then
		fbClipBoardAvailable = False
	End If
	If fbIsWin64Program() And _
		fsGetSetting( _
		&quot;oosetupversion&quot;) = &quot;5.0&quot; And _
		fbIsLibreOffice() Then
		fbClipBoardAvailable = False
	End If
	Exit Function
	fbClipBoardAvailableErr:
	fbClipBoardAvailable = False
End Function


Function fbOfficeSupports( _
	ByVal s1) As Boolean
	&apos; Based on code listing 3 on page 173 of 
	&apos; Pitonyak, Andrew.  *OpenOffice Macros Explained*. Milwaukee, Hentzenwerke, 2004.
	&apos; ISBN:9781930919518
	Dim b1
	b1 = False
	Dim vManager
	Dim a1
	Dim i#
	vManager = GetProcessServiceManager()
	a1 = vManager.getAvailableServiceNames()
	For i = LBound(a1) To UBound(a1)
		If a1(i) = s1 Then
			b1 = True
			Exit For
		End If
	Next
	fbOfficeSupports = b1
End Function


Function fsGetClipBoard( _
	ByVal bSuggest As Boolean) As String
	&apos; if bSuggest is true, then show inputbox prompt if the clipboard
	&apos; does not contain text data.
	&apos;
	&apos; Based On listing Listing 5.64: View the clipboard As text.
	&apos; by Andrew Pitonyak at http://www.pitonyak.org/AndrewMacro.odt 
	&apos; October 28,2010
	&apos;
	
	fsGetClipBoard = &quot;&quot;
	Dim mimetype$
	mimetype = &quot;text/plain;charset=utf-16&quot;
	If Not(fbClipBoardAvailable()) Then
		fsGetClipBoard = &quot;&quot;
		Exit Function
	End If
	
	Dim oClip As Variant
	Dim oTypes As Variant
	Dim oClipContents As Variant
	Dim oConverter As Variant
	Dim convertedString$
	convertedString = &quot;&quot;
	Dim i%
	i = 0
	Dim iPlainLoc%
	iPlainLoc =  - 1
	Dim s$
	s$ = &quot;com.sun.star.datatransfer.clipboard.SystemClipboard&quot;
	On Error Goto fsGetClipBoardErr
	oClip = createUnoService(s$)
	oConverter = createUnoService(&quot;com.sun.star.script.Converter&quot;)
	&apos;Print &quot;Clipboard name=&quot; &amp; oClip.getName()
	&apos;Print &quot;Implementation name=&quot; &amp; oClip.getImplementationName()
	oClipContents = oClip.getContents()
	oTypes = oClipContents.getTransferDataFlavors()
	
	For i = LBound(oTypes) To UBound(oTypes)
		If oTypes(i).MimeType = mimetype Then
			iPlainLoc = i
			Exit For
		End If
	Next
	
	If(iPlainLoc &gt;= 0) Then
		convertedString = oConverter.convertToSimpleType( _
		oClipContents.getTransferData(oTypes(iPlainLoc)), _
		com.sun.star.uno.TypeClass.ANY)
		fsGetClipBoard = convertedString
	Else
		If bSuggest Then
			fsGetClipBoard = InputBox( _
			fsLookUpTerm( _
			fsSelectionLanguage()), _
			fsLookUpTerm( _
			&quot;s_read-text&quot;), _
			&quot; &quot;)
		End If
	End If
	Exit Function
	fsGetClipBoardErr:
	fsGetClipBoard = &quot;&quot;
End Function


Function WinSpeechProgramPath() As String
	&apos; 2023-07-22
	&apos; Always default to wscript.
	&apos; The dialog shows all compatible SAPI5 voices
	&apos; SAPI5 can&apos;t use Microsoft Speech Server voices
	WinSpeechProgramPath = &quot;&quot;
	Dim sub_path As Variant : sub_path = faWindowsTestArray()
	Dim _app As Variant : _app = Array(&quot;\wscript.exe&quot;, &quot;\cscript.exe&quot;)
	Dim s2$ : s2 = fsHomeDrive()
	Dim x As Integer
	Dim y As Integer
	For y = Lbound(_app) to Ubound(_app)
		For x = Lbound(sub_path) To Ubound(sub_path)
			If FileExists(s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; _app(y)) Then
				WinSpeechProgramPath = s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; _app(y)
					Exit Function
			End If
		Next
	Next
End Function


Function WinSpeechArgument() As String
	&apos;OOo for Windows always default to wscript.exe
	Dim s1 As String
	s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	WinSpeechArgument = s1
End Function


Function fbWindowsHasAnInternationalVoice( _
	ByVal bShow, _
	ByVal sSearch) As Boolean
	&apos; if only US English voices are installed, don&apos;t show multilingual option
	&apos; optional search term - search by a specific language or region
	&apos;    if fbWindowsHasAnInternationalVoice (False, &quot;United States&quot;) then
	&apos;         &apos; We have another country&apos;s voice
	&apos;        Do stuff
	&apos;    end if
	Dim b1 As Boolean
	Dim n As Integer
	Dim s1 As String
	Dim s2 As String
	Dim cr As String
	
	s2 = &quot;&quot;
	cr = Chr(10)
	On Error Goto fbWindowsHasAnInternationalVoiceErr
	b1 = True
	If fsGetOS = &quot;WINDOWS&quot; Then
		Dim sapi As Object
		Set Sapi = CreateObject(&quot;Sapi.SpVoice&quot;)
		b1 = False
		For n = 0 To Sapi.GetVoices.Count - 1
			s1 = (Sapi.GetVoices.Item(n).GetDescription)
			s2 = s2 &amp; s1 &amp; cr
			s1 = LCase(s1)
			If InStr(s1, &quot;microsoft sam&quot;) &lt;&gt; 0 Then
				Exit For
			ElseIf InStr(s1, LCase(sSearch)) = 0 Then
				&apos; We found a non-matching voice
				b1 = True
				If Not(bShow) Then
					Exit For
				End If
			End If
		Next
		If bShow Then
			MsgBox(s2, _
			0, _
			fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
			&quot; &quot; &amp; _
			fsLookUpTerm(&quot;s_test&quot;) &amp; _
			&quot; - &quot; &amp; _
			b1)
		End If
	End If
	fbWindowsHasAnInternationalVoice = b1
	Exit Function
	fbWindowsHasAnInternationalVoiceErr:
	
	fbWindowsHasAnInternationalVoice = False
End Function


Sub dialog1Combo2ShowSAPIChoices( _
	oDialog)
&apos; Windows dialogue
	Dim Sapi As Object
	Dim n As Integer
	Dim aLineOfText As String,myScriptPath As String
	Dim n1 As Integer,s1 As String,oComboBox As Variant
	Dim sProgram As String,myTextPath As String
	Dim s2 As String
	Dim sSelectionLangCountryTag, sSelectionLanguageTag As String
	Dim bNoMp3Tool As Boolean
	Dim bHaveVLC As Boolean
	Dim bHaveFfmpeg As Boolean
    bNoMp3Tool = True
	bHaveVLC = fbHaveVLC()
	bHaveFfmpeg = fbHaveFfmpeg()
	Set Sapi = CreateObject(&quot;Sapi.SpVoice&quot;)
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n1 = oComboBox.getItemCount()
	oComboBox.removeItems(0, n1)
	n = 0
	If fbWindowsHasAnInternationalVoice(False, &quot;united states&quot;) Then
		sSelectionLangCountryTag = &quot; /language:&quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot;
		sSelectionLanguageTag = &quot;(SELECTION_LANGUAGE_CODE)&quot;
	Else
		sSelectionLangCountryTag = &quot; /language:&quot;&quot;en-US&quot;&quot;&quot;
		sSelectionLanguageTag = &quot;en&quot;
	End If

	While n &lt; Sapi.GetVoices.Count
		s1 = Sapi.GetVoices.Item(n).GetDescription
		For n1 = 10 To - 10 step - 2
			oComboBox.addItem( &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
			&quot; /voice:&quot;&quot;&quot; &amp; s1 &amp; &quot;&quot;&quot; /rate:&quot; &amp; Trim(n1) &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;,0)
		Next
		n = n + 1
	WEnd
	On Error Goto FichierKO
	For n1 = 10 To - 10 step - 2
		oComboBox.addItem( &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /rate:&quot; &amp; Trim(n1) &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;,0)
	Next

	If bHaveVLC Then
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).opus&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	End If

	If fbHaveOgg() Or bHaveFfmpeg Or bHaveVLC Then
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).ogg&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	End If

	If bHaveFfmpeg Or fbHaveLame() Then
		bNoMp3Tool = False
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).mp3&quot;&quot;&quot; &amp; _
		&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	ElseIf bHaveVLC And Not fbHaveItunes() Then
		bNoMp3Tool = False
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).mp3&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	End If

	If fbHaveNeroEnc() And fbHaveNeroTag() Then
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).m4a&quot;&quot;&quot; &amp; _
		&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	ElseIf fbHaveNeroEnc() Then
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).m4a&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	End If

	If fbHaveFlac() Then
		s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
		sSelectionLangCountryTag &amp; _
		&quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot; &amp; _
		&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).flac&quot;&quot;&quot; &amp; _
		&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
		&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		oComboBox.addItem(s1, 0)
	End If

	If bNoMp3Tool Then
		If fbHaveItunes() Then
			&apos; We can use iTunes to embed metadata and an album cover.
			&apos; [iTunes][1] makes the file in it&apos;s own directory and indexes it. We
			&apos; copy the file to our sound directory. You can delete either copy
			&apos; if you don&apos;t need one, but if speed is important, and you don&apos;t
			&apos; want a copy every time use [Nero m4a encoder][2]
			&apos; [1]: https://www.apple.com/itunes/
			&apos; [2]: https://www.nero.com/
			bNoMp3Tool = False
			s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
			sSelectionLangCountryTag &amp; _
			&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
			&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).aif&quot;&quot;&quot; &amp; _
			&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			oComboBox.addItem(s1, 0)
			s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
			sSelectionLangCountryTag &amp; _
			&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
			&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).mp3&quot;&quot;&quot; &amp; _
			&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			oComboBox.addItem(s1, 0)
			s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
			sSelectionLangCountryTag &amp; _
			&quot; /imagefile:&quot;&quot;(POSTER_IMG)&quot;&quot;&quot; &amp; _
			&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).m4a&quot;&quot;&quot; &amp; _
			&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			oComboBox.addItem(s1, 0)
		End If
	End If
	s2 = &quot;&quot;
	If bHaveVLC Then
		s2 = &quot; /use-optional-app:&quot;&quot;True&quot;&quot;&quot;
	End If
	s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
	sSelectionLangCountryTag &amp; _
	s2 &amp; _
	&quot; /soundfile:&quot;&quot;(HOME)&quot; &amp; sSelectionLanguageTag &amp; &quot;\(NOW).wav&quot;&quot;&quot; &amp; _
	&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1, 0)
	s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot; /visible:&quot;&quot;True&quot;&quot;&quot; &amp; _
	sSelectionLangCountryTag &amp; _
	&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1, 0)
	s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
	sSelectionLangCountryTag &amp; _
	&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1, 0)
	&apos; do not specify the language for the top item.
	s1 = &quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot; &amp; _
	&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1, 0)
	fbRemoveFile(myTextPath)
	Exit Sub
	FichierKO:
	Resume FichierKO2
	FichierKO2:
	On Error Resume Next
End Sub


Function fsMacVoice( _
	ByVal n, _
	ByVal s2) As String
	Dim s1 As String
	Dim a1
	fsMacVoice = &quot;&quot;
	Select Case s2
		Case &quot;ar-SA&quot;
		s1 = &quot;Tarik,Maged&quot;
		Case &quot;cs-CZ&quot;
		s1 = &quot;Zuzana&quot;
		Case &quot;da-DK&quot;
		s1 = &quot;Sara&quot;
		Case &quot;de-DE&quot;,&quot;de-AT&quot;,&quot;de-CH&quot;,&quot;de-LU&quot;,&quot;de-LI&quot;,&quot;de-BE&quot;
		s1 = &quot;Anna&quot;
		Case &quot;el-GR&quot;
		s1 = &quot;Melina&quot;
		Case &quot;en-AU&quot;,&quot;en-NZ&quot;
		s1 = &quot;Lee,Karen&quot;
		Case &quot;en-GB&quot;,&quot;en-BD&quot;,&quot;en-BS&quot;,&quot;en-GH&quot;,&quot;en-HK&quot;,&quot;en-JM&quot;,&quot;en-TT&quot;
		s1 = &quot;Daniel&quot;
		Case &quot;en-IE&quot;
		s1 = &quot;Moira&quot;
		Case &quot;en-IN&quot;,&quot;en-PK&quot;
		s1 = &quot;Veena&quot;
		Case &quot;en-US&quot;, &quot;en-CA&quot;
		s1 = &quot;Victoria,Samantha,Fred,Alex&quot;
		Case &quot;en-ZA&quot;
		s1 = &quot;Tessa&quot;
		Case &quot;es-AR&quot;
		s1 = &quot;Diego&quot;
		Case &quot;es-ES&quot;
		s1 = &quot;Monica,Jorge&quot;
		Case &quot;es-MX&quot;
		s1 = &quot;Paulina,Juan&quot;
		Case &quot;fi-FI&quot;
		s1 = &quot;Satu&quot;
		Case &quot;fr-CA&quot;
		s1 = &quot;Amelie&quot;
		Case &quot;fr-FR&quot;,&quot;fr-BE&quot;
		s1 = &quot;Thomas&quot;
		Case &quot;he-IL&quot;
		s1 = &quot;Carmit&quot;
		Case &quot;hi-IN&quot;
		s1 = &quot;Lekha&quot;
		Case &quot;hu-HU&quot;
		s1 = &quot;Mariska&quot;
		Case &quot;id-ID&quot;
		s1 = &quot;Damayanti&quot;
		Case &quot;it-IT&quot;
		s1 = &quot;Luca,Alice&quot;
		Case &quot;ja-JP&quot;
		s1 = &quot;Kyoko&quot;
		Case &quot;ko-KR&quot;, &quot;ko-KP&quot;
		s1 = &quot;Yuna&quot;
		Case &quot;nb-NO&quot;
		s1 = &quot;Nora&quot;
		Case &quot;nl-BE&quot;
		s1 = &quot;Ellen&quot;
		Case &quot;nl-NL&quot;
		s1 = &quot;Xander&quot;
		Case &quot;pl-PL&quot;
		s1 = &quot;Zosia&quot;
		Case &quot;pt-BR&quot;
		s1 = &quot;Luciana&quot;
		Case &quot;pt-PT&quot;
		s1 = &quot;Joana&quot;
		Case &quot;ro-RO&quot;
		s1 = &quot;Ioana&quot;
		Case &quot;ru-RU&quot;
		s1 = &quot;Milena&quot;
		Case &quot;sk-SK&quot;
		s1 = &quot;Laura&quot;
		Case &quot;sv-SE&quot;
		s1 = &quot;Alva&quot;
		Case &quot;th-TH&quot;
		s1 = &quot;Kanya&quot;
		Case &quot;tr-TR&quot;
		s1 = &quot;Yelda&quot;
		Case &quot;zh-CN&quot;
		s1 = &quot;Ting-Ting&quot;
		Case &quot;zh-HK&quot;
		s1 = &quot;Sin-ji&quot;
		Case &quot;zh-TW&quot;
		s1 = &quot;Ya-Ling,Mei-Jia&quot;
		Case Else
		s1 = Join( _
		Array( _
		&quot;Victoria&quot;, _
		&quot;Veena&quot;, _
		&quot;Tessa&quot;, _
		&quot;Samantha&quot;, _
		&quot;Rishi&quot;, _
		&quot;Moira&quot;, _
		&quot;Karen&quot;, _
		&quot;Fred&quot;, _
		&quot;Daniel&quot;, _
		&quot;Alex&quot;), _
		&quot;,&quot;)
	End Select
	s1 = s1 &amp; &quot;,,&quot;
	a1 = Split(s1, &quot;,&quot;)
	If n &lt;= UBound(a1) Then
		fsMacVoice = a1(n)
	End If
End Function


Sub dialog1Combo2ShowSAYChoices( _
	oDialog)
&apos; Apple MacOS
	Dim n, o As Integer
	Dim s1 As String
	Dim oComboBox As Variant
	Dim aA
	Dim selection_IsoLang$
	selection_IsoLang = fsSelectionLanguageAndRegion(True)
	Select Case fsGetMyTunesApp()
		Case &quot;iTunes&quot;
		aA = Array(&quot;.m4a&quot;,&quot;.aif&quot;)
		Case &quot;Music&quot;
		aA = Array(&quot;.aif&quot;)
		Case Else
		&apos; Todo : Check if app is called &quot;Music&quot; in other languages
		&apos; When you use a script to invoke a program you will
		&apos; need to approve script access to the program. Or,
		&apos; if you don&apos;t trust the script you can also
		&apos; use VideoLan VLC or invoke the MacOS **Create MP3** 
		&apos; Automator Music Quick Action to compress AIFF files. 
		&apos; The Automator Music Quick Action workflow only
		&apos; supports compressing from AIFF, CAFF and WAV
		&apos; audio files. You can select a level of compression
		&apos; but you cannot change the metadata.
		aA = Array(&quot;.aif&quot;)
	End Select
	
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n = oComboBox.getItemCount()
	oComboBox.removeItems(0,n)
	
	If Not b_CaBcVancouverHolgateJamesReadtextextensionHideExports Then
		For n = LBound(aA) To UBound(aA)
			s1 = &quot; -f &quot;&quot;(TMP)&quot;&quot;&quot; &amp; &quot;-o &quot;&quot;(HOME)(NOW)&quot; &amp; aA(n) &amp; &quot;&quot;&quot;&quot;
			oComboBox.addItem(s1,0)
		Next
	End If
	n = 0
	For n = 0 To 40
		If fsMacVoice(n, selection_IsoLang) = &quot;&quot; Then
			Exit For
		Else
			For o = LBound(aA) To UBound(aA)
				s1 = &quot;--voice &quot; &amp; _
				fsMacVoice(n, selection_IsoLang) &amp; _
				&quot; -f &quot;&quot;(TMP)&quot;&quot; -o &quot;&quot;(HOME)(NOW).&quot; &amp; _
				aA(o) &amp; _
				&quot;&quot;&quot;&quot;
				oComboBox.addItem(s1,0)
			Next
			s1 = &quot;--voice &quot; &amp; _
			fsMacVoice(n, selection_IsoLang) &amp; _
			&quot; -f &quot;&quot;(TMP)&quot;&quot;&quot;
			oComboBox.addItem(s1,0)
		End If
	Next
	s1 = &quot;-f &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
End Sub


Sub dialog1Combo2ShowAppleScriptChoices( _
	oDialog)
	&apos;Mac MacOS open or osascript
	Dim n As Integer
	Dim CR$
	CR = Chr$(10)
	Dim s1$
	s1 = &quot;&quot;
	Dim s2$
	s2 = &quot;&quot;
	Dim a1, a2
	Dim oComboBox As Variant
	
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	n = oComboBox.getItemCount()
	oComboBox.removeItems( 0,n)
	Select Case b_CaBcVancouverHolgateJamesReadtextextensionHideExports
		Case False
		Select Case fsGetMyTunesApp()
			Case &quot;Music&quot;
			&apos; 2021-12 MacOS 12.01 (Monterey)
			&apos; .m4a opens in third party apps like VideoLan VLC, but not
			&apos; the native MacOS 11 Music or Quicktime player programs.
			If Not fbHaveVLC() Then
				s2 = &quot;.aif,.mp3&quot;
			Else
				
				s2 = &quot;.opus,.ogg,.aif,.mp3&quot;
			End If
			Case &quot;iTunes&quot;
			&apos; MacOS 10.13.6 and iTunes 12.8.3.1
			&apos; .mp3 -- no metadata
			If fbHaveVLC() Then
				s2 = &quot;.aif,.m4a&quot;
			Else
				s2 = &quot;.opus,.ogg,.aif,.mp3,.m4a&quot;
			End If
			Case &quot;VLC&quot;
			&apos; The VLC script does not add any metadata to
			&apos; the exported file.
			s2 = &quot;.opus,.ogg,.mp3&quot;
			Case Else
			&apos; Unknown or missing audio helper program
			s2 = &quot;.aif&quot;
		End Select
		a2 = Split(s2, &quot;,&quot;)
		s1 = &quot;_SYSTEM_VOICE)&quot;&quot;&quot; &amp; CR
		For n = LBound(a2) To UBound(a2)
			s1 = s1 &amp; &quot;_SYSTEM_VOICE)&quot;&quot; &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; a2(n) &amp; _
			&quot;&quot;&quot;&quot; &amp; CR &amp; _
			&quot;_QUICKLY)&quot;&quot; &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; a2(n) &amp; &quot;&quot;&quot;&quot; &amp; CR &amp; _
			&quot;_SLOWLY)&quot;&quot; &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; a2(n) &amp; &quot;&quot;&quot;&quot; &amp; CR &amp; _
			&quot;)&quot;&quot; &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; a2(n) &amp; &quot;&quot;&quot;&quot; &amp; CR
		Next
		Case Else
		s1 = &quot;&quot;
		s2 = &quot;&quot;
	End Select
	
	s1 = s1 &amp; &quot;_SYSTEM_VOICE)&quot;&quot;&quot; &amp; CR &amp; _
	&quot;_SLOWLY)&quot;&quot;&quot; &amp; CR &amp; _
	&quot;_QUICKLY)&quot;&quot;&quot; &amp; CR &amp; _
	&quot;)&quot;&quot;&quot;
	a1 = Split(s1,CR)
	For n = LBound(a1) To UBound(a1)
		oComboBox.addItem(&quot;&quot;&quot;(SAY_APPLESCRIPT&quot; &amp; a1(n),0)
	Next
End Sub


Sub dialog1Combo2ShowESPEAKChoices( _
	oDialog)
	&apos;espeak
	Dim n As Integer
	Dim s1 As String
	Dim s2(3) As String
	Dim s3 As String
	Dim s4 As String
	Dim n2 As Integer
	Dim oComboBox As Variant
	Dim sLanguage As String
	
	sLanguage = LCase(fsGetLanguage())
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n = oComboBox.getItemCount()
	oComboBox.removeItems(0,n)
	s3 = &quot;&quot;
	s2(0) = &quot; -b 1 -s 130 -f &apos;(TMP)&apos; -w &apos;(HOME)(NOW).wav&apos;&quot;
	s2(1) = &quot; -b 1 -f &apos;(TMP)&apos; -w &apos;(HOME)(NOW).wav&apos;&quot;
	s2(2) = &quot; -b 1 -s 130 -f &apos;(TMP)&apos;&quot;
	s2(3) = &quot; -b 1 -f &apos;(TMP)&apos;&quot;
	For n = 0 To 3
		&apos;English
		s1 = s3 &amp; &quot;-v en-us&quot; &amp; s2(n)
		oComboBox.addItem(s1,0)
		s1 = s3 &amp; &quot;-v en&quot; &amp; s2(n)
		oComboBox.addItem(s1,0)
		Select Case sLanguage
			Case &quot;es&quot;
			s1 = s3 &amp; &quot;-v es-mx&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			s1 = s3 &amp; &quot;-v es-la&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			s1 = s3 &amp; &quot;-v es&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case &quot;fr&quot;
			s1 = s3 &amp; &quot;-v fr-be&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			s1 = s3 &amp; &quot;-v fr&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case &quot;nb&quot;,&quot;nn&quot;,&quot;no&quot;
			&apos; Norway
			s1 = s3 &amp; &quot;-v no&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case &quot;pt&quot;
			&apos; Portugal And Brazil
			s1 = s3 &amp; &quot;-v pt-pt&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			s1 = s3 &amp; &quot;-v pt&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case &quot;zh&quot;
			s1 = s3 &amp; &quot;-v zh-yue&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			s1 = s3 &amp; &quot;-v zh&quot; &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case &quot;af&quot;,&quot;bs&quot;,&quot;ca&quot;,&quot;cs&quot;,&quot;cy&quot;,&quot;da&quot;,&quot;de&quot;,&quot;el&quot;,&quot;eo&quot;,&quot;fi&quot;,&quot;hi&quot;,&quot;hr&quot;,&quot;hu&quot;, _
			&quot;hy&quot;,&quot;id&quot;,&quot;is&quot;,&quot;it&quot;,&quot;ku&quot;,&quot;la&quot;,&quot;lv&quot;,&quot;mk&quot;,&quot;nl&quot;,&quot;pl&quot;,&quot;ro&quot;,&quot;ru&quot;,&quot;sk&quot;,&quot;sq&quot;, _
			&quot;sr&quot;,&quot;sv&quot;,&quot;sw&quot;,&quot;ta&quot;,&quot;tr&quot;,&quot;vi&quot;
			s1 = s3 &amp; &quot;-v &quot; &amp; sLanguage &amp; s2(n)
			oComboBox.addItem(s1,0)
			Case Else
		End Select
		If FileExists(&quot;/usr/bin/mbrola&quot;) Or _
			FileExists(fsProgramDirectory() &amp; &quot;eSpeak\espeak-data\mbrola\&quot;) Or _
			FileExists(fsProgramDirectoryx86() &amp; &quot;eSpeak\espeak-data\mbrola\&quot;) Then
			s1 = s3 &amp; &quot;-v mb-(SELECTION_LANGUAGE_CODE)1 &quot; &amp; s2(n)
			&apos;fsTTSListVoicesVBS            oComboBox.addItem(s1,0)
		End If
		For n2 = 0 To fiCountEspeakMbrolaLanguage()
			s4 = fsGetEspeakMbrolaLanguage(n2,1)
			If FileExists(&quot;/usr/share/mbrola/&quot; &amp; s4 &amp; &quot;/&quot; &amp; s4) Or _
				FileExists(&quot;/usr/local/share/mbrola/&quot; &amp; s4 &amp; &quot;/&quot; &amp; s4) Or _
				FileExists(&quot;/usr/share/mbrola/voices/&quot; &amp; s4) Or _
				FileExists(&quot;/usr/local/share/mbrola/voices/&quot; &amp; s4) Or _
				FileExists(fsProgramDirectory() &amp; &quot;eSpeak\espeak-data\mbrola\&quot; &amp; s4) Or _
				FileExists(fsProgramDirectoryx86() &amp; &quot;eSpeak\espeak-data\mbrola\&quot; &amp; s4) Then
				s1 = s3 &amp; &quot;-v mb-&quot; &amp; s4 &amp; &quot; &quot; &amp; s2(n)
				oComboBox.addItem(s1,0)
			End If
		Next
		s1 = s3 &amp; s2(n)
		oComboBox.addItem(s1,0)
	Next
End Sub


Sub dialog1Combo2ShowMEDIAChoices( _
	oDialog)
	&apos; Show some URLs
	Dim n1 As Integer
	Dim s1 As String
	Dim oComboBox As Variant
	
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n1 = oComboBox.getItemCount()
	oComboBox.removeItems(0, n1)

	s1 = &quot;https://translate.google.com/?sl=auto&amp;tl=(SELECTION_LANGUAGE_CODE)&amp;text=(OOO_WEBTEXTSMALL)&quot;
	oComboBox.addItem(s1, 0)
	s1 = &quot;https://translate.google.com/?sl=auto&amp;tl=(LANGUAGE_CODE)&amp;text=(OOO_WEBTEXTSMALL)&quot;
	oComboBox.addItem(s1, 0)
	If Len(fsLocalHostSpeech()) &lt;&gt; 0 Then
		oComboBox.addItem(fsLocalHostSpeech(), 0)
	End If
End Sub


Sub dialog1Combo2ShowFESTIVALChoices( _
	oDialog)
	&apos; Show some URLs
	Dim n1 As Integer
	Dim s1 As String
	Dim oComboBox As Variant
	
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n1 = oComboBox.getItemCount()
	oComboBox.removeItems( 0,n1)
	s1 = &quot;--language welsh --tts &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
	s1 = &quot;--language spanish --tts &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
	s1 = &quot;--language english --tts &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
	s1 = &quot;--tts &quot;&quot;(TMP)&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
End Sub


Sub dialog1Combo2ShowTEXT2WAVEChoices( _
	oDialog)
	&apos; Show this Festival script options
	Dim n1 As Integer
	Dim s1 As String
	Dim oComboBox As Variant
	
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	Rem first remove all old items from the list
	n1 = oComboBox.getItemCount()
	oComboBox.removeItems( 0,n1)
	s1 = &quot;&quot;&quot;(TMP)&quot;&quot; -otype snd -o &quot;&quot;(HOME)(NOW).wav&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
	s1 = &quot;&quot;&quot;(TMP)&quot;&quot; -o &quot;&quot;(HOME)(NOW).wav&quot;&quot;&quot;
	oComboBox.addItem(s1,0)
End Sub


Sub dialog1Combo1ShowFestivalScripts( _
	oDialog)
&apos; Linux
	Dim n As Integer
	Dim n2 As Integer
	Dim s1 As String
	Dim s2(5) As String
	Dim oComboBox As Variant
	
	Rem Get control
	oComboBox = oDialog.getControl(&quot;ComboBox1&quot;)
	Rem first remove all old items from the list
	n = oComboBox.getItemCount()
	oComboBox.removeItems(0, n)
	s2(5) = &quot;(audio_mode &apos;shutup)&quot;
	s2(4) = &quot;(audio_mode &apos;async)(tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	s2(3) = &quot;(SayText &quot;&quot;The selection says: &quot;&quot;)( tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	s2(2) = &quot;(SayText &quot;&quot;On (WEEKDAY), (DATE) at (TIME), (AUTHOR) said: &quot;&quot;)( tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	s2(1) = &quot;(set! utt1 (Utterance Phrase ((Phrase ((name B))The (selected ((EMPH 3)))text )(Phrase ((name BB)) says: ))))(utt.synth utt1)(utt.play utt1)(tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	If FileExists(soundsDirectory() &amp; &quot;apert.wav&quot;) Then
		s2(0) = &quot;(set! utt1 (Utterance Wave (SOUND_GALLERY)apert.wav))(utt.synth utt1)(utt.play utt1)(tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	Else
		s2(0) = &quot;(set! utt1 (Utterance Wave /usr/share/sounds/alsa/Noise.wav))(utt.synth utt1)(utt.play utt1)(tts &quot;&quot;(TMP)&quot;&quot; nil)(quit)&quot;
	End If
	For n2 = 0 To fiCountFestivalDirectory()
		For n = 0 To 4
			If FileExists(fsFestivalDirectory(n2)) Then
				If n = 4 Or InStr(fsFestivalDirectory(n2) ,&quot;english&quot;) &lt;&gt; 0 Then
					s1 = &quot;(voice_&quot; &amp; fsFestivalVoice(n2) &amp; &quot;)&quot;
					oComboBox.addItem(s1 &amp; s2(n),0)
				End If
			End If
		Next
	Next
	n = 5
	oComboBox.addItem(s2(n),0)
	n = 4
	oComboBox.addItem(s2(n),0)
End Sub


Function fiCountFestivalVoices() As Integer
	Dim n# : n = 0
	fiCountFestivalVoices = 0
	For n = 0 To fiCountFestivalDirectory()
		If FileExists(fsFestivalDirectory(n)) Then
			fiCountFestivalVoices = fiCountFestivalVoices + 1
		End If
	Next
End Function


Sub CheckComboBox4UrlList(oDialog)
	&apos; ComboBox4 should include a localhost address if a localhost
	&apos; speech service in a web browser is enabled.
	Dim sLocalHostSpeech$ : sLocalHostSpeech = fsLocalHostSpeech()
	If Len(sLocalHostSpeech) &lt;&gt; 0 Then
		Dim oComboBox As Variant : oComboBox = oDialog.getControl(&quot;ComboBox4&quot;)
		With oComboBox 
			.addItem(sLocalHostSpeech, 0)
		End With
	End If
End Sub


Function fiDialog1Combo2ShowMyPythonChoices( _
	oDialog) As Integer
	&apos; Python
	&apos; Show the python script options
	Dim n As Integer
	Dim n2 As Integer
	Dim s1 As String
	Dim _opts(10) As String
	Dim s3 As String
	Dim s4 As String
	Dim sLanguage As String
	Dim a1
	Dim CR As String
	Dim oComboBox As Variant
	Dim bIsAppImage As Boolean : bIsAppImage = False
	Dim bEnableLocalHostRate As Boolean : bEnableLocalHostRate = True
	Dim sGetOS As String : sGetOS = fsGetOS()
	If Len(fsAppImageResourcePath(&quot;python&quot;)) &lt;&gt; 0 Then bIsAppImage = True
	CR = Chr(10)
	s1 = CR
	s3 = &quot;&quot;
	s4 = &quot;&quot;
	Dim bEnableRate As Boolean
	bEnableRate = True
	sLanguage = LCase(fsGetLanguage())
	Dim sProg As String : sProg = &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot;&quot;
	Select Case sGetOS
		Case &quot;WINDOWS&quot; &apos; Show examples
		s1 = s1 &amp; CR &amp; &quot;-c &quot;&quot;import os; os.startfile(&apos;https://chart.apis.google.com/chart?chs=350x350&amp;cht=qr&amp;chl=(OOO_WEBTEXT)&apos;)&quot;&quot;&quot;
		s1 = s1 &amp; CR &amp; &quot;-c &quot;&quot;import os; os.startfile(&apos;https://translate.google.com/?sl=auto&amp;tl=(SELECTION_LANGUAGE_COUNTRY_CODE)&amp;q=(OOO_WEBTEXTSMALL)&apos;)&quot;&quot;&quot;
		Case &quot;MacOS&quot;
		&apos;pass
		Case Else
		bEnableRate = Len(fsMatchFestivalVoice(&quot;_hts&quot;)) = 0
	End Select
	oComboBox = oDialog.getControl(&quot;ComboBox2&quot;)
	n = oComboBox.getItemCount()
	oComboBox.removeItems(0,n)

	If fbIsSandboxed() Then
		&apos; https://www.dwds.de/wb/r/?q=(OOO_WEBTEXTDEFINITION)
		s1 = s1 &amp; CR &amp; &quot;-m webbrowser -t &quot;&quot;https://www.dwds.de/wb/r/?q=(OOO_WEBTEXTDEFINITION)&quot;&quot;&quot; &amp; CR &amp; _
		&quot;-m webbrowser -t &quot;&quot;https://chart.apis.google.com/chart?chs=350x350&amp;cht=qr&amp;chl=(OOO_WEBTEXT)&quot;&quot;&quot; &amp; CR &amp; _
		&quot;-m webbrowser -t &quot;&quot;https://www.google.com/search?hl=(SELECTION_LANGUAGE_COUNTRY_CODE)&amp;defl=(SELECTION_LANGUAGE_COUNTRY_CODE)&amp;q=define:(OOO_WEBTEXTDEFINITION)&quot;&quot;&quot; &amp; CR &amp; _
		&quot;-m webbrowser -t &quot;&quot;https://translate.google.com/?sl=auto&amp;tl=(LANGUAGE_CODE)&amp;text=(OOO_WEBTEXT)&quot;&quot;&quot;
	End If
	If fbHaveNetworkTTS() or isSnap() or isFlatPak() Then
		If fsGetOS() = &quot;UNIX&quot; Then
			bEnableLocalHostRate = fbEnableLocalHostRate()
			&apos; Include settings for [larynx-server](https://github.com/rhasspy/larynx)
			If bEnableLocalHostRate Then
				Redim _opts : _opts = Array(&quot;MALE3&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;)
			Else
				&apos; NOTE: Some tts models ignore gender; consider using neutral terms like &quot;VOICE1&quot;
				&apos; The disadvantage is that the labeling system would not match `speech-dispatcher`
				Redim _opts : _opts = Array(&quot;MALE6&quot;, &quot;MALE5&quot;, &quot;MALE4&quot;, &quot;MALE3&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;,_
				&quot;FEMALE6&quot;, &quot;FEMALE5&quot;, &quot;FEMALE4&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;)
			End If
			For n = Lbound(_opts) To Ubound(_opts)
				If bEnableLocalHostRate Then
					s4 = &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE) --rate &quot;&quot;70%&quot;&quot; --voice &quot;&quot;&quot; &amp; _opts(n) &amp; &quot;&quot;&quot;&quot;
					s1 = s1 &amp; fspyPlayOption(oDialog, s4)
				End If
				s4 = &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE) --voice &quot;&quot;&quot; &amp; _opts(n) &amp; &quot;&quot;&quot;&quot;
				s1 = s1 &amp; fspyPlayOption(oDialog, s4)
			Next
		End If
		If bEnableLocalHostRate Then
			s4 = &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE) --rate &quot;&quot;70%&quot;&quot;&quot;
			s1 = s1 &amp; fspyPlayOption(oDialog, s4)
		End If
        s4 = &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyPlayOption(oDialog, s4)
		If fbInPaths(&quot;larynx-server&quot;) Then
			s1 = s1 &amp; CR &amp; _
			&quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --visible True --language (SELECTION_LANGUAGE_CODE) &quot;&quot;(TMP)&quot;&quot;&quot; &amp; CR &amp; _
			&quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; --voice &quot;&quot;mary_ann&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		End If
		s1 = s1 &amp; CR &amp; _
		&quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		CheckComboBox4UrlList(oDialog)
	End If
	If fbHavePyQrCode() Then
		Redim _opts : _opts = Array(_
		&quot;12&quot;,_
		&quot;9&quot;,_
		&quot;6&quot;,_
		&quot;3&quot;,_
		&quot;1&quot;)
		For n = 0 To Lbound(_opts)
			s1 = s1 &amp; CR &amp; &quot;&quot;&quot;(CREATE_QR_LABEL_PY)&quot;&quot; --size &quot; &amp; _opts(n) &amp; _
			&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).png&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			
			s1 = s1 &amp; CR &amp; &quot;&quot;&quot;(CREATE_QR_LABEL_PY)&quot;&quot; --size &quot; &amp; _opts(n) &amp; _
			&quot; --output &quot;&quot;/tmp/&quot; &amp; _
			fsGetSetting(&quot;ooname&quot;) &amp; _
			&quot; - &quot; &amp; _
			fsLookUpTerm(&quot;s_read-text&quot;) &amp; &quot; - &quot; &amp; _
			fsUserName &amp; &quot;.png&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		Next
		s1 = s1 &amp; CR &amp; _
		&quot;&quot;&quot;(CREATE_QR_LABEL_PY)&quot;&quot; --level M --size 3 --fill rgb(0,0,0) --background rgb(255,255,255) --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).png&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		
		s1 = s1 &amp; CR &amp; &quot;&quot;&quot;(CREATE_QR_LABEL_PY)&quot;&quot; --output &quot;&quot;/tmp/&quot; &amp; _
		fsGetSetting(&quot;ooname&quot;) &amp; _
		&quot; - &quot; &amp; _
		fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
		&quot;.png&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	End If	
	
	If InStr(LCase(f_dlgSpeechSetup.GetControl(&quot;FileControl2&quot;).Model.Text),&quot;bin/python3&quot;) &lt;&gt; 0 or _
	bIsAppImage Then
		If FileExists(Environ(&quot;HOME&quot;) &amp; _
			&quot;/.speech-dispatcher/conf/speechd.conf&quot;) Or FileExists( _
			Environ(&quot;HOME&quot;) &amp; _
			&quot;/.config/speech-dispatcher/speechd.conf&quot;) Or bIsAppImage Or _
			Not(fbHaveEspeak()) or Len(fsGetPipLibPath(&quot;speechd&quot;, False)) &lt;&gt; 0 Then
			Select Case fsGetOS()
				Case &quot;UNIX&quot;
				If fbHaveNetworkTTS() Then
					Redim _opts : _opts = Array(_
					&quot;MALE3&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;,_
					&quot;CHILD_MALE&quot;, &quot;CHILD_FEMALE&quot;, &quot;AUTO&quot;)
				Else
					Redim _opts : _opts = Array(_
					&quot;MALE3&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;,_
					&quot;CHILD_MALE&quot;, &quot;CHILD_FEMALE&quot;)
				End If
				Case &quot;MacOS&quot;
				Select Case FileExists(&quot;/usr/bin/python3&quot;)
					Case True
					If fbHaveNetworkTTS() Then
						Redim _opts : _opts = Array(_
						&quot;MALE8&quot;, &quot;MALE7&quot;, &quot;MALE6&quot;, &quot;MALE5&quot;, &quot;MALE4&quot;, &quot;MALE3&quot;,_
						&quot;MALE2&quot;, &quot;MALE1&quot;, &quot;FEMALE8&quot;, &quot;FEMALE7&quot;, &quot;FEMALE6&quot;,_
						&quot;FEMALE5&quot;, &quot;FEMALE4&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;,_
						&quot;AUTO&quot;)
					Else
						Redim _opts : _opts = Array(_
						&quot;MALE8&quot;, &quot;MALE7&quot;, &quot;MALE6&quot;, &quot;MALE5&quot;, &quot;MALE4&quot;, &quot;MALE3&quot;,_
						&quot;MALE2&quot;, &quot;MALE1&quot;, &quot;FEMALE8&quot;, &quot;FEMALE7&quot;, &quot;FEMALE6&quot;,_
						&quot;FEMALE5&quot;, &quot;FEMALE4&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;)
					End If			
					Case Else
					If sLanguage = &quot;en&quot; Then
						If fbHaveNetworkTTS() Then
							Redim _opts : _opts = Array(_
							&quot;FEMALE5&quot;, &quot;FEMALE4&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;,_
							&quot;MALE2&quot;, &quot;MALE1&quot;, &quot;AUTO&quot;)
						Else
							Redim _opts : _opts = Array(_
							&quot;FEMALE5&quot;, &quot;FEMALE4&quot;, &quot;FEMALE3&quot;, &quot;FEMALE2&quot;, &quot;FEMALE1&quot;,_
							&quot;MALE2&quot;, &quot;MALE1&quot;)
						End If
					Else
						If fbHaveNetworkTTS() Then
							Redim _opts : _opts = Array(_
							&quot;FEMALE1&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;, &quot;AUTO&quot;)
						Else
							Redim _opts : _opts = Array(_
							&quot;FEMALE1&quot;, &quot;MALE2&quot;, &quot;MALE1&quot;)
						End If					
					End If
					End Select
				Case Else
				Redim _opts : _opts = Array(_
				&quot;MALE1&quot;, &quot;FEMALE1&quot;)
			End Select
			If Not fbIsSandboxed() Then
				If Len(fsFindAppPath(&quot;afconvert&quot;)) &lt;&gt; 0 Then
					s4 = sProg &amp; &quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
					s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)
				End If
				For n = Lbound(_opts) To Ubound(_opts)
					If bEnableRate Then
						s1 = s1 &amp; CR &amp; sProg &amp; _
						&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;&quot; &amp; _opts(n) &amp; _
						&quot;&quot;&quot; --rate &quot;&quot;140%&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
						s1 = s1 &amp; CR &amp; sProg &amp; _
						&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;&quot; &amp; _opts(n) &amp; _
						&quot;&quot;&quot; --rate &quot;&quot;70%&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
					End If
					s1 = s1 &amp; CR &amp; sProg &amp; _
					&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;&quot; &amp; _opts(n) &amp; _
					&quot;&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
				Next
				Select Case sGetOS
					Case &quot;MacOS&quot;
					s1 = s1 &amp; CR &amp; sProg &amp; _
					&quot; --visible True --voice &quot;&quot;AUTO&quot;&quot; --language&quot; &amp;_
					&quot; &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
				End Select
				s1 = s1 &amp; CR &amp; sProg &amp; _
				&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot; &amp; _
				&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
				s1 = s1 &amp; CR &amp; &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			End If
		End If
	End If

	If len(fsFindAppPath(&quot;text2wave&quot;)) &lt;&gt; 0 Or _
		FileExists(fsProgramDirectoryx86() &amp; &quot;festival\text2wave.exe&quot;) Or _
		FileExists(fsProgramDirectory() &amp; &quot;festival\texttowave.exe&quot;) Then
		Select Case fiCountFestivalVoices()
			Case 0
			&apos; pass
			Case 1
			s4 = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot; &quot;
			If Not FileExists(&quot;/usr/bin/apt&quot;) Then
				&apos; Hide export options
				&apos; Festival on non-debian (Ubuntu, Mint...) platforms write
				&apos; a file that you can play, but it might not work with
				&apos; the `Gst` (gstreamer) file converter with the settings
				&apos; that we use.
				s1 = s1 &amp; CR &amp; &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			Else
				s1 = s1 &amp; fspyOutOptions(oDialog, s4, bEnableRate)
			End If		
			Case 2
			For n = 0 To fiCountFestivalDirectory()
				If FileExists(fsFestivalDirectory(n)) Then
					s4 = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --eval &quot;&quot;(voice_&quot; &amp; fsFestivalVoice(n) &amp; &quot;)&quot;&quot;&quot;
					s1 = s1 &amp; fspyOutOptions(oDialog, s4, bEnableRate)
				End If
			Next
			s4 = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --eval &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot;
			s1 = s1 &amp; fspyOutOptions(oDialog, s4, bEnableRate)
			Case Else
			s4 = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --eval &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot;
			s1 = s1 &amp; fspyOutOptions(oDialog, s4, bEnableRate)
		End Select
	ElseIf len(fsFindAppPath(&quot;flite&quot;)) &lt;&gt; 0 Then
		s4 = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot; &quot;
		s1 = s1 &amp; fspyPlayOption(oDialog, s4)	
	End If
	If fbOKWithRhVoice(sLanguage) Then
		s4 = &quot;&quot;&quot;(RHVOICE_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --visible True --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)
		s4 = &quot;&quot;&quot;(RHVOICE_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)  &apos; 2022.08 voices ignored rate and pitch
	End If
	If fbHaveEspeak() Or _
		FileExists(fsProgramDirectoryx86() &amp; &quot;eSpeak\command_line\espeak.exe&quot;) Or _
		FileExists(fsProgramDirectory() &amp; &quot;eSpeak\command_line\espeak.exe&quot;) Then
		s4 = &quot;&quot;&quot;(ESPEAK_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --visible True --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)
		s4 = &quot;&quot;&quot;(ESPEAK_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot; &apos; &amp; &quot; --rate 100% --pitch 100% &quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, True)
	End If
	If Len(fsFindAppPath(&quot;pico2wave&quot;)) &lt;&gt; 0  Then
		s4 = &quot;&quot;&quot;(PICO_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --visible True --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)
		s4 = &quot;&quot;&quot;(PICO_READ_TEXT_PY)&quot;&quot;&quot; &amp; &quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, True)
	End If
	If Len(fsFindAppPath(&quot;open_jtalk&quot;)) &lt;&gt; 0 Then
		s4 = &quot;&quot;&quot;(OPENJTALK_READ_TEXT_PY)&quot;&quot; --language ja-JP&quot;
		s1 = s1 &amp; fspyOutOptions(oDialog, s4, False)
	End If
	If Len(s1) &gt; 0 Then
		If Asc(Left(s1, 1)) = 10 Then
			s1 = Mid(s1, 2)
		End If
		
		a1 = Split(s1, CR)
		For n = LBound(a1) + 1 To UBound(a1)
			If Not(Instr(a1(n), &quot;--output&quot;) &lt;&gt; 0 and Instr(Lcase(a1(n)), &quot;--visible true&quot;) &lt;&gt; 0) Then
				If Instr(a1(n), &quot;&quot;&quot;(TMP)&quot;&quot;&quot;) &lt;&gt; 0 or _
				Instr(a1(n), &quot;WEBTEXT&quot;) &lt;&gt; 0 Then
					oComboBox.addItem(a1(n), 0)
				End If
			End If
		Next
	End If
	n = oComboBox.getItemCount()
	fiDialog1Combo2ShowMyPythonChoices = n
	Exit Function
	fiDialog1Combo2ShowMyPythonChoicesErr
	
	fiDialog1Combo2ShowMyPythonChoices = 0
End Function


Function fspyPlayOption( _
	oDialog, _
	ByVal s4) As String
	&apos; Return a simple play aloud option, with no export flags. Processing
	&apos; online or legacy format audio might not work or it might increase risk
	&apos; of arbitrary code execution from an unverified source.
	 fspyPlayOption = Chr(10) &amp; _
		s4 &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;
End Function


Function gst_plugin_path() As String
	&apos; Enumerate Array FileExists(dir)
	gst_plugin_path = &quot;&quot;
	Dim x As Integer
	Dim _paths As Variant
	_paths = Array(_
	&quot;/usr/local/lib/x86_64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/x86_64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib64/gstreamer-1.0/&quot;, _
	&quot;/usr/lib64/gstreamer-1.0/&quot;, _
	&quot;/usr/local/i386/gstreamer-1.0/&quot;, _
	&quot;/usr/i386/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/i386-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/i386-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/amd64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/amd64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/armel-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/armel-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/armhf-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/armhf-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/arm64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/arm64-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/mips-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/mips-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/mips64el-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/mips64el-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/mipsel-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/mipsel-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/ppc64el-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/ppc64el-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/local/lib/s390x-linux-gnu/gstreamer-1.0/&quot;, _
	&quot;/usr/lib/s390x-linux-gnu/gstreamer-1.0/&quot;)
	For x = Lbound(_paths) to Ubound(_paths)
		If FileExists(_paths(x)) Then
			gst_plugin_path = _paths(x)
			Exit Function
		End If
	Next
End Function


Function fspyOutOptions( _
	oDialog, _
	ByVal s4, _
	ByVal bPitchSpeed) As String
	Dim s1, s2, s3, s5, s6, CR As String
	Dim extension As Variant
	Dim command_list As Variant
	Dim x As Integer
	Dim _x_ok As Integer : _x_ok = 0
	Dim _ext As Integer : _ext = 0
	Dim _lib_so As Integer : _lib_so = 1
	Dim _plugin_path As String : _plugin_path = gst_plugin_path()
	Dim _vlc As String : _vlc = vlcPath()
	Dim _mp3_image As String : _mp3_image = &quot;&quot;
	Dim _ogg_image As String : _ogg_image = &quot;&quot;
	s1 = &quot;&quot;
	s3 = &quot; &quot;&quot;(TMP)&quot;&quot;&quot;
	s6 = &quot;&quot;
	If InStr(LCase(f_dlgSpeechSetup.GetControl(&quot;FileControl2&quot;).Model.Text), _
		&quot;/bin/python3&quot;) = 0 Then
		s2 = &quot;&quot; &amp; s3 &apos; Customize for python 2 - legacy libraries
	Else
		s2 = &quot;&quot; &amp; s3 &apos; Customize for python 3 - for example, new speech libraries
	End If
	CR = Chr(10)
	s5 = &quot;&quot;
	If s4 = &quot;&quot; Then
		s1 = &quot;&quot;
	ElseIf fsGetOS() = &quot;MacOS&quot; Then
		Select Case Len(_vlc)
			Case 0
			extension = Array(&quot;.aiff&quot;, &quot;.m4a&quot;, &quot;.aac&quot;)
			Case Else
			extension = Array(&quot;.aiff&quot;, &quot;.opus&quot;, &quot;.ogg&quot;, &quot;.mp3&quot;, &quot;.m4a&quot;, &quot;.flac&quot;, _
			&quot;.aac&quot;)
		End Select
		For x = Lbound(extension) To Ubound(extension)
			ReDim Preserve command_list(x)
			command_list(x) = s4 &amp; _
			&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; _
			extension(x) &amp; &quot;&quot;&quot;&quot; &amp; s3
		Next
		s1 = CR &amp; Join(command_list, CR) &amp; CR &amp; s4
	Else
		If fsGetOS() = &quot;UNIX&quot; Then
			If Len(_
			fsContainerResourcePath(_
			&quot;python&quot;)) &lt;&gt; 0 Then
				&apos; Pass - The container is sandboxed by default, so
				&apos; we cannot count on it working properly.
			ElseIf Len(_
			fsAppImageResourcePath(&quot;python&quot;)) &lt;&gt; 0 And Not(_
			fbHaveFfmpeg()) And Not(fbHaveVLC()) Then
				&apos; The Python gstreamer library might not be available, so 
				&apos; propose saving audio formats that your apps support.

				If fbHaveLame() Then
					s1 = s1 &amp; CR &amp; s4 &amp; _
					&quot; --image &quot;&quot;(POSTER_IMG)&quot;&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).mp3&quot;&quot;&quot; &amp; _
					s3
				End If
				s1 = s1 &amp; CR &amp; s4 &amp; _
				&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).wav&quot;&quot;&quot; &amp; _
				s3
			Else
				&apos; `opus` replaces `.spx` and `.ogg`.
				&apos; `lame` (.mp3) replaces `mp1` and `.mp2`.
				If fbHaveLame() Then
					_mp3_image = &quot; --image &quot;&quot;(POSTER_IMG)&quot;&quot;&quot;
				End If
				If fbHaveFfmpeg() Then
					_mp3_image = &quot; --image &quot;&quot;(POSTER_IMG)&quot;&quot;&quot;
					_ogg_image = &quot; --image &quot;&quot;(POSTER_IMG)&quot;&quot;&quot;
				End If
				extension = Array(_
				Array(&quot;.wav&quot;, &quot;libgstwavenc&quot;, &quot;gstreamer1.0-plugins-good/copyright&quot;, &quot;&quot;), _
				Array(&quot;.opus&quot;, &quot;libgstopus&quot;, &quot;gstreamer1.0-plugins-good/copyright&quot;, &quot;&quot;), _
				Array(&quot;.ogg&quot;, &quot;libgstogg&quot;, &quot;gstreamer1.0-plugins-good/copyright&quot;, _ogg_image), _
				Array(&quot;.mp3&quot;, &quot;libgstlame&quot;, &quot;libmp3lame0/copyright&quot;, _mp3_image), _
				Array(&quot;.flac&quot;, &quot;libgstflac&quot;, &quot;gstreamer1.0-plugins-good/copyright&quot;, &quot;&quot;))

				For x = Lbound(extension) To Ubound(extension)
					If FileExists(_plugin_path &amp; extension(x)(1) &amp; &quot;.so&quot;) Then 
						ReDim Preserve command_list(_x_ok)
						command_list(_x_ok) = s4 &amp; _
						extension(x)(3) &amp; _
						&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; _
						extension(x)(0) &amp; &quot;&quot;&quot;&quot; &amp; s3
						_x_ok = _x_ok + 1
					End If
				Next

				If _x_ok = 0 Then
					For x = Lbound(extension) To Ubound(extension)
						If FileExists(&quot;/usr/share/doc/&quot; &amp; extension(x)(2)) Then 
							ReDim Preserve command_list(_x_ok)
							command_list(_x_ok) = s4 &amp; _
							&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW)&quot; &amp; _
							extension(x)(0) &amp; &quot;&quot;&quot;&quot; &amp; s3
							_x_ok = _x_ok + 1
						End If
					Next
				End If
				If Len(fsContainerResourcePath(&quot;python&quot;)) = 0 Then			
					If _x_ok &lt;&gt; 0 Then
						s1 = CR &amp; Join(command_list, CR)
					Else
						s1 = s1 &amp; CR &amp; s4 &amp; _
						&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).wav&quot;&quot;&quot; &amp; _
						s3
					End If
				End If
			End If
		Else  &apos; WINDOWS			
			extension = Array(_
			Array(&quot;.wav&quot;, _vlc, fsMyFfmpeg()), _
			Array(&quot;.opus&quot;, _vlc, fsMyFfmpeg()), _
			Array(&quot;.ogg&quot;, _vlc, oggPath()), _
			Array(&quot;.mp3&quot;, _vlc, lamePath()), _
			Array(&quot;.flac&quot;, _vlc, flacPath()), _
			Array(&quot;.aac&quot;, _vlc, neroPath()))
			For x = Lbound(extension) To Ubound(extension)
				If FileExists(extension(x)(2)) Or _
				FileExists(extension(x)(1)) Then
					ReDim Preserve command_list(_x_ok)
					command_list(_x_ok) = s4 &amp; _
					&quot; --output &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)\(NOW)&quot; &amp; _
					extension(x)(0) &amp; &quot;&quot;&quot;&quot; &amp; s3
					_x_ok = _x_ok + 1
				End If
			Next		
		End If
		If Len(fsContainerResourcePath(&quot;python&quot;)) &lt;&gt; 0 Then
			&apos;pass
		ElseIf Len(fsAppImageResourcePath(&quot;python&quot;)) &lt;&gt; 0 And Not(fbHaveFfmpeg()) Then
			&apos; The Python gi Gst library is unavailable, so the python script can
			&apos; only work with a discreet converter.
			&apos;pass

		End If
		&apos; End File Write section
		If bPitchSpeed Then
			s1 = s1 &amp; CR &amp; s4 &amp; _
			&quot; --rate 75% --pitch 100%&quot; &amp; s3
			&apos; Nominal rate and pitch is --rate 100% --pitch 100% &quot;
			s1 = s1 &amp; CR &amp; s4 &amp; _
			&quot; --rate 125% --pitch 100%&quot; &amp; s3
		End If
		s1 = s1 &amp; CR &amp; s4 &amp; &quot;&quot; &amp; s3
	End If
	fspyOutOptions = s1
End Function


Function fsAppImageResourcePath( _
	ByVal sApp As String) As String
	&apos; Linux AppImage installations use a specific version of python
	&apos; running in a temporary mounted directory.
	Dim i#
	i = 0
	Dim s1$
	s1 = ConvertFromUrl(Split(CreateUNOService(&quot;com.sun.star.util.PathSettings&quot;).Gallery, &quot;;&quot;)(0))
	
	fsAppImageResourcePath = &quot;&quot;
	If (InStr(s1, &quot;/tmp/.mount_&quot;) = 1) Then
		For i = 1 To 5
			fsAppImageResourcePath = fsAppImageResourcePath &amp; &quot;/&quot; &amp; Split(s1, &quot;/&quot;)(i)
		Next
		fsAppImageResourcePath = fsAppImageResourcePath &amp; &quot;/&quot; &amp; sApp
		If Not FileExists(fsAppImageResourcePath) Then
			fsAppImageResourcePath = &quot;&quot;
		End If
	End If
End Function


Function fsContainerResourcePath( _
	ByVal sApp As String) As String
	&apos; Linux Snap installations use a specific version of python
	&apos; running in the root `/snap` directory.
	fsContainerResourcePath = &quot;&quot;
	Dim i#
	i = 0
	Dim s1$
	s1 = ConvertFromUrl(Split(CreateUNOService(&quot;com.sun.star.util.PathSettings&quot;).Gallery, &quot;;&quot;)(0))
	If (InStr(s1, &quot;/snap/&quot;) = 1) Or InStr(s1, &quot;.mount&quot;) &lt;&gt; 0 Then
		If FileExists(&quot;/snap/core/current/usr/bin/python3&quot;) Then
			fsContainerResourcePath = &quot;/snap/core/current/usr/bin/python3&quot;
		End If
	End If
End Function


Function AppleScriptPath() As String
	AppleScriptPath = &quot;/usr/bin/osascript&quot;
End Function


Function fsMyTitleInputBox( _
	ByVal b_skip_windows, _
	ByVal suggestion, _
	ByVal dialog_title) As String
	&apos; b_skip_windows - Skip dialogue if Windows..
	&apos; Normally, the Windows script takes care of verifying
	&apos; the title.
	&apos; suggestion - an optional title suggestion.  Returns string or blank if 
	&apos; you click &quot;Cancel&quot;
	&apos; 
	Dim cr As String
	Dim s1 As String
	Dim s2 As String
	Dim s3 As String
	Dim s4 As String
	Dim s5 As String
	Dim x As Integer
	Dim unwanted_characters As String
	unwanted_characters = &quot;,:;-–&gt;&lt;{}|&quot;
	If b_skip_windows Then
		If fsGetOS = (&quot;WINDOWS&quot;) Then
			fsMyTitleInputBox = suggestion
			Exit Function
		End If
	End If
	If len(dialog_title) = 0 Then
		dialog_title = fsThisDocGenre()
	End If
	cr = Chr(10)
	s1 = fsSuperTrim(fsThisDocTitle(), unwanted_characters)
	s2 = fsSuperTrim(fsThisDocAuthor(), unwanted_characters)
	s3 = dialog_title  &apos; ###### Dialog Title
	s4 = fsSuperTrim(fsThisSoundTitle(), unwanted_characters)
	s5 = Trim(str(fiMyCurrentAudioTrack(False)))
	suggestion = fsSuperTrim(suggestion, unwanted_characters)
	fsMyTitleInputBox = InputBox(s1 &amp; cr &amp; s2 &amp; cr &amp; cr &amp; s5 &amp; &quot;. &quot; &amp; s4, s3, _
	suggestion)
	If Len(fsMyTitleInputBox) = 0 Then
		x = i_CaBcVancouverHolgateJamesReadtextextensionLastSpokenTrack
		If x &gt; 0 Then
			i_CaBcVancouverHolgateJamesReadtextextensionLastSpokenTrack = x - 1
		End If
	End If
End Function


Sub resetSpeech()
&apos; Reset Speech
	Dim a1 As Variant
	Dim n As Integer
	fbRemoveTextLocks()
	a1 = Array(_
	fsFestivalScriptName(),_
	fsTemporaryTextDoc(),_
	fsTemporaryTextDoc() &amp; &quot;.sable&quot;,_
	fsTemporaryTtsAppleScript())
	For n = LBound(a1) To UBound(a1)
		fbRemoveFile(a1(n))
	Next
End Sub


Function fsAbout() As String
	fsAbout = getTextFromFile(fsDescriptionDoc(), &quot;UTF-8&quot;)
	&apos; Application&apos;s Default encoding
End Function


Function fsVBSTextString() As String
	fsVBSTextString = getTextFromFile(fsTTSScriptVBS(), &quot;iso-8859-15&quot;)
	&apos;iso-8859-15 Windows encoding
End Function


Function fsSPDTextString() As String
	fsSPDTextString = getTextFromFile(fsPythonSpdDoc(), &quot;UTF-8&quot;)
End Function


Function fsPicoTextString() As String
	fsPicoTextString = getTextFromFile(fsPythonPicoDoc(), &quot;UTF-8&quot;)
End Function


Function fsEspeakTextString() As String
	fsEspeakTextString = getTextFromFile(fsPythonEspeakDoc(), &quot;UTF-8&quot;)
End Function


Function fsFestivalTextString() As String
	fsFestivalTextString = getTextFromFile(fsPythonFestivalDoc(), &quot;UTF-8&quot;)
End Function


Function fsPythonNetTtsTextString() As String
	fsPythonNetTtsTextString = getTextFromFile(fsNetworkTtsDoc(), &quot;UTF-8&quot;)
End Function

  
Function fsRhVoiceTextString() As String
	fsRhVoiceTextString = getTextFromFile(fsRhVoiceTtsDoc(), &quot;UTF-8&quot;)
End Function


Function fsOpenJtalkTextString() As String
	fsOpenJtalkTextString = getTextFromFile(fsPythonOpenJTalkDoc(), &quot;UTF-8&quot;) 
End Function


Function fsQRTextString() As String
	fsQRTextString = getTextFromFile(fsPythonCreateQR(), &quot;UTF-8&quot;)
End Function


Function getTextFromFile( _
	sFilePath, _
	sEncoding) As String
&apos; Reading files
	&apos; http://www.oooforum.org/forum/viewtopic.phtml?t=53813
	&apos; Use simpleFileAccess instead of Basic file handling to 
	&apos; translate encoded text
	Dim myTextFile As Object,sf As Object,fileStream As Object
	Dim aLineOfText As String,myFilePath As String
	
	myFilePath = convertToURL(sFilePath)
	sf = createUnoService(&quot;com.sun.star.ucb.SimpleFileAccess&quot;)
	On Error Goto fichierKO
	fileStream = sf.openFileRead(myFilePath)
	myTextFile = createUnoService(&quot;com.sun.star.io.TextInputStream&quot;)
	myTextFile.InputStream = fileStream
	myTextFile.Encoding = sEncoding
	Do While Not myTextFile.IsEOF
		getTextFromFile = getTextFromFile &amp; myTextFile.readLine &amp; Chr(13)
	Loop
	fileStream.closeInput
	myTextFile.closeInput
	On Error Goto 0
	Exit Function
	FichierKO:
	
	Resume FichierKO2
	FichierKO2:
	
	On Error Resume Next
	MsgBox(&quot;File read Error !&quot;,16)
	fileStream.closeInput
	myTextFile.closeInput
	On Error Goto 0
End Function


Function fsStripSmartQuotes( _
	ByVal sA) As String
	sA = fsReplaceText(sA, &quot;“&quot;, &quot;&quot;&quot;&quot;)
	sA = fsReplaceText(sA, &quot;”&quot;, &quot;&quot;&quot;&quot;)
	sA = fsReplaceText(sA, &quot;‘&quot;, &quot;&apos;&quot;)
	fsStripSmartQuotes = fsReplaceText(sA, &quot;’&quot;, &quot;&apos;&quot;)
End Function


Function fbWestEuropeanLang( _
	ByVal test_str As String) As Boolean
	fbWestEuropeanLang = False
	If Len(test_str) &lt; 2 Then Exit Function
	test_str = LCase(Left(test_str, 2))
	Dim x As Integer
	x = 0
	Dim a1
	a1 = Array( _
	&quot;ca&quot;, _
	&quot;de&quot;, _
	&quot;en&quot;, _
	&quot;eo&quot;, _
	&quot;es&quot;, _
	&quot;fr&quot;, _
	&quot;ga&quot;, _
	&quot;gd&quot;, _
	&quot;it&quot;, _
	&quot;la&quot;, _
	&quot;nl&quot;, _
	&quot;pt&quot;)
	For x = LBound(a1) To UBound(a1)
		If test_str = a1(x) Then
			fbWestEuropeanLang = True
			Exit For
		End If
	Next
End Function


Function fsGetActuateExtension( _
	ByVal test_command As String, _
	ByVal media_list As String) As String
	fsGetActuateExtension = &quot;&quot;
	Dim a1 As Variant
	a1 = Split(media_list, &quot;,&quot;)
	Dim x As Integer
	For x = Lbound(a1) To Ubound(a1)
		If Instr(test_command, a1(x) &amp; &quot;&quot;&quot;&quot;) &lt;&gt; 0 Then
			fsGetActuateExtension = a1(x)
			Exit For
		End If
	Next
End Function


Function faSettingsArray(_
		title As String,_
		track As Integer) As Variant
&apos; Key Value pairs for media production and audio formatting
	faSettingsArray = Array(_				
	Array(&quot;id&quot;, fsThisDocAuthor()),_
	Array(&quot;album&quot;, fsThisDocTitle()),_
	Array(&quot;title&quot;, title),_
	Array(&quot;genre&quot;, fsThisDocGenre()),_
	Array(&quot;track&quot;, Trim(Str(track))),_
	Array(&quot;lexicon&quot;, CustomLexiconDir())_
	)
End Function


Function fbRemoveTextLocks() As Boolean
	fbRemoveTextLocks = False
	On Local Error GoTo fbRemoveTextLocksErr
	Dim x As Integer
	Dim a1 As Variant
	a1 = faSettingsArray(&quot;_title&quot;, 1)
	For x = Lbound(a1) To Ubound(a1)
		fbRemoveFile(fsMyTempLock(&quot;lock.&quot; &amp; a1(x)(0)))
	Next
	fbRemoveTextLocks = True
Exit Function
	fbRemoveTextLocksErr:
	fbRemoveTextLocks = False
End Function


Function fbWriteTextLocks(_
		title As String,_
		track As Integer) As Boolean
	fbWriteTextLocks = False
	On Local Error GoTo fbWriteTextLocksErr
	Dim x As Integer
	Dim a1 As Variant
	a1 = faSettingsArray(title, track)
	For x = Lbound(a1) To Ubound(a1)
		CreateFile(fsMyTempLock(&quot;lock.&quot; &amp; a1(x)(0)), a1(x)(1), &quot;UTF-8&quot;)
	Next
Exit Function
	fbWriteTextLocksErr:
	fbWriteTextLocks = False
End Function


Function fsJsonSettings(_
		title As String,_
		track As Integer) As String
	fsJsonSettings = &quot;&quot;
	Dim x As Integer
	Dim CR As String : CR = Chr(13)
	Dim _str as String : _str = &quot;{&quot;&quot;read_text&quot;&quot;:{&quot; &amp; CR
	Dim a1 As Variant
	a1 = faSettingsArray(title, track)
	For x = Lbound(a1) To Ubound(a1)
		_str = _str &amp; &quot;    &quot;&quot;&quot; &amp; a1(x)(0) &amp; &quot;&quot;&quot;:&quot;&quot;&quot; &amp; fsJsonSafe(a1(x)(_
		1)) &amp; &quot;&quot;&quot;,&quot; &amp; CR
	Next
	fsJsonSettings = fsReplaceText(_str &amp; &quot;}}&quot;, &quot;,&quot; &amp; CR &amp; &quot;}}&quot;, CR &amp; &quot;}}&quot;)
End Function


Sub ttsActuate( _
	config() As Variant, _
	msgs() As Variant, _
	errorCode As Integer, _
	ByVal sTextToSpeak As String)
	Dim a1
	a1 = Array(&quot;id&quot;, _
	&quot;title&quot;, _
	&quot;album&quot;, _
	&quot;genre&quot;, _
	&quot;track&quot;)
	Dim bAddTime As Boolean
	bAddTime = False
	Dim language$
	language = fsSelectionLanguageAndRegion(True)
	Dim model$
	model = &quot;&quot;
	Dim _text_file$
	_text_file = fsTemporaryTextDoc()
	Dim s1$
	s1 = &quot;&quot;
	Dim sArtLook$
	sArtLook = &quot;&quot;
	Dim sArtURL$
	sArtURL = &quot;&quot;
	Dim scodec$
	scodec = &quot;UTF-8&quot;
	Dim sCommand$
	sCommand = &quot;&quot;
	Dim sGetOS$
	sGetOS = fsGetOS()
	Dim sScript$
	sScript = &quot;&quot;
	Dim sProgram$
	sProgram = &quot;&quot;
	Dim aVal As Integer
	Dim bWait As Boolean
	bWait = False
	Dim n As Integer
	n = 0
	Dim oBar    &apos; Generated status bar 
	Dim oFrame  &apos; Current frame
	Dim media_list As String
	media_list = &quot;.3gp,.aac,.aif,.aiff,.alsa,.ape,.asf,.au,.avi,.caf,.dts,.flac,&quot; &amp; _
		&quot;.m4a,.mp2,.mp3,.mp4,.mpeg,.oga,.ogg,.ogm,.ogv,.oma,.opus,.riff,.rm,.smp,.snd,.sou,.spx,&quot; &amp; _
		&quot;.tta,.voc,.wav,.weba,.webm,.wma,.wmv,.wsaud&quot;
&apos; Temporary Files
	On Error Goto errorHandler
	&apos;Choose what to speak
	If sTextToSpeak = &quot;&quot; Then
		sTextToSpeak = fsGetTextSelection(False, True)
	End If
	For n = LBound(a1) To UBound(a1)
		fbRemoveFile(fsMyTempLock(&quot;lock.&quot; &amp; a1(n)))
	Next
	If Len(sTextToSpeak) = 0 Then
		Exit Sub
	End If
	On Error Resume Next
	oFrame = ThisComponent.getCurrentController().getFrame()
	oBar = oFrame.createStatusIndicator()
	oBar.start(fsLookUpTerm(&quot;s_read-text&quot;), 100)
	
	&apos;Get rid of the old files containing a script And/or plain text of selected String
	resetSpeech
	sArtLook = config(5)
	
	If fbCreatingMediaFile(media_list) Then
		&apos; Get current track, then increment it by one to a maximum value of 255. 
		&apos; (hex FF)
		n = fiMyCurrentAudioTrack(True)
		If sGetOS = &quot;MacOS&quot; Then
			&apos; If metadata is required, it is written into a temporary
			&apos; osascript document.
			bAddTime = True
		Else
			If Bool(config(fiExternalOption())) Or Bool(config(fiFestivalOption())) Then
				&apos; Temporary Metadata for an external vbs or python script.
				&apos; External scripts delete these files once they have been
				&apos; read.  MacOS creates a script at run-time, so these files
				&apos; are not required.
				&apos; 
				&apos; On UNIX and Linux platforms, check the sound title 
				&apos; before writing the setting.  Windows does this in the
				&apos; vbs script.
				Select Case sGetOS
					Case &quot;WINDOWS&quot;
					s1 = fsThisSoundTitle()
					Case Else
					s1 = fsMyTitleInputBox(_
					True, _
					fsThisSoundTitle(), _
					fsThisDocGenre() &amp; &quot; (&quot; &amp; fsGetActuateExtension(_
					sArtLook, media_list) &amp; &quot;)&quot; )
					If s1 = &quot;&quot; Then
						Exit Sub
					End If
				End Select
				fbWriteTextLocks(s1, n)  &apos; title As String, track as Integer
			End If
		End If
	Else
		&apos; Set the global variable holding the track counter to zero
		&apos; if we aren&apos;t creating a media file.
		&apos; 
		i_CaBcVancouverHolgateJamesReadtextextensionLastSpokenTrack = 0
		CreateFile(fsMyTempLock(&quot;lock.lexicon&quot;), CustomLexiconDir(), &quot;UTF-8&quot;)
	End If
	oBar.Value = 70
	If config(fiFestivalOption()) Then
		&apos;Write the Festival script and the file to read aloud
		sProgram = config(fiFestivalPath())
		sCommand = &quot;&quot;&quot;&quot; &amp; ConvertFromUrl(fsFestivalScriptName()) &amp; &quot;&quot;&quot;&quot;
		&apos; Windows - don&apos;t limit to SAPI languages
		sScript = config(fiFestivalComboChoice())
		sScript = replaceLocalTokensWithStr(sScript)
		sScript = replacePublicTokensWithStr(sScript)
		If fsComplexAsiaOrWest(sTextToSpeak) = &quot;WEST&quot; Then
			&apos; Compatible characters are officially supported by Festival using iso-8859-15
			If fbWestEuropeanLang(language) Then
				scodec = &quot;iso-8895-15&quot;
			End If
		End If
		CreateFile(fsFestivalScriptName(), sScript, scodec)
		CreateFile(_text_file, sTextToSpeak, scodec)
	ElseIf config(fiExternalOption()) Then
		sProgram = config(fiExternalProgramPath())
		sCommand = config(fiExternalCommand)
		If InStr(LCase(sProgram), &quot;bin/padsp&quot;) &lt;&gt; 0 Then
			If InStr(LCase(sCommand), &quot;swift&quot;) &lt;&gt; 0 Then
				&apos; Cepstral swift Alison (2008) for Linux does not pronounce text around smart quotes correctly,
				&apos; so we strip the smart quotes. Be sure to tell swift to use UTF-8 encoded text as follows: 
				&apos; &quot;Read with external program&quot; set to /usr/bin/padsp and 
				&apos; &quot;Command line options&quot; to swift -e UTF-8 -m text -f &quot;(TMP)&quot;
				sTextToSpeak = fsStripSmartQuotes(sTextToSpeak)
			End If
		End If
		If ThisComponent.supportsService( _
			&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
			&apos; Write a song cover image in the output directory.
			sArtLook = config(5)
			If fbCreatingMediaFile(&quot;.aif,.aiff,.m4a,.mp3,.oga,.webm,.mp4&quot;, sArtLook) Then
				sArtURL = fsExportAlbumCover()
			End If
		End If
		If sGetOS = &quot;UNIX&quot; Or sGetOS = &quot;MacOS&quot; Then
			If fbUsingPosixTalkProgram(sProgram) Then
				&apos; When using a posix speech command and not using a script,
				&apos; the routine writes a lock file to use for toggling speech.
				&apos; The speech toggle does not work with all speech synthesis
				&apos; applications on all Posix platforms, because the `killall`
				&apos; command may not work on some processes when it is invoked 
				&apos; by a user with limited permissions.
				If instr(sProgram, &quot;/say&quot;) = 0 Then
					CreateFile(fsMyTempLock(&quot;lock&quot;), fsAppSignature(), &quot;UTF-8&quot;)
				End If
			End If
		End If
		
		&apos; Remove audible markdown code symbols for blockquote, heading, emphasize 
		&apos; when they occur at the beginning or the end of a line.
		sTextToSpeak = fsTrimSpecial(sTextToSpeak, Chr(13) &amp; Chr(10) &amp; &quot;`#&gt;_ =-*+&quot;)
		sTextToSpeak = fsReplaceText(sTextToSpeak, Chr(10) &amp; &quot;&gt;&quot;, Chr(10)) &amp; Chr(10)
		sTextToSpeak = fsCleanMdCode(sTextToSpeak)
		If bAddTime Then
			sTextToSpeak = sTextToSpeak &amp; &quot; [[slnc 400]]&quot;
		End If
		&apos; Customizing speech
		CreateFile(_text_file, sTextToSpeak, scodec)
		Select Case sGetOS
			Case &quot;WINDOWS&quot;
			&apos; Posix systems that use python3 perform customized
			&apos; pronunciation when running the python script. Since
			&apos; we normally handle speech synthesis on Windows using
			&apos; wscript or cscript, the read text extension 
			&apos; needs to use a python3 json library here.
&apos;&apos;
&apos;&apos; Customize pronunciation
&apos;&apos; =======================
&apos;&apos;
&apos;&apos; When you use this extension with a compatible app, you can replace
&apos;&apos; incorrectly pronounced words and acronyms with a string that the
&apos;&apos; system speech synthesizer can read correctly.
&apos;&apos;
&apos;&apos;     &quot;g&quot;:&quot;Metis&quot;,&quot;p&quot;:&quot;[met-tea]&quot;
&apos;&apos;     &quot;g&quot;:&quot;Read Text Extension&quot;,&quot;p&quot;:&quot;reed text extension&quot;
&apos;&apos;
&apos;&apos; Activate
&apos;&apos; --------
&apos;&apos;
&apos;&apos; ### MacOS
&apos;&apos;
&apos;&apos; The feature is available on MacOS only if you use `python3` instead of
&apos;&apos; the default `osascript`. Command + Click is the same as Right-Click.
&apos;&apos;
&apos;&apos; ### Windows
&apos;&apos;
&apos;&apos; To use the feature, you must first initiate the option by modifying the
&apos;&apos; pronunciation of at least a single word. Caveat: If you are processing
&apos;&apos; long phrases and you have a lot of replacement words, there may be a
&apos;&apos; delay while python processes your text.
&apos;&apos;
&apos;&apos; Use
&apos;&apos; ---
&apos;&apos; 
&apos;&apos; + Select a word that you want to change the pronunciation (i.e.: &quot;Metis&quot;)
&apos;&apos; + Select *Tools - Add Ons... - Read Text Extension*
&apos;&apos; + Click *About...*
&apos;&apos; + Right-Click the *Tools* Icon.
&apos;&apos; + In the *Read with an external program (windows-sapi)*
&apos;&apos;   field enter how you want to say the mispronounced word (i.e.: &quot;[met-tea]&quot;)
&apos;&apos; + Click *Apply*
&apos;&apos; + Some platforms (like MaryTTS) support the International Phonetic Alphabet
&apos;&apos;   but on default Windows and MacOS systems, you need to use creative spelling
&apos;&apos;   that works for you.
&apos;&apos;
			&apos; NOTE: Apache OpenOffice 4 for Windows does not support python 3
			If fbIsLibreOffice() Then
			model = WindowsSpeechAppInfo().json_dir
				If FileExists(fsFullPathOf(fsExtensionSetJson(&quot;lexicons/&quot; &amp; model, language))) Then
					fbWindowsReplacePhonemes(language, model, _text_file)
				End If
			End If
			Case &quot;MacOS&quot;
			If InStr(sCommand, &quot;_PY)&quot;&quot;&quot;) &lt;&gt; 0 Then
				&apos; If you chose a Python script, you need to use python
				&apos; but you don&apos;t need to write an osascript document.
				sProgram = PosixPythonPath()
			ElseIf InStr(sCommand,&quot;&quot;&quot;(SAY_APPLESCRIPT_SLOWLY)&quot;&quot;&quot;) = 1 Then
				fswriteMacOSSpeechScript(&quot;-r 110 &quot;, _
				language, sArtURL)
			ElseIf InStr(sCommand,&quot;&quot;&quot;(SAY_APPLESCRIPT_QUICKLY)&quot;&quot;&quot;) = 1 Then
				fswriteMacOSSpeechScript(&quot;-r 240 &quot;, _
				language, sArtURL)
			ElseIf InStr(config(fiExternalCommand),&quot;(SAY_APPLESCRIPT_SYSTEM_VOICE)&quot;) &lt;&gt; 0 Then
				fswriteMacOSSpeechScript(&quot;&quot;, _
				&quot;&quot;, sArtLook)
			Else
				fswriteMacOSSpeechScript(&quot;&quot;, _
				language, sArtURL)
			End If
		End Select
		If InStr(sCommand,&quot;&quot;&quot;(TTS_WSCRIPT_VBS)&quot;&quot;&quot;) = 1 Then
			
			&apos;only consider SAPI voices
			sCommand = fsReplaceText(sCommand,&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;,fsSelectionLanguageAndRegion(False))
		End If
		sCommand = replaceLocalTokensWithStr(sCommand)
		sCommand = replacePublicTokensWithStr(sCommand)
		sCommand = replaceWebTokensWithStr(sCommand, sTextToSpeak) &apos;for online content with media player
		fbCreateMissingMediaDirectory(sCommand)
	Else &apos;if config(fiHtmlOption) then
		&apos;Translate And read with web tools
		i_CaBcVancouverHolgateJamesReadtextextensionLastSpokenTrack = 0
		sCommand = config(fiHtmlComboURL())
		sCommand = replacePublicTokensWithStr(sCommand)
		sCommand = replaceWebTokensWithStr(sCommand, sTextToSpeak)
		&apos; HTML file
		If Len(sCommand) &lt;&gt; 0 Then
			If (InStr(sCommand,&quot;http://&quot;) &lt;&gt; 1 And InStr(sCommand,&quot;https://&quot;) &lt;&gt; 1 And InStr(sCommand,&quot;mailto:&quot;) &lt;&gt; 1) Then
				sCommand = &quot;http://&quot; &amp; sCommand
			End If
			webHelp(sCommand)
		Else
			ErrorDisplay()
		End If
		oBar.End()
		Exit Sub
	End If
	If FileExists(sProgram) Then
		&apos; program path
		&apos; 0 - focus is On the hidden program window,
		&apos; program parameter strings,
		&apos; False - tasks do not wait until shell task ends
		bWait = False
		If sGetOS = &quot;UNIX&quot; Then
			If Right(sProgram, Len(&quot;festival&quot;)) = &quot;festival&quot; Then
				&apos; When festival is the external program, the routine pauses while
				&apos; the computer is speaking to avoid the possibility of playing 
				&apos; two voices at once.
				bWait = True
			End If
		End If
		
		If sCommand &lt;&gt; &quot;&quot; Then
			Select Case sGetOS
				Case &quot;WINDOWS&quot;
				errorCode = Shell(_
				sProgram, 0, sCommand, bWait)
				Case Else
				&apos; Specify a program path as URL because
				&apos; a program path to a python application
				&apos; could include spaces.
				If sGetOS =&quot;MacOS&quot; And _
					InStr(sProgram, &quot;/python&quot;) &lt;&gt; 0 And _
					fbIsLibreOffice() Then
						sProgram = PosixPythonPath()				
				End If
				errorCode = Shell(_
				converttourl(_
				sProgram), 0, sCommand, bWait)
			End Select
		End If
		On Error Resume Next
		oBar.Value = 80
		On Error Goto errorHandler
	Else
		MsgBox(fsLookUpTerm(&quot;s_could-not-locate-the-program&quot;) &amp; _
		&quot; &quot; &amp; _
		fsLookUpTerm(&quot;s_string-cannot-be-analyzed&quot;), 64 , _
		fsLookUpTerm(&quot;s_read-text&quot;))
		fbRemoveFile(fsFullPathOf(fsExtensionSettingsIni))
		fbRemoveFile(fsFullPathOf(&quot;ReadClipBoard.lock&quot;))
		resetSpeech
	End If
	On Error Resume Next
	oBar.Value = 90
	If Len(sArtURL) &gt; 0 Then
		If (sGetOS = &quot;WINDOWS&quot;) Then
			&apos; The Windows `tts_wscript.vbs` script must deal with the
			&apos; custom image because removing it here may cause an error.
		Else
			If FileExists(sArtURL) Then
				For n = 0 To 30
					Wait 500
					If Not(FileExists(fsMyTempLock(&quot;lock&quot;))) Then
						fbRemoveFile(sArtURL)
						Exit For
					End If
				Next
			End If
		End If
	End If
	oBar.Value = 100
	oBar.End()
	Exit Sub
	ErrorHandler:
	
	MsgBox(fsLookUpTerm( &quot;s_string-cannot-be-analyzed&quot;), 48, _
	fsLookUpTerm( &quot;s_read-text&quot;))
	fbRemoveFile(fsFullPathOf(fsExtensionSettingsIni))
	fbRemoveFile(fsFullPathOf(&quot;ReadClipBoard.lock&quot;))
	resetSpeech
End Sub


Function fbCreateMissingMediaDirectory( _
	ByVal sCommandLine) As Boolean
	&apos; To put a media file in a directory that does not exist.
&apos; Media Directories
	fbCreateMissingMediaDirectory = False
	Dim s1, s2 As String
	Dim n, o As Integer
	Dim a1, a2, a3
	Dim os_div As String : os_div = &quot;/&quot;

	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	
	On Error Goto fbCreateMissingMediaDirectoryErr
	
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		os_div = &quot;\&quot;
		s1 = &quot;&quot;&quot;&quot;
		Case Else
		sCommandLine = fsReplaceText(sCommandLine, &quot;&quot;&quot;&quot;, &quot;&quot;)
		sCommandLine = fsReplaceText(sCommandLine, &quot;&apos;&quot;, &quot;&quot;)
		s1 = &quot; &quot;
	End Select
	
	If Instr(sCommandLine, os_div) = 0 Then
		Exit Function
	End If
	a1 = Split(sCommandLine, s1)
	a2 = Array( _
	&quot;wav&quot;, _
	&quot;png&quot;, _
	&quot;opus&quot;, _
	&quot;ogg&quot;, _
	&quot;mp4&quot;, _
	&quot;mp3&quot;, _
	&quot;m4a&quot;, _
	&quot;jpg&quot;, _
	&quot;flac&quot;, _
	&quot;3gp&quot;, _
	&quot;aac&quot;, _
	&quot;aif&quot;, _
	&quot;aiff&quot;, _
	&quot;au&quot;, _
	&quot;avi&quot;, _
	&quot;csv&quot;, _
	&quot;doc&quot;, _
	&quot;docx&quot;, _
	&quot;epub&quot;, _
	&quot;gif&quot;, _
	&quot;jpeg&quot;, _
	&quot;jpg&quot;, _
	&quot;m4a&quot;, _
	&quot;m4v&quot;, _
	&quot;mov&quot;, _
	&quot;mkv&quot;, _
	&quot;mp2&quot;, _
	&quot;mpeg&quot;, _
	&quot;oga&quot;, _
	&quot;ogg&quot;, _
	&quot;ogm&quot;, _
	&quot;pdf&quot;, _
	&quot;ppt&quot;, _
	&quot;pptx&quot;, _
	&quot;tif&quot;, _
	&quot;webm&quot;, _
	&quot;wma&quot;, _
	&quot;wmv&quot;, _
	&quot;xls&quot;, _
	&quot;xlsx&quot;, _
	&quot;zip&quot;)	
	For n = UBound(a1) To LBound(a1) Step -1
		s2 = a1(n)
		If instr(s2, &quot;.&quot;) &lt;&gt; 0 And Instr(s2, os_div) &lt;&gt; 0 Then
			For o = LBound(a2) To UBound(a2)
				If GetFileNameExtension(s2) = a2(o) Then
					s2 = ConvertToUrl(s2)
					If FileExists(DirectoryNameoutofPath(s2, &quot;/&quot;)) Then
						fbCreateMissingMediaDirectory = True
					Else
						fbCreateMissingMediaDirectory = fbcreateDirectory(_
						DirectoryNameoutofPath(s2, &quot;/&quot;))
					End If
					Exit For		
				End If
			Next
		End If
	Next
	Exit Function
	fbCreateMissingMediaDirectoryErr:
	fbCreateMissingMediaDirectory = False
End Function


Function fsReplaceText( _
	sA As String, _
	sFind As String, _
	sReplace As String) As String
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	fsReplaceText = ReplaceString(sA, sReplace, sFind)
End Function


Function replaceLocalTokensWithStr( _
	sA As String) As String
	&apos; This function takes a String with tokens And replaces each
	&apos; token with a useful String
&apos; Tokens
	Dim sFind As String
	Dim sReplace As String
	Dim sB As String
	
	sB = fsGetTextSelection(False, False)
	&apos;Temporary file name
	sFind = &quot;(TMP)&quot;
	sReplace = ConvertFromUrl(fsTemporaryTextDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(TTS_WSCRIPT_VBS)&quot;
	sReplace = ConvertFromUrl(fsTTSScriptVBS())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SPD_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonSpdDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(PICO_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonPicoDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(ESPEAK_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonEspeakDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(FESTIVAL_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonFestivalDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(RHVOICE_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsRhVoiceTtsDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(NETWORK_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsNetworkTtsDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(OPENJTALK_READ_TEXT_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonOpenJTalkDoc())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SAY_APPLESCRIPT)&quot;
	sReplace = ConvertFromUrl(fsTemporaryTtsAppleScript())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SAY_APPLESCRIPT_SLOWLY)&quot;
	sReplace = ConvertFromUrl(fsTemporaryTtsAppleScript())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SAY_APPLESCRIPT_QUICKLY)&quot;
	sReplace = ConvertFromUrl(fsTemporaryTtsAppleScript())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SAY_APPLESCRIPT_SYSTEM_VOICE)&quot;
	sReplace = ConvertFromUrl(fsTemporaryTtsAppleScript())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(CREATE_QR_LABEL_PY)&quot;
	sReplace = ConvertFromUrl(fsPythonCreateQR())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Work directory also known As My Documents or home
	sFind = &quot;(HOME)&quot;
	sReplace = fsGetHomeDir()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Current time reformatted so that you can use it in a filename
	sFind = &quot;(NOW)&quot;
	sReplace = fsFileTime()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(SOUND_GALLERY)&quot;
	sReplace = soundsDirectory()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos; Sample image for movie clip with embedded speech
	sFind = &quot;(POSTER_IMG)&quot;
	sReplace = ConvertFromUrl(fsPosterImg())
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos; Sample image for movie clip with embedded speech
	sFind = &quot;(POSTER2_IMG)&quot;
	sReplace = ConvertFromUrl(fsPoster2Png)
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Choose an image for your movie clip with embedded speech
	If InStr(sA,&quot;(MY_IMAGE)&quot;) &lt;&gt; 0 Then
		sFind = &quot;(MY_IMAGE)&quot;
		sReplace = fsGetPicturePath()
		sA = fsReplaceText(sA,sFind,sReplace)
	End If
	&apos;New line
	sFind = &quot;(/NL)&quot;
	sReplace = Chr(13)
	sA = fsReplaceText(sA,sFind,sReplace)
	&apos;
	replaceLocalTokensWithStr = sA
End Function


Function ReplaceWebTokensWithStr( _
	sA As String, _
	ByVal sB As String) As String
	Dim sFind As String
	Dim sReplace As String
	
	sB = fsSuperTrim(sB, &quot;&quot;)
	sFind = &quot;(OOO_WEBTEXTBIG)&quot;
	sReplace = fsEscapeStr(Left(Trim(sB),9999))
	&apos; A lot of text. Use if you have a dedicated online speech server.
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(OOO_WEBTEXT)&quot;
	sReplace = fsEscapeStr(Left(Trim(sB),999))
	&apos; Use with free online text-To-speech utilities
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(OOO_WEBTEXT250)&quot;
	sReplace = fsEscapeStr(Left(Trim(sB),249))
	&apos; Use with online QRCode utilities
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(OOO_WEBTEXTSMALL)&quot;
	&apos; Use with Google Translate to ensure that the text-To-speech is enabled
	sReplace = fsEscapeStr(Left(Trim(sB),99))
	sA = fsReplaceText(sA,sFind,sReplace)
	ReplaceWebTokensWithStr = sA
	
	sFind = &quot;(OOO_WEBTEXTDEFINITION)&quot;
	&apos; Use with an on-line dictionary.
	&apos;
	sReplace = LCase(fsEscapeStr(fsQuickTitle(1, 99, fsTrimSpecial(sB,  &quot; `_-*#&gt;_&quot;))))
	&apos; sReplace = fsTrimSpecial(sReplace, &quot; `_-*#&gt;_&quot;)
	sA = fsReplaceText(sA,sFind,sReplace)
	ReplaceWebTokensWithStr = sA
End Function


Function replacePublicTokensWithStr( _
	sA As String) As String
	Dim sFind As String
	Dim sReplace As String
	
	sFind = &quot;(AUTHOR)&quot;
	sReplace = fsReplaceText(fsThisDocAuthor,&quot; &quot;,Chr$(160)) &apos;&amp;nbsp;
	sA = fsReplaceText(sA,sFind,sReplace)
	
	sFind = &quot;(TITLE)&quot;
	sReplace = fsReplaceText(fsThisDocTitle,&quot; &quot;,Chr$(160)) &apos;&amp;nbsp;
	If sReplace = &quot;&quot; Then
		sReplace = fsDateMyRegion(1) &amp; &quot;_&quot; &amp; fsTimeMyRegion(1)
	End If
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Current date
	sFind = &quot;(DATE)&quot;
	sReplace = fsReplaceText(fsDateMyRegion(1),&quot; &quot;,Chr$(160)) &apos;&amp;nbsp;
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Current time As spoken in region
	sFind = &quot;(TIME)&quot;
	sReplace = fsTimeMyRegion(1)
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Current day of week As spoken in region
	sFind = &quot;(WEEKDAY)&quot;
	sReplace = fsWeekDayMyRegion()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Language - en for English fr for French etc. ISO_639-1
	sFind = &quot;(LANGUAGE_CODE)&quot;
	sReplace = fsGetLanguage()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Country - US for United States FR for France etc.
	sFind = &quot;(COUNTRY_CODE)&quot;
	sReplace = fsGetCountry()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos;Language And Region en-US or fr-FR
	sFind = &quot;(LANGUAGE_COUNTRY_CODE)&quot;
	sReplace = fsGetLanguage() &amp; &quot;-&quot; &amp; fsGetCountry()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos; Selection Country - US for United States FR for France etc.
	sFind = &quot;(SELECTION_COUNTRY_CODE)&quot;
	sReplace = fsSelectionCountry()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos; Selection Language - en for English fr for French etc. ISO_639-1
	sFind = &quot;(SELECTION_LANGUAGE_CODE)&quot;
	sReplace = fsSelectionLanguage()
	sA = fsReplaceText(sA,sFind,sReplace)
	
	&apos; Selection Language And Region en-US or fr-FR
	sFind = &quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;
	sReplace = fsSelectionLanguageAndRegion(True)
	sA = fsReplaceText(sA,sFind,sReplace)
	replacePublicTokensWithStr = sA
End Function


Function fsFileTime() As String
	&apos;Revised 2020-02-17_15-46-33 so all versions and locales return the same value
	
	fsFileTime = Join(Array(Year(Now), _
	&quot;-&quot;, _
	fsPrefixZeroes(Month(Now),2), _
	&quot;-&quot;, _
	fsPrefixZeroes(Day(Now),2), _
	&quot;_&quot;, _
	format(Now,&quot;hh&quot;), _
	&quot;-&quot;, _
	fsPrefixZeroes(Minute(Now),2), _
	&quot;-&quot;, _
	fsPrefixZeroes(Second(Now),2)), _
	&quot;&quot;)
End Function


Function fsPathSettings( _
	sPathType As String, _
	Optional bshowall As Boolean, _
	Optional ListIndex As Integer) As String
	&apos; Gets a special configured PathSetting
	Dim oSettings,oPathSettings As Object
	Dim sPath As String
	Dim PathList() As String
	Dim MaxIndex As Integer
	Dim oPS As Object
	
	oPS = createUnoService(&quot;com.sun.star.util.PathSettings&quot;)
	
	If Not ismissing(bShowall) Then
		If bShowAll Then
			ShowPropertyValues(oPS)
			Exit Function
		End If
	End If
	sPath = oPS.getPropertyValue(sPathType)
	If Not ismissing(ListIndex) Then
		&apos; Share And User-Directory
		If InStr(1,sPath,&quot;;&quot;) &lt;&gt; 0 Then
			PathList = ArrayoutofString(sPath,&quot;;&quot;,MaxIndex)
			If ListIndex &lt;= MaxIndex Then
				sPath = PathList(ListIndex)
			Else
				MsgBox(fsLookUpTerm(&quot;s_string-cannot-be-analyzed&quot;), _
				48, _
				fsLookUpTerm(&quot;s_read-text&quot;))
			End If
		End If
	End If
	If InStr(1,sPath,&quot;;&quot;) = 0 Then
		fsPathSettings = ConvertToUrl(sPath)
	Else
		fsPathSettings = sPath
	End If
End Function


Function fiStringToInteger( _
	value As String) As Integer
	Dim b As Integer
	b = 0
	Dim v As String
	v = Trim(value)
	
	On Error Goto CONVERSIONERROR
	b = value
	fiStringToInteger = b
	Exit Function
	CONVERSIONERROR:
	
	fiStringToInteger = 0
End Function


Function fsSelectionLanguageAndRegion( _
	Optional bIgnoreInstalledVoices) As String
	Dim sA, sB As String
&apos;Language and Region
	If s_CaBcVancouverHolgateJamesReadtextextensionWorkingCountryLanguage = &quot;&quot; Then
		If ismissing(bIgnoreInstalledVoices) Then
			bIgnoreInstalledVoices = True
		End If
		sB = fsSelectionLanguage()
		sA = sB &amp; &quot;-&quot; &amp; fsSelectionCountry()

		If bIgnoreInstalledVoices Then
			fsSelectionLanguageAndRegion = sA
		Else
			Select Case fsGetOS()
				Case &quot;WINDOWS&quot;
				If fbWindowsHasVoiceInThisLanguage(sA) Then
					&apos; use language and locale
					fsSelectionLanguageAndRegion = sA
				ElseIf fbWindowsHasVoiceInThisLanguage(sB) Then
					&apos; use language only
					fsSelectionLanguageAndRegion = sB
				Else
					&apos; try using the language only...
					fsSelectionLanguageAndRegion = sB
				End If
				Case Else
				fsSelectionLanguageAndRegion = sA
			End Select
		End If
	Else
		fsSelectionLanguageAndRegion = s_CaBcVancouverHolgateJamesReadtextextensionWorkingCountryLanguage
	End If
End Function


Function fbWindowsHasVoiceInThisLanguage( _
	Optional ByVal sLang) As Boolean
	&apos; Since Windows Vista, we can use Speech XML
	&apos; https://www.w3.org/TR/speech-synthesis
	&apos; Determine which SAPI voices are installed, then
	&apos; if we have a modern voice from Windows Vista, Windows 7 or above
	&apos; then return true, else if no voices found, then return False
	Dim Sapi As Object
	Dim n,n1 As Integer
	Dim s1, s2 As String
	
	If ismissing(sLang) Then
		sLang = fsGetSetting(&quot;language&quot;)
	End If
	sLang = LCase(sLang)
	fbWindowsHasVoiceInThisLanguage = False
	Set Sapi = CreateObject(&quot;Sapi.SpVoice&quot;)
	s1 = LCase(isoToEnglish(sLang))
	&apos;let&apos;s see if we recognize the language s1
	For n = 0 To Sapi.GetVoices.Count - 1
		s2 = LCase(Sapi.GetVoices.Item(n).GetDescription)
		If InStr(s2,s1) &lt;&gt; 0 Then
			fbWindowsHasVoiceInThisLanguage = True
			Exit For
		End If
	Next
	Set Sapi = Nothing
	Exit Function
	VoiceTestError
	
	fbWindowsHasVoiceInThisLanguage = False
	On Error Resume Next
End Function


Function isoToEnglish( _
	ByVal s1) As String
	&apos; Returns name of language, if known
	Dim S2 As String
	
	If Right(s1,1) = &quot;-&quot; Then
		s1 = Left(s1,Len(s1 - 1))
	End If
	Select Case LCase(s1)
		Case &quot;en-us&quot;
		S2 = &quot;English (United States)&quot;
		Case &quot;en-gb&quot;
		S2 = &quot;English (Great Britain)&quot;
		Case &quot;en-vg&quot;
		S2 = &quot;English (British Virgin Islands)&quot;
		Case &quot;en-io&quot;
		S2 = &quot;English (Great Britain)&quot;
		Case &quot;en-gg&quot;
		S2 = &quot;English (Guernsey)&quot;
		Case &quot;en-au&quot;
		S2 = &quot;English (Australia)&quot;
		Case &quot;en-bz&quot;
		S2 = &quot;English (Belize)&quot;
		Case &quot;en-ca&quot;
		S2 = &quot;English (Canada)&quot;
		Case &quot;en-bs&quot;
		S2 = &quot;English (Bahamas)&quot;
		Case &quot;en-hk&quot;
		S2 = &quot;English (Hong Kong)&quot;
		Case &quot;en-in&quot;
		S2 = &quot;English (India)&quot;
		Case &quot;en-id&quot;
		S2 = &quot;English (Indonesia)&quot;
		Case &quot;en-ie&quot;
		S2 = &quot;English (Ireland)&quot;
		Case &quot;en-jm&quot;
		S2 = &quot;English (Jamaica)&quot;
		Case &quot;en-my&quot;
		S2 = &quot;English (Malaysia)&quot;
		Case &quot;en-nz&quot;
		S2 = &quot;English (New Zealand)&quot;
		Case &quot;en-ph&quot;
		S2 = &quot;English (Philippines)&quot;
		Case &quot;en-sg&quot;
		S2 = &quot;English (Singapore)&quot;
		Case &quot;en-za&quot;
		S2 = &quot;English (South Africa)&quot;
		Case &quot;en-tt&quot;
		S2 = &quot;English (Trinidad &quot; &apos; sic
		Case &quot;en-zw&quot;
		S2 = &quot;English (Zimbabwe)&quot;
		Case &quot;en&quot;
		S2 = &quot;English&quot;
		Case &quot;fr-be&quot;
		S2 = &quot;French (Belgium)&quot;
		Case &quot;fr-ca&quot;
		S2 = &quot;French (Canada)&quot;
		Case &quot;fr-cg&quot;
		S2 = &quot;French (Congo)&quot;
		Case &quot;fr-ch&quot;
		S2 = &quot;French (Switzerland)&quot;
		Case &quot;fr-ci&quot;
		S2 = &quot;French (Ivory Coast)&quot;
		Case &quot;fr-cm&quot;
		S2 = &quot;French (Cameroon)&quot;
		Case &quot;fr-fr&quot;
		S2 = &quot;French (France)&quot;
		Case &quot;fr-ht&quot;
		S2 = &quot;French (Haiti)&quot;
		Case &quot;fr-lu&quot;
		S2 = &quot;French (Luxembourg)&quot;
		Case &quot;fr-ma&quot;
		S2 = &quot;French (Morocco)&quot;
		Case &quot;fr-mc&quot;
		S2 = &quot;French (Monaco)&quot;
		Case &quot;fr-ml&quot;
		S2 = &quot;French (Mali)&quot;
		Case &quot;fr-re&quot;
		S2 = &quot;French (Reunion)&quot;
		Case &quot;fr-sn&quot;
		S2 = &quot;French (Senegal)&quot;
		Case &quot;fr&quot;
		S2 = &quot;French&quot;
		Case &quot;it&quot;,&quot;it-it&quot;
		S2 = &quot;Italian&quot;
		Case &quot;de-at&quot;
		S2 = &quot;German (Austria)&quot;
		Case &quot;de-ch&quot;
		S2 = &quot;German (Switzerland)&quot;
		Case &quot;de-de&quot;
		S2 = &quot;German (Germany)&quot;
		Case &quot;de-li&quot;
		S2 = &quot;German (Lithuania)&quot;
		Case &quot;de-lu&quot;
		S2 = &quot;German (Luxembourg)&quot;
		Case &quot;de&quot;
		S2 = &quot;German&quot;
		Case &quot;es-es&quot;
		S2 = &quot;Spanish (Spain)&quot;
		Case &quot;es-ar&quot;
		S2 = &quot;Spanish (Argentina)&quot;
		Case &quot;es-bo&quot;
		S2 = &quot;Spanish (Bolivia)&quot;
		Case &quot;es-cl&quot;
		S2 = &quot;Spanish (Chile)&quot;
		Case &quot;es-co&quot;
		S2 = &quot;Spanish (Colombia)&quot;
		Case &quot;es-cr&quot;
		S2 = &quot;Spanish (Costa Rica)&quot;
		Case &quot;es-do&quot;
		S2 = &quot;Spanish (Dominican Republic)&quot;
		Case &quot;es-ec&quot;
		S2 = &quot;Spanish (Ecuador)&quot;
		Case &quot;es-sv&quot;
		S2 = &quot;Spanish (Svalbard) &quot;
		Case &quot;es-gt&quot;
		S2 = &quot;Spanish (Guatemala)&quot;
		Case &quot;es-hn&quot;
		S2 = &quot;Spanish (Honduras)&quot;
		Case &quot;es-mx&quot;
		S2 = &quot;Spanish (Mexico)&quot;
		Case &quot;es-ni&quot;
		S2 = &quot;Spanish (Nicaragua)&quot;
		Case &quot;es-pa&quot;
		S2 = &quot;Spanish (Panama)&quot;
		Case &quot;es-py&quot;
		S2 = &quot;Spanish (Paraguay)&quot;
		Case &quot;es-pe&quot;
		S2 = &quot;Spanish (Peru)&quot;
		Case &quot;es-pr&quot;
		S2 = &quot;Spanish (Puerto Rico)&quot;
		Case &quot;es-us&quot;
		S2 = &quot;Spanish (United States)&quot;
		Case &quot;es-uy&quot;
		S2 = &quot;Spanish (Uraguay)&quot;
		Case &quot;es-ve&quot;
		S2 = &quot;Spanish (Venezuela)&quot;
		Case &quot;es&quot;
		S2 = &quot;Spanish&quot;
		Case &quot;ru&quot;,&quot;ru-ru&quot;
		S2 = &quot;Russian&quot;
		Case &quot;hi&quot;,&quot;hi-in&quot;
		S2 = &quot;Hindi&quot;
		Case &quot;af&quot;,&quot;af-za&quot;
		S2 = &quot;Afrikaans&quot;
		Case &quot;ak&quot;,&quot;ak-gh&quot;
		S2 = &quot;Akan&quot;
		Case &quot;an&quot;,&quot;an-es&quot;
		S2 = &quot;Argonese&quot;
		Case &quot;az&quot;,&quot;az-az&quot;
		S2 = &quot;Azerbaijani&quot;
		Case &quot;ar-sa&quot;
		S2 = &quot;Arabic (Saudi Arabia)&quot;
		Case &quot;ar-dz&quot;
		S2 = &quot;Arabic (Algeria)&quot;
		Case &quot;ar-bh&quot;
		S2 = &quot;Arabic (Bhutan)&quot;
		Case &quot;ar-eg&quot;
		S2 = &quot;Arabic (Egypt)&quot;
		Case &quot;ar-iq&quot;
		S2 = &quot;Arabic (Iraq)&quot;
		Case &quot;ar-jo&quot;
		S2 = &quot;Arabic (Jordan)&quot;
		Case &quot;ar-kw&quot;
		S2 = &quot;Arabic (Kuwait)&quot;
		Case &quot;ar-lb&quot;
		S2 = &quot;Arabic (Lebanon)&quot;
		Case &quot;ar-ly&quot;
		S2 = &quot;Arabic (Libya)&quot;
		Case &quot;ar-om&quot;
		S2 = &quot;Arabic (Oman)&quot;
		Case &quot;ar-qa&quot;
		S2 = &quot;Arabic (Qatar)&quot;
		Case &quot;ar-sy&quot;
		S2 = &quot;Arabic (Syria)&quot;
		Case &quot;ar-tn&quot;
		S2 = &quot;Arabic (Tunisia)&quot;
		Case &quot;ar-ae&quot;
		S2 = &quot;Arabic (United Arab Emirates)&quot;
		Case &quot;ar-ye&quot;
		S2 = &quot;Arabic (Yemen)&quot;
		Case &quot;ar&quot;
		S2 = &quot;Arabic&quot;
		Case &quot;be&quot;,&quot;be-by&quot;
		S2 = &quot;Belarusian&quot;
		Case &quot;bm&quot;,&quot;bm-ml&quot;
		S2 = &quot;Bambara&quot;
		Case &quot;beq&quot;,&quot;beq-cg&quot;
		S2 = &quot;Beembe&quot;
		Case &quot;bk&quot;,&quot;bkw-cg&quot;
		S2 = &quot;Bekwel&quot;
		Case &quot;bn&quot;,&quot;bn-bd&quot;
		S2 = &quot;Bengali&quot;
		Case &quot;bs&quot;,&quot;bs-bn&quot;
		S2 = &quot;Bosnian&quot;
		Case &quot;buc&quot;,&quot;buc-yt&quot;
		S2 = &quot;Bushi&quot;
		Case &quot;eu&quot;,&quot;eu-fr&quot;,&quot;eu-es&quot;
		S2 = &quot;Basque&quot;
		Case &quot;bg&quot;,&quot;bg-bg&quot;
		S2 = &quot;Bulgarian&quot;
		Case &quot;ca&quot;,&quot;ca-es&quot;
		S2 = &quot;Catalan&quot;
		Case &quot;ceb&quot;,&quot;ceb-ph&quot;
		S2 = &quot;Cebuano&quot;
		Case &quot;cop&quot;,&quot;cop-eg&quot;
		S2 = &quot;Coptic&quot;
		Case &quot;csb&quot;,&quot;csb-pl&quot;
		S2 = &quot;Kashubian&quot;
		Case &quot;cv&quot;,&quot;cv-ru&quot;
		S2 = &quot;Chuvash&quot;
		Case &quot;cs&quot;,&quot;cs-cz&quot;
		S2 = &quot;Czech&quot;
		Case &quot;cy&quot;,&quot;cy-gb&quot;
		S2 = &quot;Welsh&quot;
		Case &quot;da&quot;,&quot;da-dk&quot;
		S2 = &quot;Danish&quot;
		Case &quot;dsb&quot;,&quot;dsb-de&quot;
		S2 = &quot;Sorbian, Lower&quot;
		Case &quot;ebo&quot;,&quot;ebo-cg&quot;
		S2 = &quot;Teke-Eboo&quot;
		Case &quot;ee&quot;,&quot;ee-gh&quot;
		S2 = Chr(201) &amp; &quot;w&quot; &amp; Chr(233)
		Case &quot;eo&quot;,&quot;eo-&quot;
		S2 = &quot;Esperanto&quot;
		Case &quot;et&quot;,&quot;et-ee&quot;
		S2 = &quot;Estonian&quot;
		Case &quot;fa&quot;,&quot;fa-ir&quot;
		S2 = &quot;Farsi&quot;
		Case &quot;fi&quot;,&quot;fi-fi&quot;
		S2 = &quot;Finnish&quot;
		Case &quot;fj&quot;,&quot;fj-fj&quot;
		S2 = &quot;Fijian&quot;
		Case &quot;fu&quot;,&quot;fu-it&quot;
		S2 = &quot;Friulian&quot;
		Case &quot;fy&quot;,&quot;fy-nl&quot;
		S2 = &quot;Frisian&quot;
		Case &quot;gd&quot;,&quot;gd-gb&quot;
		S2 = &quot;Gaelic&quot;
		Case &quot;gl&quot;,&quot;gl-es&quot;
		S2 = &quot;Galician&quot;
		Case &quot;gu&quot;,&quot;gu-in&quot;
		S2 = &quot;Gujarati&quot;
		Case &quot;ga&quot;,&quot;ga-ie&quot;
		S2 = &quot;Irish&quot;
		Case &quot;gd&quot;,&quot;gd-gb&quot;
		S2 = &quot;Gaelic&quot;
		Case &quot;gsc&quot;,&quot;gsc-fr&quot;
		S2 = &quot;Gascon&quot;
		Case &quot;gug&quot;,&quot;gug-py&quot;
		S2 = &quot;Guarani&quot;
		Case &quot;haw&quot;,&quot;haw-us&quot;
		S2 = &quot;Hawaiian&quot;
		Case &quot;hl&quot;,&quot;hl-gr&quot;
		S2 = &quot;Greek&quot;
		Case &quot;he&quot;,&quot;he-il&quot;
		S2 = &quot;Hebrew&quot;
		Case &quot;hr&quot;,&quot;hr-hr&quot;
		S2 = &quot;Croatian&quot;
		Case &quot;hsb&quot;,&quot;hsb-de&quot;
		S2 = &quot;Sorbian, Upper&quot;
		Case &quot;ht&quot;,&quot;ht-ht&quot;
		S2 = &quot;Haitian&quot;
		Case &quot;hu&quot;,&quot;hu-hu&quot;
		S2 = &quot;Hungarian&quot;
		Case &quot;ha&quot;,&quot;ha-gh&quot;,&quot;ha-ng&quot;
		S2 = &quot;Hausa&quot;
		Case &quot;hil&quot;,&quot;hil-ph&quot;
		S2 = &quot;Hiligaynon&quot;
		Case &quot;ia&quot;,&quot;ia-&quot;
		S2 = &quot;Interlingua&quot;
		Case &quot;id&quot;,&quot;id-id&quot;
		S2 = &quot;Indonesian&quot;
		Case &quot;is&quot;,&quot;is-is&quot;
		S2 = &quot;Icelandic&quot;
		Case &quot;jbo&quot;,&quot;jbo-&quot;
		S2 = &quot;Lojban&quot;
		Case &quot;jp&quot;,&quot;jp-jp&quot; , &quot;ja&quot;, &quot;ja-jp&quot;
		S2 = &quot;Japanese&quot;
		Case &quot;kab&quot;,&quot;kab-dz&quot;
		S2 = &quot;Kabyle&quot;
		Case &quot;ki&quot;,&quot;ki-ke&quot;
		S2 = &quot;Gikuyu&quot;
		Case &quot;kk&quot;,&quot;kk-kz&quot;
		S2 = &quot;Kazak&quot;
		Case &quot;kl&quot;,&quot;kl-gl&quot;
		S2 = &quot;Kalaallisut&quot;
		Case &quot;ksf&quot;,&quot;ksf-cm&quot;
		S2 = &quot;Bafia&quot;
		Case &quot;ko&quot;,&quot;ko-kp&quot;,&quot;ko-kr&quot;
		S2 = &quot;Korean&quot;
		Case &quot;ka&quot;,&quot;ka-ge&quot;
		S2 = &quot;Georgian&quot;
		Case &quot;km&quot;,&quot;km-kh&quot;
		S2 = &quot;Khmer&quot;
		Case &quot;kn&quot;,&quot;kn-in&quot;
		S2 = &quot;Kannada&quot;
		Case &quot;kok&quot;,&quot;kok-in&quot;
		S2 = &quot;Konkani&quot;
		Case &quot;ku&quot;,&quot;ku-sy&quot;,&quot;ku-tr&quot;
		S2 = &quot;Kurdish&quot;
		Case &quot;ky&quot;,&quot;ky-kg&quot;
		S2 = &quot;Kirghiz&quot;
		Case &quot;la&quot;,&quot;la-va&quot;
		S2 = &quot;Latin&quot;
		Case &quot;lb&quot;,&quot;lb-lu&quot;
		S2 = &quot;Luxembourgish&quot;
		Case &quot;ldi&quot;,&quot;ldi-cg&quot;
		S2 = &quot;Lari&quot;
		Case &quot;lg&quot;,&quot;lg-ug&quot;
		S2 = &quot;Ganda&quot;
		Case &quot;ln&quot;,&quot;ln-cd&quot;
		S2 = &quot;Lingala&quot;
		Case &quot;lo&quot;,&quot;lo-la&quot;
		S2 = &quot;Lao&quot;
		Case &quot;lt&quot;,&quot;lt-lt&quot;
		S2 = &quot;Lithuanian&quot;
		Case &quot;ltg&quot;,&quot;ltg-lv&quot;
		S2 = &quot;Latgalian&quot;
		Case &quot;lv&quot;,&quot;lv-lv&quot;
		S2 = &quot;Latvian&quot;
		Case &quot;mdw&quot;,&quot;mdw-cg&quot;
		S2 = &quot;Mbochi&quot;
		Case &quot;mi&quot;,&quot;mi-nz&quot;
		S2 = &quot;Maori (New Zealand)&quot;
		Case &quot;ms&quot;,&quot;ms-sg&quot;,&quot;ms-my&quot;,&quot;ms-id&quot;,&quot;ms-bn&quot;
		S2 = &quot;Malay&quot;
		Case &quot;mk&quot;,&quot;mk-mk&quot;
		S2 = &quot;Macedonian&quot;
		Case &quot;mkw&quot;,&quot;mkw-cg&quot;
		S2 = &quot;Kituba&quot;
		Case &quot;mn&quot;,&quot;mn-mn&quot;
		S2 = &quot;Mongolian&quot;
		Case &quot;mo-mn&quot;,&quot;mo&quot;
		S2 = &quot;Moldavian&quot;
		Case &quot;mos&quot;,&quot;mos-bf&quot;
		S2 = &quot;Moore&quot;
		Case &quot;mr&quot;,&quot;mr-in&quot;
		S2 = &quot;Marathi&quot;
		Case &quot;nds&quot;,&quot;nds-de&quot;
		S2 = &quot;Low German&quot;
		Case &quot;nl&quot;,&quot;nl-nl&quot;,&quot;nl-be&quot;
		S2 = &quot;Dutch&quot;
		Case &quot;nn&quot;,&quot;nn-no&quot;
		S2 = &quot;Norwegian Norsk&quot;
		Case &quot;nb&quot;,&quot;nb-no&quot;
		S2 = &quot;Norwegian Bokmal&quot;
		Case &quot;no&quot;,&quot;no-no&quot;
		S2 = &quot;Norwegian&quot;
		Case &quot;nr&quot;,&quot;nr-za&quot;
		S2 = &quot;Ndebele, South&quot;
		Case &quot;nso&quot;,&quot;nso-za&quot;
		S2 = &quot;Northern Sotho&quot;
		Case &quot;ny&quot;,&quot;ny-mw&quot;
		S2 = &quot;Nyanja&quot;
		Case &quot;oc&quot;,&quot;oc-fr&quot;
		S2 = &quot;Occitan&quot;
		Case &quot;om&quot;,&quot;om-et&quot;
		S2 = &quot;Oromo&quot;
		Case &quot;pap&quot;,&quot;pap-aw&quot;,&quot;pap-an&quot;
		S2 = &quot;Papiamento&quot;
		Case &quot;pl&quot;,&quot;pl-pl&quot;
		S2 = &quot;Polish&quot;
		Case &quot;pli&quot;,&quot;pli-&quot;
		S2 = &quot;Pali&quot;
		Case &quot;plt&quot;,&quot;plt-mg&quot;
		S2 = &quot;Malagasy&quot;
		Case &quot;pt-br&quot;
		S2 = &quot;Portuguese (Brazil)&quot;
		Case &quot;pt-pt&quot;
		S2 = &quot;Portuguese (Portugal)&quot;
		Case &quot;pt&quot;
		S2 = &quot;Portuguese&quot;
		Case &quot;qtz&quot;,&quot;qtz-&quot;
		S2 = &quot;KeyID&quot;
		Case &quot;qul&quot;,&quot;quh&quot;,&quot;qu&quot;,&quot;qul-bo&quot;,&quot;qu-ec&quot;,&quot;quh-bo&quot;
		S2 = &quot;Quechua&quot;
		Case &quot;rm&quot;,&quot;rm-ch&quot;
		S2 = &quot;Rhaeto-Romance&quot;
		Case &quot;ro&quot;,&quot;ro-ro&quot;
		S2 = &quot;Romanian&quot;
		Case &quot;ru&quot;,&quot;ru-ru&quot;
		S2 = &quot;Russian&quot;
		Case &quot;rue&quot;,&quot;rue-sk&quot;,&quot;rue-ua&quot;
		S2 = &quot;Rusyan&quot;
		Case &quot;rw&quot;,&quot;rw-rw&quot;
		S2 = &quot;Kinyarwanda&quot;
		Case &quot;smn&quot;,&quot;se&quot;,&quot;smj&quot;,&quot;sma&quot;,&quot;smn-fi&quot;,&quot;smn-ru&quot;,&quot;smj-no&quot;,&quot;smj-se&quot;,&quot;se-fi&quot;,&quot;se-no&quot;,&quot;se-se&quot;,&quot;sms-fi&quot;,&quot;sma-no&quot;,&quot;sma-se&quot;
		S2 = &quot;Sami&quot;
		Case &quot;sh&quot;,&quot;sr&quot;,&quot;sr-me&quot;,&quot;sr-su&quot;,&quot;sr-rs&quot;,&quot;sh-me&quot;,&quot;sh-yu&quot;,&quot;sh-rs&quot;,&quot;sh-su&quot;
		S2 = &quot;Serbian&quot;
		Case &quot;shs&quot;,&quot;shs-ca&quot;
		S2 = &quot;Shuswap&quot;
		Case &quot;sk&quot;,&quot;sk-sk&quot;
		S2 = &quot;Slovakian&quot;
		Case &quot;sl&quot;,&quot;sl-si&quot;
		S2 = &quot;Slovene&quot;
		Case &quot;so&quot;,&quot;so-so&quot;
		S2 = &quot;Somali&quot;
		Case &quot;sq&quot;,&quot;sq-al&quot;
		S2 = &quot;Albanian&quot;
		Case &quot;src&quot;,&quot;src-it&quot;
		S2 = &quot;Sardinian (Logudorese)&quot;
		Case &quot;sdc&quot;,&quot;sdc-it&quot;
		S2 = &quot;Sardinian (Sassarese)&quot;
		Case &quot;ss&quot;,&quot;ss-za&quot;
		S2 = &quot;Swazi&quot;
		Case &quot;st&quot;,&quot;st-za&quot;
		S2 = &quot;Southern Sotho&quot;
		Case &quot;sw&quot;,&quot;sw-tz&quot;,&quot;sw-ke&quot;
		S2 = &quot;Swahili&quot;
		Case &quot;swb&quot;,&quot;swb-yt&quot;
		S2 = &quot;Maore&quot;
		Case &quot;sv&quot;,&quot;sv-se&quot;
		S2 = &quot;Swedish&quot;
		Case &quot;tek&quot;,&quot;tek-cg&quot;
		S2 = &quot;Teke-Ibali&quot;
		Case &quot;tet&quot;,&quot;tet-id&quot;,&quot;tet-tl&quot;
		S2 = &quot;Tetun&quot;
		Case &quot;tg&quot;,&quot;tg-tj&quot;
		S2 = &quot;Tajic&quot;
		Case &quot;th&quot;,&quot;th-th&quot;
		S2 = &quot;Thai&quot;
		Case &quot;ti&quot;,&quot;ti-er&quot;,&quot;ti-et&quot;
		S2 = &quot;Tigrigna&quot;
		Case &quot;tk&quot;,&quot;tk-tm&quot;
		S2 = &quot;Turkmen&quot;
		Case &quot;tl&quot;,&quot;tl-ph&quot;
		S2 = &quot;Tagalog&quot;
		Case &quot;tn&quot;,&quot;tn-bw&quot;,&quot;tn-za&quot;
		S2 = &quot;Tswana&quot;
		Case &quot;tpi&quot;,&quot;tpi-pg&quot;
		S2 = &quot;Tok Pisin&quot;
		Case &quot;tr&quot;,&quot;tr-tr&quot;
		S2 = &quot;Turkish&quot;
		Case &quot;tt&quot;,&quot;tt-ru&quot;
		S2 = &quot;Tatar&quot;
		Case &quot;ts&quot;,&quot;ts-za&quot;
		S2 = &quot;Tsonga&quot;
		Case &quot;ty&quot;,&quot;ty-pf&quot;
		S2 = &quot;Tahitian&quot;
		Case &quot;tyx&quot;,&quot;tyx-cg&quot;
		S2 = &quot;Teke-Tyee&quot;
		Case &quot;uk&quot;,&quot;uk-ua&quot;
		S2 = &quot;Ukrainian&quot;
		Case &quot;ur&quot;,&quot;ur-in&quot;,&quot;ur-pk&quot;
		S2 = &quot;Urdu&quot;
		Case &quot;uz&quot;,&quot;uz-uz&quot;
		S2 = &quot;Uzbec&quot;
		Case &quot;ve&quot;,&quot;ve-za&quot;
		S2 = &quot;Venda&quot;
		Case &quot;vi&quot;,&quot;vi-vn&quot;
		S2 = &quot;Vietnamese&quot;
		Case &quot;vif&quot;,&quot;vif-cg&quot;
		S2 = &quot;Vili&quot;
		Case &quot;wa&quot;,&quot;wa-be&quot;
		S2 = &quot;Walloon&quot;
		Case &quot;xh&quot;,&quot;xh-za&quot;
		S2 = &quot;Xhosa&quot;
		Case &quot;yi&quot;,&quot;yi-us&quot;
		s2 = &quot;Yiddish&quot;
		Case &quot;yo&quot;,&quot;yo-ng&quot;
		S2 = &quot;Yoruba&quot;
		Case &quot;zh-cn&quot;
		S2 = &quot;Chinese (Simplified)&quot;
		Case &quot;zh-tw&quot;
		S2 = &quot;Chinese (Traditional)&quot;
		Case &quot;zh-hk&quot;
		S2 = &quot;Chinese (Hong Kong)&quot;
		Case &quot;zh-sg&quot;
		S2 = &quot;Chinese (Singapore)&quot;
		Case &quot;zh-mo&quot;
		S2 = &quot;Chinese (Macau)&quot;
		Case &quot;zh-yue&quot;,&quot;zh-yu&quot;
		S2 = &quot;Chinese (Yue)&quot;
		Case &quot;zh&quot;
		S2 = &quot;Chinese&quot;
		Case &quot;zu&quot;,&quot;zu-za&quot;
		S2 = &quot;Zulu&quot;
		Case &quot;zxx&quot;, &quot;zxx-&quot;
		S2 = &quot;Ambiguous Or Missing Language&quot;
		Case Else
		S2 = S1 &apos; not Found, So We Return Iso Language Code.
	End Select
	Isotoenglish = S2
End Function


Function fsRetrieveCalcActiveCellText() As String
	fsRetrieveCalcActiveCellText = fsRetrieveCalcActiveCellProperty(&quot;String&quot;)
End Function


Function fsSelectionLanguage( _
	Optional ByVal sFilter) As String
	Dim longI
	Dim myLocale As New com.sun.star.lang.Locale
	Dim oDoc
	Dim oVC
	Dim sA
	Dim sB
	Dim sC
	Dim sD
	
	If ismissing(sFilter) Then
		&apos; Consider western, Asian, complex or all languages(&quot;&quot;)?
		sFilter = &quot;&quot;
	End If
	
	On Error Resume Next
	sA = &quot;&quot;
	sB = &quot;&quot;
	sC = &quot;&quot;
	sD = &quot;&quot;
	oDoc = ThisComponent
	If oDoc.SupportsService(&quot;com.sun.star.sheet.SpreadsheetDocument&quot;) Then
		sA = fsRetrieveCalcActiveCellProperty(&quot;language&quot;)
		sB = fsRetrieveCalcActiveCellProperty(&quot;string&quot;)
		sC = fsRetrieveCalcActiveCellProperty(&quot;asian-language&quot;)
		sD = fsRetrieveCalcActiveCellProperty(&quot;complex-language&quot;)
	ElseIf oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.drawing.DrawingDocument&quot;) Then
		sA = fsDrawProperty(&quot;language&quot;)
		sB = fsDrawProperty(&quot;string&quot;)
		sC = fsDrawProperty(&quot;asian-language&quot;)
		sD = fsDrawProperty(&quot;complex-language&quot;)
		If sB = &quot;&quot; Then
			&apos; no text is selected.
			On Error Resume Next
			myLocale = ThisComponent.CharLocale
			sA = myLocale.Language
			myLocale = ThisComponent.CharLocaleAsian
			sC = myLocale.Language
			myLocale = ThisComponent.CharLocaleComplex
			sD = myLocale.Language
			PresentErr
			
		End If
	Else
		On Error Resume Next
		oVC = oDoc.getCurrentController.getViewCursor
		sA = oVC.CharLocale.Language
		sB = oVC.GetString()
		sC = oVC.CharLocaleAsian.Language
		sD = oVC.CharLocaleComplex.Language
		
		svcErr
		
	End If
	&apos; The application&apos;s built in CharLocale.Language property does not identify
	&apos; oriental or complex text locales so we use the UTF encoding for the first
	&apos; character to evaluate the language. See &lt;https://www.utf8-chartable.de/unicode-utf8-table.pl&gt;
	&apos; and &lt;https://unicode.org/Public/UNIDATA/Blocks.txt&gt;
	If sFilter = &quot;WEST&quot; Or sFilter = &quot;UNDEFINED&quot; Then
		fsSelectionLanguage = sA
	ElseIf sFilter = &quot;COMPLEX&quot;  Then
		fsSelectionLanguage = sD
	ElseIf sFilter = &quot;ASIA&quot; Then
		If fbIsKorean(sB) Then
			sC = &quot;ko&quot;
		ElseIf fbIsJapanese(sB) Then
			sC = &quot;ja&quot;
		End If
		fsSelectionLanguage = sC
	Else
		If fbIsKorean(sB) Then
			sC = &quot;ko&quot;
		ElseIf fbIsJapanese(sB) Then
			sC = &quot;ja&quot;
		End If
		fsSelectionLanguage = fsUseLanguageType(sA,sB,sC,sD)
	End If
	
	If fsSelectionLanguage = &quot;&quot; Then
		fsSelectionLanguage = fsDocLanguage()
	End If
	Exit Function
	SELECTLANGUAGEERROR
	
	fsSelectionLanguage = fsDocLanguage()
End Function


Function fsSelectionCountry( _
	Optional ByVal sFilter) As String
	Dim longI
	Dim myLocale As New com.sun.star.lang.Locale
	Dim oDoc
	Dim oVC
	Dim sA
	Dim sB
	Dim sC
	Dim sD
	
	If ismissing(sFilter) Then
		&apos; Consider western, Asian, complex, or all?
		sFilter = &quot;&quot;
	End If
	On Error Resume Next
	sA = &quot;&quot;
	sB = &quot;&quot;
	sC = &quot;&quot;
	sD = &quot;&quot;
	oDoc = ThisComponent
	If oDoc.SupportsService(&quot;com.sun.star.sheet.SpreadsheetDocument&quot;) Then
		sA = fsRetrieveCalcActiveCellProperty(&quot;country&quot;)
		sB = fsRetrieveCalcActiveCellProperty(&quot;string&quot;)
		sC = fsRetrieveCalcActiveCellProperty(&quot;asian-country&quot;)
		sD = fsRetrieveCalcActiveCellProperty(&quot;complex-country&quot;)
	ElseIf oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.drawing.DrawingDocument&quot;) Then
		sA = fsDrawProperty(&quot;country&quot;)
		sB = fsDrawProperty(&quot;string&quot;)
		sC = fsDrawProperty(&quot;asian-country&quot;)
		sD = fsDrawProperty(&quot;complex-country&quot;)
		If sB = &quot;&quot; Then
			&apos; no text is selected.
			On Error Resume Next
			myLocale = oDoc.CharLocale
			sA = myLocale.Country
			myLocale = oDoc.CharLocaleAsian
			sC = myLocale.Country
			myLocale = oDoc.CharLocaleComplex
			sD = myLocale.Country
			CountryErr
			
		End If
	Else
		On Error Resume Next
		oVC = oDoc.getCurrentController.getViewCursor
		sA = oVC.CharLocale.Country
		sB = oVC.GetString()
		sC = oVC.CharLocaleAsian.Country
		sD = oVC.CharLocaleComplex.Country
		svcCountryErr
		
	End If
	&apos; The application&apos;s built in CharLocale.Country property does not identify
	&apos; oriental or complex text locales so we use the UTF encoding for the first
	&apos; character to evaluate the country.  See &lt;https://www.utf8-chartable.de/unicode-utf8-table.pl&gt;
	&apos; and &lt;https://unicode.org/Public/UNIDATA/Blocks.txt&gt;
	If sFilter = &quot;WEST&quot; Or sFilter = &quot;UNDEFINED&quot; Then
		fsSelectionCountry = sA
	ElseIf sFilter = &quot;COMPLEX&quot;  Then
		fsSelectionCountry = sD
	ElseIf sFilter = &quot;ASIA&quot; Then
		If fbIsKorean(sB) Then
			sC = &quot;KR&quot;
		ElseIf fbIsJapanese(sB) Then
			sC = &quot;JP&quot;
		End If
		fsSelectionCountry = sC
	Else
		If fbIsKorean(sB) Then
			sC = &quot;KR&quot;
		ElseIf fbIsJapanese(sB) Then
			sC = &quot;JP&quot;
		End If
		fsSelectionCountry = fsUseLanguageType(sA,sB,sC,sD)
	End If
	If fsSelectionCountry = &quot;&quot; Then
		fsSelectionCountry = fsDocCountry()
	End If
	Exit Function
	SELECTCOUNTRYERROR
	
	fsSelectionCountry = fsDocCountry()
End Function


Function fsComplexAsiaOrWest( _
	ByVal sA) As String
	Dim longI As Long
	Dim iLocale As Integer
	Dim sB As String
	Dim x As Integer
	
	sA = Trim(sA)
&apos; Complex languages
	If fbHasLTRMarker(sA) Or fbHasRTLMarker(sA) Then
		fsComplexAsiaOrWest = &quot;COMPLEX&quot;
		Exit Function
	End If
	&apos; Ignore numbers, basic punctuation, telephone network code and 
	&apos; western currency symbols that Asian languages commonly use
	sB = &quot; 0123456789.,-+÷×—–*#$*%#@(){}|!@&lt;&gt;=[]/:¼½¾&quot;&quot;&apos;“”‘’·€£¥¢¤&quot; &amp; _
	&quot;₠₡₢₣₤₥₦₧₨₩₪₫€₭₮₯₰₱₲₳₴₵₶₷₸₹₺⅓⅔⅛⅜⅝&quot; &amp; _
	Chr$(10) &amp; _
	Chr$(13)
	For x = 1 To 100
		If Len(sA) &lt;&gt; 0 And InStr(sB, Left(sA,1)) &lt;&gt; 0 Then
			sA = Mid(sA,2)
			sA = Trim(sA)
		Else
			Exit For
		End If
	Next
	If sA = &quot;&quot; Then
		longI = 0
	Else
		longI = Asc(sA)
	End If
	If longI &gt;= CLng(&quot;&amp;H0000&quot;) And longI &lt;= CLng(&quot;&amp;H058F&quot;) Then
		iLocale = 0 &apos; western
	ElseIf longI &gt;= CLng(&quot;&amp;H3400&quot;) And longI &lt;= CLng(&quot;&amp;H9FFF&quot;) Then
		iLocale = 1 &apos; zh, ja or ko
	ElseIf longI &gt;= CLng(&quot;&amp;H3040&quot;) And longI &lt;= CLng(&quot;&amp;H31FF&quot;) Then
		iLocale = 1 &apos; &quot;ja&quot;
	ElseIf longI &gt;= Asc(&quot;?&quot;) And longI &lt;= Asc(&quot;?&quot;) Then
		iLocale = 1 &apos; &quot;ja&quot;
	ElseIf longI &gt;= CLng(&quot;&amp;HAC00&quot;) And longI &lt;= CLng(&quot;&amp;HD7A3&quot;) Then
		iLocale = 1 &apos; &quot;ko&quot;
	ElseIf longI &gt;= CLng(&quot;&amp;HFFA0&quot;) And longI &lt;= CLng(&quot;&amp;HFFDC&quot;) Then
		iLocale = 1 &apos; &quot;ko&quot;
	Else &apos; western
		iLocale = 0
	End If
	Select Case iLocale
		Case 0
		If fbIsAnURL(sA) Then
			fsComplexAsiaOrWest = &quot;UNDEFINED&quot;
		Else
			fsComplexAsiaOrWest = &quot;WEST&quot;
		End If
		Case Else
		fsComplexAsiaOrWest = &quot;ASIA&quot;
	End Select
End Function


Function fbIsJapanese( _
	ByVal sA) As Boolean
	Dim longI As Long
	Dim sB As String
	Dim x As Integer
	sA = Trim(sA)
	&apos;
	&apos; Ignore numbers, basic punctuation, telephone network code and 
	&apos; western currency symbols that Asian languages commonly use
	sB = &quot; 0123456789.,-+÷×—–*#$*%#@(){}|!@&lt;&gt;=[]/:¼½¾&quot;&quot;&apos;“”‘’·€£¥¢¤&quot; &amp; _
	&quot;₠₡₢₣₤₥₦₧₨₩₪₫€₭₮₯₰₱₲₳₴₵₶₷₸₹₺⅓⅔⅛⅜⅝&quot; &amp; _
	Chr$(10) &amp; _
	Chr$(13)
	For x = 1 To 100
		If Len(sA) &lt;&gt; 0 And InStr(sB, Left(sA,1)) &lt;&gt; 0 Then
			sA = Mid(sA,2)
			sA = Trim(sA)
		Else
			Exit For
		End If
	Next
	If sA = &quot;&quot; Then
		longI = 0
	Else
		longI = Asc(sA)
	End If
	If longI &gt;= 12352 And longI &lt;= 12799 Then
		fbIsJapanese = True &apos; &quot;ja&quot;
	ElseIf longI &gt;= 65381 And longI &lt;= 65439 Then
		fbIsJapanese = True &apos; &quot;ja&quot;
	Else &apos; Complex, Western, Chinese, Korean or ambiguous language
		fbIsJapanese = False
	End If
End Function


Function fbIsKorean( _
	ByVal sA) As Boolean
	Dim longI As Long
	Dim sB As String
	Dim x As Integer
	
	sA = Trim(sA)
	&apos;
	&apos; Ignore numbers, basic punctuation, telephone network code and 
	&apos; western currency symbols that Asian languages commonly use
	sB = &quot; 0123456789.,-+÷×—–*#$*%#@(){}|!@&lt;&gt;=[]/:¼½¾&quot;&quot;&apos;“”‘’·€£¥¢¤&quot; &amp; _
	&quot;₠₡₢₣₤₥₦₧₨₩₪₫€₭₮₯₰₱₲₳₴₵₶₷₸₹₺⅓⅔⅛⅜⅝&quot; &amp; _
	Chr$(10) &amp; _
	Chr$(13)
	For x = 1 To 100
		If Len(sA) &lt;&gt; 0 And InStr(sB, Left(sA,1)) &lt;&gt; 0 Then
			sA = Mid(sA,2)
			sA = Trim(sA)
		Else
			Exit For
		End If
	Next
	If sA = &quot;&quot; Then
		longI = 0
	Else
		longI = Asc(sA)
	End If
	If longI &gt;= 44032 And longI &lt;= 55203 Then
		fbIsKorean = True &apos; &quot;ko&quot;
	ElseIf longI &gt;= 65440 And longI &lt;= 65500 Then
		fbIsKorean = True &apos; &quot;ko&quot;
	Else &apos; Complex, Western, Chinese, Japanese or ambiguous language
		fbIsKorean = False
	End If
End Function


Function fsUseLanguageType( _
	sA, _
	sB, _
	sC, _
	sD) As String
	Dim sE As String
	
	sE = fsComplexAsiaOrWest(sB)
	Select Case sE
		Case &quot;ASIA&quot;
		fsUseLanguageType = sC
		Case &quot;COMPLEX&quot;
		fsUseLanguageType = sD
		Case Else &apos; &quot;WEST&quot; or &quot;UNDEFINED&quot;
		fsUseLanguageType = sA
	End Select
End Function


Function fsDrawText() As String
	&apos;function to get text selection in a drawing or a presentation slide
	fsDrawText = fsDrawProperty(&quot;String&quot;)
End Function


Function fsDrawProperty( _
	strA) As String
	Dim oDoc As Object
	Dim oController As Object
	Dim oSelection As Object
	Dim s1r As String
	
	On Error Goto fsDrawPropertyErr
	s1r = &quot;&quot;
	oDoc = ThisComponent
	oController = oDoc.getCurrentController()
	oSelection = oController.getSelection()
	If oSelection.supportsService(&quot;com.sun.star.text.TextCursor&quot;) Then
		Select Case strA
			Case &quot;country&quot;
			s1r = oSelection.CharLocale.Country
			Case &quot;language&quot;
			s1r = oSelection.CharLocale.Language
			Case &quot;asian-language&quot;
			s1r = oSelection.CharLocaleAsian.Language
			Case &quot;complex-language&quot;
			s1r = oSelection.CharLocaleComplex.Language
			Case &quot;asian-country&quot;
			s1r = oSelection.CharLocaleAsian.Country
			Case &quot;complex-country&quot;
			s1r = oSelection.CharLocaleComplex.Country
			Case Else
			s1r = oSelection.getString()
		End Select
	End If
	fsDrawProperty = s1r
	Exit Function
	fsDrawPropertyErr:
	
	fsDrawProperty = &quot;&quot;
End Function

&apos; Reference

Sub MsgSpeak( _
	strA As String)
&apos; MsgSpeak (Basic command)
	Dim sFile As String
	Dim i1 As Integer
	Dim msgs() As Variant
	Dim errorCode As Integer
	Dim config(fiCountConfigOptions) As Variant
	
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	If FileExists(sFile) Then
		If fbCreatingMediaFile() Then
			&apos; We show you the settings and ask you to
			&apos; verify that you really want to create
			&apos; a media file.
			i1 = fiReportMetaData(True)
			Select Case i1
				Case 2
				&apos; (&quot;Cancel&quot;)
				Exit Sub
				Case 7
				&apos; (&quot;No&quot;) Edit the settings
				If ThisComponent.supportsService( _
					&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
					&apos; Stop the presentation if it is running
					&apos; because the graphics exporter does not
					&apos; work when the presentation is running.
					ThisComponent.Presentation.End
				End If
				ConfigureReadTextAloud()
				Case Else
				&apos; (&quot;Yes&quot;) Process using the settings
				If ThisComponent.supportsService( _
					&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
					ThisComponent.Presentation.End
				End If
				tts_config_parseFile(sFile,config(),errorCode)
				ttsActuate(config(), _
				msgs(), _
				errorCode, _
				strA)
			End Select
		ElseIf fsGetOS() = &quot;MacOS&quot; And _
			fbCreatingMediaFile(&quot;AppleTV,attic,basement,bedroom,BLUETOOTH,B&amp;W,Bose,Bowers,&quot; &amp; _
			&quot;Creative,Dell,Harmon,Jambox,Jawbone,JBL,kitchen,LogiTech,Polk,Reflector,room,&quot; &amp; _
			&quot;Soundcast,Ultimate,yard&quot;) Then
			&apos; Using say speech synthesis with a wireless  
			&apos; option could fail silently.
			&apos;
			&apos; Say speech synthesis only sends audio.
			&apos;
			&apos; See: [`man say`][MS0]
			&apos;
			&apos; [MS0]:https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/say.1.html
			&apos;
			ConfigureReadTextAloud()
		Else
			&apos; Read strA aloud
			If FileExists(sFile) Then
				tts_config_parseFile(sFile,config(),errorCode)
				ttsActuate(config(), _
				msgs(), _
				errorCode, _
				strA)
			Else
				ConfigureReadTextAloud()
			End If
		End If
	Else
		&apos; Show the settings dialogue
		ConfigureReadTextAloud()
	End If
End Sub


Function fsEscapeStr( _
	sA As String, _
	Optional ByVal bIgnoreOS) As String
	If ismissing(bIgnoreOS) Then
		bIgnoreOS = False
	End If
	If fsGetOS() = &quot;MacOS&quot; And Not(bIgnoreOS) Then
		sA = fsreplaceText(sA,&quot;+&quot;,&quot;+&quot;)
		&apos;https://www.fileformat.info/info/unicode/char/ff0b/index.htm
		sA = fsreplaceText(sA,&quot;&amp;&quot;,&quot;&amp;&quot;)
		&apos;https://www.fileformat.info/info/unicode/char/ff06/index.htm
		fsEscapeStr = sA
	Else
		sA = fsreplaceText(sA,&quot;+&quot;,&quot;%2B&quot;)
		sA = fsreplaceText(sA,&quot;&amp;&quot;,&quot;%26&quot;)
		Select Case LCase(Left(ConvertToURL(sA),InStr(ConvertToURL(sA),&quot;:&quot;)))
			Case &quot;file:&quot;
			fsEscapeStr = Mid(ConvertToURL(sA),9)
			Case Else
			fsEscapeStr = sA
		End Select
	End If
End Function


Function fsLang() As String
	&apos; Full Language String - en-US en-GB zh-CN zh-TW etc.
	&apos; for languages with no UI variant, returns a two letter string
	&apos; fl, fr, pl etc.
	Dim SubstService As Variant
	
	SubstService = CreateUnoService(&quot;com.sun.star.util.PathSubstitution&quot;)
	fsLang = SubstService.substituteVariables(&quot;$(vlang)&quot;,True)
End Function


Function fsOptDirectory() As String
	If fsGetOS = &quot;WINDOWS&quot; Then
		fsOptDirectory = fsHomeDrive() &amp; &quot;\opt\&quot;
	Else
		fsOptDirectory = &quot;/opt/&quot;
	End If
End Function


Function fsHomeDrive() As String
	fsHomeDrive = Environ(&quot;HOMEDRIVE&quot;)
	If fsHomeDrive = &quot;&quot; Then
		If fsGetOS = &quot;WINDOWS&quot; Then
			fsHomeDrive = &quot;C:&quot;
		Else
			fsHomeDrive = &quot;&quot;
		End If
	End If
End Function


Function fsProgramDirectory() As String
	Dim c As String
	
	c = Environ(&quot;ProgramFiles&quot;)
	If InStr(c,&quot;\&quot;) &lt;&gt; 0 Then
		fsProgramDirectory = c &amp; &quot;\&quot;
	Else
		fsProgramDirectory = &quot;/usr/bin/&quot;
	End If
End Function


Function fsProgramDirectoryx86() As String
	Dim c As String
	
	c = Environ(&quot;ProgramFiles(x86)&quot;)
	If InStr(c,&quot;\&quot;) &lt;&gt; 0 Then
		fsProgramDirectoryx86 = c &amp; &quot;\&quot;
	Else
		fsProgramDirectoryx86 = &quot;/usr/bin/&quot;
	End If
End Function


Function fsInstallPath() As String
	Dim SubstService As Variant
	
	SubstService = CreateUnoService(&quot;com.sun.star.util.PathSubstitution&quot;)
	fsInstallPath = SubstService.substituteVariables(&quot;$(inst)&quot;,True)
End Function


Function fbIsWin64Program( _
	Optional ByVal installPath) As Boolean
	If ismissing(installPath) Then
		installPath = fsInstallPath()
	ElseIf installPath = &quot;&quot; Then
		installPath = fsInstallPath()
	End If
	If fsGetOS = &quot;WINDOWS&quot; And _
		UCase(Environ(&quot;PROCESSOR_ARCHITECTURE&quot;)) = &quot;AMD64&quot; And _
		InStr(LCase(installPath), &quot;(x86)&quot;) = 0 Then
		fbIsWin64Program = True
	Else
		fbIsWin64Program = False
	End If
End Function


Function fbIsAMediaPlayer( _
	s1 As String) As Boolean
	&apos; Return `True` if a string describes a valid media player.
	Dim n As Integer
	s1 = LCase(s1)
	fbIsAMediaPlayer = False
	If Len(s1) = 0 Then
		Exit Function
	End If
	Dim aA
	aA = Array( _
	&quot;/usr/bin/aplay&quot;, _
	&quot;/usr/bin/avplay&quot;, _
	&quot;/usr/bin/bangarang&quot;, _
	&quot;/usr/bin/exail&quot;, _
	&quot;/usr/bin/ffplay&quot;, _
	&quot;/usr/bin/gmplayer&quot;, _
	&quot;/usr/bin/gnome-open&quot;, _
	&quot;/usr/bin/gst-launch-1.0&quot;, _
	&quot;/usr/bin/kaffeine&quot;, _
	&quot;/usr/bin/kde-open&quot;, _
	&quot;/usr/bin/kplayer&quot;, _
	&quot;/usr/bin/mpg123&quot;, _
	&quot;/usr/bin/mpg321&quot;, _
	&quot;/usr/bin/mplayer&quot;, _
	&quot;/usr/bin/noatun&quot;, _
	&quot;/usr/bin/parole&quot;, _
	&quot;/usr/bin/play&quot;, _
	&quot;/usr/bin/pw-cat&quot;, _
	&quot;/usr/bin/sensible-browser&quot;, _
	&quot;/usr/bin/totem&quot;, _
	&quot;/usr/bin/xdg-open&quot;, _
	&quot;/usr/bin/xfmedia&quot;, _
	&quot;/usr/bin/xine&quot;, _
	&quot;/usr/bin/xmms&quot;, _
	&quot;audacity&quot;, _
	&quot;chrome&quot;, _
	&quot;chromium&quot;, _
	&quot;firefox&quot;, _
	&quot;iceweasel&quot;, _
	&quot;iexplore&quot;, _
	&quot;opera&quot;, _
	&quot;quicktimeplayer.exe&quot;, _
	&quot;vlc&quot;, _
	&quot;winamp&quot;, _
	&quot;wmplayer&quot;)
	For n = LBound(aA) To UBound(aA)
		If InStr(s1,aA(n)) &lt;&gt; 0 Then
			fbIsAMediaPlayer = True
			Exit For
		End If
	Next
End Function


Sub myBeep()
	Dim sA As String
	Dim oSvc As Object
	sA = soundsDirectory() &amp; &quot;apert.wav&quot;
	If FileExists(sA) Then
		Select Case fsGetOS()
			Case &quot;UNIX&quot;
			sA = ConvertToURL(sA)
		End Select
	ElseIf FileExists(&quot;/usr/share/sounds/alsa/Noise.wav&quot;) Then
		sA = convertToURL(&quot;/usr/share/sounds/alsa/Noise.wav&quot;)
	Else
		sA = convertToURL(&quot;/usr/share/sounds/speech-dispatcher/test.wav&quot;)
	End If
	If FileExists(&quot;/usr/bin/afplay&quot;) Then
		Shell(&quot;afplay&quot;, 0, sA)
	ElseIf FileExists(&quot;/usr/bin/gst-play-1.0&quot;) Then
		Shell(&quot;gst-play-1.0&quot;, 0, sA)
	Else
		On Error Goto myBeepErr
		oSvc = createUnoService(&quot;com.sun.star.system.SystemShellExecute&quot;)
		oSvc.execute(sA, &quot;&quot;, 1)
	End If
	Exit Sub
	myBeepErr:
End Sub


Function fiMyMouseEventToInt(_
		Event) As Double
	&apos; Returns an integer depending on the
	&apos; mouse event.
	&apos; 0 - cancel
	&apos; 1 - main mouse click (Left)
	&apos; 2 - alternate mouse click (Right) 
	&apos; 3 - scroll or centre click
	fiMyMouseEventToInt = 0
	On Local Error GoTo fiMyMouseEventToIntErr
	If Event.Buttons and _
			com.sun.star.awt.MouseButton.RIGHT Then
		fiMyMouseEventToInt = 2
	ElseIf Event.Buttons and _
			com.sun.star.awt.MouseButton.MIDDLE Then
		fiMyMouseEventToInt = 3
	Else
		fiMyMouseEventToInt = 1
	End If	
	Exit Function
	fiMyMouseEventToIntErr:
	fiMyMouseEventToInt = 0
End Function


Sub windowsSAPIControl(Event As Object)
	&apos; MouseButtonReleased Dialog3, ImageControl5
	Dim sA as String
	Dim oSvc As Object
	Dim MouseMain As Integer : MouseMain = 1
	Dim MouseAlt As Integer : MouseAlt = 2
	Dim MouseOther As Integer : MouseOther = 3
	Dim MouseEvent As Integer : MouseEvent = fiMyMouseEventToInt(Event)

	oSvc = createUnoService(&quot;com.sun.star.system.SystemShellExecute&quot;)
	sA = fswindowsSAPIControl()
	Select Case fsGetOS()
		Case &quot;MacOS&quot;
			Select Case MouseEvent
				Case 0
				&apos;pass
				Case MouseAlt
				If fbIsLibreOffice() Then
					EditJsonPhonemeTable()
				End If
				Case Else
				Shell(&quot;open&quot;, 0, &quot;-b com.apple.systempreferences&quot;, False)
			End Select
		Case &quot;WINDOWS&quot;
			Select Case MouseEvent
				Case 0
				&apos;pass
				Case MouseAlt
				&apos; NOTE: Apache OpenOffice 4 for Windows does not support `Wscript.Shell`,
				&apos; `com.sun.star.util.PathSubstitution` or python 3 features.
				If fbIsLibreOffice() Then
					EditJsonPhonemeTable()
				End If
				Case Else
				If Len(sA) &lt;&gt; 0 Then
					oSvc.execute(sA, &quot;&quot;, 0)
				End If
			End Select
		
		Case Else
		Select Case MouseEvent
			Case 0
			&apos;pass
			Case MouseAlt
			ResetHostSpeechURI
			EditJsonPhonemeTable()
			Case Else
			If Len(fsLocalHostSpeech()) &lt;&gt; 0 Then
				webHelp(fsLocalHostSpeech())
			ElseIf Len(sA) &lt;&gt; 0 Then
				Shell(sA, 0, &quot;&quot;, False)
			End If
		End Select
	End Select
End Sub


Function faWindowsTestArray() As Variant
	&apos; Return an array of the Windows subdirectories where you can find
	&apos; System programs, Control Panels or other resources
	&apos; i.e: [&apos;SysArm32&apos;, &apos;System32&apos;, &apos;SysWOW64&apos; ...]
	faWindowsTestArray = Array()
	Dim _div$ : _div = Chr(13)
	Dim _win_dir$ : _win_dir = &quot;C:\Windows&quot;
	On Error Goto faWindowsTestArrayErr
	If Len(Environ(&quot;windir&quot;)) &lt;&gt; 0 Then
		win_dir = Environ(&quot;windir&quot;)
	End If
	faWindowsTestArrayErr:
	Dim _system$ : _system = &quot;System32&quot;
	If fbIsWin64Program() Then
		_system = &quot;SysWOW64&quot;
	End If
	Dim _skip$ : _skip = &quot;;SYSTEM;SYSTEMAPPS;SYSTEMRESOURCES;SYSTEMTEMP;&quot;
	Dim x# : x = 0
	Dim _Dirs As Variant : _Dirs = Split(_
	_system &amp; _div &amp; fsSubDirectories(_win_dir), _
	_div)
	Dim result$ : result = &quot;&quot;
	For x = Lbound(_Dirs) To Ubound(_Dirs)
		If instr(Ucase(_Dirs(x)), &quot;SYS&quot;) &lt;&gt; 0 Then
			If Instr(_skip, Ucase(&quot;;&quot; &amp; _Dirs(x) &amp; &quot;;&quot;)) = 0 Then
				If Len(Result) = 0 Then 
					result = _Dirs(x)
				ElseIf Instr(result, _Dirs(x) &amp; _div) &lt;&gt; 1 then
					result = result &amp; _div &amp; _Dirs(x)
				End If
			End If
		End If
	Next
	If Len(result) = 0 Then
		faWindowsTestArray = Array(_system)
	Else
		faWindowsTestArray = Split(result, _div)
	End If
End Function


Function fswindowsSAPIControl() As String
	fswindowsSAPIControl = &quot;&quot;
	Dim x As Integer
	Dim s2 As String
	Dim sub_path As Variant

	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
			sub_path = faWindowsTestArray()
		s2 = fsHomeDrive()
		For x = Lbound(sub_path) To Ubound(sub_path)
			If FileExists(s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; &quot;\Speech\SpeechUX\sapi.cpl&quot;) Then
				fswindowsSAPIControl = s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; &quot;\Speech\SpeechUX\sapi.cpl&quot;
				Exit Function
			End If
		Next
		If FileExists(fsProgramDirectory() &amp; _
		&quot;Common Files\Microsoft Shared\Speech\sapi.cpl&quot;) Then
			fswindowsSAPIControl = fsProgramDirectory() &amp; _
			&quot;Common Files\Microsoft Shared\Speech\sapi.cpl&quot;
		ElseIf FileExists(s2 &amp; &quot;\WINDOWS\ServicePackFiles\i386\sapi.cpl&quot;) Then
			fswindowsSAPIControl = s2 &amp; &quot;\WINDOWS\ServicePackFiles\i386\sapi.cpl&quot;
		Else
			For x = Lbound(sub_path) To Ubound(sub_path)
				If FileExists(s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; &quot;\access.cpl&quot;) Then
					fswindowsSAPIControl = s2 &amp; &quot;\Windows\&quot; &amp; sub_path(x) &amp; &quot;\access.cpl&quot;
					Exit Function
				End If
			Next
		End If
		Case &quot;MacOS&quot;
			fswindowsSAPIControl = &quot;open -b com.apple.systempreferences&quot;
		Case Else
		sub_path = Array(_
		&quot;systemsettings&quot;, &quot;xfce-setting-show&quot;, &quot;gnome-control-center&quot;, _
		&quot;mate-control-center&quot;, &quot;unity-control-center&quot;)
		For x = Lbound(sub_path) To Ubound(sub_path)
			If FileExists(&quot;/usr/bin/&quot; &amp; sub_path(x)) Then
				fswindowsSAPIControl = &quot;/usr/bin/&quot; &amp; sub_path(x)
				Exit Function
			End If
		Next
	End Select
End Function


Sub libreHelp()
&apos; Help in LibreOffice
	If Not fbHelpIsInstalled() Then
		WebHelp(fsHttpHelpUrl())
	End If
End Sub


Function fbcreateDirectory( _
	sPath) As Boolean
	&apos; `sPath` is a URI, not a file path
	On Error Goto fbcreateDirectoryErr
	Dim sA As String
	
	If Len(sPath) &lt; Len(&quot;file:///c/d&quot;) Then
		fbcreateDirectory = False
	Else
		fbcreateDirectory = True
		If Right(sPath, 1) = &quot;/&quot; Then
			sA = sPath &amp; &quot;temp-&quot; &amp; Trim(Second(Now)) &amp; &quot;.txt&quot;
		Else
			sA = sPath &amp; &quot;/&quot; &amp; &quot;temp-&quot; &amp; Trim(Second(Now)) &amp; &quot;.txt&quot;
		End If
		fbcreateDirectory = CreateFile(sA, fsAppSignature(), &quot;UTF-8&quot;)
		fbRemoveFile(sA)
	End If
	Exit Function
	fbcreateDirectoryErr:
	fbcreateDirectory = False
End Function


Function fsNow() As String
&apos; Time formats
	Dim sA As String
	
	sA = Year(Now) &amp; &quot;-&quot; &amp; _
	fsPrefixZeroes(Month(Now),2) &amp; &quot;-&quot; &amp; _
	fsPrefixZeroes(Day(Now),2) &amp; &quot;T&quot; &amp; _
	fsPrefixZeroes(Hour(Now),2) &amp; &quot;:&quot; &amp; _
	fsPrefixZeroes(Minute(Now),2) &amp; &quot;:&quot; &amp; _
	fsPrefixZeroes(Second(Now),2)
	fsNow = sA
End Function


Function fsPrefixZeroes( _
	s1, _
	n1) As String
	&apos; s1 is the stringto prefix zeroes with
	&apos; n1 is the minimum length of the return string
	Dim s2 As String
	
	If n1 &lt; 1000 And Len(s1) &lt; n1 Then &apos; sanity check
	s2 = String(n1, &quot;0&quot;) &amp; s1
	fsPrefixZeroes = Right(s2,n1)
Else
	fsPrefixZeroes = s1
End If
End Function


Function fxStr( _
Optional ByVal sA)
&apos; Unescapes Python or ECMAscript style line ending code.
&apos; https://www.random.org
&apos;
If ismissing(sA) Then sA = &quot;&quot;
If Not(sA = &quot;&quot;) Then
	sA = fsReplaceText(sA, &quot;\\n&quot;, &quot;[[%%ekuoC52bRp08c6noyqDy%%]]n&quot;)
	sA = fsReplaceText(sA, &quot;\n&quot;, Chr(10))
	sA = fsReplaceText(sA, &quot;[[%%ekuoC52bRp08c6noyqDy%%]]n&quot;, &quot;\n&quot;)
End If
fxStr = sA
End Function


Function fsAboutAbilityToolsApple() As String
	Dim s1$
	s1 = Join( _
	Array( _
&quot;Read Text&quot;, _
&quot;=========&quot;, _
&quot;&quot;, _
&quot;Summary&quot;, _
&quot;-------&quot;, _
&quot;&quot;, _
&quot;**Read Text** reads text aloud, saves audio or video files&quot;, _
&quot;from text, and can use resources from the web based on the&quot;, _
&quot;selected text.&quot;, _
&quot;&quot;, _
&quot; * Select text.&quot;, _
&quot; * Click the *Read selection...* button.&quot;, _
&quot; * To read aloud, accept the default in the dialogue, or choose&quot;, _
&quot;   another action from the menus.&quot;, _
&quot;&quot;, _
&quot;### Read Aloud ###&quot;, _
&quot;&quot;, _
&quot;    &quot;&quot;(SAY_APPLESCRIPT)&quot;&quot;&quot;, _
&quot;&quot;, _
&quot;### Save as file&quot;, _
&quot;&quot;, _
&quot;On supported releases of MacOS, you can save an audio file of&quot;, _
&quot;a spoken excerpt using **Read Text**.&quot;, _
&quot;&quot;, _
&quot;    &quot;&quot;(SAY_APPLESCRIPT)&quot;&quot; &quot;&quot;(HOME)(SELECTION_LANGUAGE_CODE)/(NOW).aif&quot;&quot;&quot;, _
&quot;&quot;, _
&quot;Features&quot;, _
&quot;--------&quot;, _
&quot;&quot;, _
&quot; * Automatically change languages according to the text language.&quot;, _
&quot; * Use web resources to translate, look up, listen, post, or&quot;, _
&quot;   interface with web applications.&quot;, _
&quot;&quot;, _
&quot;Installation&quot;, _
&quot;------------&quot;, _
&quot;&quot;, _
&quot;Get *Read Text* from the download page and install it by double-clicking it.&quot;, _
&quot;&quot;, _
&quot;[Apache OpenOffice][1]  &quot;, _
&quot;[LibreOffice][2]&quot;, _
&quot;&quot;, _
&quot;&quot;, _
&quot;License&quot;, _
&quot;-------&quot;, _
&quot;&quot;, _
&quot;The project is licensed under the [GNU 2.0][3] license.&quot;, _
&quot;&quot;, _
&quot;Online help&quot;, _
&quot;-----------&quot;, _
&quot;&quot;, _
&quot;[Read Text][4]&quot;, _
&quot;&quot;, _
&quot;&quot;, _
&quot;  [1]: https://extensions.openoffice.org/en/project/read-text&quot;, _
&quot;  [2]: https://extensions.libreoffice.org/extension-center/read-text&quot;, _
&quot;  [3]: https://www.gnu.org/licenses/gpl-2.0.txt&quot;, _
&quot;  [4]: https://sites.google.com/site/readtextextension/&quot;, _
&quot;&quot;), _
Chr$(13))
	
	fsAboutAbilityToolsApple = s1
End Function


Function fbHaveItunes() As Boolean
&apos; iTunes for Windows
	fbHaveItunes = False
	Dim iversion As Integer
	iversion = 0
	Dim iOldVersion#
	iOldVersion = 9
	Dim iFailVersion#
	iFailVersion = 1
	On Error Goto fbHaveItunesErr
	If Len(fsGetMyTunesApp()) &lt;&gt; 0 Then
		fbHaveItunes = True
		Exit Function
	End If
	If i_CaBcVancouverHolgateJamesReadtextextensionWinItunesVersion &gt; iOldVersion Then
		&apos; Only probe the iTunes App object once per session.
		fbHaveItunes = True
		Exit Function
	ElseIf i_CaBcVancouverHolgateJamesReadtextextensionWinItunesVersion &gt; 0 Then
		Exit Function
	End If
	Dim iTunesApp As object
	Set iTunesApp = CreateObject(&quot;iTunes.Application.1&quot;)
	Dim s1$
	s1 = iTunesApp.Version
	Select Case iTunesApp.PlayerState
		Case 0
		&apos; Not playing
		iTunesApp.quit()
	End Select
	iversion = Int(Split(s1, &quot;.&quot;)(0))
	If iversion &gt; iOldVersion Then
		fbHaveiTunes = True
	End If
	i_CaBcVancouverHolgateJamesReadtextextensionWinItunesVersion = iversion
	Exit Function
	fbHaveItunesErr:
	
	i_CaBcVancouverHolgateJamesReadtextextensionWinItunesVersion = iFailVersion
	fbHaveItunes = False
End Function


Function fsGetMyTunesApp() As String
	&apos; Some old Macs use iTunes.app. New Macs use Music.app
	&apos; See also: `fbIsLegacyMac()`
	fsGetMyTunesApp = &quot;&quot;
	Dim n As Integer
	n = 0
	Dim o As Integer
	o = 0
	Dim a1
	a1 = Array(&quot;Music&quot;, &quot;iTunes&quot;)
	Dim a2
	a2 = Array(&quot;/Applications/&quot;, &quot;/System/Applications/&quot;)
	For n = LBound(a1) To UBound(a1)
		For o = LBound(a2) To UBound(a2)
			If FileExists(a2(o) &amp; _
				a1(n) &amp; _
				&quot;.app/&quot;) Then
				fsGetMyTunesApp = a1(n)
				Exit For
			End If
		Next
	Next
End Function


Function fbMacOSLegacyReplacePhonemes(_
		_language As String,_
		_model As String,_
		_text_file_in As String) As Boolean
    &apos;Replaces mispronounced words with phonemes
    fbMacOSLegacyReplacePhonemes = False
    Dim PyPath$ : PyPath = BundlePyPath()
    If Len(PyPath) = 0 Then
    	Exit Function
    End If
    On Error GoTo fbMacOSLegacyReplacePhonemesErr
	Dim _command As String : _command = Join(Array(_
	&quot;&quot;&quot;&quot;, ConvertFromUrl(fsMyURL() &amp; &quot;/python/find_replace_phonemes.py&quot;), _
	&quot;&quot;&quot; --language &quot;, _language, &quot; --model &quot;, _model, &quot; &quot;&quot;&quot;, _
	ConvertFromUrl(_text_file_in), &quot;&quot;&quot;&quot;), &quot;&quot;)
	shell(PyPath, 6 , _command, True)
	fbMacOSLegacyReplacePhonemes = True
	Exit Function
	fbMacOSLegacyReplacePhonemesErr:
	fbMacOSLegacyReplacePhonemes = False
End Function


Function fswriteMacOSSpeechScript( _
	ByVal sArguments, _
	ByVal sArgLangLocale, _
	ByVal ArtPath) As String
	fswriteMacOSSpeechScript = &quot;&quot;
&apos; Writes an osascript to read a sound, or create and convert a sound.
&apos; Creates a lock file to prevent double talk and to silence the speaker
&apos; if the button is clicked while the synthesizer is speaking.

	fswriteMacOSSpeechScript = &quot;&quot;
	Dim CR$
	CR = Chr(13)
	Dim n As Integer
	n = 0
	Dim o As Integer
	o = 0
	Dim s1 As String
	s1 = &quot;&quot;
	Dim s2 As String
	s2 = &quot;&quot;
	Dim sA$
	sA = &quot;-- fswriteMacOSSpeechScript: &quot; &amp; _
	&quot;No actions are defined.&quot;
	Dim sB$
	sB = &quot;&quot;
	Dim sBaseCountry$
	sBaseCountry = &quot;&quot;
	Dim sBPostPlay$
	sBPostPlay = &quot;true&quot;
	Dim sComment$
	sComment = fsLookUpTerm(&quot;s_speech-synthesis&quot;) &amp; _
	&quot; (&quot; &amp; _
	fsGetSetting(&quot;ooname&quot;) &amp; _
	&quot; &quot; &amp; Chr(8211) &amp; &quot; &quot; &amp; _
	fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
	&quot;)&quot;
	Dim sF$
	sF = ConvertFromUrl(fsTemporaryTextDoc())
	Dim sFile$
	sFile = fsTemporaryTtsAppleScript()
	Dim sGetOS$
	sGetOS = fsGetOS()
	Dim sLang$
	sLang = &quot;&quot;
	Dim sLangLocale$
	sLangLocale = &quot;&quot;
	Dim sSize$
	sSize = &quot;600x600&quot; &apos; Small square format for audio players
	Dim sTitle$
	sTitle = &quot;&quot;
	Dim myTunes$
	myTunes = fsGetMyTunesApp()
	Dim bestEncoder$
	bestEncoder = &quot;AAC&quot;
	Dim confirmMetaData$
	confirmMetaData = &quot;.aac,.aif,.aiff,.caf,.m4a,.mp4&quot;
	&apos; The best encoder was tested not to omit data or raise an
	&apos; error when adding metadata.
	Select Case myTunes
		Case &quot;Music&quot;
		bestEncoder = &quot;MP3&quot;
		confirmMetaData = &quot;.aif,.aiff,.caf,.mp3&quot;
	End Select
	fbRemoveFile(sFile)
	If FileExists(sFile) Then
		&apos; if we can&apos;t make a fresh file, then we don&apos;t want to run an
		&apos; arbitrary script.
		Exit Function
	Else
		&apos; Make sure we have a valid directory
		CreateFile(sFile, _
		sA, _
		&quot;UTF-8&quot;)
		fbRemoveFile(sFile)
	End If
	sA = &quot;&quot;
	&apos; We use the system voice if the selected language is the same as the user
	&apos; interface language. You can choose a specific voice for your primary
	&apos; working language using the system preferences for speech. Secondary 
	&apos; languages use voices chosen to match language and region.  We recommend
	&apos; you install the optional high quality voice for any voice you use
	&apos; regularly.
	
	If sArgLangLocale = &quot;&quot; Then
		sLangLocale = &quot;&quot;
	Else
		sLang = fsGetLanguage() &amp; &quot;-&quot; &amp; fsGetCountry()
		sBaseCountry = Mid(sArgLangLocale, InStr(sArgLangLocale,&quot;-&quot;) + 1)
		Select Case sArgLangLocale
			Case &quot;&quot;, sLang, fsGetLanguage() &amp; &quot;-&quot; &amp; sBaseCountry
			sLangLocale = &quot;&quot;
			Case Else
			sLangLocale = fsReplaceText(sArgLangLocale,&quot;-&quot;,&quot;_&quot;)
		End Select
	End If
	If fbIsLibreOffice() And Len(sArgLangLocale) &lt;&gt; 0 Then
		Dim model$ : model = MacOSSpeechAppInfo().json_dir
		If FileExists(fsFullPathOf(fsExtensionSetJson(&quot;lexicons/&quot; &amp; model, sArgLangLocale))) Then
			fbMacOSLegacyReplacePhonemes(sArgLangLocale, model, fsTemporaryTextDoc())
		End If
	End If

	If Len(myTunes) &lt;&gt; 0 And fbCreatingMediaFile() Then
		&apos; MacOS 10 iTunes or MacOS 11 Music programs can generate
		&apos; audio files and playlists.
		If ArtPath = &quot;&quot; Or _
			Not(FileExists(ArtPath)) Then
			ArtPath = Trim(ConvertFromUrl(fsPosterImg()))
		Else
			ArtPath = Trim(ConvertFromUrl(ArtPath))
		End If
		&apos; Check generated  title 
		
		If fbCreatingMediaFile( _
			confirmMetaData) And sGetOS = &quot;MacOS&quot; Then
			sTitle = fsMyTitleInputBox(True, fsThisSoundTitle(&quot;`&gt;_ &quot;), &quot;&quot;)
			If sTitle = &quot;&quot; Then
				s1 = &quot;-- &quot; &amp; fsNow() &amp; &quot;.  The title is undefined.  &quot; &amp; _
				&quot;Did you click &quot;&quot;Cancel&quot;&quot; or leave the title blank?&quot;
				CreateFile(sFile, _
				s1, _
				&quot;UTF-8&quot;)
				fswriteMacOSSpeechScript = s1
				Exit Function
			End If
		Else
			sTitle = fsThisSoundTitle(&quot;`&gt;_ &quot;)
		End If

		If fbCreatingMacOSType1Media() Then
			sBPostPlay = &quot;true&quot;
		Else
			sBPostPlay = &quot;false&quot;
		End If	
		sB = Join(Array( _
		&quot;#&quot; &amp; AppleScriptPath(), _
		&quot;(*&quot;, _
		fsAboutAbilityToolsApple(), _
		&quot;*)&quot; , _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;-- Read Text Extension created this script&quot;, _
		&quot;-- using &quot; &amp; fsGetSetting(&quot;ooname&quot;) &amp; &quot; &quot; &amp; fsNow(), _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;on run (arguments)&quot;, _
		&quot;    set argv1 to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set argv2 to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set argv3 to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set astring to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set b to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set bestEncoder to &quot;&quot;&quot; &amp; bestEncoder &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set bPostPlay to &quot; &amp; sBPostPlay, _
		&quot;    set c to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set defaultImg to &quot;&quot;&quot; &amp; ArtPath &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set defaultSize to &quot;&quot;&quot; &amp; sSize &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set donemessage to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set err1 to &quot;&quot;Apple Script&quot;&quot;&quot;, _
		&quot;    set myLang to &quot;&quot;&quot; &amp; sLangLocale &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myLock to quoted form of POSIX path of &quot;&quot;&quot; &amp; ConvertFromUrl(fsMyTempLock(&quot;lock&quot;)) &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myOption to &quot;&quot;&quot; &amp; sArguments &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myReader to &quot;&quot;&quot; &amp; fsGetMacOsBaseVoice() &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set mySys to &quot;&quot;&quot; &amp; sGetOS &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myURL to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set notOkaySound to OKSound(&quot;&quot;Sosumi&quot;&quot;)&quot;, _
		&quot;    set okaySound to OKSound(&quot;&quot;Tink&quot;&quot;)&quot;, _
		&quot;    set sGenre to &quot;&quot;&quot; &amp; fsThisDocGenre() &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sImageURL to defaultImg&quot;, _
		&quot;    set sRunComment to &quot;&quot;&quot; &amp; sComment &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sTrack to &quot;&quot;&quot; &amp; fiMyCurrentAudioTrack(False) &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sYear to &quot;&quot;&quot; &amp; Year(Now) &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set textFile to quoted form of POSIX path of &quot;&quot;&quot; &amp; sF &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sAlbum to &quot;&quot;&quot; &amp; fsThisDocTitle() &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sArtist to &quot;&quot;&quot; &amp; fsThisDocAuthor() &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set sTitle to &quot;&quot;&quot; &amp; sTitle &amp; String(2, Chr(0)) &amp; &quot;&quot;&quot;&quot; &amp; _
		&quot;    -- Title of the selected text.&quot;, _
		&quot;    set myVoice to &quot;&quot;&quot;&quot;&quot;, _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;    try&quot;, _
		&quot;        if argv1 is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;            set argv1 to (item 1 of arguments)&quot;, _
		&quot;        end if&quot;, _
		&quot;        set astring to fsChangecase(getExtension(argv1), &quot;&quot;lower&quot;&quot;)&quot;, _
		&quot;    On Error&quot;, _
		&quot;        set argv1 to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    end try&quot;, _
		&quot;    try&quot;, _
		&quot;        set argv2 to (item 2 of arguments)&quot;, _
		&quot;    On Error&quot;, _
		&quot;        set argv2 to defaultImg&quot;, _
		&quot;    end try&quot;, _
		&quot;    try&quot;, _
		&quot;        set argv3 to (item 3 of arguments)&quot;, _
		&quot;    On Error&quot;, _
		&quot;        set argv3 to defaultSize&quot;, _
		&quot;    end try&quot;, _
		&quot;    if myLang is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;        set myVoice to &quot;&quot;System&quot;&quot;&quot;, _
		&quot;        set myLang to &quot;&quot;Default Language&quot;&quot;&quot;, _
		&quot;        set myVoiceCommand to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    else&quot;, _
		&quot;        set myVoice to fsGetthevoice(myLang)&quot;, _
		&quot;        set myVoiceCommand to &quot;&quot; --voice &apos;&quot;&quot; &amp; myVoice &amp; &quot;&quot;&apos;&quot;&quot;&quot;, _
		&quot;    end if&quot;, _
		&quot;    try&quot;, _
		&quot;        set myencodeformat to getencodeformat(argv1, bestEncoder)&quot;, _
		&quot;        if argv1 is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;            set b to (do shell script &quot;&quot;touch &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;            set err1 to &quot;&quot;Say command&quot;&quot;&quot;, _
		&quot;            set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;        else if  myencodeformat is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;            set tempAudioFile to argv1 &amp; &quot;&quot;.aif&quot;&quot;&quot;, _
		&quot;            set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; &quot;&quot; -o &quot;&quot; &amp; tempAudioFile &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;            if executeAfConvert(tempAudioFile, argv1, bestEncoder) then&quot;, _
		&quot;                theMsg(argv1, myVoice, myLang, okaySound)&quot;, _
		&quot;                set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; tempAudioFile &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;            else if executeVideoLanVLC(tempAudioFile, argv1, bestEncoder) then&quot;, _
		&quot;                theMsg(argv1, myVoice, myLang, okaySound)&quot;, _
		&quot;                set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; tempAudioFile &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;            else&quot;, _
		&quot;                set b to (do shell script &quot;&quot;touch &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;                set err1 to &quot;&quot;Say command&quot;&quot;&quot;, _
		&quot;                set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;            end if&quot;, _
		&quot;        else if myencodeformat is &quot;&quot;AIF&quot;&quot; then&quot;, _
		&quot;            set err1 to &quot;&quot;Audio file&quot;&quot;&quot;, _
		&quot;            set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; &quot;&quot; -o &quot;&quot; &amp; argv1 &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;            set err1 to &quot;&quot;&quot; &amp; myTunes &amp; &quot; &quot;&quot; &amp; astring &amp; &quot;&quot; metadata &quot;&quot;&quot;, _
		&quot;            set b to setMusicAppMetaData(argv1, sAlbum, sArtist, sGenre, sImageURL, sTitle, sTrack, sYear, mySys, sRunComment)&quot;, _
		&quot;        else if myencodeformat is &quot;&quot;AAC&quot;&quot; or myencodeformat is &quot;&quot;MP3&quot;&quot; or myencodeformat is &quot;&quot;Apple Lossless&quot;&quot; then&quot;, _
		&quot;            set err1 to &quot;&quot;Mobile audio file&quot;&quot;&quot;, _
		&quot;            set tempAudioFile to argv1 &amp; &quot;&quot;.aif&quot;&quot;&quot;, _
		&quot;            set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; &quot;&quot; -o &quot;&quot; &amp; tempAudioFile &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;            set err1 to &quot;&quot;&quot; &amp; myTunes &amp; &quot; &quot;&quot; &amp; astring &amp; &quot;&quot; conversion &quot;&quot;&quot;, _
		&quot;            compressAudio(tempAudioFile, argv1, myencodeformat)&quot;, _
		&quot;            if myencodeformat is bestEncoder or myencodeformat is &quot;&quot;Apple Lossless&quot;&quot; then&quot;, _
		&quot;                set err1 to &quot;&quot;&quot; &amp; myTunes &amp; &quot; &quot;&quot; &amp; astring &amp; &quot;&quot; metadata &quot;&quot;&quot;, _
		&quot;                set b to setMusicAppMetaData(argv1, sAlbum, sArtist, sGenre, sImageURL, sTitle, sTrack, sYear, mySys, sRunComment)&quot;, _
		&quot;                set bPostPlay to false&quot;, _
		&quot;            end if&quot;, _
		&quot;            set str1 to (do shell script &quot;&quot;rm -f &quot;&quot; &amp; quoted form of tempAudioFile)&quot;, _
		&quot;            if bPostPlay is true then&quot;, _
		&quot;                set d to (do shell script &quot;&quot;open &quot;&quot; &amp; quoted form of (argv1))&quot;, _
		&quot;            else if not myencodeformat is bestEncoder then&quot;, _
		&quot;                theMsg(argv1, myVoice, myLang, okaySound)&quot;, _
		&quot;            end if&quot;, _
		&quot;        end if&quot;, _
		&quot;    On Error&quot;, _
		&quot;        if argv1 is not &quot;&quot;&quot;&quot; then&quot;, _
		&quot;            theMsg(err1 &amp; &quot;&quot;: Cancel&quot;&quot;, myVoice, myLang, notOkaySound)&quot;, _
		&quot;            set donemessage to err1&quot;, _
		&quot;        end if&quot;, _
		&quot;        set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;        return donemessage&quot;, _
		&quot;    end try&quot;, _
		&quot;    if FileExists(myLock) then&quot;, _
		&quot;        set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;    end if&quot;, _
		&quot;end run&quot;, _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;on theMsg(sA, sVoz, myLang, sBeep)&quot;, _
		&quot;    try&quot;, _
		&quot;        display notification sA with title &quot;&quot;Read Text: &quot;&quot; &amp; sVoz &amp; &quot;&quot; (&quot;&quot; &amp; myLang &amp; &quot;&quot;)&quot;&quot; sound name sBeep&quot;, _
		&quot;    end try&quot;, _
		&quot;end theMsg&quot;, _
		&quot;on getExtension(sA)&quot;, _
		&quot;    if sA is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;        set a3 to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    else&quot;, _
		&quot;        set a1 to theSplit(sA, &quot;&quot;.&quot;&quot;)&quot;, _
		&quot;        set s1 to the last item of a1&quot;, _
		&quot;        set a2 to theSplit(s1, &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;        set s2 to first item of a2&quot;, _
		&quot;        set a3 to theSplit(s2, &quot;&quot;\&quot;&quot;&quot;&quot;)&quot;, _
		&quot;        set s3 to first item of a3&quot;, _
		&quot;    end if&quot;, _
		&quot;    return a3 as Unicode text&quot;, _
		&quot;end getExtension&quot;, _
		&quot;on fsChangecase ( s1 , s2 )&quot;, _
		&quot;    if s2 is &quot;&quot;lower&quot;&quot; then&quot;, _
		&quot;        set s3 to &quot;&quot;A-Z a-z&quot;&quot;&quot;, _
		&quot;    else&quot;, _
		&quot;        set s3 to &quot;&quot;a-z A-Z&quot;&quot;&quot;, _
		&quot;    end if&quot;, _
		&quot;    set s4 to (do shell script &quot;&quot;echo &quot;&quot; &amp; quoted form of ( s1 ) &amp; &quot;&quot; | tr &quot;&quot; &amp; s3 &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;    return s4&quot;, _
		&quot;end fsChangecase&quot;, _
		&quot;on getencodeformat(filespec, bestEncoder)&quot;, _
		&quot;    set sext to fsChangecase(getExtension(filespec), &quot;&quot;upper&quot;&quot;)&quot;, _
		&quot;    if isInString(sext, &quot;&quot;CAF&quot;&quot;) then&quot;, _
		&quot;        return &quot;&quot;Apple Lossless&quot;&quot;&quot;, _
		&quot;    else if isInString(sext, &quot;&quot;M4A&quot;&quot;) or isInString(sext, &quot;&quot;MP4&quot;&quot;) then&quot;, _
		&quot;        return &quot;&quot;AAC&quot;&quot;&quot;, _
		&quot;    else if isInString(sext, &quot;&quot;MP3&quot;&quot;) then&quot;, _
		&quot;        return &quot;&quot;MP3&quot;&quot;&quot;, _
		&quot;    else if isInString(sext, &quot;&quot;AIF&quot;&quot;) then&quot;, _
		&quot;        return &quot;&quot;AIF&quot;&quot;&quot;, _
		&quot;    end if&quot;, _
		&quot;    return &quot;&quot;&quot;&quot;&quot;, _
		&quot;end getencodeformat&quot;, _
		&quot;on compressAudio(filein, fileout, encodeformat)&quot;, _
		&quot;    set aFile to POSIX file filein&quot;, _
		&quot;    set bDone to false&quot;, _
		&quot;    tell application &quot;&quot;&quot; &amp; myTunes &amp; &quot;&quot;&quot;&quot;, _
		&quot;        set MySelections to (aFile)&quot;, _
		&quot;        set newTracks to (convert MySelections)&quot;, _
		&quot;        set preferred_encoder to current encoder&quot;, _
		&quot;        set available_encoders to (name of encoders)&quot;, _
		&quot;        set bDone to false&quot;, _
		&quot;        repeat with anEnc in available_encoders&quot;, _
		&quot;            if format of encoder anEnc is encodeformat then&quot;, _
		&quot;                set current encoder to encoder anEnc&quot;, _
		&quot;                exit repeat&quot;, _
		&quot;            end if&quot;, _
		&quot;        end repeat&quot;, _
		&quot;    end tell&quot;, _
		&quot;    repeat with thisTrack in newTracks&quot;, _
		&quot;        tell application &quot;&quot;&quot; &amp; myTunes &amp; &quot;&quot;&quot;&quot;, _
		&quot;            set currentTrack to (thisTrack)&quot;, _
		&quot;            set trackLocation to (location of currentTrack)&quot;, _
		&quot;            delete currentTrack -- remove this track from the Apple &quot; &amp; myTunes &amp; &quot; library&quot;, _
		&quot;        end tell&quot;, _
		&quot;        try&quot;, _
		&quot;            set str0 to (do shell script &quot;&quot;mv &quot;&quot; &amp; quoted form of POSIX path of trackLocation &amp; &quot;&quot; &quot;&quot; &amp; quoted form of fileout)&quot;, _
		&quot;            set bDone to true&quot;, _
		&quot;        end try&quot;, _
		&quot;    end repeat&quot;, _
		&quot;    tell application &quot;&quot;&quot; &amp; myTunes &amp; &quot;&quot;&quot;&quot;, _
		&quot;        set current encoder to preferred_encoder&quot;, _
		&quot;    end tell&quot;, _
		&quot;    return bDone&quot;, _
		&quot;end compressAudio&quot;, _
		&quot;on setMusicAppMetaData(myURL, sAlbum, sArtist, sGenre, sImageURL, sTitle, sTrack, sYear, sComment)&quot;, _
		&quot;    set aFile to POSIX file myURL&quot;, _
		&quot;    try&quot;, _
		&quot;        set aImage to POSIX file sImageURL&quot;, _
		&quot;    end try&quot;, _
		&quot;    set currentAlbum to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set sTaggedURL to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set n to 0&quot;, _
		&quot;    delay 0.400&quot;, _
		&quot;    tell application &quot;&quot;&quot; &amp; myTunes &amp; &quot;&quot;&quot;&quot;, _
		&quot;        set myTune to open (aFile)&quot;, _
		&quot;        try&quot;, _
		&quot;            set x to CheckMusicAppOK()&quot;, _
		&quot;        end try&quot;, _
		&quot;        set str0 to (do shell script &quot;&quot;ls &quot;&quot; &amp; quoted form of sImageURL)&quot;, _
		&quot;        repeat while currentAlbum is &quot;&quot;&quot;&quot; and n is less than 10&quot;, _
		&quot;        delay 1&quot;, _
		&quot;            try&quot;, _
		&quot;                set the album of the current track to sAlbum&quot;, _
		&quot;                set currentAlbum to the album of the current track&quot;, _
		&quot;            end try&quot;, _
		&quot;            set n to 1 + n&quot;, _
		&quot;        end repeat&quot;, _
		&quot;        set theTrack to the current track&quot;, _
		&quot;        try&quot;, _
		&quot;            set the artist of theTrack to sArtist&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set the genre of theTrack to sGenre&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set the track number of theTrack to sTrack&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set the year of theTrack to sYear&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set data of artwork 1 of theTrack to (read (file aImage) as picture)&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set the name of theTrack to sTitle&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set sTaggedURL to quoted form of POSIX path of (get location of theTrack)&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set the comment of theTrack to sComment&quot;, _
		&quot;        end try&quot;, _
		&quot;        try&quot;, _
		&quot;            set myURL to quoted form of POSIX path of aFile&quot;, _
		&quot;                set str0 to (do shell script &quot;&quot;cp -f &quot;&quot; &amp; sTaggedURL &amp; &quot;&quot; &quot;&quot; &amp; myURL)&quot;, _
		&quot;        On Error&quot;, _
		&quot;            set sTaggedURL to quoted form of myURL&quot;, _
		&quot;        end try&quot;, _
		&quot;    end tell&quot;, _
		&quot;    return sTaggedURL&quot;, _
		&quot;end setMusicAppMetaData&quot;, _
		&quot;on readUtf8File(sURL)&quot;, _
		&quot;    set x to read POSIX file sURL as &quot; &amp; Chr(171) &amp; &quot;class utf8&quot; &amp; Chr(187), _
		&quot;    return x&quot;, _
		&quot;end readUtf8File&quot;, _
		&quot;on OKSound(s1)&quot;, _
		&quot;    if not FileExists(&quot;&quot;/System/Library/Sounds/&quot;&quot; &amp; s1 &amp; &quot;&quot;.aiff&quot;&quot;) then&quot;, _
		&quot;        set s1 to &quot;&quot;Purr&quot;&quot;&quot;, _
		&quot;    end if&quot;, _
		&quot;    return s1&quot;, _
		&quot;end OKSound&quot;, _
		&quot;on CheckMusicAppOK()&quot;, _
		&quot;    -- Pause up to 30 seconds or until &quot; &amp; myTunes &amp; &quot; is an active process&quot;, _
		&quot;    set b4 to False&quot;, _
		&quot;    set n to 0&quot;, _
		&quot;    try&quot;, _
		&quot;        repeat while b4 is False and n is less than 30&quot;, _
		&quot;            set s4 to (do shell script &quot;&quot;ps aux -c&quot;&quot;)&quot;, _
		&quot;            -- ignore &quot; &amp; myTunes &amp; &quot;Helper&quot;, _
		&quot;            set b4 to isInString(s4, &quot;&quot;&quot; &amp; myTunes &amp; &quot;&quot;&quot; &amp; (ASCII character 13))&quot;, _
		&quot;            set n to 1 + n&quot;, _
		&quot;            if b4 is False then&quot;, _
		&quot;                delay 1&quot;, _
		&quot;            end if&quot;, _
		&quot;        end repeat&quot;, _
		&quot;    On Error&quot;, _
		&quot;        set b4 to False&quot;, _
		&quot;    end    try&quot;, _
		&quot;    return b4&quot;, _
		&quot;end CheckMusicAppOK&quot;, _
		&quot;on executeAfConvert(in_sound_path, out_sound_path, bestEncoder)&quot;, _
		&quot;	-- Convert quickly with no metadata&quot;, _
		&quot;	set afc_app to &quot;&quot;/usr/bin/afconvert&quot;&quot;&quot;, _
		&quot;	if FileExists(afc_app) is false then&quot;, _
		&quot;		return false&quot;, _
		&quot;	end if&quot;, _
		&quot;	set audio_codec to &quot;&quot;&quot;&quot;&quot;, _
		&quot;	set dq to ASCII character 34 -- quote &quot;&quot;&quot;, _
		&quot;	set sext to fsChangecase(getExtension(out_sound_path), &quot;&quot;lower&quot;&quot;)&quot;, _
		&quot;	if sext is &quot;&quot;3gp&quot;&quot; then&quot;, _
        &quot;		set audio_codec to &quot;&quot;-f 3gpp -d Qclp&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;3g2&quot;&quot; then&quot;, _
		&quot;	    set audio_codec to &quot;&quot;-f 3gp2 -d Qclp&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;aac&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f adts -d aac&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;aifc&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f AIFC -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;aif&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f AIFF -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;aiff&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f AIFF -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;m4a&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f m4af -d aac&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;m4r&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f m4af -d aac&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;caf&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f caff -d aac&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;mp4&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f mp4f -d aac&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;au&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f NeXT -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;snd&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f NeXT -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;sd2&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f Sd2f -d BEI16&quot;&quot;&quot;, _
		&quot;	else if sext is &quot;&quot;wav&quot;&quot; then&quot;, _
		&quot;		 set audio_codec to &quot;&quot;-f WAVE -d ulaw&quot;&quot;&quot;, _
		&quot;	else if isInString(bestEncoder, &quot;&quot;MP3&quot;&quot;) then&quot;, _
		&quot;		if sext is &quot;&quot;flac&quot;&quot; then&quot;, _
		&quot;			set audio_codec to &quot;&quot;-f flac -d flac&quot;&quot;&quot;, _
		&quot;		else if sext is &quot;&quot;w64&quot;&quot; then&quot;, _
		&quot;			set audio_codec to &quot;&quot;-f W64f -d ulaw&quot;&quot;&quot;, _
		&quot;		else if sext is &quot;&quot;loas&quot;&quot; then&quot;, _
		&quot;			set audio_codec to &quot;&quot;-f loas -d &apos;aace&apos;&quot;&quot;&quot;, _
		&quot;		end if&quot;, _
		&quot;	end if&quot;, _
		&quot;	if audio_codec is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;		return false&quot;, _
		&quot;	else&quot;, _
		&quot;		-- afconvert -f mp4f -d aac in.aif out.mp4&quot;, _
		&quot;		set command_line to afc_app &amp; &quot;&quot; &quot;&quot; &amp; audio_codec &amp; &quot;&quot; &quot;&quot; &amp; dq &amp; in_sound_path &amp; dq &amp; &quot;&quot; &quot;&quot; &amp; dq &amp; out_sound_path &amp; dq&quot;, _
		&quot;		try&quot;, _
		&quot;			set b to (do shell script command_line)&quot;, _
		&quot;		On Error&quot;, _
		&quot;			return false&quot;, _
		&quot;		end try&quot;, _
		&quot;	end if&quot;, _
		&quot;	return FileExists(out_sound_path)&quot;, _
		&quot;end executeAfConvert&quot;, _		
		&quot;on executeVideoLanVLC(in_sound_path, out_sound_path, bestEncoder)&quot;, _
		&quot;    -- Flac mux doesn&apos;t always produce a compatible MacOS file&quot;, _
		&quot;    set vlc_app to &quot;&quot;/Applications/VLC.app/Contents/MacOS/VLC&quot;&quot;&quot;, _
		&quot;    if FileExists(vlc_app) is false then&quot;, _
		&quot;        return false&quot;, _
		&quot;    end if &quot;, _
		&quot;    set channel_count to &quot;&quot;2&quot;&quot;&quot;, _
		&quot;    set audio_codec to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set average_bitrate to &quot;&quot;0&quot;&quot;&quot;, _
		&quot;    set sample_rate to &quot;&quot;0&quot;&quot;&quot;, _
		&quot;    set mux to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set verbosity to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set dq to ASCII character 34 -- quote &quot;&quot;&quot;, _
		&quot;    set sext to fsChangecase(getExtension(out_sound_path), &quot;&quot;lower&quot;&quot;)&quot;, _
		&quot;    if sext is &quot;&quot;mp3&quot;&quot; then&quot;, _
		&quot;        set audio_codec to &quot;&quot;mp3&quot;&quot;&quot;, _
		&quot;        set average_bitrate to &quot;&quot;128&quot;&quot;&quot;, _
		&quot;        set sample_rate to &quot;&quot;44100&quot;&quot;&quot;, _
		&quot;        set mux to &quot;&quot;dummy&quot;&quot;&quot;, _
		&quot;    else if sext is &quot;&quot;ogg&quot;&quot; then&quot;, _
		&quot;        set audio_codec to &quot;&quot;vorb&quot;&quot;&quot;, _
		&quot;        set average_bitrate to &quot;&quot;128&quot;&quot;&quot;, _
		&quot;        set sample_rate to &quot;&quot;44100&quot;&quot;&quot;, _
		&quot;        set mux to &quot;&quot;ogg&quot;&quot;&quot;, _
		&quot;    else if sext is &quot;&quot;opus&quot;&quot; then&quot;, _
		&quot;        set audio_codec to &quot;&quot;opus&quot;&quot;&quot;, _
		&quot;        set average_bitrate to &quot;&quot;96&quot;&quot;&quot;, _
		&quot;        set sample_rate to &quot;&quot;48000&quot;&quot;&quot;, _
		&quot;        set mux to &quot;&quot;ogg&quot;&quot;&quot;, _
		&quot;    else if sext is &quot;&quot;flac&quot;&quot; then&quot;, _
		&quot;        if isInString(bestEncoder, &quot;&quot;MP3&quot;&quot;)&quot;, _
		&quot;            -- We can&apos;t play the flac file with QuickTime Player&quot;, _
		&quot;            set audio_codec to &quot;&quot;&quot;&quot;&quot;, _
		&quot;        else&quot;, _
		&quot;            set audio_codec to &quot;&quot;flac&quot;&quot;&quot;, _
		&quot;            set average_bitrate to &quot;&quot;128&quot;&quot;&quot;, _
		&quot;            set sample_rate to &quot;&quot;44100&quot;&quot;&quot;, _
		&quot;            set mux to &quot;&quot;raw&quot;&quot;&quot;, _
		&quot;        end if&quot;, _
		&quot;    end if&quot;, _
		&quot;    if audio_codec is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;        return false&quot;, _
		&quot;    else&quot;, _
		&quot;       set command_line to dq &amp; vlc_app &amp; dq &amp; &quot;&quot; &quot;&quot; &amp; dq &amp; in_sound_path &amp; dq &amp; &quot;&quot; --intf dummy &quot;&quot; &amp; verbosity &amp; &quot;&quot;--sout=&quot;&quot; &amp; dq &amp; &quot;&quot;#transcode{vcodec=none,acodec=&quot;&quot; &amp; audio_codec &amp; &quot;&quot;,ab=&quot;&quot; &amp; average_bitrate &amp; &quot;&quot;,channels=&quot;&quot; &amp; channel_count &amp; &quot;&quot;,samplerate=&quot;&quot; &amp; sample_rate &amp; &quot;&quot;}:std{access=file,mux=ogg,dst=&apos;&quot;&quot; &amp; out_sound_path &amp; &quot;&quot;&apos;}&quot;&quot; &amp; dq &amp; &quot;&quot; vlc://quit&quot;&quot;&quot;, _
		&quot;        try&quot;, _
		&quot;            set b to (do shell script command_line)&quot;, _
		&quot;        On Error&quot;, _
		&quot;            return false&quot;, _
		&quot;        end try&quot;, _
		&quot;    end if&quot;, _
		&quot;    return FileExists(out_sound_path)&quot;, _
		&quot;end executeVideoLanVLC&quot;, _
		&quot;on FileExists(theFile) -- (String) as Boolean&quot;, _
		&quot;    tell application &quot;&quot;System Events&quot;&quot;&quot;, _
		&quot;        if exists file theFile then&quot;, _
		&quot;            return true&quot;, _
		&quot;        else&quot;, _
		&quot;            return false&quot;, _
		&quot;        end if&quot;, _
		&quot;    end tell&quot;, _
		&quot;end FileExists&quot;), _
		CR)
	Else
		&apos; &quot;Speech synthesis using `say`&quot;
		sB = Join( _
		Array( _
		&quot;#&quot; &amp; AppleScriptPath(), _
		&quot;(*&quot;, _
		fsAboutAbilityToolsApple(), _
		&quot;*)&quot;, _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;-- Read Text Extension created this script&quot;, _
		&quot;-- using &quot; &amp; fsGetSetting(&quot;ooname&quot;) &amp; &quot; &quot; &amp; fsNow(), _
		&quot;-- ------------------------------------------------------&quot;, _
		&quot;on run (arguments)&quot;, _
		&quot;    set b to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    set err1 to &quot;&quot;Apple Script&quot;&quot;&quot;, _
		&quot;    set myLang to &quot;&quot;&quot; &amp; sLangLocale &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myLock to quoted form of POSIX path of &quot;&quot;&quot; &amp; ConvertFromUrl(fsMyTempLock(&quot;lock&quot;)) &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myOption to &quot;&quot;&quot; &amp; sArguments &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set myVoice to &quot;&quot;&quot; &amp; fsGetMacOsBaseVoice() &amp; &quot;&quot;&quot;&quot;, _
		&quot;    set textFile to quoted form of POSIX path of &quot;&quot;&quot; &amp; sF &amp; &quot;&quot;&quot;&quot;, _
		&quot;    -- ------------------------------------------------------&quot;, _
		&quot;    set b to (do shell script &quot;&quot;touch &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;    if myLang is &quot;&quot;&quot;&quot; then&quot;, _
		&quot;        set myVoiceCommand to &quot;&quot;&quot;&quot;&quot;, _
		&quot;    else&quot;, _
		&quot;        set myVoice to fsGetthevoice(myLang)&quot;, _
		&quot;        set myVoiceCommand to &quot;&quot; --voice &apos;&quot;&quot; &amp; myVoice &amp; &quot;&quot;&apos;&quot;&quot;&quot;, _
		&quot;    end if&quot;, _
		&quot;    try&quot;, _
		&quot;        set err1 to &quot;&quot;Say command&quot;&quot;&quot;, _
		&quot;        set b to (do shell script &quot;&quot;say &quot;&quot; &amp; myOption &amp; myVoiceCommand &amp; &quot;&quot; -f &quot;&quot; &amp; textFile &amp; &quot;&quot; &quot;&quot;)&quot;, _
		&quot;    On Error&quot;, _
		&quot;        set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;    end try&quot;, _
		&quot;    set b to (do shell script &quot;&quot;rm -f &apos;&quot;&quot; &amp; myLock &amp; &quot;&quot;&apos;&quot;&quot;)&quot;, _
		&quot;    return b&quot;, _
		&quot;end run&quot;), _
		CR)
	End If
	sB = sB &amp; Join( _
	Array( _
	&quot;&quot;, _
	&quot;-- ------------------------------------------------------&quot;, _
	&quot;on theSplit(theString, theDelimiter)&quot;, _
	&quot;    set oldDelimiters to AppleScript&apos;s text item delimiters&quot;, _
	&quot;    set AppleScript&apos;s text item delimiters to theDelimiter&quot;, _
	&quot;    set theArray to every text item of theString&quot;, _
	&quot;    set AppleScript&apos;s text item delimiters to oldDelimiters&quot;, _
	&quot;    return theArray&quot;, _
	&quot;end theSplit&quot;, _
	&quot;on extractVoice(str0)&quot;, _
	&quot;    if isInString(str0, &quot;&quot;) &quot;&quot;) then&quot;, _
	&quot;        set iIndex to offset of &quot;&quot;) &quot;&quot; in str0&quot;, _
	&quot;        return characters 1 thru (iIndex) of str0 as text&quot;, _
	&quot;    else&quot;, _
	&quot;        set iIndex to offset of &quot;&quot;  &quot;&quot; in str0&quot;, _
	&quot;        return characters 1 thru (iIndex - 1) of str0 as text&quot;, _
	&quot;    end if&quot;, _
	&quot;end extractVoice&quot;, _
	&quot;on isInString(str0, str1)&quot;, _
	&quot;    set retval to true&quot;, _
	&quot;    set iIndex to offset of str1 in str0&quot;, _
	&quot;    if iIndex is 0 then&quot;, _
	&quot;        set retval to false&quot;, _
	&quot;    end if&quot;, _
	&quot;    return retval&quot;, _
	&quot;end isInString&quot;, _
	&quot;on testTheString(myArray, sLang, sDiv)&quot;, _
	&quot;    set retval to &quot;&quot;&quot;&quot;&quot;, _
	&quot;    set sLang2 to &quot;&quot;&quot;&quot;&quot;, _
	&quot;    if sDiv is &quot;&quot; &quot;&quot; then&quot;, _
	&quot;        set sLang2 to sLang&quot;, _
	&quot;    else&quot;, _
	&quot;        set iIndex to offset of sDiv in sLang&quot;, _
	&quot;        if iIndex is not 0 then&quot;, _
	&quot;            set sLang2 to characters 1 thru (iIndex) of sLang as text&quot;, _
	&quot;        end if&quot;, _
	&quot;    end if&quot;, _
	&quot;    repeat with theItem in myArray&quot;, _
	&quot;        if (isInString(theItem, sLang2)) then&quot;, _
	&quot;            set retval to extractVoice(theItem)&quot;, _
	&quot;            exit repeat&quot;, _
	&quot;        end if&quot;, _
	&quot;    end repeat&quot;, _
	&quot;    return retval&quot;, _
	&quot;end testTheString&quot;, _
	&quot;on fsGetthevoice(sLang)&quot;, _
	&quot;    try&quot;, _
	&quot;        set str0 to (do shell script &quot;&quot;say --voice &apos;?&apos;&quot;&quot;)&quot;, _
	&quot;        set myArray to my theSplit(str0, (ASCII character 13))&quot;, _
	&quot;        set retval to testTheString(myArray, sLang, &quot;&quot; &quot;&quot;)&quot;, _
	&quot;        if retval is &quot;&quot;&quot;&quot; then&quot;, _
	&quot;            set retval to testTheString(myArray, sLang, &quot;&quot;_&quot;&quot;)&quot;, _
	&quot;        end if&quot;, _
	&quot;        if retval is &quot;&quot;&quot;&quot; then&quot;, _
	&quot;            set retval to testTheString(myArray, sLang, &quot;&quot;-&quot;&quot;)&quot;, _
	&quot;        end if&quot;, _
	&quot;        if retval is &quot;&quot;&quot;&quot; then&quot;, _
	&quot;            set retval to &quot;&quot;&quot; &amp; fsGetMacOsBaseVoice() &amp; &quot;&quot;&quot;&quot;, _
	&quot;        end if&quot;, _
	&quot;    On Error&quot;, _
	&quot;        set retval to &quot;&quot;&quot; &amp; fsGetMacOsBaseVoice() &amp; &quot;&quot;&quot;&quot;, _
	&quot;    end try&quot;, _
	&quot;    -- On MacOS 13.0, Lee is an optional en_AU voice&quot;, _
	&quot;    if retval is &quot;&quot;Agnes&quot;&quot; or retval is &quot;&quot;Albert&quot;&quot; or retval is &quot;&quot;Lee&quot;&quot; or retval is &quot;&quot;&quot;&quot; then&quot;, _
	&quot;        set retval to &quot;&quot;Alex&quot;&quot;&quot;, _
	&quot;    end if&quot;, _
	&quot;    return retval&quot;, _
	&quot;end fsGetthevoice&quot;, _
	&quot;&quot;), _
	CR)
	CreateFile( _
	sFile, _
	sB, _
	&quot;UTF-8&quot;)
	fswriteMacOSSpeechScript = sB
End Function


Function fsTemporaryTtsAppleScript() As String
	Dim sA As String
	fsTemporaryTtsAppleScript = createUnoService(&quot;com.sun.star.util.PathSettings&quot;).temp &amp; _
	&quot;/readaloud.applescript&quot;
End Function


Function CreateFile( _
	sFilePath, _
	sWriteString, _
	Optional sEncoding) As Boolean
	&apos; CreateFile(&quot;/tmp/sample.txt&quot;,&quot;Hello world&quot;,&quot;UTF-8&quot;) &apos; Best practice
	&apos;
	&apos; Windows can not write Asian languages correctly with &quot;iso-8859-15&quot;
	&apos; Anything written for the extension&apos;s private use should be &quot;UTF-8&quot;
	&apos; This sub will create the file and all the nested directories
	&apos; in the path in a single step.
	Dim CR As String
	Dim oOutputAccess As Object
	Dim oOutputStream As Object
	Dim vOutputData, UDP, PV As Variant
	
	CR = Chr(13)
	If ismissing(sEncoding) Then
		Select Case fsGetOS()
			Case &quot;WINDOWS&quot;
			sEncoding = &quot;iso-8859-15&quot; &apos;iso-8859-15 is Windows &quot;western&quot; encoding
			Case Else
			sEncoding = &quot;UTF-8&quot; &apos; Posix standard
		End Select
	End If
	On Error Goto CreateFileError
	fbRemoveFile(sFilePath)
	oOutputAccess = CreateUnoService(&quot;com.sun.star.ucb.SimpleFileAccess&quot;)
	oOutputStream = CreateUnoService(&quot;com.sun.star.io.TextOutputStream&quot;)
	vOutputData = oOutputAccess.openFileWrite(sFilePath)
	oOutputStream.setOutputStream(vOutputData)
	If Len(sEncoding) &lt;&gt; 0 Then
		oOutputStream.setEncoding(sEncoding)
	End If
	oOutputStream.writeString(sWriteString)
	oOutputStream.flush()
	oOutputStream.closeOutput()
	CreateFile = FileExists(sFilePath)
	Exit Function
	CreateFileError:
	CreateFile = False
End Function


Function fbIsAnURL( _
	sA) As Boolean
	If InStr(sA, &quot;http:&quot;) = 1 Then
		fbIsAnURL = True
	ElseIf InStr(sA, &quot;ftp:&quot;) = 1 Then
		fbIsAnURL = True
	ElseIf InStr(sA, &quot;https:&quot;) = 1 Then
		fbIsAnURL = True
	ElseIf InStr(sA, &quot;ftps:&quot;) = 1 Then
		fbIsAnURL = True
	ElseIf InStr(sA, &quot;mailto:&quot;) = 1 Then
		fbIsAnURL = True
	Else
		fbIsAnURL = False
	End If
End Function


Sub WarnNoSpeech()
	Dim s1 As String
	s1 = fsLookUpTerm(&quot;s_speech-synthesis&quot;)
	On Error Goto WarnNoSpeechErr
	If (6 = MsgBox(s1 &amp; _
		Chr(10) &amp; _
		String(Len(s1), &quot;=&quot;) &amp; _
		Chr(10) &amp; _
		Chr(10) &amp; _
		&quot;  &quot; &amp; fsLookUpTerm( _
		&quot;s_could-not-locate-the-program&quot;) &amp; _
		Chr(10) &amp; _
		&quot;  &quot; &amp; fsLookUpTerm(&quot;s_on-line-help&quot;) &amp; _
		&quot;?&quot; , 68, fsLookUpTerm(&quot;s_read-text&quot;))) Then
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		webHelp(&quot;https://sites.google.com/site/readtextextension/home/microsoft-windows&quot;)
		Case &quot;MacOS&quot;
		webHelp(&quot;https://sites.google.com/site/readtextextension/home/apple-MacOS&quot;)
		Case Else
		Select Case Environ(&quot;DESKTOP_SESSION&quot;)
			Case &quot;debian&quot;
			webHelp(&quot;apt:espeak&quot;)
			Case &quot;ubuntu&quot;
			Select Case fsGetLanguage()
				Case &quot;de&quot;, &quot;en&quot;, &quot;es&quot;, &quot;fr&quot;, &quot;it&quot;
				webHelp(&quot;apt:libttspico-utils&quot;)
				Case &quot;af&quot;
				webHelp(&quot;apt:mbrola-af1&quot;)
				Case &quot;ca&quot;
				webHelp(&quot;apt:festvox-ca-ona-hts&quot;)
				Case &quot;cs&quot;
				webHelp(&quot;apt:festvox-czech-machac&quot;)
				Case &quot;el&quot;
				webHelp(&quot;apt:mbrola-gr1&quot;)
				Case &quot;et&quot;
				webHelp(&quot;apt:mbrola-ee1&quot;)
				Case &quot;fi&quot;
				webHelp(&quot;apt:festvox-suopuhe-mv&quot;)
				Case &quot;hr&quot;
				webHelp(&quot;apt:mbrola-cr1&quot;)
				Case &quot;hi&quot;
				webHelp(&quot;apt:festvox-hi-nsk&quot;)
				Case &quot;hu&quot;
				webHelp(&quot;apt:mbrola-hu1&quot;)
				Case &quot;id&quot;
				webHelp(&quot;apt:mbrola-id1&quot;)
				Case &quot;la&quot;
				webHelp(&quot;apt:mbrola-la&quot;)
				Case &quot;mr&quot;
				webHelp(&quot;apt:festvox-mr-nsk&quot;)
				Case &quot;nl&quot;
				webHelp(&quot;apt:mbrola-nl2&quot;)
				Case &quot;pl&quot;
				webHelp(&quot;apt:mbrola-pl1&quot;)
				Case &quot;pt&quot;
				webHelp(&quot;apt:mbrola-br1&quot;)
				Case &quot;ro&quot;
				webHelp(&quot;apt:mbrola-ro1&quot;)
				Case &quot;ru&quot;
				webHelp(&quot;apt:festvox-ru&quot;)
				Case &quot;sv&quot;
				webHelp(&quot;apt:mbrola-sw1&quot;)
				Case &quot;te&quot;
				webHelp(&quot;apt:festvox-te-nsk&quot;)
				Case Else
				webHelp(&quot;apt:espeak&quot;)
				End Select 
			Case Else
			webHelp(fsHttpHelpUrl())
			End Select
		End Select
	End If
	Exit Sub
	WarnNoSpeechErr:
	webHelp(fsHttpHelpUrl())
End Sub


Function fbCheckPosixSpeech() As Boolean
	fbCheckPosixSpeech = False
	Dim _app As Variant
	Dim x As Integer : x = 0
	Select Case fsGetOS()
		Case &quot;UNIX&quot;
		_app = Array(_
		&quot;festival&quot;, &quot;open_jtalk&quot;, &quot;pico2wave&quot;, &quot;RHVoice-test&quot;, &quot;spd-say&quot;)
		Case &quot;MacOS&quot;
		_app = Array(&quot;say&quot;)
		Case Else
		Exit Function
	End Select
	If Not fbIsSandboxed() Then
		If fbHaveEspeak() Then
			fbCheckPosixSpeech = True
		Else
			For x = Lbound(_app) To Ubound(_app)
				If FileExists(&quot;/usr/bin/&quot; &amp; _app(x)) Then
					fbCheckPosixSpeech = True
					Exit Function
				End If
			Next
		End If
	End If
End Function


Sub CheckUnixSpeech()
	&apos; Linux may not include a speech synthesiser by default.
	&apos; Check the first time the application runs.

	If fsGetOS() = &quot;UNIX&quot; Then
		If Not(FileExists(fsFullPathOf(fsExtensionSettingsIni))) Then
			If isSnap() or isFlatPak() Then
				&apos; Translate this message for your language
				If (MsgBox(_(_
				&quot;Get on-line help for snap? Read Text uses a http speech daemon like [larynx-server](https://github.com/rhasspy/larynx).&quot;,_
				&quot;tools&quot;, fsDisplayLanguage(), -1), 68, fsLookUpTerm(&quot;s_read-text&quot;)) = 6) Then
					webHelp(&quot;https://github.com/rhasspy/larynx#samples&quot;)
				End If
			Else
				If Not fbCheckPosixSpeech() Then
					WarnNoSpeech()
				End If
			End If
		End If
	End If
End Sub


Function fbIsSandboxed() As Boolean
	&apos; flatpak and snap apps cannot run external programs.
	fbIsSandboxed = False
	Dim x As Integer
	Dim sand_path As Variant : sand_path = Array(_
	&quot;/.var/app/org.libreoffice.LibreOffice/&quot;, _
	&quot;/snap/libreoffice&quot;_
	)
	For x = Lbound(sand_path) to Ubound(sand_path)
		If Instr(soundsDirectory(), sand_path(x)) &lt;&gt; 0 Then
			fbIsSandboxed = True
			Exit Function
		End If
	Next
End Function


Function fbHaveEspeak() As Boolean
	fbHaveEspeak = False
	Dim n# : n = 0
	Dim a1 : a1 = Array(&quot;espeak-ng&quot;, &quot;speak-ng&quot;, &quot;espeak&quot;)
	For n = Lbound(a1) To Ubound(a1)
		If Len(fsFindAppPath(a1(n))) &lt;&gt; 0 Then
			fbHaveEspeak = True
			Exit Function
		End If
	Next
	If FileExists(fsProgramDirectoryx86() &amp; &quot;eSpeak\command_line\espeak.exe&quot;) Or _
			FileExists(fsProgramDirectory() &amp; &quot;eSpeak\command_line\espeak.exe&quot;) Then
		fbHaveEspeak = True
	End If
End Function

Function fbHaveFfmpeg() As Boolean
	fbHaveFfmpeg = Not (Len(fsMyFfmpeg()) = 0)
End Function


Function fbHavePipeWire() As Boolean
	fbHavePipeWire = Not (Len(fsMyPipeWire()) = 0)
End Function


Function fbHaveGst() As Boolean
	fbHaveGst = Not (Len(GstLaunchPath()) = 0)
End Function


Function fbHaveVLC() As Boolean
	fbHaveVLC = Not (Len(vlcPath()) = 0)
End Function


Function fbHaveLame() As Boolean
	fbHaveLame = Not (Len(lamePath()) = 0)
End Function


Function fbHaveFlac() As Boolean
	fbHaveFlac = Not (Len(flacPath()) = 0)
End Function


Function fbHaveOgg() As Boolean
	fbHaveOgg = Not (Len(oggPath()) = 0)
End Function


Function fbHaveNeroEnc() As Boolean
	fbHaveNeroEnc = Not (Len(neroEncPath()) = 0)
End Function


Function fbHaveNeroTag() As Boolean
	fbHaveNeroTag = Not (Len(neroTagPath()) = 0)
End Function


Function fbHavePyQrCode() As Boolean
	&apos; Install `qrcode` with `apt install python3-qrcode`
	&apos; or `pip3 install qrcode` 
	fbHavePyQrCode = Len(fsGetPipLibPath(&quot;qrcode&quot;, False)) &lt;&gt; 0
	If fbHavePyQrCode Then
		Exit Function
	End If
	Dim x# : x = 0
	Dim Tokens : Tokens = Array(_
	&quot;/usr/lib/python3/dist-packages/qrcode/release.py&quot;, _
	Environ(&quot;HOME&quot;) &amp; &quot;/.local/bin/qr&quot;)
	
	If FileExists(fsNetworkTtsDoc()) And _
	Len(fsContainerResourcePath(&quot;python&quot;)) = 0 And _
	Len(fsContainerResourcePath(&quot;python3&quot;)) = 0 Then
		For x = Lbound(Tokens) To Ubound(Tokens)
			If FileExists(Tokens(x)) Then
				fbHavePyQrCode = True
				Exit For
			End If
		Next 
	End If
End Function


Function fbOKWithRhVoice(_
		sA) As Boolean
	fbOKWithRhVoice = False
	&apos; The version of RhVoice included in Ubuntu 22.04 does not include
	&apos; all languages described on the github site.
	Dim _test$ : _test$ = &quot;&quot;
	Dim languages$ : languages = &quot;file:///usr/share/RHVoice/languages/&quot;
	Dim a1 : a1 = Array(_
		&quot;RHVoice-test&quot;)
	Dim x As Integer : x = 0

    If Not FileExists(fsRhVoiceTtsDoc()) Then
        Exit Function
    End If
    
	For x = Lbound(a1) to Ubound(a1)
		If FileExists(&quot;/usr/bin/&quot; &amp; a1(x)) Then
			_test = a1(x)
			Exit For
		End If
	Next
	If Len(_test) = 0 Then
		Exit Function
	End If
	Select Case Split(sA &amp; &quot;-&quot;, &quot;-&quot;)(0)	
	Case &quot;en&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;English&quot;)	
	Case &quot;eo&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Esperanto&quot;)
	Case &quot;ky&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Kyrgyz&quot;)
	Case &quot;mk&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Macedonian&quot;)
	Case &quot;pl&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Polish&quot;)
	Case &quot;pt&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Brazilian-Portuguese&quot;)
	Case &quot;ru&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Russian&quot;)
	Case &quot;sq&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Albanian&quot;)
	Case &quot;tt&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Tatar&quot;)
	Case &quot;uk&quot;
	fbOKWithRhVoice = FileExists(languages &amp; &quot;Ukrainian&quot;)
	Case Else
	fbOKWithRhVoice = False
	End Select 
End Function


Function fsGetPipLibPath(s_test As String, only_local As Boolean) As String
	&apos; On UNIX, if `only_local` is True, then do not check for a library
	&apos; unless the current user has explicitly installed it with a version
	&apos; of pip that makes user installed pip libraries available to other
	&apos; user applications, excluding python virtual environments (`venvs`).
	Dim ret_val$ : ret_val = &quot;&quot;
	Dim os_div$ : os_div = getPathSeparator
	Dim sPythonSubDirs$
	Dim deb12_pipx$ : deb12_pipx = &quot;&quot;
	Dim py_dir$
	Dim home$ : home = Environ(&quot;HOME&quot;)
	fsGetPipLibPath = &quot;&quot;

	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		sPythonSubDirs = &quot;\Lib\site-packages&quot;
		py_dir = Environ(&quot;LOCALAPPDATA&quot;) &amp; &quot;\Programs\Python&quot;
		Case &quot;MacOS&quot;
		sPythonSubDirs = &quot;/lib/python/site-packages&quot;
		py_dir = home &amp; &quot;/Library/Python&quot;	
		Case &quot;UNIX&quot;
		&apos; `snap`, `flatpak`, `appimage` and other standalone versions of
		&apos; of LibreOffice python might not work correctly with the system
		&apos; python extended libraries or user installed libraries
		deb12_pipx = home &amp; &quot;/.local/pipx/venvs/&quot; &amp; s_test
		If Not Instr(Environ(&quot;PWD&quot;), home) = 1 Then
			Exit Function
		ElseIf FileExists(deb12_pipx) Then
			&apos; NOTE: When path is present, the string points to a resource
			&apos; directory that contains the actual library. If the version
			&apos; of python doesn&apos;t match, then the python routine may fail.
			fsGetPipLibPath = deb12_pipx
			Exit Function
		ElseIf Len(fsAppImageResourcePath(&quot;python&quot;)) &lt;&gt; 0 Then
			Exit Function
		ElseIf Not only_local Then
			If FileExists(&quot;/usr/lib/python3/dist-packages/&quot; &amp; s_test) Then
				fsGetPipLibPath = &quot;/usr/lib/python3/dist-packages/&quot; &amp; s_test
				Exit Function
			ElseIf FileExists(fsLinux64PythonLib() &amp; &quot;/site-packages/&quot; &amp; s_test) Then
				fsGetPipLibPath = fsLinux64PythonLib() &amp; &quot;/site-packages/&quot; &amp; s_test
				Exit Function
			End If
		End If
		sPythonSubDirs = &quot;/site-packages&quot;
		py_dir = home &amp; &quot;/.local/lib&quot;
	End Select
	Dim sSubDirectories$ : sSubDirectories = fsSubDirectories(py_dir)
	Dim version_list As Variant : version_list = Split(sSubDirectories, Chr(13))

	Dim x As Integer : x = 0
	For x = Lbound(version_list) to Ubound(version_list)
		If instr(version_list(x), &quot;python&quot;) = 1 Then
			ret_val = py_dir &amp; _
			os_div &amp; _
			version_list(x) &amp; _
			sPythonSubDirs &amp; _
			os_div &amp; _
			s_test
			If FileExists(ret_val) Then
				fsGetPipLibPath = ret_val
				Exit Function
			End If
		End If
	Next
	fsGetPipLibPath = &quot;&quot;
End Function


Function fsSubDirectories(sPath As String)
	&apos; Returns directories
	Dim sDir As String : sDir = &quot;&quot;
	Dim sValue As String : sValue = &quot;&quot;
	Dim path_sep As String : path_sep = getPathSeparator
	fsSubDirectories = &quot;&quot;
	sDir = &quot;&quot;
	If Len(sPath) = 0 Then Exit Function
	sValue = Dir(sPath + path_sep + &quot;*&quot;, 16)

	On Error Resume Next
	Do
		If sValue &lt;&gt; &quot;.&quot; And sValue &lt;&gt; &quot;..&quot; Then
			If (GetAttr(sPath + path_sep + sValue) And 16) &gt; 0 Then
				sDir = sDir &amp; Chr(13) &amp; sValue			   
			End If
		End If
		sValue = Dir$
	Loop Until sValue = &quot;&quot;
	fsSubDirectories = fsSuperTrim(sDir, &quot;&quot;)
	Exit Function
	fsSubDirectoriesErr:
	fsSubDirectories = &quot;&quot;
End Function


Function fbLocalPythonDevKit() As Boolean
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		fbLocalPythonDevKit = FileExists(_
		Environ(_
		&quot;LOCALAPPDATA&quot;) &amp; &quot;\Programs\Python&quot;)
		Case &quot;MacOS&quot;
			fbLocalPythonDevKit = FileExists(_
			Environ(_
			&quot;HOME&quot;) &amp; &quot;/Library/Python&quot;)
		Case Else
			fbLocalPythonDevKit = False
		End Select
End Function


Function AwsBoto3Json()
	AwsBoto3Json = fsFullPathOf(&quot;aws/boto3/config.json&quot;)
End Function


Function AwsPolyJson()
	AwsPolyJson = fsFullPathOf(&quot;aws/polly/config.json&quot;)
End Function


Function GoogleApisJson()
	&apos; https://codelabs.developers.google.com/codelabs/cloud-text-speech-python3
	&apos; Requires registration with Google:
	&apos; Project_Email Project_Name, Project_ID, Project_Number
	&apos; [Set up python](https://cloud.google.com/python/docs/setup)
	&apos; Install python library using pip3
	&apos; `pip3 install --user --upgrade google-cloud-texttospeech`
	&apos; Save key.json to your configuration directory.
	&apos; Don&apos;t share the key without evaluating usage fees.
	&apos; Sample code produces .wav files
	GoogleApisJson = fsFullPathOf(&quot;googleapis/tts/key.json&quot;)
End Function


Function msAzureJson()
	msAzureJson = fsFullPathOf(&quot;ms/azure/cognitiveservices/speech/config.json&quot;)
End Function


Function ibmWatsonJson()
	ibmWatsonJson = fsFullPathOf(&quot;ibm/watson/speech/config.json&quot;)
End Function


Function gttsResourceCheck()
	Dim home$ : home = Environ(&quot;HOME&quot;)
	If FileExists(home &amp; &quot;/.local/pipx/venvs/gtts/bin/gtts-cli&quot;) Then
		gttsResourceCheck = fsFullPathOf(&quot;gtts/config.json&quot;)
	Else
		gttsResourceCheck = home &amp; &quot;/.local/bin/gtts-cli&quot;
	End If
End Function


Function fbHaveNetworkTTS() As Boolean
	&apos; See: &lt;https://github.com/pndurette/gTTS&gt;
	&apos; If you are not running libreoffice from normal home directory, then
	&apos; the script disables network speech because container versions of
	&apos; the application do not necessarily include the required libraries.
	&apos;
	&apos; Install `gtts` with `pip3 install python3-gtts-token python3-gtts
	If fbInPaths(&quot;docker-init&quot;) And fsGetOS() = &quot;UNIX&quot; Then
		fbHaveNetworkTTS = True
		Exit Function
	End If
	fbHaveNetworkTTS = Len(fsGetPipLibPath(&quot;gtts&quot;, True)) &lt;&gt; 0
	If fbHaveNetworkTTS Then
		Exit Function
	End If
	If fbInPaths(&quot;larynx-server&quot;) Then
		fbHaveNetworkTTS = True
		Exit Function
	End If
	Dim x# : x = 0
	Dim home$ : home = Environ(&quot;HOME&quot;)
	Dim Tokens : Tokens = Array(_
	gttsResourceCheck(), _
	AwsBoto3Json(), _
	AwsPolyJson(), _
	GoogleApisJson(), _
	ibmWatsonJson(), _
	msAzureJson())
	Select Case home
		Case Environ(&quot;PWD&quot;)
		If FileExists(fsNetworkTtsDoc()) And _
		Len(fsContainerResourcePath(&quot;python&quot;)) = 0 And _
		Len(fsContainerResourcePath(&quot;python3&quot;)) = 0 Then
			For x = Lbound(Tokens) To Ubound(Tokens)
				If FileExists(Tokens(x)) Then
					fbHaveNetworkTTS = True
					Exit For
				End If
			Next 
		End If
	End Select
End Function


Function neroTagPath() As String
	neroTagPath = &quot;&quot;
	Dim a1
	a1 = Array( _
	&quot;nero\neroAacTag.exe&quot;, _
	&quot;opt\neroAacTag.exe&quot;, _
	&quot;neroAacTag.exe&quot; _
	)
	Dim n
	For n = LBound(a1) To UBound(a1)
		If Len(fsFindAppPath(a1(n))) &gt; 0 Then
			neroTagPath = fsFindAppPath(a1(n))
			Exit For
		End If
	Next
End Function


Function neroEncPath() As String
	neroEncPath = &quot;&quot;
	Dim a1
	a1 = Array( _
	&quot;nero\neroAacEnc.exe&quot;, _
	&quot;opt\neroAacEnc.exe&quot;, _
	&quot;neroAacEnc.exe&quot; _
	)
	Dim n
	For n = LBound(a1) To UBound(a1)
		If Len(fsFindAppPath(a1(n))) &gt; 0 Then
			neroEncPath = fsFindAppPath(a1(n))
			Exit For
		End If
	Next
End Function


Function fsMyFfmpeg() As String
&apos; FFmpeg is a command line utility for playing, manipulating
&apos; and converting sound files.
	Dim sTest, sExt As String
	Dim aC, aD As Variant
	Dim i, j As Integer
	
	aC = Array(&quot;ffmpeg&quot;, &quot;avconv&quot;)
	sTest = &quot;&quot;
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		sExt = &quot;.exe&quot;
		aD = Array(_
			converttourl(fsProgramDirectory() &amp; &quot;/Shotcut/&quot;), _
			converttourl(fsProgramDirectoryx86() &amp; &quot;/Shotcut/&quot;), _	
			converttourl(Environ(&quot;HOMEDRIVE&quot;) &amp; &quot;/opt/&quot;), _
			converttourl(Environ(&quot;USERPROFILE&quot;) &amp; &quot;/opt/&quot;))
		Case Else
		sExt = &quot;&quot;
		aD = Array(_
			&quot;file:///usr/bin/&quot;, _
			&quot;file:///Applications/Shotcut.app/Contents/MacOS/&quot;, _
			&quot;file:///usr/local/bin/&quot;, _
			&quot;file:///opt/&quot;, _
			&quot;file:///opt/local/&quot;, _
			&quot;file:///opt/Shotcut/Shotcut.app/bin/&quot;)
	End Select
	For i = LBound(aC) To UBound(aC)
		For j = LBound(aD) to Ubound(aD)
			sTest = aD(j) &amp; aC(i) &amp; sExt
			If FileExists(sTest) Then
				fsMyFfmpeg = ConvertFromUrl(sTest)
				Exit Function
			End If
		Next
	Next
	fsMyFfmpeg = &quot;&quot;
End Function


Function fsMyPipeWire() As String
&apos; pw-cat is a command line utility for playing, manipulating
&apos; and converting sound files.
	Dim sTest, sExt As String
	Dim aC, aD As Variant
	Dim i, j As Integer
	
	aC = Array(&quot;pw-cat&quot;, &quot;pw-play&quot;)
	sTest = &quot;&quot;
	Select Case fsGetOS()
	Case &quot;WINDOWS&quot;
	sExt = &quot;.exe&quot;
	aD = Array(_
		converttourl(Environ(&quot;HOMEDRIVE&quot;) &amp; &quot;/opt/&quot;), _
		converttourl(Environ(&quot;USERPROFILE&quot;) &amp; &quot;/opt/&quot;))
	Case Else
	sExt = &quot;&quot;
	aD = Array(_
		&quot;file:///usr/bin/&quot;, _
		&quot;file:///usr/local/bin/&quot;, _
		&quot;file:///opt/&quot;, _
		&quot;file:///opt/local/&quot;)
	End Select
	For i = LBound(aC) To UBound(aC)
		For j = LBound(aD) to Ubound(aD)
			sTest = aD(j) &amp; aC(i) &amp; sExt
			If FileExists(sTest) Then
				fsMyPipeWire = ConvertFromUrl(sTest)
				Exit Function
			End If
		Next
	Next
	fsMyPipeWire = &quot;&quot;
End Function


Function fsGetPath(app As String) As String
	&apos; Use the system path to select a complete application URI
	&apos; or return `&apos;&apos;` if the application isn&apos;t in the path.
	&apos; Most platforms let you add and remove paths in the
	&apos; system user&apos;s &quot;PATHS&quot; list.
	FsGetPath = &quot;&quot;
	Dim spliter$ : spliter = &quot;:&quot;
	If fsGetOS() = &quot;WINDOWS&quot; Then
		spliter = &quot;;&quot;
	End If
	Dim a1 : a1 = split(Environ(&quot;PATH&quot;), spliter)
	Dim n# : n = 0
	Dim prueba$ : prueba = &quot;&quot;
	For n = Lbound(a1) To Ubound(a1)
		prueba = ConvertToURL(a1(n)) &amp; &quot;/&quot; &amp; app
		If FileExists(prueba) Then
			FsGetPath = prueba
			Exit Function
		End If
	Next
End Function


Function fsFindAppPath(sa) As String
	&apos; Given an Application subpath in the form
	&apos; `fsFindAppPath(&quot;Adobe/Adobe Digital Editions 4.5/DigitalEditions.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Audacity/Audacity.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Common Files/microsoft shared/MSInfo/msinfo32.exe&quot;)`
	&apos; `fsFindAppPath(&quot;ffmpeg/bin/ffmpeg.exe&quot;)`
	&apos; `fsFindAppPath(&quot;ffmpeg/bin/ffplay.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Internet Explorer/iexplore.exe&quot;)`
	&apos; `fsFindAppPath(&quot;lame3/lame.exe&quot;)`
	&apos; `fsFindAppPath(&quot;LibreOffice/program/soffice.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Microsoft VS Code/Code.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Mozilla Firefox/firefox.exe&quot;)`
	&apos; `fsFindAppPath(&quot;OpenOffice 4/program/soffice.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Pandoc/pandoc.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Python/Python310/python.exe&quot;)`
	&apos; `fsFindAppPath(&quot;xiph/flac.exe&quot;)`
	&apos; `fsFindAppPath(&quot;rarewares/oggenc.exe&quot;)`
	&apos; `fsFindAppPath(&quot;rarewares/oggenc2.exe&quot;)`
	&apos; `fsFindAppPath(&quot;VideoLAN/VLC/vlc.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Windows Media Player/wmplayer.exe&quot;)`
	&apos; `fsFindAppPath(&quot;Windows NT/Accessories/wordpad.exe&quot;)
	&apos; `fsFindAppPath(&quot;Zulu/zulu-17/bin/java.exe&quot;)`    &apos; returns a full path if it is in a normal
	&apos; location, like `C:\Program Files\` or it
	&apos; returns `&quot;&quot;` if it is not.
	&apos; The extension  can&apos;t reliably use programs that are installed 
	&apos; in a protected container format like `snap` or `flatpak`.
	fsFindAppPath = &quot;&quot;
	Dim n As Integer
	Dim a1
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		a1 = Array( _
		converttourl(Environ(&quot;READTEXTHELPER&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;LOCALAPPDATA&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;ProgramFiles&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;ProgramFiles(x86)&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;ProgramW6432&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;HOMEDRIVE&quot;) &amp; &quot;\opt\&quot;), _
		converttourl(Environ(&quot;SystemRoot&quot;) &amp; &quot;\&quot;), _
		converttourl(Environ(&quot;USERPROFILE&quot;) &amp; &quot;\opt\&quot;), _
		converttourl(Environ(&quot;HOMEDRIVE&quot;) &amp; &quot;\opt\&quot;), _
		converttourl(Environ(&quot;LOCALAPPDATA&quot;) &amp; &quot;\Programs\&quot;))
		Case &quot;MacOS&quot;
		a1 = Array( _
		&quot;file:///Applications/&quot;, _
		&quot;file:///usr/local/bin/&quot;, _
		&quot;file:///usr/bin/&quot;)
		Case Else
		a1 = Array( _
		&quot;file:///usr/local/bin/&quot;, _
		&quot;file:///usr/bin/&quot;)
	End Select
	If Len(sa) &gt; 0 Then
		For n = LBound(a1) To UBound(a1)
			If Len(a1(n)) &gt; Len(&quot;file:///&quot;) Then
				If FileExists(a1(n) &amp; sa) Then
					fsFindAppPath = a1(n) &amp; sa
					Exit Function
				End If
			End If
		Next
	End If
	fsFindAppPath = fsGetPath(sa)
End Function


Function vlcPath() As String
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		vlcPath = fsFindAppPath(&quot;VideoLAN/VLC/vlc.exe&quot;)
		Case &quot;MacOS&quot;
		vlcPath = fsFindAppPath(&quot;VLC.app/Contents/MacOS/VLC&quot;)
		Case Else
		Select Case Len(fsAppImageResourcePath(&quot;python&quot;))
		Case 0
			vlcPath = fsFindAppPath(&quot;vlc&quot;)
		Case Else
			vlcPath = &quot;&quot;
		End Select
	End Select
End Function


Function GstLaunchPath() As String
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		GstLaunchPath = fsFindAppPath(&quot;gstreamer/bin/gst-launch-1.0.exe&quot;)
		Case &quot;MacOS&quot;
		GstLaunchPath = &quot;&quot;
		Case Else
		GstLaunchPath = fsFindAppPath(&quot;gst-launch-1.0&quot;)
	End Select
End Function


Function ffmpegPath() As String
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		ffmpegPath = fsFindAppPath(&quot;ffmpeg/bin/ffmpeg.exe&quot;)
		Case &quot;MacOS&quot;
		ffmpegPath = fsFindAppPath(&quot;ffmpeg.app/Contents/MacOS/ffmpeg&quot;)
		Case Else
		ffmpegPath = fsFindAppPath(&quot;ffmpeg&quot;)
	End Select
End Function


Function flacPath() As String
&apos; Returns path to the flac audio file converter program.
	flacPath = &quot;&quot;
	Dim n
	Dim found_value$
	found_value = &quot;&quot;
	Dim a1
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		a1 = Array( _
		&quot;rarewares/flac.exe&quot;, _
		&quot;xiph/flac.exe&quot;, _
		&quot;flac/flac.exe&quot;, _
		&quot;flac.exe&quot;)
		Case &quot;MacOS&quot;
		a1 = Array( _
		&quot;flac.app/Contents/MacOS/flac&quot;, _
		&quot;flac&quot;)
		Case Else
		a1 = Array( _
		&quot;flac&quot;)
	End Select
	For n = LBound(a1) To UBound(a1)
		found_value = fsFindAppPath(a1(n))
		If Len(found_value) &gt; 0 Then
			flacPath = found_value
			Exit Function
		End If
	Next
End Function


Function lamePath() As String
	&apos; Returns path to the lame mp3 converter program.
	lamePath = &quot;&quot;
	Dim n
	Dim found_value$
	found_value = &quot;&quot;
	Dim a1
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		a1 = Array( _
		&quot;rarewares/lame.exe&quot;, _
		&quot;xiph/lame.exe&quot;, _
		&quot;lame3/lame.exe&quot;, _
		&quot;lame2/lame.exe&quot;, _
		&quot;lame/lame.exe&quot;, _
		&quot;Lame For Audacity/lame.exe&quot;, _
		&quot;lame.exe&quot;)
		Case &quot;MacOS&quot;
		a1 = Array( _
		&quot;lame.app/Contents/MacOS/lame&quot;, _
		&quot;lame&quot;, _
		&quot;LAME&quot;)
		Case Else
		a1 = Array( _
		&quot;lame&quot;, _
		&quot;LAME&quot;)
	End Select
	For n = LBound(a1) To UBound(a1)
		found_value = fsFindAppPath(a1(n))
		If Len(found_value) &gt; 0 Then
			lamePath = found_value
			Exit Function
		End If
	Next
End Function


Function neroPath() As String
	&apos; Returns path to the nero aac converter program.
	neroPath = &quot;&quot;
	Dim n
	Dim found_value$
	found_value = &quot;&quot;
	Dim a1
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		a1 = Array( _
		&quot;nero/neroAacEnc.exe&quot;, _
		&quot;neroAacEnc.exe&quot;)
		Case &quot;MacOS&quot;
		a1 = Array( _
		&quot;neroAacEnc.app/Contents/MacOS/neroAacEnc&quot;, _
		&quot;neroAacEnc&quot;, _
		&quot;NEROAACENC&quot;)
		Case Else
		a1 = Array( _
		&quot;neroAacEnc&quot;, _
		&quot;NEROAACENC&quot;)
	End Select
	For n = LBound(a1) To UBound(a1)
		found_value = fsFindAppPath(a1(n))
		If Len(found_value) &gt; 0 Then
			neroPath = found_value
			Exit Function
		End If
	Next
End Function


Function oggPath() As String
	&apos; Returns path to the ogg converter program.
	oggPath = &quot;&quot;
	Dim n
	Dim found_value$
	found_value = &quot;&quot;
	Dim a1
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		a1 = Array( _
		&quot;rarewares/oggenc2.exe&quot;, _
		&quot;rarewares/oggenc.exe&quot;, _
		&quot;xiph/oggenc2.exe&quot;, _
		&quot;xiph/oggenc.exe&quot;, _
		&quot;ogg/oggenc2.exe&quot;, _
		&quot;ogg/oggenc.exe&quot;, _
		&quot;oggenc2.exe&quot;, _
		&quot;oggenc.exe&quot;)
		Case &quot;MacOS&quot;
		a1 = Array( _
		&quot;ogg.app/Contents/MacOS/oggenc2&quot;, _
		&quot;oggenc2&quot;, _
		&quot;oggenc&quot;)
		Case Else
		a1 = Array( _
		&quot;oggenc2&quot;, _
		&quot;oggenc&quot;)
	End Select
	For n = LBound(a1) To UBound(a1)
		found_value = fsFindAppPath(a1(n))
		If Len(found_value) &gt; 0 Then
			oggPath = found_value
			Exit Function
		End If
	Next
End Function


Sub resetSpeechDispatcher( _
	bAll As Boolean)
&apos;Stopping Speech
	Dim a1
	Dim i# : i = 0
	Dim errorCode
	Dim oBar
	Dim oFrame
	Dim sTemp
	
	On Error Resume Next
	oFrame = ThisComponent.getCurrentController().getFrame()
	oBar = oFrame.createStatusIndicator()
	oBar.start(fsLookUpTerm(&quot;s_read-text&quot;), 100)
	oBar.Value = 70
	On Error Goto resetSpeechDispatcherErr
    Select Case fsGetOS()
    	Case &quot;WINDOWS&quot;
		fbRemoveFile(fsMyTempLock(&quot;lock&quot;))
    	Case &quot;MacOS&quot;
		If FileExists(&quot;/usr/bin/say&quot;) Then
			If Not (fbCreatingMacOSMediaFile()) Then
				errorCode = Shell(&quot;killall&quot;, 0, &quot;say&quot;, True)
				errorCode = Shell(&quot;killall&quot;, 0, &quot;afplay&quot;, True)
				fbRemoveFile(fsMyTempLock(&quot;lock&quot;))
			End If
		End If

    	Case Else  &apos; UNIX
		If FileExists(&quot;/usr/bin/spd-say&quot;) Or _
			FileExists(&quot;/usr/local/bin/spd-say&quot;) Then
			If bAll Then
				errorCode = Shell(&quot;killall&quot;, 0, &quot;--quiet speech-dispatcher&quot;, True)
			Else
				errorCode = Shell(&quot;spd-say&quot;, 0, &quot;--cancel&quot;, True)
			End If
		ElseIf FileExists(&quot;/usr/bin/speech-dispatcher&quot;) Then	
			errorCode = Shell(&quot;killall&quot;, 0, &quot;--quiet speech-dispatcher&quot;, True)
		End If
		
		If Not ( _
			fbLetButtonInterruptPosixPlayer) Or fbUsingPosixTalkProgram( _
			fsProgramCommand()) Then
			&apos; Stop the sound.
			&apos; Check players before synthesizers.
			a1 = Array( _
			&quot;gst-launch-1.0&quot;, _
			&quot;pw-cat&quot;, _
			&quot;afplay&quot;, _
			&quot;aplay&quot;, _
			&quot;artsplay&quot;, _
			&quot;esdplay&quot;, _
			&quot;ffplay&quot;, _
			&quot;ossplay&quot;, _
			&quot;paplay&quot;, _
			&quot;play&quot;, _
			&quot;roarcat&quot;, _
			&quot;roarcatplay&quot;, _
			&quot;espeak&quot;, _
			&quot;espeak-ng&quot;, _
			&quot;festival&quot;, _
			&quot;festvox&quot;, _
			&quot;padsp&quot;, _
			&quot;pico2wave&quot;, _
			&quot;speak_ng&quot;, _
			&quot;text2wave&quot;)
			For i = LBound(a1) To UBound(a1)
				If FileExists(&quot;/usr/bin/&quot; &amp; a1(i)) Or _
					FileExists(&quot;/usr/local/bin/&quot; &amp; a1(i)) Then
					errorCode = Shell(&quot;killall&quot;, 0, &quot;--quiet &quot; &amp; a1(i), True)
				End If
			Next
			If fbHaveNetworkTTS() And FileExists(&quot;/usr/bin/vlc&quot;) Then
				errorCode = Shell(&quot;killall&quot;, 0, &quot;--quiet vlc&quot;, True)
			End If
		End If
		fbRemoveFile(fsMyTempLock(&quot;lock&quot;))
		fbRemoveFile(fsTemporaryTextDoc() &amp; &quot;.sable&quot;)
    End Select
	fbRemoveFile(fsTemporaryTextDoc())
	On Error Resume Next
	oBar.End()
	Exit Sub
	resetSpeechDispatcherErr:
End Sub


Function fbLetButtonInterruptPosixPlayer() As Boolean
	Dim b1 As Boolean
	
	b1 = False
	&apos; don&apos;t interrupt if we are writing a media file
	b1 = fbCreatingMediaFile(&quot;.3gp,.aac,.aif,.aiff,.alsa,.ape,.asf,.au,.avi,.caf,.dts,.flac,&quot; &amp; _
	&quot;.m4a,.mp2,.mp3,.mp4,.mpeg,.oga,.ogg,.ogm,.ogv,.oma,.opus,.riff,.rm,.smp,.snd,.sou,.spx,&quot; &amp; _
	&quot;.tta,.voc,.wav,.weba,.webm,.wma,.wmv,.wsaud&quot;)
	&apos; don&apos;t interrupt if we are using a graphical player.
	If fbCreatingMediaFile( _
		&quot;--visible true,--visible &apos;true&apos;,--visible &quot;&quot;true&quot;&quot;&quot;) Or _
		Not (fbCreatingMediaFile(&quot;--visible &quot;)) Then
		b1 = False
	End If
	fbLetButtonInterruptPosixPlayer = b1
End Function


Function fbCreatingMacOSType2Media() As Boolean
	&apos; We either didn&apos;t use ffmpeg or a compatible media player is missing.
	fbCreatingMacOSType2Media = fbCreatingMediaFile( _
	&quot;.aif,.avi,.aiff,.flac,.m4a,.oga,.ogg,.ogv,.wav,.webm,.wma,.wmv&quot;)
End Function


Function fbCreatingMacOSType1Media() As Boolean
	fbCreatingMacOSType1Media = fbCreatingMediaFile(&quot;.caf,.m4v,.mp3,.mp4&quot;)
End Function


Function fbCreatingMacOSMediaFile() As Boolean
	Dim sA As String
	fbCreatingMacOSMediaFile = fbCreatingMediaFile(&quot;.aif,.caf,.m4v,.mp3,.mp4&quot;)
End Function


Function fbCreatingMediaFile( _
	Optional ByVal sA, _
	Optional ByVal sB) As Boolean
	&apos; s2 is a csv string of media identifiers- for example, file extensions.
	&apos; config is a set of preferences. This function uses use config(5); the
	&apos; string in `Tools - Add-ons - Read Selection... - Command Line Options`
	&apos; You can test or simulate different command strings with sB.
	If ismissing(sA) Then
		sA = &quot;.3gp,.aac,.aif,.aiff,.au,.avi,.bit,.flac,.m4a,.m4v,.mov,.mkv,.mp2,&quot; &amp; _
		&quot;.mp3,.mp4,.mpeg,.oga,.ogg,.ogm,.ogv,.opus,.wav,.webm,.wma,.wmv&quot;
	End If
	If ismissing(sB) Then
		sB = &quot;&quot;
	End If
	Dim sFile As String
	Dim aA
	Dim bTattle As Boolean
	bTattle = False
	Dim n As Integer
	n = 0
	Dim msgs()As Variant
	Dim errorCode As Integer
	errorCode = 0
	Dim config(fiCountConfigOptions) As Variant
	
	fbCreatingMediaFile = False
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	tts_config_parseFile(sFile, config(), errorCode)
	If Len(sB) &lt; 1 Then
		sB = LCase(config(5))
	End If
	If bTattle Then
		MsgBox sB &amp; Chr(10) &amp; sA
	End If
	If Not(config(fiExternalOption())) Then
		&apos; if the external option button in the main dialogue is not selected, then return
		&apos;     fbCreatingMediaFile = False
		Exit Function
	End If
	aA = Split(LCase(sA), &quot;,&quot;)
	If Len(sB) &lt;&gt; 0 Then
		For n = LBound(aA) To UBound(aA)
			If aA(n) = &quot;&quot; Then
				Exit For
			ElseIf InStr(sB, aA(n)) &lt;&gt; 0 Then
				fbCreatingMediaFile = True
				Exit For
			End If
		Next
	End If
End Function


Function fbGoingOnline() As Boolean
	Dim sFile As String
	Dim errorCode As Integer
	Dim config(fiCountConfigOptions)As Variant
	
	fbGoingOnline = False
	sFile = fsFullPathOf(fsExtensionSettingsIni)
	tts_config_parseFile(sFile, config(), errorCode)
	If config(fiHtmlOption) Then
		fbGoingOnline = True
	End If
End Function


Function fsThisDocAuthor() As String
	Dim s1 As String
	Dim s2 As String
	
	On Error Goto fsThisDocAuthorErr
	s1 = ThisComponent.DocumentProperties.Author
	If Len(Trim(s1)) = 0 Then
		s1 = fsGetThisUsers(&quot;fullname&quot;)
	End If
	If Len(Trim(s1)) = 0 Then
		&apos; Fallback - system user name
		Select Case fsGetOS()
			Case &quot;WINDOWS&quot;
			s1 = Environ(&quot;USERNAME&quot;)
			Case &quot;MacOS&quot;
			s1 = Environ(&quot;USERNAME&quot;)
			Case Else  &apos; UNIX
			s1 = Environ(&quot;USER&quot;)
		End Select
	End If
	&apos; Final fallback - extension name and version.
	If Len(Trim(s1)) = 0 Then
		s1 = fsLookUpTerm( &quot;s_read-text&quot;) &amp; &quot; &quot; &amp; _
		fsExtensionVersion()
	End If
	fsThisDocAuthor = fsSmarten(fsQuickTitle(12, 60, s1))
	Exit Function
	fsThisDocAuthorErr:
	
	fsThisDocAuthor = fsLookUpTerm(&quot;s_read-text&quot;)
End Function


Function fsGetThisUsers( _
	Optional cType As String) As String
&apos;Your personal information
	If ismissing(cType) Then
		cType = &quot;fn&quot;
	End If
	Dim sNodePath$ : sNodePath = &quot;/org.openoffice.UserProfile/Data&quot;
	Dim oNode
	Dim snval
	Dim gnval
	Dim ival
	Dim sFullname  &apos; We combine your first and last names.
	
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	
	oNode = foGetOOoSetupNode(sNodePath$)
	snval = oNode.getByName(&quot;sn&quot;)
	gnval = oNode.getByName(&quot;givenname&quot;)
	Select Case fsGetSetting(&quot;language&quot;)
		Case &quot;zh&quot;, &quot;jp&quot;, &quot;ja&quot;, &quot;yu&quot;, &quot;ko&quot; &apos;Asian
		sFullname = snval &amp; gnval
		Case Else
		sFullname = gnval &amp; &quot; &quot; &amp; snval
	End Select
	Select Case cType
		Case &quot;fn&quot;, &quot;fullname&quot;
		fsGetThisUsers = sFullname
		Case &quot;c&quot;, &quot;country&quot; &apos; region (province or state and country)
		fsGetThisUsers = oNode.getByName(&quot;c&quot;)
		Case &quot;facsimiletelephonenumber&quot;
		fsGetThisUsers = oNode.getByName(&quot;facsimiletelephonenumber&quot;)
		Case &quot;givenname&quot;, &quot;gn&quot;
		fsGetThisUsers = oNode.getByName(&quot;givenname&quot;)
		Case &quot;homephone&quot;
		fsGetThisUsers = oNode.getByName(&quot;homephone&quot;)
		Case &quot;initials&quot;
		fsGetThisUsers = oNode.getByName(&quot;initials&quot;)
		Case &quot;l&quot;, &quot;city&quot;
		fsGetThisUsers = oNode.getByName(&quot;l&quot;)
		Case &quot;mail&quot;, &quot;email&quot;
		fsGetThisUsers = oNode.getByName(&quot;mail&quot;)
		Case &quot;o&quot;, &quot;organization&quot;
		fsGetThisUsers = oNode.getByName(&quot;o&quot;)
		Case &quot;position&quot;
		fsGetThisUsers = oNode.getByName(&quot;position&quot;)
		Case &quot;postalcode&quot;, &quot;zipcode&quot;
		fsGetThisUsers = oNode.getByName(&quot;postalcode&quot;)
		Case &quot;sn&quot;, &quot;surname&quot;
		fsGetThisUsers = oNode.getByName(&quot;sn&quot;)
		Case &quot;st&quot;, &quot;state&quot;, &quot;province&quot;
		fsGetThisUsers = oNode.getByName(&quot;st&quot;)
		Case &quot;street&quot;, &quot;address&quot;
		fsGetThisUsers = oNode.getByName(&quot;street&quot;)
		Case &quot;telephonenumber&quot;, &quot;workphone&quot;
		fsGetThisUsers = oNode.getByName(&quot;telephonenumber&quot;)
		Case &quot;title&quot;
		fsGetThisUsers = oNode.getByName(&quot;title&quot;)
		Case Else
		fsGetThisUsers = &quot;&quot;
	End Select
End Function


Function fsThisSoundTitle( _
	Optional ByVal strip_these) As String
	Dim s1 As String
	If ismissing(strip_these) Then
		strip_these = &quot;`#&gt;_ &quot;
	End If
	If Len(strip_these) = 0  Then
		strip_these = &quot; &quot;
	End If
	On Error Goto fsThisSoundTitleErr
	s1 = fsTrimSpecial(fsQuickTitle(6, 60), Chr(13) &amp; Chr(10) &amp; strip_these)
	fsThisSoundTitle = fsSmarten(s1)
	Exit Function
	fsThisSoundTitleErr:
	
	fsThisSoundTitle = &quot;&quot;
End Function


Function fsThisDocTitle() As String
	Dim sC As String
	
	On Error Goto fsThisDocTitleErr
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	sC = ThisComponent.DocumentProperties.Title
	If Len(sC) = 0 Then
		sC = Replace(_
		GetFileNameWithoutExtension(_
		FileNameoutofPath(ThisComponent.getURL())), &quot;%20&quot;, &quot; &quot;)
	End If
	fsThisDocTitle = fsSuperTrim(sC, &quot;&quot;)
	Exit Function
	fsThisDocTitleErr:
	
	fsThisDocTitle = fsGetSetting(&quot;ooname&quot;) &amp; _
	&quot; - &quot; &amp; _
	fsLookUpTerm(&quot;s_speech-synthesis&quot;)
End Function


Function fsViewAndEditEscapedText( _
	Optional ByVal sA) As String
	If ismissing(sA) Then
		sA = fsThisDocTitle()
	End If
	fsViewAndEditEscapedText = InputBox(sA, _
	&quot;Test&quot;, _
	fsEscapeStr(fsThisDocTitle, True))
End Function


Function fsThisDocGenre() As String
	Dim sA, sB As String
	
	On Error Goto fsThisDocGenreErr
	sA = fsLookUpTerm(&quot;s_speech-synthesis&quot;)
	If fsGetLanguage = fsSelectionLanguage() Then
		sB = &quot;&quot;
	Else
		If fsGetLanguage() = &quot;en&quot; Then
			&apos; Use language and region
			sB = isoToEnglish(fsSelectionLanguageAndRegion(True))
		Else
			&apos; Use lookup table for language
			&apos; Use language and region for Traditional Chinese (zh-TW)
			&apos; and Simplified Chinese (zh-CN)
			sB = fsLookUpTerm(fsSelectionLanguage())
		End If
	End If
	If Len(sB) = 0 Then
		fsThisDocGenre = sA
	Else
		fsThisDocGenre = sA &amp; &quot; &quot; &amp; Chr(2014) &amp; &quot; &quot; &amp; sB  &apos; mdash;
	End If
	Exit Function
	fsThisDocGenreErr:
	
	fsThisDocGenre = &quot;Speech&quot;
End Function


Function fsSmarten( _
	ByVal a, _
	Optional sCheckCode) As String
	&apos; Prepare text for printed appearance - smart quotes
	&apos; em-dashes etc.  Optionally, manipulate string
	&apos; for system or functional requirements.
	If ismissing(sCheckCode) Then
		sCheckCode = fsGetOS()
	End If
	Dim CR, b, c, d As String
	Dim aB,aC,aD
	Dim i, j As Integer
	
	CR = Chr$(10)
	aB = Array(Chr(13), _
	Chr(45), _
	Chr(42), _
	Chr(95), _
	Chr(8211), _
	Chr(8212), _
	Chr(40), _
	Chr(41), _
	Chr(91), _
	Chr(93), _
	Chr(32), _
	Chr(10), _
	Chr(9))
	a = &quot; &quot; &amp; a
	&apos; opening single quotes
	For i = LBound(aB) To UBound(aB)
		a = fsReplaceText(a, aB(i) &amp; &quot;&apos;&quot;, aB(i) &amp; &quot;‘&quot;)
	Next
	&apos; closing single quotes &amp; apostrophes
	a = fsReplaceText(a, &quot;&apos;&quot;, &quot;’&quot; )
	&apos; opening double quotes
	a = fsReplaceText(a, &quot;‘&quot;&quot;&quot;, &quot;‘“&quot; )
	For i = LBound(aB) To UBound(aB)
		a = fsReplaceText(a, aB(i) &amp; &quot;&quot;&quot;&quot;, aB(i) &amp; &quot;“&quot;)
	Next
	&apos; closing double quotes
	a = fsReplaceText(a, &quot;&quot;&quot;&quot;, &quot;”&quot; )
	&apos; horizontal ellipsis
	a = fsReplaceText(a, &quot;...&quot;, &quot;…&quot; )
	&apos; fractions, copyright, em-dashes
	&apos; &quot;¼,½,¾,⅓,⅔,⅛,⅜,⅝,⅞,©,—,—&quot;
	aC = Array( _
	Chr(188), _
	Chr(189), _
	Chr(190), _
	Chr(8531), _
	Chr(8532), _
	Chr(8539), _
	Chr(8540), _
	Chr(8541), _
	Chr(8542), _
	Chr(169), _
	Chr(8211), _
	Chr(8212))
	aD = Array( _
	&quot;1/4&quot;, _
	&quot;1/2&quot;, _
	&quot;3/4&quot;, _
	&quot;1/3&quot;, _
	&quot;2/3&quot;, _
	&quot;1/8&quot;, _
	&quot;3/8&quot;, _
	&quot;5/8&quot;, _
	&quot;7/8&quot;, _
	&quot;(c)&quot;, _
	&quot;--&quot;, _
	&quot;---&quot;)
	For j = LBound(aC) To UBound(aC)
		For i = LBound(aB) To UBound(aB)
			a = fsReplaceText( _
			a, _
			&quot; &quot; &amp; aD(j) &amp; aB(i), _
			&quot; &quot; &amp; aC(j) &amp; aB(i))
		Next
	Next
	Select Case sCheckCode
		Case &quot;MacOS&quot;
		&apos; Remove speech code and alter Markdown emphasis markers
		&apos; and characters that could be interpreted as osascript
		a = fsReplaceText(a, &quot;[[slnc 400]]&quot;, &quot;&quot;)
		a = fsReplaceText(a, &quot;--&quot;, &quot;  &quot;)
		a = fsReplaceText(a, &quot;**)&quot;, &quot;__)&quot;)
		a = fsReplaceText(a, &quot;(**&quot;, &quot;(__&quot;)
		a = fsReplaceText(a, &quot;*)&quot;, &quot;_)&quot;)
		a = fsReplaceText(a, &quot;(*&quot;, &quot;(_&quot;)
		a = fsReplaceText(a, &quot;«&quot;, &quot;”&quot;)
		a = fsReplaceText(a, &quot;»&quot;, &quot;“&quot;)
		Case &quot;WEB&quot;
		a = fsEscapeStr(a)
		Case Else
		&apos; Add function specific manipulations
	End Select
	fsSmarten = RTrim( _
	Right( _
	a, _
	Len(a) - 1))
End Function


Function fsQuickTitle( _
	Optional iWords, _
	Optional iMaxLength, _
	Optional sText) As String
	&apos; Returns the first words of the selected string
	Dim s1, s2, s3, s4, CR As String
	Dim a1, a2, a3, a4
	Dim n As Integer
	
	If ismissing(iWords) Then
		iWords = 6
	End If
	If ismissing(iMaxLength) Then
		iMaxLength = 30
	End If
	If ismissing(sText) Then
		a4 = Split(fsGetTextSelection(True, False), Chr(10))
		sText = a4(LBound(a4))
	End If
	On Error Goto fsQuickTitleErr
	If fsComplexAsiaOrWest(sText) = &quot;ASIA&quot; Then
		&apos; Use the greater of word count or string length.
		&apos; We need to assess Asian text differently.
		&apos; Asian text might not contain spaces or
		&apos; the `split(s1, s2)` function may not give an
		&apos; accurate ubound value when the second
		&apos; argument (`s2`) is Asian.
		s3 = Trim(sText)
		If iMaxLength &gt; iWords Then
			n = iMaxLength
		Else
			n = iWords
		End If
		If Len(s3) &gt; n Then
			fsQuickTitle = Left(s3, n)
		Else
			fsQuickTitle = s3
		End If
	Else
		&apos; We avoid splitting in the middle of a word.
		s1 = sText
		s2 = &quot;&quot;
		s3 = &quot;&quot;
		s4 = &quot;&quot;
		CR = Chr$(10)
		If Len(sText) = 0 Then
			s2 = &quot;&quot;
		Else
			s4 = s1
			a3 = Split(s4, CR)
			For n = LBound(a3) To UBound(a3)
				If Len(a3(n)) &gt; 1 And Not(fbMdCode(a3(n))) Then
					s1 = a3(n)
					Exit For
				End If
			Next
			s2 = &quot;&quot;
			a1 = Split(s1, &quot; &quot;)
			For n = LBound(a1) To iWords + 1
				s1 = s1 &amp; &quot; &quot; &amp; Chr$(13)
			Next n
			a2 = Split(s1, &quot; &quot;)
			For n = LBound(a2) To iWords - 1
				s3 = s3 &amp; a2(n) &amp; &quot; &quot;
				If Len(s3) &gt; iMaxLength Then
					Exit For
				End If
				s2 = s3
			Next
			s2 = fsSuperTrim(s2, &quot;&quot;)
			s2 = fsReplaceText(s2, Chr$(13),&quot;&quot;)
			s2 = fsReplaceText(s2, Chr$(10), &quot; &quot;)
			s2 = fsReplaceText(s2, Chr$(9), &quot;&quot;)
		End If
		
		fsQuickTitle = Trim(s2)
	End If
	Exit Function
	fsQuickTitleErr:
	
	fsQuickTitle = &quot;&quot;
End Function


Function fbMdCode( _
	ByVal sA) As Boolean
	&apos; Identify lines with strings of spaces, tabs or computer code characters
	Dim n, o As Integer
	Dim s1 As String
	Dim a1
	
	sA = Trim(sA)
	n = Len(sA)
	a1 = Array( _
	&quot;=&quot;, _
	&quot;-&quot;, _
	&quot; &quot;, _
	&quot;&apos;&quot;, _
	&quot;*&quot;, _
	&quot;#&quot;, _
	&quot;&quot;&quot;&quot;, _
	&quot;\&quot;, _
	&quot;[&quot;, _
	&quot;]&quot;, _
	&quot;{&quot;, _
	&quot;}&quot;, _
	&quot;/&quot;, _
	&quot;(&quot;, _
	&quot;$&quot;, _
	&quot;%&quot;, _
	&quot;;&quot;, _
	&quot;:&quot;, _
	Chr$(9))
	fbMdCode = False
	For o = LBound(a1) To UBound(a1)
		If String(n, a1(o)) = sA Then
			fbMdCode = True
			Exit For
		End If
	Next
End Function


Function fsSlidePlainText( _
	Optional ByVal i) As String
	If ismissing(i) Then
		i =  - 100
	End If
	Dim oDoc, oDrawPage, oDrawPages
	Dim nShape, nNumShapes
	Dim oShape
	Dim sA, sB
	
	fsSlidePlainText = &quot;&quot;
	sB = &quot;&quot;
	sA = &quot;&quot;
	oDoc = ThisComponent
	If oDoc.supportsService( _
		&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		Select Case i
			Case - 100
			i = ThisComponent.getCurrentController.getCurrentPage().Number() - 1
		End Select
		oDrawPages = oDoc.getDrawPages()
		oDrawPage = oDrawPages.getByIndex(i)
		nNumShapes = oDrawPage.getCount()
		For nShape = 0 To nNumShapes - 1
			oShape = oDrawPage.getByIndex(nShape)
			If HasUnoInterfaces(oShape, &quot;com.sun.star.lang.XServiceInfo&quot;) Then
				sA = &quot;&quot;
				On Error Resume Next
				&apos; The slide has an item that does not support getString
				sA = fsSuperTrim(oShape.getText().getString(), &quot;&quot;)
				fsSlidePlainTextErr1
				
				If Len(sA) &lt;&gt; 0 Then
					sB = sB &amp; sA &amp; Chr$(10)
				End If
			End If
		Next
	End If
	fsSlidePlainText = sB
End Function


Function fsCleanMdCode( _
	ByVal sA) As String
	&apos; Remove lines that are repeating markdown or computer
	&apos; code dividers like &quot;=====&quot;, &quot;#####&quot; or &quot;-----&quot;
	Dim a1
	Dim CR As String
	Dim LF As String
	Dim n As Integer
	Dim s1
	
	s1 = &quot;&quot;
	CR = Chr(10)
	LF = Chr(13)
	sA = fsReplaceText(sA, LF, &quot;&quot;)
	a1 = Split(sA, CR)
	For n = LBound(a1) To UBound(a1)
		If(fbMdCode(a1(n))) Then
			s1 = s1 &amp; CR
		Else
			s1 = s1 &amp; a1(n) &amp; CR
		End If
	Next
	fsCleanMdCode = s1
End Function


Function fbIsAPowerPointToken( _
	sA) As Boolean
	&apos; Is the string a simple token like &quot;&lt;number&gt;&quot;
	&apos; as opposed to an xml string or a plain text string?
	Dim x As Integer
	
	x = Len(sA)
	fbIsAPowerPointToken = False
	If x &lt;&gt; 0 And x &lt; 100 Then  &apos; sanity check
		If InStr(sA,&quot;&gt;&quot;) = x Then
			If InStr(sA,&quot; &quot;) = 0 Then
				If InStr(sA,&quot;&lt;&quot;) = 1 Then
					fbIsAPowerPointToken = True
				End If
			End If
		End If
	End If
End Function

Function fsGetSlidenote( _
	Optional bClean, _
	Optional ByVal nPage) As String
	Dim oDoc As Object
	Dim sA As String
	Dim i As Integer
	
	If ismissing(bClean) Then
		bClean = True
	End If
	If ismissing(nPage) Then
		nPage =  - 100
	End If
	oDoc = ThisComponent
	sA = &quot;&quot;
	fsGetSlidenote = &quot;&quot;
	If oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		Select Case nPage
			Case - 100
			nPage = oDoc.getCurrentController.getCurrentPage().Number - 1
		End Select
		i = fiGetSlidenoteIndex(nPage)
		If i &lt;&gt; - 1 Then
			If HasUnoInterfaces(oDoc.getDrawPages().getByIndex(nPage).getnotesPage.getByIndex(i), _
				&quot;com.sun.star.text.XText&quot;) Then
				sA = oDoc.getDrawPages().getByIndex(nPage).getnotesPage.getByIndex(i).String
				
				If Len(sA) &lt;&gt; 0 Then
					&apos; ignore empty text fields
					If Not(fbIsAPowerPointToken(sA)) Then
						&apos; ignore PowerPoint utility fields
						If bClean Then
							fsGetSlidenote = fsCleanMdCode(sA)
						Else
							fsGetSlidenote = sA
						End If
					End If
				End If
			End If
		End If
	Else
		fsGetSlidenote = &quot;&quot;
	End If
End Function


Function fiGetSlidenoteIndex( _
	Optional nPage) As Integer
	On Error Goto fiGetSlidenoteIndexErr
	Dim oDoc As Object
	Dim i As Integer
	Dim sA As String
	Dim inotesCount As Integer
	If ismissing(nPage) Then
		nPage =  - 100
	End If
	oDoc = ThisComponent
	fiGetSlidenoteIndex =  - 1
	If oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		Select Case nPage
			Case - 100
			nPage = oDoc.getCurrentController.getCurrentPage().Number - 1
		End Select
		inotesCount = oDoc.getDrawPages().getByIndex( nPage ).getnotesPage.getCount
		If inotesCount = 2 Then
			&apos; a native Impress document
			For i = inotesCount - 1 To 0 step - 1
				If HasUnoInterfaces( _
					oDoc.getDrawPages().getByIndex(nPage).getnotesPage.getByIndex(i), _
					&quot;com.sun.star.text.XText&quot;) Then
					fiGetSlidenoteIndex = i
					Exit For
				End If
			Next
		Else
			&apos; Presentation probably originated from PowerPoint, so note
			&apos; page contains extra text fields. The order depends on
			&apos; whether the original was a ppt or a pptx. We examine 
			&apos; the contents to guess which PowerPoint field includes
			&apos; the speaker notes. In most cases, the highest numbered 
			&apos; text field is the presenter notes field.
			&apos; if you add a new text field to the notes page, we use that 
			&apos; field.
			fiGetSlidenoteIndex = inotesCount - 1
			For i = inotesCount - 1 To 0 step - 1
				If HasUnoInterfaces(oDoc.getDrawPages().getByIndex( nPage ).getnotesPage.getByIndex(i), _
					&quot;com.sun.star.text.XText&quot;) Then
					sA = oDoc.getDrawPages().getByIndex( nPage ).getnotesPage.getByIndex(i).String
					If Len(sA) &lt;&gt; 0 Then
						&apos;ignore empty text fields
						If Not(fbIsAPowerPointToken(sA)) Then
							&apos; ignore PowerPoint page number display field
							fiGetSlidenoteIndex = i
							Exit For
						End If
					End If
				End If
			Next
		End If
	Else
		&apos; We didn&apos;t find a valid presentation text field.
		&apos; Signal the calling routine.
		fiGetSlidenoteIndex = - 1
	End If
	Exit Function
	fiGetSlidenoteIndexErr:
	
	fiGetSlidenoteIndex = - 1
End Function


Function fsExportAlbumCover( _
	Optional sPath, _
	Optional iScale) As String
	&apos; exports current slide as an album cover
	&apos; returns path if successful creating an image.
	If ismissing(iScale) Then
		&apos; We should use a fairly small image size so that the
		&apos; image does not increase the audio file size much.
		&apos; This makes an image of 600x450 pixels for a normal slide.
		iScale = 28000 / 600
	End If
	If ismissing(sPath) Then
		sPath = converttourl(fsGetHomeDir) &amp; fsSelectionLanguage() &amp; _
		&quot;/poster-&quot; &amp; _
		Right(&quot;000&quot; &amp; _
		Trim(str(fiMyCurrentAudioTrack(False))), 3) &amp; _
		&quot;.jpg&quot;
	ElseIf sPath = &quot;&quot; Then
		sPath = converttourl(fsGetHomeDir) &amp; fsSelectionLanguage() &amp; _
		&quot;/poster-&quot; &amp; _
		Right(&quot;000&quot; &amp; _
		Trim(str(fiMyCurrentAudioTrack(False))), 3) &amp; _
		&quot;.jpg&quot;
	End If
	Dim xDoc, sView, xSelection, xObj, xView
	Dim aFD1(4) As New com.sun.star.beans.PropertyValue
	
	fsExportAlbumCover = &quot;&quot;
	If ThisComponent.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Then
		viewNormal()
		&apos; let&apos;s wait a second to make sure the display is stabilized.
		wait 1000
		
		&apos; Make sure we have a writable folder
		CreateFile(sPath &amp; &quot;.txt&quot; , fsAppSignature(), &quot;UTF-8&quot;)
		If FileExists(sPath &amp; &quot;.txt&quot;) Then
			fbRemoveFile(sPath &amp; &quot;.txt&quot;)
		Else
			fsExportAlbumCover = &quot;&quot;
			Exit Function
		End If
		&apos; describe image properties
		aFD1(0).Name = &quot;PixelWidth&quot;        &apos;
		aFD1(0).Value = Int((fsImpressdimension(&quot;Width&quot;) / iScale) + .5)
		aFD1(1).Name = &quot;PixelHeight&quot;
		aFD1(1).Value = Int((fsImpressdimension(&quot;Height&quot;) / iScale) + .5)
		aFD1(2).Name = &quot;LogicalWidth&quot;
		aFD1(2).Value = Int((fsImpressdimension(&quot;Width&quot;) / iScale) + .5)
		aFD1(3).Name = &quot;LogicalHeight&quot;
		aFD1(3).Value = Int((fsImpressdimension(&quot;Height&quot;) / iScale) + .5)
		aFD1(4).Name = &quot;Quality&quot;
		aFD1(4).Value = 65
		xDoc = thiscomponent
		xView = xDoc.currentController
		xSelection = xView.selection
		xObj = xView.currentPage
		ExportJpeg(xObj, sPath, aFD1())
		fsExportAlbumCover = sPath
	End If
	&apos; msgbox &quot;fsExportAlbumCover :&quot; &amp; fsExportAlbumCover
	Exit Function
	
	ExportAlbumCoverErr
	
	fsExportAlbumCover = &quot;&quot;
End Function


Sub ExportJpeg( _
	xobject, _
	sFileUrl As String, _
	aFD1)
	&apos; https://web.archive.org/web/20130529074927/http://codesnippets.services.openoffice.org/Office/Office.GraphicExport.snip
	&apos; Export JPEG by Olivier Samyn (initial), Sven Jacobi, Michael Hoennig, Tom Schindl
	&apos; revised February 24, 2013 for LibreOffice 4
	Dim xExporter
	Dim aArgs(2) As New com.sun.star.beans.PropertyValue
	Dim aURL As New com.sun.star.util.URL
	
	xExporter = createUnoService(&quot;com.sun.star.drawing.GraphicExportFilter&quot;)
	xExporter.SetSourceDocument( xobject )
	aURL.Complete = sFileUrl
	aArgs(0).Name = &quot;MediaType&quot;
	aArgs(0).Value = &quot;image/jpeg&quot;
	aArgs(1).Name = &quot;URL&quot;
	aArgs(1).Value = sFileUrl &apos; aURL
	aArgs(2).Name = &quot;FilterData&quot;
	aArgs(2).Value = aFD1
	xExporter.Filter(aArgs())
End Sub


Sub viewNormal()
	&apos; View a presentation in Normal view
	Dim aURL, oController, oDisp
	
	On Error Resume Next
	aURL = CreateUnoStruct(&quot;com.sun.star.util.URL&quot;)
	aURL.Complete = &quot;.uno:NormalMultiPaneGUI&quot;
	CreateUnoService(&quot;com.sun.star.util.URLTransformer&quot;). _
	parseStrict(aURL)
	oController = ThisComponent.getCurrentController()
	oDisp = oController.queryDispatch(aURL, &quot;_self&quot;, 0)
	If Not IsNull(oDisp) Then
		oDisp.dispatch(aURL, Array())
	End If
End Sub


Function fsImpressdimension( _
	Optional ByVal sType) As String
	&apos; This may vary depending on the current view. 
	&apos; for normal 3x4 view, the full sizes are:
	&apos; Height = 21000
	&apos; Width = 28000
	If ismissing(sType) Then
		sType = &quot;Height&quot;
	End If
	Dim xDoc, xView, xSelection, xObj
	
	xDoc = thiscomponent
	xView = xDoc.currentController
	xSelection = xView.selection
	xObj = xView.currentPage
	Select Case LCase (sType)
		Case &quot;height&quot;, &quot;h&quot;
		fsImpressdimension = xObj.getPropertyValue(&quot;Height&quot;)
		Case Else
		fsImpressdimension = xObj.getPropertyValue(&quot;Width&quot;)
	End Select
End Function


Sub setWesternDocLanguage( _
	sA)
	&apos; sA is the language in the form en-CA
	&apos; for Asian and Complex languages, we ignore the language
	
	Dim sLocale As New com.sun.star.lang.Locale
	Dim sB As String
	Dim sC As String
	Dim x As Integer
	
	If Len(sA) &lt; 2 Then
		Exit Sub
	End If
	x = InStr(sA, &quot;-&quot;)
	If x = 0 Then
		Exit Sub
	Else
		sB = LCase(Left(sA, x - 1))
		sC = UCase(Mid(sA, x + 1))
	End If
	sLocale.Language = sB
	sLocale.Country = sC
	On Error Resume Next
	ThisComponent.CharLocale = sLocale
End Sub


Sub setAsianDocLanguage( _
	sA)
	&apos; sA is the language in the form zh-CN
	&apos; for Western and Complex languages, we ignore the language
	
	Dim sLocale As New com.sun.star.lang.Locale
	Dim sB As String
	Dim sC As String
	Dim x As Integer
	
	If Len(sA) &lt; 2 Then
		Exit Sub
	End If
	x = InStr(sA, &quot;-&quot;)
	If x = 0 Then
		Exit Sub
	Else
		sB = LCase(Left(sA, x - 1))
		sC = UCase(Mid(sA, x + 1))
	End If
	sLocale.Language = sB
	sLocale.Country = sC
	&apos; msgbox( &quot;Asian language :&quot; &amp; sB &amp; &quot;-&quot; &amp; sC
	On Error Resume Next
	ThisComponent.CharLocale = sLocale
	ThisComponent.CharLocaleAsian = sLocale
End Sub


Sub setComplexDocLanguage( _
	sA)
	&apos; sA is the language in the form hi-IN
	&apos; for Western and Asian languages, we ignore the language
	
	Dim sLocale As New com.sun.star.lang.Locale
	Dim sB As String
	Dim sC As String
	Dim x As Integer
	
	If Len(sA) &lt; 2 Then
		Exit Sub
	End If
	x = InStr(sA, &quot;-&quot;)
	If x = 0 Then
		Exit Sub
	Else
		sB = LCase(Left(sA, x - 1))
		sC = UCase(Mid(sA, x + 1))
	End If
	sLocale.Language = sB
	sLocale.Country = sC
	&apos; msgbox( &quot;Complex language :&quot; &amp; sB &amp; &quot;-&quot; &amp; sC
	On Error Resume Next
	ThisComponent.CharLocale = sLocale
	ThisComponent.CharLocaleComplex = sLocale
End Sub


Function fsTrimSpecial( _
	ByVal sA, _
	ByVal sTrim, _
	Optional ByVal iMax) As String
	Dim m As Integer
	Dim n As Integer
	Dim s1 As String
	Dim s2 As String
	
	&apos; sA - the string to trim
	&apos; sTrim - the characters to check for and remove.
	&apos; iMax - the Maximum number of characters to remove. The
	&apos; default value is 80, which is long enough to handle
	&apos; the longest normal markdown sequence (Horizontal rule).
	&apos;
	&apos; Trims specified characters from beginning and end of a
	&apos; string up to a specified maximum of characters at the 
	&apos; start of the string and at the end of the string.
	&apos;
	&apos; The purpose of the function is to remove markdown paragraph
	&apos; level code from text that will be displayed or spoken. 
	
	If ismissing(iMax) Then
		iMax = 80
	End If
	If Len(sA) &lt; iMax Then
		iMax = Len(sA)
	End If
	fsTrimSpecial = sA
	If Len(sA) = 0 Or Len(sTrim) = 0 Then
		Exit Function
	End If
	
	&apos; Edit sTrim to minimize processing time or
	&apos; to exit before looping if possible.
	s1 = &quot;&quot;
	s2 = &quot;&quot;
	For n = 1 To Len(sTrim)
		If InStr(sA, Mid(sTrim, n, 1)) &lt;&gt; 0 Then
			s2 = s2 &amp; Mid(sTrim, n, 1)
		End If
	Next
	If s2 = &quot;&quot; Then
		Exit Function
	Else
		sTrim = s2
	End If
	
	&apos; Left loop    
	For n = 1 To iMax
		For m = 1 To Len(sTrim)
			s1 = Mid(sTrim, m, 1)
			If Left(sA, 1) = s1 Then
				sA = Mid(sA, 2)
			End If
			If Len(sA) &lt; 2 Then
				Exit For
			End If
		Next
	Next
	If Len(sA) = 0 Then
		fsTrimSpecial = sA
		Exit Function
	ElseIf Len(sA) &lt; iMax Then
		iMax = Len(sA)
	End If
	&apos; Right loop
	For n = 1 To iMax
		For m = 1 To Len(sTrim)
			s1 = Mid(sTrim, m, 1)
			If Right(sA, 1) = s1 Then
				sA = Left(sA, Len(sA) - 1)
			End If
			If Len(sA) &lt; 2 Then
				Exit For
			End If
		Next
	Next
	fsTrimSpecial = sA
End Function


Function fsGetTopicSentence( _
	ByVal sA) As String
	Dim a1
	Dim s1
	
	s1 = &quot;&quot;
	If Len(sA) &gt; 0 Then
		&apos; Determine the first sentence of the body text.
		If Left(sA, 1) = &quot;&gt;&quot; Then
			&apos; The string is a blockquote which we interpret
			&apos; as an aside, quote or intermission slide; not
			&apos; a topic sentence.
			s1 = &quot;&quot;
		ElseIf InStr(sA, &quot;. &quot;) &lt;&gt; 0 Then
			a1 = Split(sA, &quot;.&quot;)
			s1 = fsQuickTitle(100, 200, a1(LBound(a1)) &amp; &quot;.&quot;)
		ElseIf InStr(sA, &quot;? &quot;) &lt;&gt; 0 Then
			a1 = Split(sA, &quot;?&quot;)
			s1 = fsQuickTitle(100, 200, a1(LBound(a1)) &amp; &quot;?&quot;)
		ElseIf InStr(sA, &quot;! &quot;) &lt;&gt; 0 Then
			a1 = Split(sA, &quot;!&quot;)
			s1 = fsQuickTitle(100, 200, a1(LBound(a1)) &amp; &quot;!&quot;)
		ElseIf InStr(sA, &quot;?&quot;) &lt;&gt; 0 Then
			&apos; IDEOGRAPHIC FULL STOP (Asian period symbol)
			a1 = Split(sA, &quot;?&quot;)
			s1 = fsQuickTitle(100, 200, a1(LBound(a1)) &amp; &quot;?&quot;)
		Else
			s1 = &quot;&quot;
		End If
	Else
		s1 = &quot;&quot;
	End If
	fsGetTopicSentence = s1
End Function


Function fmyFontWidthIndex( _
	sA)
	&apos; sA is some text to figure out the width factor for.
	&apos; This returns an adjustment factor for languages
	&apos; that use a wide font set.
	&apos; for English, French, German, Italian, Spanish etc.
	&apos; it returns 1 (The narrowest character set)
	&apos; for wider character sets, it returns a value less than 1.
	Dim iMaxLength
	Select Case fsComplexAsiaOrWest(sA)
		Case &quot;COMPLEX&quot;
		&apos; Complex languages may have wide characters.
		iMaxLength = 145
		Case &quot;ASIA&quot;
		&apos; Asia uses fixed width font with each character as wide
		&apos; as an em-dash.
		iMaxLength = 90
		Case Else
		&apos; Western or undefined
		Select Case fsSelectionLanguage()
			Case &quot;bg&quot;, &quot;bs&quot;, &quot;hr&quot;, &quot;mc&quot;, &quot;ru&quot;, &quot;sr&quot;, &quot;uk&quot;
			&apos; Cyrillic characters are a little wide.
			iMaxLength = 150
			Case Else
			iMaxLength = 185
		End Select
	End Select
	fmyFontWidthIndex = iMaxLength / 185
End Function


Function fbsetnote( _
	oPage, _
	sA) As Boolean
	&apos; oPage is a presentation slide.
	&apos; sA is the string to write
	Dim i
	
	i = 1
	If HasUnoInterfaces(oPage.getnotesPage.getByIndex(i), _
		&quot;com.sun.star.text.XText&quot;) Then
		oPage.getnotesPage.getByIndex(i).String = sA &amp; Chr(10)
		fbsetnote = True
	Else
		fbsetnote = False
	End If
	Exit Function
	fbsetnoteErr
	
	fbsetnote = False
End Function


Sub BgCanaryYellow( _
	i)
	ChangeBackground(i, 255, 255, 165)
End Sub

Sub BgPink( _
	i)
	ChangeBackground(i, 255, 0, 165)
End Sub

Sub BgBlue( _
	i)
	ChangeBackground(i, 0, 0, 165)
End Sub

Sub BgBlack( _
	i)
	ChangeBackground(i, 0, 0, 0)
End Sub

Sub BgSystemColor( _
	i)
	If fsGetOS() = &quot;UNIX&quot; Then
		&apos; [Ubuntu Orange &amp; Aubergine][1]
		&apos; [Ubuntu Design][2]
		&apos; [1]: https://design.canonical.com/2011/07/ubuntu-orange-is-dd4814/
		&apos; [2]: https://design.ubuntu.com/brand/colour-palette
		ChangeBackground(i, 119, 72, 83)
	ElseIf fsGetOS() = &quot;WINDOWS&quot; Then
		&apos; [Teal][3]
		&apos; [3]: http://colorlib.com/etc/metro-colors/
		ChangeBackground(i, 29, 29, 29)
	Else
		&apos; Background Grey
		ChangeBackground(i, 153, 153, 153)
	End If
End Sub

Function flSystemColor()
	&apos; Bright color of active button or control
	Dim l1
	
	If fsGetOS() = &quot;UNIX&quot; Then
		&apos; [Ubuntu Orange &amp; Aubergine][1]
		&apos; [Ubuntu Design][2]
		&apos; [1]: https://design.canonical.com/2011/07/ubuntu-orange-is-dd4814/
		&apos; [2]: https://design.ubuntu.com/brand/colour-palette
		l1 = RGB(221, 72, 20)  &apos; orange
	ElseIf fsGetOS() = &quot;WINDOWS&quot; Then
		&apos; [Teal][3]
		&apos; [3]: https://colorlib.com/etc/metro-colors/
		l1 = RGB(0, 171, 169)
	ElseIf fsGetOS() = &quot;ANDROID&quot; Then
		l1 = RGB(255, 196, 13) &apos; medium yellow accent
	Else
		&apos; l1 = rgb(153, 153, 153) &apos; medium grey
		&apos; l1 = rgb(221, 72, 20)  &apos; orange
		&apos; l1 = rgb(0, 171, 169)  &apos; teal
		l1 = RGB(49, 131, 251) &apos; Yosemite blue accent
	End If
	flSystemColor = l1
End Function

Function fsSystemFont() As String
	Select Case fsGetOS
		Case &quot;UNIX&quot;
		fsSystemFont = &quot;Arial;DejaVu Sans;Liberation Sans;Droid Sans;Sans-Serif&quot;
		Case &quot;WINDOWS&quot;
		fsSystemFont = &quot;Arial;Segoe UI;Calibri;Tahoma;Liberation Sans;Sans-Serif&quot;
		Case &quot;MacOS&quot;
		fsSystemFont = &quot;Helvetica Neue;Lucida Grande;Helvetica;Arial;Liberation Sans;Sans-Serif&quot;
		Case Else
		fsSystemFont = &quot;Droid Sans;Liberation Sans;DejaVu Sans;Sans-Serif&quot;
	End Select
End Function


Function fsSetexttoAtx( _
	ByVal sA, _
	ByVal sB) As String
	&apos; sA - line to modify
	&apos; sB - the line under it we need to check for Setext code
	&apos;
	&apos; Convert [Markdown][1] [Setext-style][2] headers 
	&apos; to [atx][3].
	&apos;
	&apos; [1]: https://daringfireball.net/projects/markdown/syntax
	&apos; [2]: http://docutils.sourceforge.net/mirror/setext.html
	&apos; [3]: http://www.aaronsw.com/2002/atx/
	Dim s5 As String
	
	s5 = &quot;&quot;
	If Not(Len(sB) = 0) And Not(Len(sA) = 0) Then
		If String(Len(sB), &quot;=&quot;) = sB Then
			s5 = &quot;#&quot;
		ElseIf String(Len(sB), &quot;-&quot;) = sB Then
			s5 = &quot;##&quot;
		End If
	End If
	fsSetexttoAtx = s5 &amp; sA
End Function


Sub NewPresentionFromSelection( _
	Optional sA, _
	Optional sB)
	If ismissing(sA) Then
		sA = fsThisDocTitle()
	End If
	If ismissing(sB) Then
		sB = fsGetTextSelection(False, False)
	End If
	Dim a1
	Dim a2
	Dim bWesternOnly
	Dim i
	Dim j
	Dim k
	Dim L
	Dim m
	Dim oAlbum
	Dim oAsianLanguage
	Dim oBar    &apos; Generated status bar 
	Dim oFrame  &apos; Current frame
	Dim oLanguage
	Dim oShape1
	Dim s1
	Dim s2
	Dim s3
	Dim s4
	Dim s5
	Dim sAuthor
	Dim sAsianLanguage
	Dim sAsianCountry
	Dim sComplexLanguage
	Dim sComplexCountry
	Dim sCountry
	Dim sLanguage
	Dim x
	
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	
	sAsianLanguage = &quot;&quot;
	sAsianCountry = &quot;&quot;
	sComplexLanguage = &quot;&quot;
	sComplexCountry = &quot;&quot;
	oLanguage = ThisComponent.CharLocale
	sLanguage = oLanguage.Language
	sCountry = oLanguage.Country
	sLanguage = fsSelectionLanguage(&quot;WEST&quot;)
	sCountry = fsSelectionCountry(&quot;WEST&quot;)
	Select Case fsComplexAsiaOrWest(sB)
		Case &quot;ASIA&quot;
		sAsianLanguage = fsSelectionLanguage(&quot;ASIA&quot;)
		sAsianCountry = fsSelectionCountry(&quot;ASIA&quot;)
		Case &quot;COMPLEX&quot;
		sComplexLanguage = fsSelectionLanguage(&quot;COMPLEX&quot;)
		sComplexCountry = fsSelectionCountry(&quot;COMPLEX&quot;)
	End Select
	sAuthor = fsThisDocAuthor
	
	If Len(sA) &lt;&gt; 0 Then
		&apos; Create a new Impress document
		oAlbum = StarDesktop.loadComponentFromUrl(&quot;private:factory/simpress&quot;, _
		&quot;_blank&quot;, _
		0, _
		dimarray())
		x = ThisComponent
		BgCanaryYellow(0)
		x.DocumentProperties.Title = sA
		&apos; Format the aspect ratio of the presentation
		Select Case fbCreatingMediaFile()
			Case True
			&apos; Square - aspect ratio of the presentation is the same as an album cover
			&apos; displayed in an audio media player. With compatible convertors, you can
			&apos; set a compatible exported image as a sound file&apos;s icon.
			x.getDrawPages.getByIndex(0).Height = x.getDrawPages.getByIndex(0).Width
			Case Else
			&apos; HDMI - Most users can use the full screen.
			x.getDrawPages.getByIndex(0).Width = x.getDrawPages.getByIndex(0).Height * 1.77778
		End Select
		&apos; Title slide  - summary of paragraph contents
		If Len(sB) &lt;&gt; 0 Then
			&apos; We use a2 for the heading level of markdown (# = h1 ## = h2 etc.)
			a2 = Split(Chr(10) &amp; sB, Chr(10))
			&apos; We use a1 to display cleaned up text
			sB = Chr(10) &amp; fsCleanMdCode(sB)
			a1 = Split(sB, Chr(10))
			
			k = 255  &apos; Maximum number of slides
			s2 = &quot;&quot;
			s3 = &quot;&quot;
			s4 = &quot;&quot;
			s5 = &quot;&quot;
			If UBound(a1) &lt; k Then
				k = UBound(a1)
			End If
			For j = LBound(a1) To k
				s5 = &quot;&quot;
				If Len(a1(j)) &gt; 3 Then
					s2 = s5 &amp; s2
					If j + 1 &lt; UBound(a1) Then
						&apos; Convert Markdown Setext-style headers 
						&apos; to atx.
						L = j + 1
						s1 = fsSetexttoAtx(a2(j), a2(L))
					Else
						s1 = a2(j)
					End If
					If Left(Trim(s1), 1) = &quot;#&quot; Then
						&apos; Looks like a heading. Demote one level and add extra LFs.
						If Left(Trim(s1), 7) = String(7, &quot;#&quot;) Then
							&apos; Markdown can&apos;t use more than 6 &quot;#&quot; symbols.
							s1 = String(6,&quot;#&quot;) &amp; fsTrimSpecial(Trim(s1), &quot;#&quot;)
						End If
						s2 = s2 &amp; Chr(10) &amp; &quot;#&quot; &amp; fsQuickTitle(7, 35, Trim(s1)) &amp; Chr(10) &amp; Chr(10)
					ElseIf Left(s1, 2) = &quot; -&quot; Or _
						Left(s1, 2) = &quot; *&quot; Or _
						Left(s1, 1) = &quot;-&quot; Or _
						Left(s1, 1) = &quot;*&quot; Then
						s2 = s2 &amp; Trim(fsQuickTitle(7, 35, s1)) &amp; Chr(10)
						&apos; You already included a markdown unordered list symbol.
					Else
						s2 = s2 &amp; &quot;- &quot; &amp; fsTrimSpecial(fsQuickTitle(7, 35, s1), &quot;`_-*#&gt;&quot;) &amp; Chr(10)
						&apos; Clean string up and add a markdown unordered list symbol.
					End If
					If Len(s3) = 0 Then
						&apos; Determine the first sentence of the body text.
						s3 = fsGetTopicSentence(a1(j))
					End If
				End If
			Next
		Else
			s2 = sAuthor
			s3 = s2
		End If
		
		If s3 = &quot;&quot; Then
			s3 = fsDateMyRegion(1)
		End If
		
		&apos; Set the text of the speaker notes for the title slide
		If Not(fbsetnote(x.getDrawPages().getByIndex(0), _
			&quot;# &quot; &amp; sA &amp; _
			Chr(10) &amp; _
			Chr(10) &amp; _
			&quot;&gt; _&quot; &amp; s3 &amp; &quot;_&quot; &amp; _
			Chr(10) &amp; _
			Chr(10) &amp; _
			s2)) Then
			&apos; incompatible document format
			Exit Sub
		End If
		&apos;  Record the first sentence of the body text in the description
		s4 = s3
		s4 = fsTrimSpecial(s4, &quot;`-#&gt;_ &quot; &amp; Chr(13) &amp; Chr(10))
		x.DocumentProperties.Description = s4
		x.getDrawPages().getByIndex(0).getByIndex(0).String = sA
		x.getDrawPages().getByIndex(0).Name = sA
		x.getDrawPages().getByIndex(0).getByIndex(1).String = sAuthor
		
		&apos; for each paragraph, make a slide
		oFrame = ThisComponent.getCurrentController().getFrame()
		oBar = oFrame.createStatusIndicator()
		oBar.start(fsLookUpTerm(&quot;s_read-text&quot;), UBound(a1))
		k = 0
		If Len(sAsianLanguage) &gt; 0 Then
			setAsianDocLanguage(sAsianLanguage &amp; &quot;-&quot; &amp; sAsianCountry)
		ElseIf Len(sComplexLanguage) &gt; 0 Then
			setComplexDocLanguage(sComplexLanguage &amp; &quot;-&quot; &amp; sComplexCountry)
		Else
			setWesternDocLanguage(sLanguage &amp; &quot;-&quot; &amp; sCountry)
		End If
		For j = LBound(a1) To UBound(a1)
			s1 = &quot;&quot;
			If Len(a1(j)) &gt; 0 Then
				k = k + 1
				If j + 1 &lt; UBound(a1) Then
					&apos; Convert Markdown Setext-style headers 
					&apos; to atx.
					L = j + 1
					s1 = fsSetexttoAtx(a1(j), a2(L))
				Else
					s1 = a1(j)
				End If
				x.getDrawPages().InsertNewByIndex(k)
				If Len(s1) &gt; 0 And _
					(Not(String(Len(s1), &quot;=&quot;) = s1) And _
					Not(String(Len(s1), &quot;-&quot;) = s1)) Then
					&apos; The string is not empty and is not a simple
					&apos; markdown &lt;h1&gt;, &lt;h2&gt; or &lt;hr /&gt; code string.
					addTextToSlide(x, s1, k, sComplexLanguage)
				End If
			End If
			oBar.Value = j
		Next
		Select Case fbCreatingMediaFile()
			Case False
			oShape1 = x.getDrawPages().getByIndex(x.GetDrawPages.getCount() - 1).getByIndex(1)
			oShape1.setString(&quot; ? &quot;)
			oShape1.CharFontName = fsSystemFont()
			oShape1.CharFontNameComplex = fsSystemFont()
			oShape1.CharFontNameAsian = fsSystemFont()
			oShape1.OnClick = com.sun.star.presentation.ClickAction.STOPPRESENTATION
			oShape1.CharHeight = x.getDrawPages().getByIndex(0).Height / 1000
			ResizeAsianComplexText(oShape1)
		End Select
		oBar.End()
		On Error Resume Next
		x.Presentation.IsMouseVisible() = True
		&apos; We want to be able to close without an &quot;Are you sure?&quot; message.
		x.setModified(False)
	End If
End Sub


Sub ResizeAsianComplexText( _
	oShape)
	oShape.CharHeightAsian = oShape.CharHeight
	oShape.CharHeightComplex = oShape.CharHeight
End Sub


Sub addTextToSlide( _
	Optional o1, _
	Optional ByVal sA, _
	Optional ByVal i, _
	Optional sComplexLanguage, _
	Optional sStyle, _
	Optional bLiveText)
	&apos;
	&apos; Add text to a slide
	&apos; -------------------
	&apos;
	&apos; Adds text and control buttons to a blank slide
	&apos;
	&apos; o1 - Current component (document object)
	&apos; sA - String to show (may be shortened if it is too long to fit)
	&apos; i - Index of slide to modify (between 0 and number of slides - 1)
	&apos; sComplexLanguage - home language if the language is complex. (Default: hi-IN)
	&apos; sStyle - force slide text shape style `[h1|h2|h3|h4|h5|h6|code|pre|blockquote]`
	&apos; bLiveText - if true, then clicking the text starts speech synthesis
	&apos;
	&apos; Uses a subset of [Markdown][1] to format the appearance
	&apos; of the slide by using Markdown paragraph style markers.
	&apos;
	&apos; - # for heading 1
	&apos; - ## for heading 2
	&apos; - ### for heading 3
	&apos; - &gt; for aside (blockquote)
	&apos; - ` for code
	&apos; - _ for emphasis (italics)
	&apos; - * for emphasis (italics)
	&apos;
	&apos; See OpenOffice.org Macros Explained, Third Ed., 2015. 
	&apos; [Andrew Pitonyak][2]
	&apos; for a description of createPoint and createSize
	&apos;
	&apos; [1]: https://daringfireball.net/projects/markdown/
	&apos; [2]: http://www.pitonyak.org
	If ismissing(sA) Then
		sA = fsSampleMd(fsSelectionLanguage())
	End If
	If ismissing(sComplexLanguage) Then
		sComplexLanguage = &quot;hi&quot;
	End If
	If ismissing(sStyle) Then
		sStyle = &quot;&quot;
	End If
	If ismissing(bLiveText) Then
		Select Case fbCreatingMediaFile()
			Case True
			bLiveText = False
			Case Else
			bLiveText = True
		End Select
	End If
	Dim oPage
	Dim oShape
	Dim oShape1
	Dim lwide
	Dim lhigh
	Dim m As Integer
	Dim n As Integer
	Dim iMaxLength As Integer
	Dim iITALIC As Integer
	Dim s1 As String
	Dim s1c As String
	Dim s2 As String
	Dim s4 As String
	
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	iITALIC = 2
	On Error Goto addTextToSlideErr
	If ismissing(o1) Then
		o1 = StarDesktop.loadComponentFromUrl(&quot;private:factory/simpress&quot;, _
		&quot;_blank&quot;, _
		0, _
		dimarray())
	End If
	
	iMaxLength = 185 * fmyFontWidthIndex(sA)
	If ismissing(i) Then
		i = 0
	End If
	oPage = o1.getDrawPages().getByIndex(i)
	oShape = o1.createInstance(&quot;com.sun.star.drawing.TextShape&quot;)
	oPage.add(oShape)
	
	If bLiveText Then
		oShape1 = o1.createInstance(&quot;com.sun.star.drawing.EllipseShape&quot;)
		oPage.add(oShape1)
		
	End If
	lwide = (oPage.Width)
	lhigh = (oPage.Height)
   
	&apos; ###Set the note
	fbsetNote(oPage, sA &amp; Chr(10))
	
	&apos; ### Set the page Name - replace &quot;Slide nn&quot;
	s4 = fsQuickTitle(7, 35, sA)
	s4 = fsTrimSpecial(s4, &quot;`-#&gt;_ &quot;)
	oPage.Name = s4
	
	&apos; ###Set some defaults for the main text box
	oShape.setString(&quot;%NO_VALUE%&quot;)
	oShape.setPosition(createPoint(lwide * 3 / 70, lhigh * 3 / 70))
	oShape.setSize(createSize(lwide * 0.91, lhigh * 0.91))
	
	If bLiveText Then
		&apos; ###Next slide button
		
		oShape1.setString(&quot;↓&quot;)
		oShape1.OnClick = com.sun.star.presentation.ClickAction.NEXTPAGE
		
		&apos; For LTR (western and Asian) text
		oShape1.setPosition(createPoint(lwide - lhigh * 7 / 70, _
		lhigh - lhigh * 7 / 70))
		oShape1.setSize(createSize(lhigh * 0.0550, lhigh * 0.0550))
		oShape1.CharHeight = lhigh / 900      
		oShape1.LineColor = RGB(49, 131, 251) &apos; MacOS blue
		oShape1.FillColor = RGB(49, 131, 251)
		oShape1.CharColor = RGB(255, 255, 255)
		oShape1.Printable = False
		oShape1.Title = &quot;Next&quot;
		oShape1.Description = &quot;Next&quot;
	End If
	
	&apos; s1 may be modified - **leave sA unmodified**
	s1 = Trim(fsSupertrim(sA, &quot;&quot;))
	BgBlack(i)
	
	&apos;### Edit the headings - Size and max string length
	
	s1c = fsReplaceText(s1, Chr(8207), &quot;&quot;)
	s1c = fsReplaceText(s1c, Chr(8206), &quot;&quot;)
	If  Left(s1c, 7) = &quot;#######&quot; Then
		&apos; Headings 7 and greater are not supported in
		&apos; markdown syntax.  Reformat as heading 6.
		s1 = Trim(fsTrimSpecial(s1, &quot;#&quot;))
		s1 = &quot;######&quot; &amp; s1
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
	End If
	If Left(s1c, 6) = &quot;######&quot; Or sStyle = &quot;h6&quot; Then
		&apos; Heading 6
		BgSystemColor(i)
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 420
		oShape.CharFontName = fsSystemFont()
		oShape.CharColor = RGB(255, 255, 255)
	ElseIf Left(s1c, 5) = &quot;#####&quot;  Or sStyle = &quot;h5&quot; Then
		&apos; Heading 5
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 420
		bgBlue(i)
		oShape.CharColor = RGB(255, 0, 165)
	ElseIf Left(s1c, 4) = &quot;####&quot; Or sStyle = &quot;h4&quot; Then
		&apos; Heading 4
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 420
		BgPink(i)
		oShape.CharColor = RGB(0, 0, 165)
	ElseIf Left(s1c, 3) = &quot;###&quot;  Or sStyle = &quot;h3&quot; Then
		&apos; Heading 3
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 420
	ElseIf Left(s1c, 2) = &quot;##&quot; Or sStyle = &quot;h2&quot; Then
		&apos; Heading 2
		s1 = Trim(fsQuickTitle(42, 20350 / iMaxLength , s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 350
	ElseIf Left(s1c, 1) = &quot;#&quot;  Or sStyle = &quot;h1&quot; Then
		&apos; Heading 1
		s1 = Trim(fsQuickTitle(42, 11100 / iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 280
	ElseIf (Left(s1c, 1) = &quot;`&quot; And _
		Right(s1, 1) = &quot;`&quot;) Or sStyle = &quot;code&quot; Then
		&apos; Code listing (very small)
		s1 = fsTrimSpecial(s1, &quot;`&quot;)
		s1 = Trim(fsQuickTitle(200, 157250 / iMaxLength, s1))
		If Len(s1) + Len(&quot;``&quot;) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 875
		oShape.CharFontName = &quot;DejaVu Sans Mono;Liberation Mono;Droid Sans Mono;Menlo Regular;Courier New;Courier;Monospace;Microsoft Sans Serif&quot;
		oShape.setString(Mid(sA, 2, Len(sA) - 2))
	ElseIf (Left(sA, 4)) = String(4, &quot; &quot;)  Or sStyle = &quot;pre&quot; Then
		&apos; Code listing - preserve indents (very small)
		s1 = fsTrimSpecial(s1, &quot;`&quot;)
		s1 = Trim(fsQuickTitle(200, 157250 / iMaxLength, s1))
		If Len(s1) + Len(&quot;``&quot;) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 840
		oShape.CharFontName = &quot;DejaVu Sans Mono;Liberation Mono;Droid Sans Mono;Menlo Regular;Courier New;Courier;Mono;Microsoft Sans Serif&quot;
		oShape.setString(sA)
	ElseIf Left(s1c, 1) = &quot;&gt;&quot; Or sStyle = &quot;blockquote&quot; Then
		&apos; Aside: definition, quote, intermission, reader task etc.
		s1 = fsTrimSpecial(s1, &quot;&gt; &quot;)
		s1 = Trim(fsQuickTitle(100, 76960 / iMaxLength, s1))
		BgCanaryYellow(i)
		oShape.CharHeight = lhigh / 600
	Else
		&apos; Plain text
		s1 = Trim(fsQuickTitle(42, iMaxLength, s1))
		If Len(s1) &lt; Len(Trim(sA)) Then
			s1 = s1 &amp; &quot; …&quot;
		End If
		oShape.CharHeight = lhigh / 420
	End If
	
	&apos;###Colors or posture
	
	s2 = Trim(fsTrimSpecial(sA, &quot; &gt;#&quot; &amp; Chr(8207) &amp; Chr(8206)))
	s1c = fsReplaceText(s1, Chr(8207), &quot;&quot;)
	s1c = fsReplaceText(s1c, Chr(8206), &quot;&quot;)
	If Left(s2, 1) = &quot;*&quot; Or  Left(s2, 1) = &quot;_&quot; Then
		&apos; You included markdown code for italics
		oShape.CharPosture = iITALIC
	End If
	If Left(s1c, 1) = &quot;#&quot; Then
		&apos; Heading
		oShape.CharPosture = iITALIC
		s1 = fsTrimSpecial(s1, &quot;#_* &quot;)
	ElseIf Left(s1c, 1) = &quot;*&quot; And Right(s1c, 1) = &quot;*&quot; Then
		&apos; Emphasis
		oShape.CharPosture = iITALIC
		s1 = fsTrimSpecial(s1, &quot;*#_ &quot;)
	ElseIf Left(s1c, 1) = &quot;_&quot; And Right(s1c, 1) = &quot;_&quot; Then
		&apos; Emphasis
		oShape.CharPosture = iITALIC
		s1 = fsTrimSpecial(s1, &quot;_*# &quot;)
	Else
		oShape.CharPosture = 0
	End If
	
	&apos; ##Replace the temporary text of main text shape with the final text.
	If oShape.getString = &quot;%NO_VALUE%&quot; Or oShape.getString = &quot;&quot; Then
		oShape.setString(s1)
		ResizeAsianComplexText(oShape)
	End If
	
	Select Case fsGetOS()
		Case &quot;MacOS&quot;
		m = 15
		Case &quot;UNIX&quot;, &quot;ANDROID&quot;
		m = 18
		Case Else
		m = 20  &apos; WINDOWS
	End Select
	If fbHasRTLMarker(sA) Then
		&apos; Has a Unicode Right to left marker.  We need to remove 
		&apos; the markdown formatting following the RTL marker, then
		&apos; prepend the string with the RTL marker `chr(8207)`.
		s1 = Chr(8207) &amp; fsTrimSpecial(s1, Chr(8207) &amp; &quot;*#_&gt; &quot;)
		oShape.setString(fsReplaceText(s1,&quot; …&quot;, Chr(10) &amp; &quot;…&quot;))
		ThisComponent.getcurrentcontroller().setCurrentPage(ThisComponent.drawpages(i))
		SetAllRightJustified
		If bLiveText Then
			oShape1.setPosition(createPoint(lwide * (3) / 70, lhigh - lhigh * 7 / 70))
		End If
		ThisComponent.getcurrentcontroller().setCurrentPage(ThisComponent.drawpages(1))
		&apos; add bubble to lower left
		&apos; wide, high, x-axis, y-axis
		&apos; .115
		If bLiveText Then
			addBubbleToSlide(o1, _
			&quot; ► &quot;, _
			i, _
			lhigh \ m, _
			lhigh \ m, _
			lwide * 0.13, _
			lhigh * 0.902)
		End If
	Else
		If fbHasLTRMarker(sA) Then
			&apos; Has a Unicode left to right marker.  We need to remove 
			&apos; the markdown formatting following the LTR marker, then
			&apos; prepend the string with the LTR marker `chr(8206)`.
			s1 = Chr(8206) &amp; fsTrimSpecial(s1, Chr(8206) &amp; &quot;*#_&gt; &quot;)
		End If
		&apos; add bubble to lower right
		&apos; msgbox  10 / 70 &apos; convert fraction to decimal
		&apos; wide, high, x-axis, y-axis
		If bLiveText Then
			addBubbleToSlide(o1, _
			&quot; ► &quot;, _
			i, _
			lhigh \ m, _
			lhigh \ m, _
			lwide * 0.8214, _
			lhigh * 0.902)
		End If
	End If
	If bLiveText Then
		&apos; The computer needs read text extension to execute this procedure.
		&apos; If the computer doesn’t have the extension, clicking the shape
		&apos; will show a dialogue telling you that it couldn’t find the script.
		&apos; If you have a tablet for drawing on the slide, you might prefer
		&apos; live text (`bLiveText`) to be false.  If you want it to be easy to
		&apos; initiate speech, it should be set to true. 
		oShape.OnClick = com.sun.star.presentation.ClickAction.MACRO
		oShape.Bookmark = &quot;vnd.sun.star.script:&quot; &amp; _
		&quot;textToSpeech.TextToSpeech.ReadTheSlideNote&quot; &amp; _
		&quot;?language=Basic&amp;location=application&quot;
	End If
	Exit Sub
	addTextToSlideErr:
	
	MsgBox fsLookUpTerm(&quot;s_cancel&quot;), _
	0, _
	fsLookUpTerm(&quot;s_read-text&quot;)
End Sub


Function fbHasAsianCharacters( _
	sA) As Boolean
	&apos; Asian Language UTF-8 strings are in a specific Unicode range 
	&apos; and do not include RTL or LTR markers.
	&apos; 
	Dim s1 As String
	Dim b1 As Boolean
	
	If Len(sA) = 0 Then
		b1 = False
	ElseIf fbHasLTRMarker(sA) Then
		b1 = False
	ElseIf fbHasRTLMarker(sA) Then
		b1 = False
	Else
		s1 = converttourl(Left(Trim(sA), 100))
		If InStr(s1, &quot;%8&quot;) &lt;&gt; 0 Then
			b1 = True
		ElseIf InStr(s1, &quot;%9&quot;) &lt;&gt; 0 Then
			&apos; zh , ja
			b1 = True
		ElseIf InStr(s1, &quot;%A&quot;) &lt;&gt; 0 Then
			&apos; zh, ja
			b1 = True
		ElseIf InStr(s1, &quot;%B&quot;) &lt;&gt; 0 Then
			&apos; zh, ja
			b1 = True
		ElseIf InStr(s1, &quot;%E&quot;) &lt;&gt; 0 Then
			&apos; ko
			b1 = True
		Else
			b1 = False
		End If
	End If
	fbHasAsianCharacters = b1
End Function


Function fbHasRTLMarker( _
	ByVal sA) As Boolean
	&apos; Languages that read right to left like Arabic, Farsi, and Hebrew
	&apos; include a [Unicode Character &quot;RIGHT-TO-LEFT MARK (U+200F)][1]
	&apos; 
	&apos; [1]: https://www.fileformat.info/info/unicode/char/200f/index.htm 
	Dim s1 As String
	Dim b1 As Boolean
	
	If Len(sA) = 0 Then
		b1 = False
	Else
		s1 = converttourl(Left(Trim(sA), 15))
		If InStr(s1, &quot;%D8&quot;) &lt;&gt; 0 Then
			b1 = True
		End If
	End If
	fbHasRTLMarker = b1
End Function


Function fbHasLTRMarker( _
	ByVal sA) As Boolean
	&apos; Languages that are complex like Hindi, Gujarati and Punjabi may
	&apos; include a [Unicode Character &quot;LEFT-TO-RIGHT MARK (U+200E)][1]
	&apos; 
	&apos; [1]: https://www.fileformat.info/info/unicode/char/200e/index.htm 
	Dim s1 As String
	Dim b1 As Boolean
	
	If Len(sA) = 0 Then
		b1 = False
	Else
		s1 = converttourl(Left(Trim(sA), 15))
		If InStr(s1, &quot;%E0&quot;) &lt;&gt; 0 Then
			b1 = True
		End If
	End If
	fbHasLTRMarker = b1
End Function


Function fiWesternAsianComplex( _
	Optional ByVal sA) As Integer
	&apos; Returns 0 for Western, 1 for Asian, 2 for Complex
	Dim i1 As Integer
	
	If ismissing(sA) Then
		fiWesternAsianComplex = 0
		Exit Function
	ElseIf sA = &quot;&quot; Then
		fiWesternAsianComplex = 0
		Exit Function
	End If
	If fbHasAsianCharacters(sA) Then
		i1 = 1
	ElseIf fbHasLTRMarker(sA) Then
		i1 = 2
	ElseIf fbHasRTLMarker(sA) Then
		i1 = 2
	Else
		i1 = 0
	End If
	fiWesternAsianComplex = i1
End Function


Function fsIsStringWesternAsianOrComplexTest( _
	sA) As String
	Dim s1 As String
	
	Select Case fiWesternAsianComplex(sA)
		Case 0
		s1 = &quot;WESTERN&quot;
		Case 1
		s1 = &quot;ASIA&quot;
		Case Else
		s1 = &quot;COMPLEX&quot;
	End Select
	fsIsStringWesternAsianOrComplexTest = s1
End Function


Sub SetAllRightJustified()
	&apos; Arabic, Hebrew and other right to left languages should be 
	&apos; aligned to the right. 
	Dim document   As object
	Dim dispatcher As object
	Dim args1(0) As New com.sun.star.beans.PropertyValue
	
	document = ThisComponent.CurrentController.Frame
	dispatcher = createUnoService(&quot;com.sun.star.frame.DispatchHelper&quot;)
	args1(0).Name = &quot;RightPara&quot;
	args1(0).Value = True
	dispatcher.executeDispatch(document, &quot;.uno:SelectAll&quot;, &quot;&quot;, 0, Array())
	dispatcher.executeDispatch(document, &quot;.uno:RightPara&quot;, &quot;&quot;, 0, args1())
End Sub


Function fiCurrentSlideIndex() As Integer
	On Error Goto fiGetCurrentSlideIndexerror
	fiCurrentSlideIndex = ThisComponent.Presentation.Controller.getCurrentSlideIndex()
	Exit Function
	fiGetCurrentSlideIndexerror:
	
	&apos; The presentation is not playing. 
	fiCurrentSlideIndex = - 1
End Function


Sub addBubbleToSlide( _
	Optional oDoc, _
	Optional ByVal sA, _
	Optional ByVal i, _
	Optional ByVal width, _
	Optional ByVal height, _
	Optional ByVal xval, _
	Optional ByVal yval, _
	Optional ByVal sType, _
	Optional ByVal lBackgroundColor, _
	Optional ByVal lcharacterColor, _
	Optional ByVal sMacroBookMark)
	&apos; Add bubble to slide
	&apos; -------------------
	&apos;
	&apos; Adds a red round-callout (speech bubble) to a presentation slide.
	&apos; Click the bubble to start speech synthesis.
	&apos;
	&apos; oDoc - this document  
	&apos; sA - text to display  
	&apos; width - full width  
	&apos; height - full height  
	&apos; xVal - position on x-axis  
	&apos; yVal - position on y-axis  
	&apos; 
	&apos; See:  
	&apos; [Re: Draw - Basic - Shapes][ABTS1]
	&apos; by Charlie Young - Sat Jan 07, 2012 5:30 am
	&apos; [ABTS1]: https://forum.openoffice.org/en/forum/viewtopic.php?f=45&amp;t=46682#p215798
	&apos;
	If ismissing(oDoc) Then
		oDoc = ThisComponent
	End If
	If ismissing(sA) Then
		sA = &quot; ? &quot;
	End If
	If ismissing(i) Then
		i = 0
	End If
	If ismissing(width) Then
		width = 1400  &apos; 2 cm
	End If
	If ismissing(height) Then
		height = width
	End If
	If ismissing(sType) Then
		sType = &quot;ellipse&quot;
		&apos; sType = &quot;circle&quot;
	End If
	If ismissing(lBackgroundColor) Then
		lBackgroundColor = RGB(238, 17, 17)  &apos; Windows 8 red
	End If
	If ismissing(lcharacterColor) Then
		lcharacterColor = RGB(255, 255, 255)  &apos; White 
	End If
	If ismissing(sMacroBookMark) Then
		sMacroBookMark = &quot;vnd.sun.star.script:&quot; &amp; _
		&quot;textToSpeech.TextToSpeech.ReadTheSlidenote&quot; &amp; _
		&quot;?language=Basic&amp;location=application&quot;
	End If
	
	Dim oDrawPage As Object
	Dim oShape As Object
	Dim shapeGeometry(0) As New com.sun.star.beans.PropertyValue
	Dim oSize As New com.sun.star.awt.Size
	Dim ShapePos As New com.sun.star.awt.Point
	
	&apos; The following list is not complete. A shape that is not included could raise an error.
	&apos; See the [Drawing Shape][ABTS1] reference for an complete list of regular drawing shapes
	&apos; and the [Custom Shape][ABTS2] reference for a list of custom shapes.
	&apos;
	&apos; [ABTS1]: https://www.openoffice.org/api/docs/common/ref/com/sun/star/drawing/module-ix.html 
	&apos; [ABTS2]: https://www.openoffice.org/api/docs/common/ref/com/sun/star/drawing/XEnhancedCustomShapeDefaulter.html
	&apos;
	oDrawPage = oDoc.DrawPages(i)
	Select Case LCase(sType)
		Case &quot;ellipse&quot;, &quot;circle&quot;
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.EllipseShape&quot;)
		oDrawPage.add(oShape)
		Case &quot;line&quot;
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.LineShape&quot;)
		oDrawPage.add(oShape)
		Case &quot;measure&quot;
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.MeasureShape&quot;)
		oDrawPage.add(oShape)
		Case &quot;rectangle&quot;
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.RectangleShape&quot;)
		oDrawPage.add(oShape)
		Case &quot;text&quot;
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.TextShape&quot;)
		oDrawPage.add(oShape)
		Case Else
		&apos; Custom shape
		oShape = oDoc.createInstance(&quot;com.sun.star.drawing.CustomShape&quot;)
		oDrawPage.add(oShape)
		shapeGeometry(0).Name = &quot;Type&quot;
		shapeGeometry(0).Value = sType
		oShape.CustomShapeGeometry = shapeGeometry
	End Select
	&apos; with size - use createSize utility
	oShape.setSize(createSize(width, height))
	
	If ismissing(xval) Then
		xval = (oDrawPage.width - oSize.width) \ 2  &apos; Center
	End If
	If ismissing(yval) Then
		yval = (oDrawPage.height - oSize.height) \ 2  &apos; Center 
	End If
	
	ShapePos.X = xVal
	ShapePos.Y = yVal
	oShape.setPosition(ShapePos)
	oShape.FillStyle = com.sun.star.drawing.FillStyle.SOLID
	
	&apos;oShape.LineWidth = 50
	oShape.String = sA
	oShape.LineColor = lBackgroundColor
	oShape.FillColor = lBackgroundColor
	oShape.CharColor = lcharacterColor
	oShape.OnClick = com.sun.star.presentation.ClickAction.MACRO
	oShape.Bookmark = sMacroBookMark
	oShape.CharFontName = fsSystemFont()
	oShape.CharFontNameComplex = fsSystemFont()
	oShape.CharFontNameAsian = fsSystemFont()
	oShape.FillTransparence = 0
	oShape.Visible = True
	oShape.TextAutoGrowWidth = False
	oShape.TextHorizontalAdjust = 3
	oShape.LineTransparence = 0
	oShape.CharShadowed = False
	oShape.Printable = False
	oShape.LineendWidth = 200
	oShape.LineJoint = 4
	oShape.LineStartWidth = 200
	oShape.CharOverline = 0
	oShape.LineStyle = 1
	oShape.LineWidth = 0
	oShape.LayerID = 0
	oShape.CharPosture = 0
	oShape.Title = &quot;ReadText_&quot; &amp; sType
	oShape.Description = fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
	&quot; - &quot; &amp; _
	fsLookUpTerm(&quot;s_speech-synthesis&quot;)
	oShape.Shadow = False
End Sub


Function BundlePyPath()
	&apos; For platforms that bundle python, return that URI, otherwise
	&apos; return a system URI to python
	BundlePyPath = &quot;&quot;
	
	If Not globalScope.BasicLibraries.isLibraryLoaded(&quot;Tools&quot;) Then
		globalScope.BasicLibraries.loadLibrary(&quot;Tools&quot;)
	End If
	On Error GoTo BundlePyPathErr
	Dim PyPath As String : PyPath = &quot;&quot;
	Dim TryPath As String : TryPath = &quot;&quot;
	Dim App As String : App = fsGetSetting(&quot;ooname&quot;)
	Dim Versions As Variant : Versions = Array(&quot;&quot;, &quot; 4&quot;, &quot; 3&quot;, &quot; 2&quot;, &quot; 5&quot;, &quot; 6&quot;,_
	&quot; 7&quot;, &quot; 8&quot;, &quot; 9&quot;, &quot; 10&quot;, &quot; 11&quot;, &quot; 12&quot;, &quot; 13&quot;, &quot; 14&quot;, &quot; 15&quot;, &quot; 16&quot;, &quot; 17&quot;)
	Dim i As Integer : i = 0
	Select Case fsGetOS()
		Case &quot;WINDOWS&quot;
		&apos; NOTE: Apache OpenOffice might not return a valid path when using
		&apos; `com.sun.star.util.PathSubstitution` so set a default.
		For i = Lbound(Versions) To UBound(Versions)
			TryPath = fsFindAppPath(App &amp; Versions(i) &amp; &quot;/program/python.exe&quot;)
			If Len(TryPath) &lt;&gt; 0 Then
				PyPath = TryPath
				Exit For
			End If
		Next
		Case Else
		PyPath = ConvertToURL(PosixPythonPath())
	End Select
	If FileExists(BundlePyPath) Then Exit Function	
	Dim v1 As Variant : v1=CreateUnoService(&quot;com.sun.star.util.PathSubstitution&quot;)
	Dim _path$ : _path = v1.substituteVariables(&quot;$(inst)&quot;,True)
	BundlePyPath = DirectoryNameoutofPath(_path, &quot;/&quot;) &amp; &quot;/python.exe&quot;
	If FileExists(BundlePyPath) Then Exit Function
	BundlePyPath = DirectoryNameoutofPath(_path, &quot;/&quot;) &amp; &quot;/python&quot;
	If FileExists(BundlePyPath) Then Exit Function
	If Len(PyPath) &lt;&gt; 0 Then
		BundlePyPath = PyPath
		Exit Function
	End If
	BundlePyPath = Replace(BundlePyPath, &quot;/lib/python&quot;, &quot;/bin/python3&quot;)
	If FileExists(BundlePyPath) Then Exit Function
	BundlePyPath = Replace(BundlePyPath, &quot;/bin/python3&quot;, &quot;/bin/python&quot;)
	If FileExists(BundlePyPath) Then Exit Function
	BundlePyPath = &quot;file:///usr/bin/python3&quot;
	If FileExists(BundlePyPath) Then Exit Function
	BundlePyPath = &quot;file:///usr/bin/python&quot;
	If FileExists(BundlePyPath) Then Exit Function
	BundlePyPath = &quot;&quot;	
	Exit Function
	BundlePyPathErr:
	BundlePyPath = &quot;&quot;
End Function


Function fsWinLocaleStr(_
		Optional ByVal sNode) As String
	&apos; The routine returns a Windows Locale setting
	&apos; When the function encounters an error, the routine returns &quot;&quot;.
	fsWinLocaleStr = &quot;&quot;
	If IsMissing(sNode) Then sNode = &quot;LocaleName&quot;
	&apos;
	&apos; Examples of sNode
	&apos; =================
	&apos;
	&apos; + &quot;Locale&quot;=&quot;00000409&quot;
	&apos; + &quot;LocaleName&quot;=&quot;en-CA&quot;
	&apos; + &quot;s1159&quot;=&quot;AM&quot;
	&apos; + &quot;s2359&quot;=&quot;PM&quot;
	&apos; + &quot;sCountry&quot;=&quot;Canada&quot;
	&apos; + &quot;sCurrency&quot;=&quot;$&quot;
	&apos; + &quot;sDate&quot;=&quot;/&quot;
	&apos; + &quot;sDecimal&quot;=&quot;.&quot;
	&apos; + &quot;sGrouping&quot;=&quot;3;0&quot;
	&apos; + &quot;sLanguage&quot;=&quot;ENC&quot;
	&apos; + &quot;sList&quot;=&quot;,&quot;
	&apos; + &quot;sLongDate&quot;=&quot;MMMM-dd-yy&quot;
	&apos;
	If fsGetOS() = &quot;WINDOWS&quot; Then
		On Local Error GoTo fsWinLocaleStrErr
		Dim objshell : objshell = CreateObject(&quot;WScript.Shell&quot;)
		Dim Path : Path = &quot;HKEY_CURRENT_USER\Control Panel\International\&quot;
		Dim MyLocale : MyLocale = objshell.RegRead(Path &amp; sNode)

		If Len(MyLocale) Then
			MyLocale = fsReplaceText(MyLocale, &quot;\\&quot;, &quot;\&quot;)
			fsWinLocaleStr = Split(MyLocale, &quot;&quot;&quot;&quot;)(0)
		End If
	End If
	Exit Function
	fsWinLocaleStrErr:
	fsWinLocaleStr = &quot;&quot;
End Function


Function fbWindowsReplacePhonemes(_
		_language As String,_
		_model As String,_
		_text_file_in As String) As Boolean
    &apos;Replaces mispronounced words with phonemes
	&apos; NOTE: Apache OpenOffice 4 for Windows does not support python 3
    fbWindowsReplacePhonemes = False
    Dim PyPath$ : PyPath = BundlePyPath()
    If Len(PyPath) = 0 Then
    	Exit Function
    End If
	Dim _command As String : _command = Join(Array(_
	&quot;&quot;&quot;&quot;, ConvertFromUrl(PyPath), &quot;&quot;&quot; &quot;&quot;&quot;, ConvertFromUrl(fsMyURL() &amp;_
	&quot;/python/find_replace_phonemes.py&quot;), &quot;&quot;&quot; --language &quot;, _language,_
	&quot; --model &quot;, _model, &quot; &quot;&quot;&quot;, ConvertFromUrl(_text_file_in), &quot;&quot;&quot;&quot;), &quot;&quot;)
	If fbIsLibreOffice() Then
		fbWindowsReplacePhonemes = fbDoWinBat(_command)
	Else
		fbWindowsReplacePhonemes = False
	End If
End Function


Function fbDoWinBat(_
		ByVal sA) As Boolean
	&apos; sA is a batch text (a series of Windows commands in batch file format).
	&apos; Batch files should only contain characters supported by iso-8859-15.
	&apos; This procedure runs the batch command sequence in the background.
	&apos;
	&apos; NOTE: Apache OpenOffice 4 cannot use `Wscript.Shell` to run a batch file
	fbDoWinBat = False
	If Not(fsGetOS() = &quot;WINDOWS&quot;) Then Exit Function
	If Len(sA) = 0 Then Exit Function
	Dim b1 As Boolean : b1 = False
	Dim CR$ : CR = Chr(13) &amp; Chr(10)  &apos; Batch files use `/r/n` line endings
	Dim n# : n = 0
	Dim s4$ : s4 = fsMyTempLock(&quot;bat&quot;)
	Dim s5$ : s5 = &quot;@echo off&quot; &amp; _
			CR &amp; _
			&quot;chcp 65001&gt;nul&quot; &amp; _
			CR
	&apos; s5 is a batch prefix to change the default encoding code page to 65001
	fbRemoveFile(s4)
	&apos; If we can&apos;t make a fresh file, then we don&apos;t want to run an
	&apos; arbitrary script.
	If FileExists(s4) Then Exit Function
	CreateFile(s4, s5 &amp; sA, &quot;utf-8&quot;)
	If FileLen(s4) = 0 Then Wait 1
	On Local Error GoTo fbDoWinBatErr
	If Len(fsWinLocaleStr(&quot;sLongDate&quot;)) = 0 Then
		&apos; You might not have access to `Wscript.Shell` so try to run the program
		&apos; in a normal shell.
		b1 = shell(sA, 6, &quot;&quot;, True)
	ElseIf fbIsLibreOffice() Then
		&apos; Run as a `Wscript.Shell` process so the system does not display a window
		&apos; while the batch file executes.
		CreateObject(&quot;Wscript.Shell&quot;).Run s4, 0, True
		b1 = True
	Else
		b1 = shell(ConvertToURL(s4), 6, &quot;&quot;, True)
	End If
	If FileExists(s4) Then
		fbDoWinBat = b1 &apos; Normally True
		fbRemoveFile(s4)
	End If
	Exit Function
	fbDoWinBatErr:
		On Local Error GoTo fbDoWinBatErr2
		&apos; Not able to use object, trying using a shell
		shell(ConvertToURL(s4), 6, &quot;&quot;, True)
		fbRemoveFile(s4)
	Exit Function
	fbDoWinBatErr2:
	fbDoWinBat = False
End Function



Function fsReleasenotesCMD( _
	sA As String) As String
&apos;Making release notes
	&apos; sA - Name of xba file to convert
	&apos; - TextToSpeech
	&apos; - ThirdPartyCode
	&apos; - TTS_Config
	&apos; - TTS_Indices
	&apos; - TTS_Utilities
	&apos;
	Dim s1 As String
	Dim s2 As String
	Dim s3 As String
	Dim s4 As String
	Dim s5
	Dim a1
	Dim n As Integer
	
	If fsGetOS() = &quot;WINDOWS&quot; Then
		fsReleasenotesCMD = &quot;&quot;
		Exit Function
	End If
	s5 = &quot;&quot;
	fsReleasenotesCMD = &quot;&quot;
	If Len(sA) = 0 Then
		sA = &quot;TextToSpeech,ThirdPartyCode,TTS_Config,TTS_Indices,TTS_Utilities&quot;
	End If
	Select Case sA
		Case &quot;ThirdPartyCode&quot;, &quot;TTS_Config&quot;, &quot;TTS_Indices&quot;, &quot;TTS_Utilities&quot;, _
		&quot;TextToSpeech,ThirdPartyCode,TTS_Config,TTS_Indices,TTS_Utilities&quot;
		&apos; ok
		Case Else
		sA = &quot;TextToSpeech&quot;
	End Select
	a1 = Split(sA, &quot;,&quot;)
	For n = LBound(a1) To UBound(a1)
		s2 = &quot;&quot;&quot;&quot; &amp; ConvertFromUrl(fsMyURL &amp; &quot;/textToSpeech/&quot; &amp; a1(n) &amp; &quot;.xba&quot;) &amp; &quot;&quot;&quot;&quot;
		s3 = &quot;&quot;&quot;&quot; &amp; ConvertFromUrl(fsGetHomeDir &amp; &quot;&quot; &amp; a1(n) &amp; &quot;.markdown&quot;) &amp; &quot;&quot;&quot;&quot;
		s4 = &quot;&quot;&quot;&quot; &amp; ConvertFromUrl(fsGetHomeDir &amp; &quot;&quot; &amp; a1(n) &amp; &quot;.markdown-e&quot;) &amp; &quot;&quot;&quot;&quot;
		s1 = &quot;cat &quot; &amp; s2 &amp; &quot; | grep &quot;&quot;&amp;apos;&amp;apos;&quot;&quot; &gt; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/&amp;apos;&amp;apos; //g&apos; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/&amp;apos;&amp;apos;//g&apos; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/&amp;quot;/&quot;&quot;/g&apos; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &quot;&quot;s/&amp;apos;/&apos;/g&quot;&quot; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/\&amp;amp;/\&amp;/g&apos; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/\&amp;gt;/\&gt;/g&apos; &quot; &amp; s3 &amp; &quot; ; &quot; &amp; _
		&quot;sed -i -e &apos;s/\&amp;lt;/\&lt;/g&apos; &quot; &amp; s3 &amp; &quot; &quot;
		s5 = InputBox( _
		&quot;Create &quot;&quot;&quot; &amp; _
		a1(n) &amp; _
		&quot;.markdown&quot;&quot; using this terminal command (&quot; &amp; _
		Trim(str(n + 1)) &amp; _
		&quot; / &quot; &amp; _
		Trim(UBound(a1) + 1) &amp; _
		&quot;) :&quot; , _
		fsLookUpTerm(&quot;s_read-text&quot;), _
		s1)
		If s5 = &quot;&quot; Then
			Exit For
		Else
			fsReleasenotesCMD = fsReleasenotesCMD &amp; &quot;;&quot; &amp; s5
			If InStr(sA, &quot;,&quot;) &lt;&gt; 0 Then
				webhelp(converttourl(fsGetHomeDir &amp; _
				a1(LBound(a1)) &amp; _
				&quot;.markdown&quot;))
			End If
		End If
	Next
End Function

Sub TextToSpeechCodeDocMarkdown()
	fsReleasenotesCMD(&quot;TextToSpeech&quot;)
End Sub

Sub ThirdPartyCodeDocMarkdown()
	fsReleasenotesCMD(&quot;ThirdPartyCode&quot;)
End Sub

Sub TTS_ConfigDocMarkdown()
	fsReleasenotesCMD(&quot;TTS_Config&quot;)
End Sub

Sub TTS_IndicesDocMarkdown()
	fsReleasenotesCMD(&quot;TTS_Indices&quot;)
End Sub

Sub TTS_UtilitiesDocMarkdown()
	fsReleasenotesCMD(&quot;TTS_Utilities&quot;)
End Sub

Sub megaDoc()
	Dim a1
	Dim s1
	Dim n
	
	a1 = Array( _
	&quot;TextToSpeech&quot;, _
	&quot;ThirdPartyCode&quot;, _
	&quot;TTS_Config&quot;, _
	&quot;TTS_Indices&quot;, _
	&quot;TTS_Utilities&quot;)
	
	&apos; cat 1.txt 2.txt 3.txt &gt; 0.txt    
	s1 = &quot;cat &quot;
	For n = LBound(a1) To UBound(a1)
		s1 = s1 &amp; _
		&quot;&quot;&quot;&quot; &amp; _
		ConvertFromUrl(fsGetHomeDir &amp; _
		a1(n) &amp; _
		&quot;.markdown&quot;) &amp; _
		&quot;&quot;&quot; &quot;
	Next
	s1 = s1 &amp; _
	&quot;&gt; &quot; &amp; _
	&quot;&quot;&quot;&quot; &amp; _
	ConvertFromUrl(fsGetHomeDir() &amp; _
	&quot;TTS_read-text-all&quot; &amp; _
	&quot;.markdown&quot;) &amp; _
	&quot;&quot;&quot; &quot;
	fsReleasenotesCMD(&quot;TextToSpeech,ThirdPartyCode,TTS_Config,TTS_Indices,TTS_Utilities&quot;)
	s1 = InputBox(&quot;TTS_read-text-all.markdown: use xCode or gedit to review.&quot;, _
	fsLookUpTerm(&quot;s_read-text&quot;), _
	s1)
	If Not(s1 = &quot;&quot;) Then
		webhelp(converttourl(fsGetHomeDir &amp; _
		&quot;TTS_read-text-all&quot; &amp; _
		&quot;.markdown&quot;))
	End If
End Sub

</script:module>