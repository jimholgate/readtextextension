<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="ThirdPartyCode" script:language="StarBasic">REM *  *  *  *  * BASIC *  *  *  *  *
&apos; ThirdPartyCode
Option Explicit
&apos;&apos; # Third Party Code
&apos;&apos;
&apos;&apos; Code shown here is used or adapted from other sources with permission.
&apos;&apos;
&apos; Unless otherwise attributed, the functions and subs below are adapted
&apos; from Extended PDF 1.4 (c) 2006 [Martin Brown](martin.brown@3bview.com)
&apos; and are distributed under the GNU General Public License
&apos;

Function fbTts_util_stringToBoolean( _
	value As String) As Boolean
	&apos; Converts a String to a boolean value.
	&apos; True=&gt; &quot;True&quot;
	&apos; False=&gt; &quot;False&quot;
	Dim b As Boolean
	b = False
	Dim v As String
	v = Trim(value)
	If StrComp(v,&quot;True&quot;, 0) = 0 _
		Or StrComp(v,&quot;yes&quot;, 0) = 0 _
		Or StrComp(v,&quot;1&quot;, 0) = 0 _
		Or val(v) &lt;&gt; 0 Then
		b = True
	End If
	fbTts_util_stringToBoolean = b
End Function


Function fsTts_util_booleanToString( _
	value As Boolean) As String
	&apos; Converts a boolean value to a String.
	&apos; True=&gt; &quot;True&quot;
	&apos; False=&gt; &quot;False&quot;
	Dim s As String
	
	If value Then
		s = &quot;True&quot;
	Else
		s = &quot;False&quot;
	End If
	fsTts_util_booleanToString = s
End Function


Function fsFullPathOf( _
	filename As String) As String
	&apos;This macro sets a complete path for the user directory for the temporary file
	
	fsFullPathOf = createUnoService(&quot;com.sun.star.util.PathSettings&quot;).userConfig &amp; _
	&quot;/&quot; &amp; _
	filename
End Function


Function fsGetHomePyVer(home As String) As String
	fsGetHomePyVer = &quot;&quot;
	Dim sub_dirs$ : sub_dirs = fsSubDirectories(home)
	Dim x# : x = 0
	Dim a1 As Variant : a1 = split(sub_dirs, Chr(13))
	For x = Lbound(a1) to Ubound(a1)
		If a1(x) &lt;&gt; &quot;Current&quot; Then
			fsGetHomePyVer = a1(x)
			Exit Function
		End If
	Next
End Function


Function fsMacPythonVersion()
	fsMacPythonVersion = &quot;&quot;
	If fsGetOs() &lt;&gt; &quot;MACOS&quot; Then
		Exit Function
	End If
	Dim home$ : home = &quot;/Applications/LibreOffice.app/Contents/Frameworks/LibreOfficePython.framework/Versions&quot;
	fsMacPythonVersion = fsGetHomePyVer(home)
End Function


Function fsLinux64PythonLib() As String
	&apos; Find location of the fedora python library
	fsLinux64PythonLib = &quot;&quot;
	Dim home$ : home = &quot;/usr/lib64&quot;
	Dim sub_dirs$ : sub_dirs = fsSubDirectories(home)
	Dim a1 As Variant : a1 = Split(sub_dirs, Chr(13))
	Dim x# : x = 0
	For x = Lbound(a1) To Ubound(a1)
		if instr(a1(x), &quot;python&quot;) = 1 Then
			 fsLinux64PythonLib = home &amp; &quot;/&quot; &amp; a1(x)
			 Exit Function
		End If
	Next
End Function


Function fbCheckPythonJson(_cmd) As Boolean
	&apos; For some local users, the system python3 is unavailable or incomplete.
	&apos; &lt;https://github.com/urllib3/urllib3/issues/3020#issuecomment-1539843879&gt;
	&apos; Try importing a library and see if there is an error.
	fbCheckPythonJson = False
	If Len(_cmd) = 0 Then
		_cmd = &quot;import json&quot;
	End If
	On Error GoTo fbCheckPythonJsonErr
	If Shell(&quot;python3&quot;, 0, &quot;-c &quot;&quot;&quot; &amp; _cmd &amp; &quot;&quot;&quot;&quot;) = 0 Then
		fbCheckPython3Ok = True
	End If
	Exit Function
	fbCheckPythonJsonErr:
	fbCheckPythonJson = False
End Function


Function fbCheckPython3Ok(_cmd) As Boolean
	&apos; For some local users, the system python3 is unavailable or incomplete.
	&apos; &lt;https://github.com/urllib3/urllib3/issues/3020#issuecomment-1539843879&gt;
	&apos; Try importing a library and see if there is an error.
	fbCheckPython3Ok = False
	If Len(_cmd) = 0 Then
		_cmd = &quot;import sys;sys.exec_prefix&quot;
	End If
	On Error GoTo fbCheckPython3OkErr
	If Shell(&quot;python3&quot;, 0, &quot;-c &quot;&quot;&quot; &amp; _cmd &amp; &quot;&quot;&quot;&quot;) = 0 Then
		fbCheckPython3Ok = True
	End If
	Exit Function
	fbCheckPython3OkErr:
	fbCheckPython3Ok = False
End Function


Function PosixPythonPath() As String
	&apos; On MacOS, if you want to use pip3 libraries, the
	&apos; version of the system python or the developer
	&apos; python needs to match the LibreOffice python
	&apos; major and minor versions (i. e.: `3.8` for
	&apos; LibreOffice 7.3). Otherwise you can only use the
	&apos; built-in libraries included with LibreOffice
	&apos; python. (i.e. : `(SPD_READ_TEXT_PY)` works)
	&apos;
	&apos; Linux LibreOffice installations that use the system
	&apos; version of python3 and pip3 just work.
	Dim a0 As Variant
	Dim a1 As Variant
	Dim x# : x = 0
	Dim y# : y = 0
	Dim py_ver$ : py_ver = fsMacPythonVersion()
	PosixPythonPath = &quot;&quot;
	Dim EnvironPy$ : EnvironPy = Environ(&quot;READ_TEXT_USE_PY&quot;)
	If Len(Environ(EnvironPy) &lt;&gt; 0) Then
		&apos; On Posix systems, you can edit a file to specify environmental
		&apos; values. To see your current values, open a console and type
		&apos; `env`. Some platforms use a user dialog to change the settings
		&apos; but it is more typical to just edit a settings file with a text
		&apos; editor. See the documentation for your distribution and desktop.
		&apos; Create an environment variable called `READ_TEXT_USE_PY`. Set
		&apos; the value to the full path of the python executable you want
		&apos; to use.		
		&apos;
		&apos; Once you have modified your default environment settings,
		&apos; when you type `env` in a console you should see a line that
		&apos; looks something like:
		&apos;
		&apos; `READ_TEXT_USE_PY=/usr/.local/bin/python3.12.1`
		&apos;
		&apos; Now, the extension uses that path for python if the path exists.
		If FileExists(EnvironPy) Then
			PosixPythonPath = EnvironPy
			Exit Function
		End If
	End If
	If fsTheOsId() = &quot;POSIX.APPIMAGE&quot; Then
		PosixPythonPath = fsAppImageResourcePath(&quot;python&quot;)
		If Len(Config(pi_external_path_string)) = 0 Then
			Config(pi_external_path_string) = PosixPythonPath	
		End If
		Exit Function
	Else
		Select Case Len(py_ver)
			Case 0
			a0 = Array(&quot;/usr&quot;)
			a1 = Array(&quot;python3&quot;, &quot;python&quot;)
			Case Else
			If fbCheckPython3Ok(&quot;&quot;) Then
			&apos; [developer, system, LibreOffice]
				a0 = Array(_
				&quot;/Library/Frameworks/Python.framework/Versions/&quot; &amp; py_ver, _
				&quot;/usr&quot;, _
				&quot;/Applications/LibreOffice.app/Contents/Frameworks/LibreOfficePython.framework/Versions/&quot; &amp; py_ver)
			Else
			&apos; [developer, LibreOffice]
				a0 = Array(_
				&quot;/Library/Frameworks/Python.framework/Versions/&quot; &amp; py_ver, _
				&quot;/Applications/LibreOffice.app/Contents/Frameworks/LibreOfficePython.framework/Versions/&quot; &amp; py_ver)
			End If
			a1 = Array(&quot;python&quot; &amp; py_ver, &quot;python3&quot;)
		End Select
		
		For y = Lbound(a0) to Ubound(a0)
			For x = Lbound(a1) To Ubound(a1)
				If FileExists(a0(y) &amp; &quot;/bin/&quot; &amp; a1(x)) Then
					PosixPythonPath = a0(y) &amp; &quot;/bin/&quot; &amp; a1(x)
					Exit Function
				End If
			Next
		Next
	End If
End Function


Function fbOsaScriptOk(_command) As Boolean
	&apos; Return `True` if MacOS `osascript` is executable
	On Error Goto fbOsaScriptOkErr
	If Len(_command) = 0 Then
		_command = &quot;-e &apos;set checked to &quot;&quot;osascript ok&quot;&quot;&apos;&quot;
	End If
	fbOsaScriptOk = Shell(&quot;osascript&quot;, 0, _command) = 0
	Exit Function
	fbOsaScriptOkErr:
	fbOsaScriptOk = False
End Function


Function fbPiperTtsOk(_command) As Boolean
	&apos; Return `True` if `piper` is executable
	On Error Goto fbPiperTtsOkErr
	If Len(_command) = 0 Then
		_command = &quot; -h&quot;
	End If
	fbPiperTtsOk = False
	Select Case i_CaReadTextExtensionPiperTestResult
		&apos; Only test once per session.
		&apos; Did test complete?
		&apos; Did the test pass?
		Case 2
		Exit Function
		Case 3
		fbPiperTtsOk = True
		Exit Function
	End Select
	Dim sPiperPath As String : sPiperPath = fsPiperPath()
	If Len(sPiperPath) = 0 or Not fbPySupportFStrings() Then
		i_CaReadTextExtensionPiperTestResult = 2
		Exit Function
	End If
	&apos; If you don&apos;t have VLC on Windows systems, then piper needs to write a file
	&apos; instead of streaming. This has the potential for causing a long delay if
	&apos; you select a long string of text to read aloud. Only show the option if
	&apos; someone enables &quot;Enable Experimental Features (May be unstable)&quot; in the
	&apos; Tools - Options - Advanced menu
	If Not fbExperimentalMode() Then
		Select Case fsTheOsId()
			Case &quot;WINDOWS&quot;, &quot;WINDOWS.WINE&quot;, &quot;WINDOWS.NOSCRIPT&quot;
			If Not fbHaveVLC() Then
				i_CaReadTextExtensionPiperTestResult = 2
				Exit Function
			End If
			End Select
	End If
	If Shell(sPiperPath, 0, _command) = 0 Then
		i_CaReadTextExtensionPiperTestResult = 3
		fbPiperTtsOk = True
	Else
		i_CaReadTextExtensionPiperTestResult = 2
	End If
	Exit Function
	fbPiperTtsOkErr:
	i_CaReadTextExtensionPiperTestResult = 0
	fbPiperTtsOk = False
End Function


Function PiperLocalSuggestion(_lang As String, _high As Boolean) As String
	&apos; Return a selection from a curated list of voice models. If `_high` is
	&apos; `True`, then return a high quality voice model.
	&apos;
	&apos; [Canadian and Indian accent reference](http://www.festvox.org/cmu_arctic/)
	If Len(_lang) = 0 Then
		_lang = fsSelectionLanguageAndRegion(False)
	End If
	PiperLocalSuggestion = &quot;en_GB-jenny_dioco-medium&quot;
	Dim models As Variant
	If _high Then
		PiperLocalSuggestion = &quot;en_US-lessac-high&quot;
		models = Array(_
		Array(&quot;de_DE&quot;, &quot;de_DE-thorsten-high#0&quot;),_
		Array(&quot;en_GB&quot;, &quot;en_GB-cori-high#0&quot;),_
		Array(&quot;en_US&quot;, &quot;en_US-lessac-high#0&quot;),_
		Array(&quot;es_MX&quot;, &quot;es_MX-claude-high#0&quot;),_
		Array(&quot;kk_KZ&quot;, &quot;kk_KZ-issai-high#0&quot;),_
		)
	Else
		models = Array(_
		Array(&quot;ar_JO&quot;, &quot;ar_JO-kareem-medium#0&quot;),_
		Array(&quot;ca_ES&quot;, &quot;ca_ES-upc_ona-medium#0&quot;),_
		Array(&quot;cs_CZ&quot;, &quot;cs_CZ-jirka-medium#0&quot;),_
		Array(&quot;da_DK&quot;, &quot;da_DK-talesyntese-medium#0&quot;),_
		Array(&quot;de_DE&quot;, &quot;de_DE-thorsten-medium#0&quot;),_
		Array(&quot;en_CA&quot;, &quot;en_US-arctic-medium#8&quot;),_
		Array(&quot;en_GB&quot;, &quot;en_GB-vctk-medium#64&quot;),_
		Array(&quot;en_IE&quot;, &quot;en_GB-jenny_dioco-medium#0&quot;),_
		Array(&quot;en_IN&quot;, &quot;en_US-arctic-medium#3&quot;),_
		Array(&quot;en_US&quot;, &quot;en_US-lessac-medium#0&quot;),_
		Array(&quot;es_ES&quot;, &quot;es_ES-sharvard-medium#0&quot;),_
		Array(&quot;fa_IR&quot;, &quot;fa_IR-gyro-medium#0&quot;),_
		Array(&quot;fi_FI&quot;, &quot;fi_FI-harri-medium#0&quot;),_
		Array(&quot;fr_FR&quot;, &quot;fr_FR-upmc-medium#0&quot;),_
		Array(&quot;hu_HU&quot;, &quot;hu_HU-anna-medium#0&quot;),_
		Array(&quot;is_IS&quot;, &quot;is_IS-bui-medium#0&quot;),_
		Array(&quot;it_IT&quot;, &quot;it_IT-riccardo-x_low#0&quot;),_
		Array(&quot;ka_GE&quot;, &quot;ka_GE-natia-medium#0&quot;),_
		Array(&quot;lb_LU&quot;, &quot;lb_LU-marylux-medium#0&quot;),_
		Array(&quot;ne_NP&quot;, &quot;ne_NP-google-medium#0&quot;),_
		Array(&quot;nl_BE&quot;, &quot;nl_BE-nathalie-medium#0&quot;),_
		Array(&quot;no_NO&quot;, &quot;no_NO-talesyntese-medium#0&quot;),_
		Array(&quot;pl_PL&quot;, &quot;pl_PL-darkman-medium#0&quot;),_
		Array(&quot;pt_BR&quot;, &quot;pt_BR-faber-medium#0&quot;),_
		Array(&quot;pt_PT&quot;, &quot;pt_PT-tug√£o-medium#0&quot;),_
		Array(&quot;ro_RO&quot;, &quot;ro_RO-mihai-medium#0&quot;),_
		Array(&quot;ru_RU&quot;, &quot;ru_RU-dmitri-medium#0&quot;),_
		Array(&quot;sk_SK&quot;, &quot;sk_SK-lili-medium#0&quot;),_
		Array(&quot;sl_SI&quot;, &quot;sl_SI-artur-medium#0&quot;),_
		Array(&quot;sr_RS&quot;, &quot;sr_RS-serbski_institut-medium#0&quot;),_
		Array(&quot;sv_SE&quot;, &quot;sv_SE-nst-medium#0&quot;),_
		Array(&quot;sw_CD&quot;, &quot;sw_CD-lanfrica-medium#0&quot;),_
		Array(&quot;tr_TR&quot;, &quot;tr_TR-dfki-medium#0&quot;),_
		Array(&quot;uk_CA&quot;, &quot;uk_UA-ukrainian_tts-medium#0&quot;),_
		Array(&quot;uk_RU&quot;, &quot;uk_UA-ukrainian_tts-medium#1&quot;),_
		Array(&quot;uk_UA&quot;, &quot;uk_UA-ukrainian_tts-medium#2&quot;),_
		Array(&quot;vi_VN&quot;, &quot;vi_VN-vais1000-medium#0&quot;),_
		Array(&quot;zh_CN&quot;, &quot;zh_CN-huayan-medium#0&quot;))
	End If
	Dim langs As Variant : langs = Array(_
	fsReplaceText(_lang, &quot;-&quot;, &quot;_&quot;,), _
	Split(_lang, &quot;-&quot;)(0), _
	Split(_lang, &quot;_&quot;)(0))
	Dim x As Integer : x = 0
	Dim y As Integer : y = 0
	For x = Lbound(langs) To Ubound(langs)
		For y = Lbound(models) to Ubound(models)
			If instr(models(y)(0), langs(x)) = 1 Then
				PiperLocalSuggestion = models(y)(1)
				Exit Function
			End If
		Next
	Next
End Function


Function fbUpdateLexiconFile(_
		_language As String,_
		_model As String,_
		_json_file_in As String) As Boolean
    &apos; Update json and remove duplicate items. When you download an untrusted
    &apos; json file, return `True` only if the data structure is compatible.
    &apos; NOTE: Apache OpenOffice 4 for Windows does not support python 3
    fbUpdateLexiconFile = False
	Dim _command As String : _command = &quot;&quot;
	Dim _app As String : _app = BundlePyPath()
	If Len(_app) = 0 Then
		Exit Function
	End If
	Select Case getGUIType()
		Case 1  &apos; WINDOWS
		_command = Join(Array(_
		&quot;&quot;&quot;&quot;, ConvertFromUrl(_app), &quot;&quot;&quot; &quot;&quot;&quot;, ConvertFromUrl(fsMyURL() &amp;_
		&quot;/python/find_replace_phonemes.py&quot;), &quot;&quot;&quot; --language &quot;, _language,_
		&quot; --model &quot;, _model, &quot; &quot;&quot;&quot;, ConvertFromUrl(_json_file_in), &quot;&quot;&quot;&quot;), &quot;&quot;)
		If fbIsLibreOffice() Then
			fbUpdateLexiconFile = fbDoWinBat(_command)
		Else
			fbUpdateLexiconFile = False
		End If
		Case Else
		_command = Join(Array(_
		&quot;&quot;&quot;&quot;, ConvertFromUrl(fsMyURL() &amp; &quot;/python/find_replace_phonemes.py&quot;),_
		&quot;&quot;&quot; --language &quot;, _language, &quot; --model &quot;, _model, &quot; &quot;&quot;&quot;,_
		ConvertFromUrl(_json_file_in), &quot;&quot;&quot;&quot;), &quot;&quot;)
		fbUpdateLexiconFile = Shell(_app, 0, _command) = 0
	End Select
	Exit Function
	fbUpdateLexiconFileErr:
	fbUpdateLexiconFile = False
End Function


Function GoogleTranslateDefault()
	Dim s1 As String : s1 = &quot;https://translate.google.com/?&amp;langpair=auto|(LANGUAGE_CODE)&amp;tbb=1&amp;ie=&amp;hl=(LANGUAGE_CODE)&amp;text=(OOO_WEBTEXT)&quot;
	GoogleTranslateDefault = s1
	On Local Error GoTo GoogleTranslateDefaultErr
	Dim a1 As Variant : a1 =  faDialog1ComboBox4Array(s1, fsDocLanguage() &amp; &quot;-&quot; &amp; fsDocCountry())
	If Len(a1(0)) &lt;&gt; 0 Then
		GoogleTranslateDefault = a1(0)
	End If
	Exit Function
	GoogleTranslateDefaultErr:
	GoogleTranslateDefault = s1
End Function


Function fvTts_config_createDefaultConfig( _
	msgs() As Variant, _
	errorCode As Integer) As Variant
	Dim player7 As String : player7 = &quot;&quot;
	&apos; The place to store the configuration data
	If UboundCurrentConfigItems() &gt; 0 Then
		fvTts_config_createDefaultConfig() = f_CaReadTextExtensionCurrentConfig
		Exit Function
	End If
	Dim Config(fiUboundConfigOptions) As Variant
	Config(pi_anonymous_key_string) = fsGetFirstKey(Config)
	Dim bPiperOk As Boolean : bPiperOk = fbPiperTtsOk(&quot;&quot;)
	Dim bUsingWine As Boolean : bUsingWine = False
	Dim sGetLanguage As String : sGetLanguage = fsGetLanguage()
	Dim sLocalHostSpeech As String : sLocalHostSpeech = &quot;&quot;
	Dim Item As Variant
	&apos; Create default values for variables

	Dim pyFallBack As String : pyFallBack = &quot;-c &quot;&quot;import webbrowser;webbrowser.open_new_tab(&apos;https://quickchart.io/qr?size=350&amp;text=(OOO_WEBTEXT)&apos;)&quot;&quot;&quot;
	Select Case getGUIType()
		Case 1  &apos; Windows
		bUsingWine = fbUsingWine(False)
		If not bUsingWine Then
			player7 = &quot; --player 0&quot;
		End If
		If bPiperOk Then
			Config(pi_use_experimental_boolean) = False
			Config(pi_experimental_path_string) = ConvertFromURL(BundlePyPath())
			Config(pi_experimental_options_string) = &quot;&quot;&quot;(PIPER_READ_TEXT_PY)&quot;&quot;&quot; &amp; player7 &amp; &quot; --voice &quot; &amp; _
			PiperLocalSuggestion(&quot;&quot;, False) &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		Else
			Config(pi_use_experimental_boolean) = False
			If FileExists(fsProgramDirectoryx86() &amp; &quot;festival&quot;) Then
				Config(pi_experimental_path_string) = fsProgramDirectoryx86() &amp; &quot;festival\festival.exe&quot;
			Else
	 			Config(pi_experimental_path_string) = fsProgramDirectory() &amp; &quot;festival\festival.exe&quot;
			End If
			Config(pi_experimental_options_string) = &quot;(audio_mode &apos;async)(tts&quot;&quot;(TMP)&quot;&quot; nil) (quit)&quot;		
		End If
		Config(pi_use_external_boolean) = True
		Config(pi_use_html_boolean) = False
		Config(pi_use_smart_select_integer) = 0
		Config(pi_html_string) = GoogleTranslateDefault()
		If Len(WinSpeechProgramPath()) = 0 Then
			Config(pi_external_path_string) = ConvertFromURL(BundlePyPath())
			Config(pi_external_options_string) = &quot;(RESET_ALL)&quot;
		ElseIf bUsingWine Then
			&apos; Don&apos;t attempt SAPI speech by default using Wine for Posix.
			Config(pi_external_path_string) = ConvertFromURL(BundlePyPath())
			Config(pi_experimental_path_string) = Config(pi_external_path_string)
			Config(pi_experimental_options_string) = &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;AUTO&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			If bPiperOk Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(PIPER_READ_TEXT_PY)&quot;&quot;&quot; &amp; player7 &amp; &quot; --voice &quot; &amp; _
				PiperLocalSuggestion(&quot;&quot;, False) &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			Else
				Config(pi_external_options_string) = &quot;(RESET_ALL) &quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --client_id &quot;&quot;(SESSION_ID)&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
				Config(pi_experimental_options_string) = pyFallBack
			End If
		Else
			Config(pi_external_path_string) = WinSpeechProgramPath()
			Config(pi_external_options_string) = WinSpeechArgument()		
		End If
		Config(pi_display_info_integer) = 0
		Config(pi_display_language_string) = sGetLanguage
		Case Else
		&apos; Posix or MacOS
		If bPiperOk Then
			Config(pi_use_experimental_boolean) = False
			Config(pi_experimental_path_string) = PosixPythonPath()
			Config(pi_experimental_options_string) = &quot;&quot;&quot;(PIPER_READ_TEXT_PY)&quot;&quot; --player 7 --voice &quot; &amp; _
			PiperLocalSuggestion(&quot;&quot;, False) &amp; &quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		ElseIf fsGetOS() = &quot;MACOS&quot; Then
			Config(pi_use_experimental_boolean) = False
			Config(pi_experimental_path_string) = PosixPythonPath()
			Config(pi_experimental_options_string) = &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;AUTO&quot;&quot; --rate &quot;&quot;70%&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
		Else  &apos; Posix
			If FileExists(&quot;/usr/bin/festival&quot;) Then
				Config(pi_use_experimental_boolean) = False
				Config(pi_experimental_path_string) = &quot;/usr/bin/festival&quot;
				Config(pi_experimental_options_string) = &quot;(audio_mode &apos;async)(tts&quot;&quot;(TMP)&quot;&quot; nil) (quit)&quot;
			ElseIf fbIsLibreOffice() Then
				Config(pi_use_experimental_boolean) = False
				Config(pi_experimental_path_string) = PosixPythonPath()
				Config(pi_experimental_options_string) = &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot; --voice &quot;&quot;AUTO&quot;&quot; --rate &quot;&quot;70%&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;			
			Else
				Config(pi_use_experimental_boolean) = False
				Config(pi_experimental_path_string) = PosixPythonPath()
				Config(pi_experimental_options_string) = pyFallBack
			End If
		End If
		Config(pi_use_external_boolean) = True
		Config(pi_use_html_boolean) = False
		Config(pi_use_smart_select_integer) = 0
		If Len(fsLocalHostSpeech()) = 0 Then
			Config(pi_html_string) = GoogleTranslateDefault()
		Else
			Config(pi_html_string) = fsLocalHostSpeech()
		End If
		If fsGetOS() = &quot;POSIX&quot; Then
			&apos; Linux
			If Len(PosixPythonPath()) &lt;&gt; 0 Then
				Config(pi_external_path_string) = PosixPythonPath()
			Else
				Config(pi_external_path_string) = &quot;/usr/bin/python&quot;
			End If
			If fsTheOsId() = &quot;POSIX.SNAP&quot; Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
				&quot;--language (SELECTION_LANGUAGE_COUNTRY_CODE) --voice &quot;&quot;FEMALE1&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf fbIsSandboxed() Then
				Config(pi_external_options_string) = &quot;-m webbrowser -t &quot; &amp; _
				&quot;&quot;&quot;https://translate.google.com/?sl=auto&amp;tl=(LANGUAGE_CODE)&amp;text=(OOO_WEBTEXT)&quot;&quot;&quot;
			ElseIf Len(fsFindAppPath(&quot;pico2wave&quot;)) &lt;&gt; 0 Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(PICO_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
				&quot;--language (SELECTION_LANGUAGE_COUNTRY_CODE) &quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf Len(fsFindAppPath(&quot;open_jtalk&quot;)) &lt;&gt; 0 And sGetLanguage = &quot;ja&quot; Then
				&apos; Japanese
				Config(pi_external_options_string) = &quot;&quot;&quot;(OPENJTALK_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
				&quot;&quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf bPiperOk Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(PIPER_READ_TEXT_PY)&quot;&quot;&quot; &amp; _
				&quot; --rate 100% --voice AUTO0#0 --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot; &amp; _
				&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf Len(fsFindAppPath(&quot;text2wave&quot;)) &lt;&gt; 0 Or Len(fsFindAppPath(&quot;flite&quot;)) &lt;&gt; 0 Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(FESTIVAL_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
				&quot;&quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf fbHaveEspeak() Then
				Config(pi_external_options_string) = &quot;&quot;&quot;(ESPEAK_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
				&quot;--language (SELECTION_LANGUAGE_COUNTRY_CODE) &quot;&quot;(TMP)&quot;&quot;&quot;
			ElseIf fbPySupportFStrings() Then
					Config(pi_external_options_string) = &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot;&quot; &amp; _
					&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot; &amp; _
					&quot; --client_id &quot;&quot;(SESSION_ID)&quot;&quot;&quot; &amp; _
					&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
				&apos; Mimic3 and MaryTTS servers include an English voice model by default.
				&apos; Piper server uses the system language. Rhvoice-Rest and OpenTTS include
				&apos; multiple voice models by default.
				sLocalHostSpeech = fsLocalHostSpeech()
				For Each Item in SpeechHostInfoList()
					If InStr(Item.langs, sGetLanguage) &lt;&gt; 0 And Instr(sLocalHostSpeech, Item.url) = 1 Then
						Config(pi_external_options_string) =  &quot;&quot;&quot;(NETWORK_READ_TEXT_PY)&quot;&quot; &quot; &amp; _
					&quot;--language (SELECTION_LANGUAGE_COUNTRY_CODE) &quot;&quot;(TMP)&quot;&quot;&quot;
						Exit For
					End If		
				Next
			Else
				Config(pi_external_options_string) = pyFallBack
			End If
		Elseif fbIsLibreOffice() Then
			&apos;Mac (MacOS)
			If fbOsaScriptOk(&quot;&quot;) And fbHaveItunes() Then
				Config(pi_external_path_string) = AppleScriptPath()
				Config(pi_external_options_string) = &quot;&quot;&quot;(SAY_APPLESCRIPT)&quot;&quot;&quot;
			ElseIf fbHaveNetworkTTS() Then
				Config(pi_external_path_string) = PosixPythonPath()
				Config(pi_external_options_string) =  &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot;&quot; &amp; _
				&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot; &amp; _
				&quot; --voice &quot;&quot;AUTO&quot;&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			Else
				Config(pi_external_path_string) = PosixPythonPath()
				Config(pi_external_options_string) =  &quot;&quot;&quot;(SPD_READ_TEXT_PY)&quot;&quot;&quot; &amp; _
				&quot; --language &quot;&quot;(SELECTION_LANGUAGE_COUNTRY_CODE)&quot;&quot;&quot; &amp; _
				&quot; &quot;&quot;(TMP)&quot;&quot;&quot;
			End If
		Else
			If fbOsaScriptOk(&quot;&quot;) And fbHaveItunes() Then
				Config(pi_external_path_string) = AppleScriptPath()
				Config(pi_external_options_string) = &quot;&quot;&quot;(SAY_APPLESCRIPT)&quot;&quot;&quot;
			Else
				Config(pi_external_path_string) = PosixPythonPath()
				Config(pi_external_options_string) = pyFallBack
			End If		
		End If
		Config(pi_display_info_integer) = 1
		Config(pi_display_language_string) = fsGetLanguage()
	End Select
	fvTts_config_createDefaultConfig() = Config()
End Function


Sub tts_config_writeFile( _
	Config() As Variant,ByVal configFilePath As String)
	&apos; Writes a configuration file from an array.
	&apos; This function updated 2013-08-29 - always write as UTF-8
	On Local Error Goto tts_config_writeFileErr
	Dim sA As String
	Dim CR As String
	Dim ExternalCommand As String
	Dim PyVersion() As String
	Dim x As Integer
	ExternalCommand = &quot;&quot;
	Dim EnvironPy As String : EnvironPy = Environ(&quot;READ_TEXT_USE_PY&quot;)
	If Len(EnvironPy) &lt;&gt; 0 Then
		If FileExists(EnvironPy) Then
			ExternalCommand = EnvironPy
		End If
	End If
	If Len(ExternalCommand) = 0 Then
		ExternalCommand = Config(pi_external_options_string)
		PyVersion = Array(&quot;4&quot;, &quot;3&quot;, &quot;2.7&quot;, &quot;2&quot;, &quot;&quot;)
		If fsTheOsId() = &quot;POSIX.APPIMAGE&quot; Then
			&apos; Do not record a temporary Posix python application path.
			ExternalCommand = fsAppImageResourcePath(&quot;python&quot;)
		End If
	End If
	If InStr(Config(pi_external_path_string), &quot;python&quot;) &lt;&gt; 0 Then
		&apos; After updating `~/.local/share/piper-tts/piper-tts/voices.json`, then
		&apos; store the active command without the update flag.
		Select Case Instr(ExternalCommand, &quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;)
			Case 0
			ExternalCommand = fsReplaceText(ExternalCommand, &quot; --update True&quot;, _
			&quot; --language (SELECTION_LANGUAGE_COUNTRY_CODE)&quot;)
			Case Else
			ExternalCommand = fsReplaceText(ExternalCommand, &quot; --update True&quot;, _
			&quot;&quot;)
		End Select
	End If
	If Len(Config(pi_anonymous_key_string)) = 0 Then
	&apos; Update `text-to-speech.anonymous.key.string` on computers when you update
	&apos; the extension version.
	&apos;
	&apos; An organization&apos;s networked services can use this key to verify
	&apos; permission to connect without using your personal information.
	&apos; Resetting the extension&apos;s settings deletes the local key permanently.
		Config(pi_anonymous_key_string) = fsGetFirstKey(Config)
	End If
	If Len(Config(pi_display_language_string)) = 0 Then
		Config(pi_display_language_string) = fsGetLanguage()
	End If
	CR = Chr(10)
	sA = Join(Array(_
	&quot;dialog1.anonymous.key.string=&quot;, Config(pi_anonymous_key_string), CR, _
	&quot;dialog1.display.info.integer=&quot;, Config(pi_display_info_integer), CR, _
	&quot;dialog1.external.options.string=&quot;,Config(pi_external_options_string), CR, _
	&quot;dialog1.use.external.boolean=&quot;, fsTts_util_booleanToString(Config(pi_use_external_boolean)), CR, _
	&quot;dialog1.use.html.boolean=&quot;, fsTts_util_booleanToString(Config(pi_use_html_boolean)), CR, _
	&quot;dialog1.html.string=&quot;, Config(pi_html_string), CR, _
	&quot;dialog1.use.experimental.boolean=&quot;, fsTts_util_booleanToString(Config(pi_use_experimental_boolean)), CR, _
	&quot;dialog1.experimental.options.string=&quot;, Config(pi_experimental_options_string), CR, _
	&quot;dialog1.external.path.string=&quot;, Config(pi_external_path_string), CR, _
	&quot;dialog1.experimental.path.string=&quot;, Config(pi_experimental_path_string), CR, _
	&quot;dialog1.use.smart.select.integer=&quot;, Config(pi_use_smart_select_integer), CR, _
	&quot;dialog1.display.language.string=&quot;, Config(pi_display_language_string), CR), &quot;&quot;)
	CreateFile(configFilePath, sA, &quot;&quot;)
	Exit Sub
	tts_config_writeFileErr:
	ResetAll()
End Sub


Sub tts_config_parseFile( _
    ByVal configFilePath As String, _
    Config() As Variant, _
    errorCode As Integer)
    &apos; Parses the configuration file into an array.
    &apos;
    &apos; Parameters:
    &apos; configFilePath (in) The path to the configuration file
    &apos; Config() (in out) The configuration settings to update with settings
    &apos;                   from the file.
    &apos; errorCode (in out) The Error parameter.
    &apos;
    On Local Error GoTo tts_config_parseFileErr
    Dim sA As String
    Dim CR As String : CR = Chr(13)
    Dim CR2 As String : CR2 = Chr(10)
    Dim key As String
    Dim value As String
    Dim msgs() As Variant
    Dim _items As Variant
    Dim _item As String
    Dim _pair As Variant

    If Not FileExists(configFilePath) Then
        &apos; Use defaults
        Config = fvTts_config_createDefaultConfig(msgs(), errorCode)
        Exit Sub
    End If

    sA = getLimitedTextFromFile(configFilePath)
    
    If InStr(sA, &quot;dialog1.&quot;) = 0 Then
        &apos; Use defaults: wrong keys or could not read the file.
        Config = fvTts_config_createDefaultConfig(msgs(), errorCode)
        Exit Sub
    End If

    _items = Split(sA, CR)
    If UBound(_items) = 0 Then
        _items = Split(sA, CR2)
    End If
    For Each _item In _items
    	If Instr(_item, &quot;=&quot;) = 0 Or Instr(_item, &quot;#&quot;) = 1 Then
    		GoTo ContinueParsing
    	End If
        _pair = Split(_item, &quot;=&quot;)
        key = Trim(_pair(LBound(_pair)))
        value = Trim(_pair(UBound(_pair)))
        If Len(key) &lt;&gt; 0 And Len(value) &lt;&gt; 0 Then
            Select Case key
                Case &quot;dialog1.use.experimental.boolean&quot;
                    Config(pi_use_experimental_boolean) = fbTts_util_stringToBoolean(value)
                Case &quot;dialog1.experimental.path.string&quot;
                    Config(pi_experimental_path_string) = value
                Case &quot;dialog1.experimental.options.string&quot;
                    Config(pi_experimental_options_string) = value
                Case &quot;dialog1.use.external.boolean&quot;
                    Config(pi_use_external_boolean) = fbTts_util_stringToBoolean(value)
                Case &quot;dialog1.external.path.string&quot;
                    Select Case fsTheOsId()
                        Case &quot;POSIX&quot;, &quot;POSIX.APPIMAGE&quot;, &quot;POSIX.SNAP&quot;, &quot;MACOS&quot;
                            If InStr(value, &quot;/python&quot;) &lt;&gt; 0 And Not fbExperimentalMode() Then
                                Config(pi_external_path_string) = ConvertFromUrl(BundlePyPath())
                            Else
                                Config(pi_external_path_string) = value
                            End If
                        Case Else
                            Config(pi_external_path_string) = value
                    End Select
                Case &quot;dialog1.external.options.string&quot;
                    Config(pi_external_options_string) = value
                    Select Case fsTheOsId()
                        Case &quot;POSIX&quot;, &quot;POSIX.APPIMAGE&quot;, &quot;POSIX.SNAP&quot;, &quot;MACOS&quot;
                            If InStr(value, &quot;/python&quot;) &lt;&gt; 0 And Not fbExperimentalMode() Then
                                Config(pi_external_options_string) = &quot;&quot;
                            End If
                    End Select
                Case &quot;dialog1.use.html.boolean&quot;
                    Config(pi_use_html_boolean) = fbTts_util_stringToBoolean(value)
                Case &quot;dialog1.html.string&quot;
                    Config(pi_html_string) = value
                Case &quot;dialog1.anonymous.key.string&quot;
                    Config(pi_anonymous_key_string) = value
                Case &quot;dialog1.display.info.integer&quot;
                    Config(pi_display_info_integer) = fiStringToInteger(value)
                Case &quot;dialog1.display.language.string&quot;
                    Config(pi_display_language_string) = value
                Case &quot;dialog1.use.smart.select.integer&quot;
                    Config(pi_use_smart_select_integer) = value
            End Select
        End If
        ContinueParsing:
    Next
    f_CaReadTextExtensionCurrentConfig = Config
    Exit Sub
tts_config_parseFileErr:
    ResetAll()
End Sub


Function fsSuperTrim( _
	ByVal sA As String, _
	ByVal unwanted_chrs As String) As String
	&apos; Trim extra unwanted characters from left and right
	&apos; of a string - like python `strip`
	&apos; * `sA` - The string to trim
	&apos; * `unwanted_chrs` - String of characters to strip
	&apos;    in the form `Chr(10) &amp; Chr(13)` or `&quot;,:;-&quot;.`
	If Len(unwanted_chrs) = 0 Then
		unwanted_chrs = Chr(10) &amp; Chr(13)
	End If
	Dim n As Integer
	Dim limit as Integer
	limit = 100
	If Len(sA) &lt; limit Then
		limit = Len(sA)
	End If
	For n = 1 To limit
		sA = Trim(sA)
		If Len(sA) = 0 Then
			Exit For
		ElseIf Instr(unwanted_chrs, Right(sA, 1)) &lt;&gt; 0 Then
			sA = Left(sA, Len(sA) - 1)
			sA = Trim(sA)
		Else
			Exit For
		End If
	Next
	For n = 1 to limit
		sA = Trim(sA)
		If Len(sA) = 0 Then
			Exit For
		ElseIf Instr(unwanted_chrs, Left(sA, 1)) &lt;&gt; 0 Then
			sA = Mid(sA, 2)
			sA = Trim(sA)
		Else
			Exit For
		End If
	Next		
	fsSuperTrim = sA
End Function


Function fsRetrieveCalcActiveCellProperty( _
	strA) As String
	&apos; Modified from sub from: Paolo Mantovani
	&apos; email: mantovani.paolo@tin.it
	&apos; published at https://sourceforge.net/projects/ooomacros/files/Andrew%20Pitonyak_s%20Macro%20Doc/2006-01-25/AndrewMacro_2006-01-25.zip/download
	&apos; Gets property of the active cell.
	Dim oOldSelection  &apos;The original selection of cell ranges
	Dim oRanges  &apos;A blank range created by the document
	Dim oActiveCell  &apos;The current active cell
	Dim sCellContent As String
	
	Rem store the current selection
	oOldSelection = ThisComponent.CurrentSelection
	oRanges = ThisComponent.createInstance(&quot;com.sun.star.sheet.SheetCellRanges&quot;)
	ThisComponent.CurrentController.Select(oRanges)
	&apos;get the active cell!
	oActiveCell = ThisComponent.CurrentSelection
	Select Case strA
		Case &quot;country&quot;
		sCellContent = oActiveCell.CharLocale.Country
		Case &quot;language&quot;
		sCellContent = oActiveCell.CharLocale.Language
		Case &quot;asian-language&quot;
		sCellContent = oActiveCell.CharLocaleAsian.Language
		Case &quot;complex-language&quot;
		sCellContent = oActiveCell.CharLocaleComplex.Language
		Case &quot;asian-country&quot;
		sCellContent = oActiveCell.CharLocaleAsian.Country
		Case &quot;complex-country&quot;
		sCellContent = oActiveCell.CharLocaleComplex.Country
		Case Else
		sCellContent = oActiveCell.getString()
	End Select
	&apos;restore the old selection (but loosing the previous active cell)
	ThisComponent.CurrentController.Select(oOldSelection)
	fsRetrieveCalcActiveCellProperty = sCellContent
End Function


Function fsGetPackageDirURL( _
	sIdentifier As String) As String
	&apos;http://www.oooforum.org/forum/viewtopic.phtml?t=72633
	Dim oPIP As Object
	
	oPIP = GetDefaultContext().getByName( _
	&quot;/singletons/com.sun.star.deployment.PackageInformationProvider&quot;)
	fsGetPackageDirURL = oPIP.getPackageLocation(sIdentifier)
End Function


Function fsGetPicturePath() As String
	Dim oDialog
	Dim oAllFiles
	Dim oFrame
	Dim oBar
	Dim sFilePickerArgs
	
	On Error Goto fsGetPicturePathErr
	oDialog = createUnoService(&quot;com.sun.star.ui.dialogs.FilePicker&quot;)
	sFilePickerArgs = Array(com.sun.star.ui.dialogs.TemplateDescription.FILEOPEN_LINK_PREVIEW)
	oDialog.Initialize(sFilePickerArgs())
	oDialog.setMultiSelectionMode(0)
	oDialog.AppendFilter( &quot;JPEG, PNG&quot;, &quot;*.jpeg;*.jpg;*.png&quot;)
	oDialog.AppendFilter( &quot;BMP, GIF, JPEG, PNG, TIF, TGA&quot;, &quot;*.bmp;*.gif;*.&quot; &amp; _
	&quot;jpeg;*.jpg;*.png;*.tif;*.tiff;*.tga&quot;)
	oDialog.setTitle(fsLookUpTerm(&quot;s_read-text&quot;) &amp; _
	&quot; - &quot; &amp; &quot; (MY_IMAGE)&quot;)
	If oDialog.execute = 0 Then
		fsGetPicturePath = ConvertFromUrl(fsPosterImg()) &apos;Default picture
	End If
	oAllFiles() = oDialog.getFiles()
	fsGetPicturePath = ConvertFromUrl(oAllFiles(0))
	If fsGetPicturePath = &quot;&quot; Then
		fsGetPicturePath = ConvertFromUrl(fsPosterImg()) &apos;Default picture
	End If
	Exit Function
	fsGetPicturePathErr:
	
	fsGetPicturePath = &quot;&quot;
End Function


Function CreatePoint( _
	ByVal x As Long, _
	ByVal y As Long) As com.sun.star.awt.Point
	&apos; OpenOffice.org Macros Explained, Third Ed., 2015. [Andrew Pitonyak](http://www.pitonyak.org)
	Dim oPoint
	oPoint = createUnoStruct( &quot;com.sun.star.awt.Point&quot; )
	oPoint.X = x
	oPoint.Y = y
	CreatePoint = oPoint
End Function


Function CreateSize( _
	ByVal x As Long, _
	ByVal y As Long) As com.sun.star.awt.Size
	&apos; OpenOffice.org Macros Explained, Third Ed., 2015. [Andrew Pitonyak](http://www.pitonyak.org)
	Dim oSize
	oSize = createUnoStruct( &quot;com.sun.star.awt.Size&quot; )
	oSize.Width = x
	oSize.Height = y
	CreateSize = oSize
End Function


Sub ChangeBackground( _
	ByVal i, _
	ByVal r1, _
	ByVal g1, _
	ByVal b1)
	&apos;AndrewMacro.odt - [Andrew Pitonyak](http://www.pitonyak.org)
	Dim oDoc As object
	Dim oDrawPages As object
	Dim oDrawPage As object
	Dim oBackground As object
	
	oDoc = ThisComponent
	If oDoc.supportsService(&quot;com.sun.star.presentation.PresentationDocument&quot;) Or _
		oDoc.supportsService(&quot;com.sun.star.drawing.DrawingDocument&quot;) Then
		oDrawPages = oDoc.getDrawPages()
		oDrawPage = oDrawPages.getByIndex(i)
		oBackground = oDoc.createInstance(&quot;com.sun.star.drawing.Background&quot;)
		oBackground.FillColor = RGB(r1, g1, b1)
		oDrawPage.Background = oBackground
	End If
End Sub


Sub zzTestPlaySound
	PlaySound(&quot;https://github.com/jimholgate/readtextextension/raw/master/media/mac_os_alex-bill_freeman-environmental_science_excerpt_cc_by_international.mp3&quot;)
End Sub


Function PlaySound(i_soundpath as string) As Boolean
	&apos; Return `True` if there is no error. For Windows and Linux. Adapted from:
	&apos; &lt;https://forum.openoffice.org/en/forum/viewtopic.php?p=387091&amp;sid=3eead031a698db5d92833cf3df9bfaad#p387091&gt;
	&apos; &lt;https://opengrok.libreoffice.org/xref/core/avmedia/source/macavf/avmediaMacAVF.component?r=43d2f3d5&gt;
	&apos; The Function blocks BASIC code execution while the sound is playing.
	PlaySound = False
	Select Case fsTheOsId()
	Case &quot;POSIX.APPIMAGE&quot;, &quot;WINDOWS.WINE&quot;
		Exit Function
	End Select
	On Error GoTo PlaySoundErr
	Dim oPlayer1 As Object
	Dim sUrlSound As String
	Dim oSounMgr As Object
	
	sUrlSound = ConvertToUrl(i_soundpath)

	If Not FileExists(sUrlSound) And Instr(sUrlSound, &quot;file://&quot;) = 1 Then	   
		MsgBox sUrlSound &amp; &quot; does not exist&quot;, 16
	Else
		If GetGuiType() = 1 Then
			oSounMgr = CreateUnoService(&quot;com.sun.star.media.Manager_DirectX&quot;)
		ElseIf fsGetOs() = &quot;POSIX&quot; Then
			oSounMgr = CreateUnoService(&quot;com.sun.star.comp.media.Manager_GStreamer&quot;)
		Else
			oSounMgr = CreateUnoService(&quot;com.sun.star.media.Manager_MacAVF&quot;)
		End If
		
		If IsNull(oSounMgr) Then
			MsgBox &quot;Sound Manager not set&quot;, 16
		Else
			oPlayer1 = oSounMgr.createPlayer(sUrlSound)
			With oPlayer1
				.setMediaTime(0.0)
				.setVolumeDB(-10) &apos; Adjust volume as needed
				.setPlayBackLoop(0) &apos; Set to 1 if you want to loop
				.start(0)
				While .isPlaying()
					DoEvents
				Wend
			End With
			oPlayer1 = Nothing
			oSounMgr = Nothing
			PlaySound = True
		End If
	End If
	Exit Function
	PlaySoundErr:
	PlaySound = False
End Function

</script:module>